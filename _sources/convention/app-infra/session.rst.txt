.. include:: ../module.txt

.. _section-app-infra-session-management-label:

セッション管理
==============================================

セッション管理の前提知識
---------------------------------------------

* セッション管理とは

ブラウザはWebサーバ間で発生する任意のHTTPリクエスト／レスポンスのアクセスを一つの集合体として管理・制御する仕組みを指す。
HTTP通信では、クライアントがリクエストを投げて(コネクションを確立し)サーバがレスポンスを返す，

このキャッチボールを1往復したところで通信は切れるという、ステートレスなプロトコルであり、前回通信の状態を持たない。
一方で、電子商取引サイトのような、ログインからログアウトまでの一連のリクエストに状態を持たせる必要がある場合、
このままでは実現できない。

HTTPにはセッションという仕様はないが、JavaEEにはセッション管理機能がサポートされているため、サーブレットのHttpServletRequestから
セッションIDという識別情報を取得し、ブラウザとWebサーバで交互にセッションIDをやりとりすることで、リクエストが同一セッションか否か、判別可能となる。
同一セッションと判別されたリクエストにセッション情報を紐付けることで、前回リクエスト時の状態を持たせることが可能となる。
|

* セッション管理の仕組み
セッション管理を実現するには、一般には以下のような方法が利用される。

.. raw:: html

	<table border=1 border-collapse="collapse" style="font-size : 12px;">
		<tr>
			<td>URLを利用</td>
			<td>基本的な方式  (セッション・ハイジャック等のセキュリティ上の問題が多い)</td>
		</tr>
		<tr>
			<td>Cookieを利用</td>
			<td>
				最もポピュラーで基本的な方式  (マルチウィンドウ・マルチセッションは使用するブラウザによって不可)<br>
				※現行システム、Terasolina5.1.0で採用されているセッション管理方式のベース
			</td>
		</tr>
		<tr>
			<td>hiddenフィールドを利用</td>
			<td>画面単位にセッションIDを持たせる（マルチウィンドウ・マルチセッション*1を実現、セキュリティ上の問題が多い）</td>
		</tr>
		<tr>
			<td>ワンタイムセッション</td>
			<td>画面単位にセッションIDを持たせる（マルチウィンドウ・マルチセッション*1を実現）</td>
		</tr>
	</table>

|

.. note::

	マルチウィンドウ・マルチセッション
		| 複数の画面が起動している状態で、起動画面別にHTTPセッションも別で管理されて動作していること
	多重ログイン
		| 既にログイン済みでセッションが有効な画面が起動している状態で、新たに別の画面から同じユーザーでログインを行うこと

1. Cookieを利用

.. figure:: img/Image72.JPG
	:align: center
	:width: 100%

.. figure:: img/Image73.JPG
	:align: center
	:width: 100%

.. figure:: img/Image74.JPG
	:align: center
	:width: 100%

2. hiddenフィールドを利用
3. ワンタイムセッション



* セッション管理の注意点

Cookieを利用したセッション管理の場合、注意する点はいくつかあるが、次期システムで考慮が必要となりそうな前提の技術情報を記載する。

1. ブラウザ種別によって、複数画面間でCookieのセッション情報(JSESSIONID)の共有非共有状態が異なる

	＜IE以外のブラウザの場合＞
		Chormeは、画面単位でCookieを管理しているため、同じ端末上で別々のウィンドウ間でセッション情報が共有化されることはない。（マルチウィンドウ・マルチセッション可能）
		FireFoxも、設定によりマルチウィンドウ・マルチセッションが可能

	＜IEの場合＞
		Microsoftのセキュリティ上の方針により、IE8以降は同じ端末上の複数の画面間でCookieのセッション情報(JSESSIONID)を共有する仕様となっている。
		(IE6,7はプロセス単位でCookie情報を管理しているため、マルチウィンドウ・マルチセッションが可能だった)

.. note::

	IEのセッション情報共用を下記にて参照
	 | `IE8 で別々のウィンドウでセッション情報が共有されてしまう <https://blogs.technet.microsoft.com/jpieblog/2010/05/10/ie8-3/#DLTS02>`_

使用するプロセスの数

.. figure:: img/Image75.JPG
	:align: center
	:width: 100%

2. 画面起動方法別、JSESSIONID共有化タイミングのパターン

.. figure:: img/Image76.JPG
	:align: center
	:width: 100%

.. figure:: img/Image77.JPG
	:align: center
	:width: 100%

.. figure:: img/Image78.JPG
	:align: center
	:width: 100%


3. 複数画面のセッションオブジェクト(*)共有による、不整合が発生する(操作の辻褄が合わなくなる)パターン
	(*) HttpSessionオブジェクトでセッション情報を管理する場合

.. figure:: img/Image79.JPG
	:align: center
	:width: 100%

.. figure:: img/Image80.JPG
	:align: center
	:width: 100%


セッション管理方式
===================================
ベースとなるセッション管理方式は、Cookieを利用した一般的なセッション管理方式を採用している

.. note::

	TERASOLUNA Server Framework for Java (5.x)の機能詳細にて下記参照
	 | `5.8. セッション管理の5.8.1. Overview <http://terasolunaorg.github.io/guideline/5.1.0.RELEASE/ja/ArchitectureInDetail/SessionManagement.html#overview>`_

.. figure:: img/Image81.JPG
	:align: center
	:width: 70%


* セッション利用時のメリット・デメリットについて

＜デメリット＞
	* 同一処理の画面を、複数のブラウザやタブで立ち上げた場合、互いの操作がセッション上に格納しているデータに干渉しあうため、データの整合性を保つことができなくなる。
	* データの整合性を保つためには、同一処理の画面を複数立ち上げることができないように、制御する必要がある。
	* データの整合性を保つための制御は、共通ライブラリから提供しているトランザクショントークンチェックを使用することで実現する事ができるが、ユーザビリティの低いアプリケーションとなってしまう。

＜メリット＞
	複数の画面(複数のリクエスト)をまたいで、データを持ち回ることができるため、ウィザード画面のような複数の画面で、1つ処理を構成する場合に、簡単にデータが持ち回れる。…等、一般的なもの

＜セッション利用時のポイント＞
	セッション利用については、メリット・デメリットを踏まえ、業務要件やシステム要件を考慮の上、リクエストパラメータで渡すか、セッションで持ち回すか検討すること

.. note::

	TERASOLUNA Server Framework for Java (5.x)の機能詳細にて下記参照
	 | `5.8.1.2.1. セッションの利用時のメリットでデメリットを参照 <http://terasolunaorg.github.io/guideline/5.1.0.RELEASE/ja/ArchitectureInDetail/SessionManagement.html#id10>`_

.. raw:: html

	<table border=1 border-collapse="collapse" style="font-size : 12px;">
	<tr bgcolor="#33CCFF">
		<th>No</th>
		<th>内容</th>
		<th>詳細</th>
		<th>備考</th>
	</tr>
	<tr>
		<td>1</td>
		<td>セッションの作成</td>
		<td>spring-security.xml へセッション生成方法のオプションを指定する。 ※オプションは 6.5.2.4.1. セッションの作成 「セッションの作成方針¶」方針を参照</td>
		<td>
			A-15<br>
			A-18
		</td>
	</tr>
	<tr>
		<td>2</td>
		<td>セッションの破棄</td>
		<td>Spring Securityは以下のタイミングでセッションを破棄する。<br>
			・ログアウト<br>
			・認証処理が成功したタイミング（セッション固定攻撃対策として）
		</td>
		<td>A-16 <br>
			 A-19 <br>
			 A-20
		</td>
	</tr>
	<tr>
		<td>3</td>
		<td>セッションタイムアウトの指定</td>
		<td>アプリケーションサーバーのサーブレットコンテナに対して行う。Servlet標準仕様で定められた指定方法(web.xml) かまたはWeblogic管理画面の設定確立されたセッションに対して一定時間アクセスがない場合、プリケーションサーバは、セッションタイムアウトを検知する。</td>
		<td>A-19 <br>
			ア-4
		</td>
	</tr>
	<tr>
		<td>4</td>
		<td>無効なセッションを使ったリクエストの検知</td>
		<td>無効なセッションを使ったリクエストを検知する機能を提供している。 無効なセッションとして扱われるリクエストの大部分は、セッションタイムアウト後のリクエストである。</td>
		<td>A-17</td>
	</tr>
	<tr>
		<td>5</td>
		<td>多重ログインの制御</td>
		<td>同じユーザー名(ログインID)を使った多重ログインを制御する機能を提供している。 先勝ち、後勝ちの両方を選択できる。デフォルトは多重ログインの制御なし</td>
		<td/>
	</tr>
	<tr>
		<td>6</td>
		<td>セッション利用時のセキュリティ対策（セッションハイジャック攻撃への対策）</td>
		<td>推測困難なセッションIDの生成HTTPSを使って通信（次期でが不採用）セッションIDはCookieを使って連携（次期ではSSLは対象外か）CookieのHttpOnly属性指定（JavaScriptからCookieにアクセスできないように）CookieにSecure属性を指定 (HTTPS通信の時だけCookieをサーバーに送信する)</td>
		<td>A-17</td>
	</tr>
	<tr>
		<td>7</td>
		<td>セッション固定攻撃への対策</td>
		<td>URL Rewriting 機能を無効可(デフォルト)有効可させると、Cookieが使用できないブラウザでURL内にJSESSIONIDが露出してしまう。ログイン後にセッションIDを変更する</td>
		<td>A-16</td>
	</tr>
	<tr>
		<td>8</td>
		<td>セッション情報の格納先</td>
		<td>Spring Securityが用意しているデフォルト実装ではHTTPセッションを使用するが、HTTPセッション以外(データベースやキーバリューストアなど)にオブジェクトを格納することも可能なアーキテクチャになっている。</td>
		<td>APサーバーをロードバランサなどでリクエストの振り分けを行う場合振り分け方によっては、どのAPサーバーからも共用で参照可能な形でセッション情報を格納必要がある</td>
	</tr>
	</table>

.. note::

	TERASOLUNA Server Framework for Java (5.x)の機能詳細にて下記参照
	 | `5.8. セッション管理 <http://terasolunaorg.github.io/guideline/5.1.0.RELEASE/ja/ArchitectureInDetail/SessionManagement.html#id3>`_


* トランザクショントークンの利用

	現行システムで実施されている上記の排他制御は、トランザクショントークンを利用して実現
	| →トランザクショントークンを利用すると、Submitボタン2度押しも禁止されるが、現行禁止していない

.. note::

	TERASOLUNA Server Framework for Java (5.x)の機能詳細にて下記参照
	 | `5.12. 二重送信防止 <http://terasolunaorg.github.io/guideline/5.1.0.RELEASE/ja/ArchitectureInDetail/DoubleSubmitProtection.html>`_


AP層の脆弱性対策
===================================
.. raw:: html

	<table border=1 cellpadding=0 cellspacing=0 style="font-size:10px;">
	 <tr bgcolor="#33CCFF">
	  <td>項番</td>
	  <td>区分</td>
	  <td>分類</td>
	  <td>タイトル</td>
	  <td>基準項目</td>
	  <td colspan=5>基準項目解説</td>
	  <td>次期への適用</td>
	  <td>達成状況</td>
	  <td>実現する階層/AP</td>
	  <td>実現する階層/システム基盤</td>
	 </tr>

	 <tr>
	  <td>A-15</td>
	  <td>○</td>
	  <td>セッション管理</td>
	  <td>推測困難なセッションID</td>
	  <td>セッションIDの推測に伴うなりすましを防ぐため、他者に容易に推測されないよう、認証用セッションIDは次を満たした値を生成すること。<br>
	    ・十分な長さの桁数<br>
	    ・ユーザ毎かつセッション毎に異なるランダムな値<br>
	    <br>
	   </td>
	  <td >・十分な長さの桁数とは128bit以上。<br>
	    ・「認証用セッションID」の定義は「④用語」参照。<br>
	  </td>
	  <td >2014年度1Q末リリース予定</td>
	  <td >○</td>
	  <td >FWの機能で提供されている。<br>
	    <br>
	    詳細はTERASOLUNA Guideline参照<br>
	    5.8章 セッション管理</td>
	  <td >○</td>
	  <td >○</td>
	  <td >　</td>
	  <td >■</td>
	  <td >　</td>
	 </tr>

	 <tr>
	  <td>A-16</td>
	  <td>○</td>
	  <td>　</td>
	  <td>セッション管理</td>
	  <td>セッション固定化攻撃対策</td>
	  <td>セッションIDの固定化攻撃に伴うなりすましを防ぐため、認証用セッションIDは、ログイン成功後に発行すること。<br></td>
	  <td>・ユーザがログインする前の段階で認証用セッションIDを発行し、その認証用セッションIDをログイン後も継続して使用する場合、セッションIDの固定化攻撃によって、他者になりすまされる可能性がある。<br>
	  	・ログイン後にログイン前のセッションを引き継ぐ必要がある場合には、ログイン成功後に新たなセッションIDを発行し、ログイン前のセッションIDは無効化すること。<br>
	    <br>
	    </td>
	  <td>AL075 認証機能</td>
	  <td>○</td>
	  <td>FWの機能で提供されている。<br>
	    <br>
	    詳細はTERASOLUNA Guideline参照<br>
	    5.8章 セッション管理<br>
	    6.3章 認証</td>
	  <td>△</td>
	  <td>○</td>
	  <td>■</td>
	  <td>　</td>
	 </tr>

	 <tr>
	  <td>A-17</td>
	  <td>○</td>
	  <td>　</td>
	  <td>セッション管理</td>
	  <td>セッションIDの格納先</td>
	  <td>認証用セッションIDは、CookieもしくはPOSTメソッドのhiddenパラメータに格納して受け渡すこと。<br></td>
	  <td>認証用セッションIDをURLパラメータに格納した場合、ブラウザのReferer送信機能や、ファイアウォールやproxyサーバのログ等によって、認証用セッションIDが他者に漏えいし、セッション・ハイジャックによって他者になりすまされる可能性がある。<br>
	  	<br>
	  </td>
	  <td >AL076 拡張認証機能</td>
	  <td >○</td>
	  <td >FWの機能で提供されている。<br>
	    <br>
	    詳細はTERASOLUNA Guideline参照<br>
	    5.8章 セッション管理<br>
	    6.3章 認証</td>
	  <td >△</td>
	  <td >○</td>
	  <td >■</td>
	  <td >　</td>
	 </tr>

	 <tr>
	  <td>A-18</td>
	  <td>○</td>
	  <td>　</td>
	  <td>セッション管理</td>
	  <td>Cookieの設定</td>
	  <td>
	  	Cookieの盗用に伴うなりすましを防ぐため、認証用セッションIDを格納したCookieは、以下を満たすように設定すること。<br>
	    ・有効期限はセッション限りとする。<br>
	    ・パスとドメインは、Cookieを発行したURL（パス、ドメイン）と等しいか、より狭い範囲に制限する。<br>
	    ・HTTPS通信で発行するCookieにはsecure属性を付与する。<br>
	    <br>
	   </td>
	  <td>Cookieのexpire/Max-Age属性を省略すると、Cookieの有効期限はセッション限りとなる。</td>
	  <td>2014年度1Q末リリース予定</td>
	  <td>△</td>
	  <td>FWの機能で提供されている。<br>
	    <br>
	    詳細はTERASOLUNA Guideline参照<br>
	    5.8章 セッション管理<br>
	    6.3章 認証</td>
	  <td >△</td>
	  <td >○</td>
	  <td >■</td>
	  <td >　</td>
	 </tr>


	 <tr>
	  <td>A-19</td>
	  <td>○</td>
	  <td>　</td>
	  <td>セッション管理</td>
	  <td>セッションの破棄</td>
	  <td>セッションIDの推測に伴うなりすましを防ぐため、ユーザの連続無操作時間が一定時間続いた場合、認証用セッションをサーバ側で破棄すること。<br>
	    </td>
	  <td>
	  	一定時間の長さは、業務要件やアクセシビリティを考慮して決定すること。<br>
	    例えば、決済システムの場合は15分（PCIDSS 3.0より）。<br>
	    <br>
	    </td>
	  <td>2014年度1Q末リリース予定</td>
	  <td>○</td>
	  <td>FWの機能で提供されている。<br>
	    <br>
	    詳細はTERASOLUNA Guideline参照<br>
	    5.8章 セッション管理<br>
	    6.3章 認証</td>
	  <td >○</td>
	  <td >○</td>
	  <td >■</td>
	  <td >　</td>
	 </tr>


	 <tr>
	  <td>A-20</td>
	  <td>○</td>
	  <td>　</td>
	  <td>セッション管理</td>
	  <td>セッションの終了</td>
	  <td>ユーザに対して、ユーザ自身がセッション終了できる機能（ログアウト機能）を提供すること。<br>
	    </td>
	  <td>・ユーザが離席した際に、第三者に悪用されるリスクを低減するための対策。システム提供者の責務として実装すべきである。<br>
	    <br>
	    </td>
	  <td>AL075 認証機能</td>
	  <td>○</td>
	  <td>FWの機能で提供されている。<br>
	    <br>
	    詳細はTERASOLUNA Guideline参照<br>
	    5.8章 セッション管理<br>
	    6.3章 認証</td>
	  <td>○</td>
	  <td>○</td>
	  <td>■</td>
	  <td>　</td>
	 </tr>
	 <tr>
	  <td>ア-4</td>
	  <td >○</td>
	  <td >　</td>
	  <td>　</td>
	  <td>システム管理者によるアクセスの終了/ロック</td>
	  <td>システム管理者の連続無操作時間が一定時間続いた場合、システム管理者との接続を終了もしくはロックすること。<br>
	    </td>
	  <td>・一定時間は5分間以下とすることが望ましい。システムの業務要件に合わせて適切な時間を設定すること。<br>
	  ・ロックは、セッションロック（アカウントロック）もしくは画面ロック（復帰時にパスワードの入力が必要なタイプ）を指している。システム管理者の操作環境（入退室管理の実施状況、リモート接続有無等）等に応じて、方法を検討すること。<br>
	    <br>
	    </td>
	  <td>?</td>
	  <td>○</td>
	  <td>FWの機能（SpringSecurity）で提供されている。<br>
	    <br>
	    詳細はTERASOLUNA Guideline参照<br>
	    5.8章 セッション管理</td>
	  <td>○</td>
	  <td>○</td>
	  <td>■</td>
	  <td>■</td>
	 </tr>
	</table>
