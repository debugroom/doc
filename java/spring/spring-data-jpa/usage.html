

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Usage &mdash; document 0.1-SNAPSHOTS documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Spring Cloud AWS" href="../spring-cloud-aws/index.html" />
    <link rel="prev" title="Introduction" href="introduction.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> document
          

          
          </a>

          
            
            
              <div class="version">
                0.1-SNAPSHOTS
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../javaee/jpa/index.html">JavaEE JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javaee/jBatch/index.html">JavaEE jBatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spring-boot/index.html">Spring Boot</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Spring Data JPA</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#section2-1-spring-data-jpa-usage-simple-access-label">シンプルなデータベースアクセス</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section2-1-1-spring-data-jpa-usage-simple-access-entity-label">エンティティクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-1-2-spring-data-jpa-usage-simple-access-repository-label">レポジトリクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-1-3-spring-data-jpa-usage-simple-access-service-label">サービスクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-1-5-spring-data-jpa-usage-simple-access-configuration-label">コンフィグレーションクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-1-6-spring-data-jpa-usage-simple-access-result-label">アプリケーション実行の結果</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section2-2-spring-data-jpa-usage-one-to-one-label">1対1関連テーブルにおけるデータ操作</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section2-2-1-spring-data-jpa-usage-one-to-one-service-label">サービスインターフェースの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-2-2-spring-data-jpa-usage-one-to-one-configuration-label">コンフィグレーションクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-2-3-spring-data-jpa-usage-one-to-one-service-impl-label">サービス実装クラスの作成</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section2-3-spring-data-jpa-usage-one-to-many-label">1対多関連テーブルにおけるデータ操作</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section2-3-1-spring-data-jpa-usage-one-to-many-service-label">サービスインターフェースの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-3-2-spring-data-jpa-usage-one-to-many-configuration-label">コンフィグレーションクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-3-3-spring-data-jpa-usage-one-to-many-service-impl-label">サービス実装クラスの作成</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section2-4-spring-data-jpa-usage-many-to-many-label">多対多関連テーブルにおけるデータ操作</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section2-4-1-spring-data-jpa-usage-many-to-many-service-label">サービスインターフェースの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-4-2-spring-data-jpa-usage-many-to-many-configuration-label">コンフィグレーションクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section2-4-3-spring-data-jpa-usage-many-to-many-service-impl-label">サービス実装クラスの作成</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../spring-cloud-aws/index.html">Spring Cloud AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spring-cloud-function/index.html">Spring Cloud Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database/cassandra/index.html">Cassandra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/aws/index.html">Amazon web service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud/kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../memo/work/index.html">work guideline</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">document</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Spring Data JPA</a> &raquo;</li>
        
      <li>Usage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/java/spring/spring-data-jpa/usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="usage">
<span id="section2-spring-data-jpa-usage-label"></span><h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<p>実際に作成したサンプルは <a class="reference external" href="https://github.com/debugroom/sample/tree/develop/sample-spring-jpa">GitHub</a> を参照のこと。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本文は執筆中につき記載が必ずしも正確でない部分が残っている事に注意。</p>
</div>
<div class="section" id="section2-1-spring-data-jpa-usage-simple-access-label">
<span id="id1"></span><h2>シンプルなデータベースアクセス<a class="headerlink" href="#section2-1-spring-data-jpa-usage-simple-access-label" title="Permalink to this headline">¶</a></h2>
<p>基本的なデータベースアクセスについて、Spring Bootのコンフィグレーションクラスの設定を踏まえて記述する。ユースケースとして以下を考える。</p>
<ul class="simple">
<li>全てのユーザを検索する。</li>
<li>全ての住所を検索する。</li>
<li>全てのメールアドレスを検索する。</li>
<li>全てのグループを検索する。</li>
<li>特定のユーザを検索する。</li>
<li>特定のユーザのアドレスを検索する。</li>
<li>特定のユーザがもつEmailアドレスを検索する。</li>
<li>指定したグループ名を元にグループを検索する。</li>
</ul>
<div class="section" id="section2-1-1-spring-data-jpa-usage-simple-access-entity-label">
<span id="id2"></span><h3>エンティティクラスの作成<a class="headerlink" href="#section2-1-1-spring-data-jpa-usage-simple-access-entity-label" title="Permalink to this headline">¶</a></h3>
<p>テーブルを表現するアノテーションを付与したエンティティクラスを作成する。JPA標準のjavax.persistenceパッケージの、代表的なアノテーションの概要は以下の通りである。</p>
<table border="1" class="colwidths-given docutils" id="id51">
<caption><span class="caption-text">javax.persistenceアノテーションの概要</span><a class="headerlink" href="#id51" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="20%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">設定</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&#64;Entity</td>
<td>クラス</td>
<td>エンティティとして表現するクラスに付与する。</td>
</tr>
<tr class="row-odd"><td>&#64;Table</td>
<td>クラス</td>
<td>エンティティとマッピングする物理テーブル名を指定する。</td>
</tr>
<tr class="row-even"><td>&#64;Embeddable</td>
<td>クラス</td>
<td>主に複合IDとして表現する組み込みクラスに付与する。</td>
</tr>
<tr class="row-odd"><td>&#64;Id</td>
<td>フィールド <br/> メソッド</td>
<td>エンティティクラスのプライマリキーのフィールドに指定する。</td>
</tr>
<tr class="row-even"><td>&#64;EmbeddedId</td>
<td>フィールド <br/> メソッド</td>
<td>エンティティクラスの複合IDプライマリーキーのフィールドに指定する。</td>
</tr>
<tr class="row-odd"><td>&#64;Column</td>
<td>フィールド <br/> メソッド</td>
<td>フィールドとデータベースのカラム名のマッピングを定義する。</td>
</tr>
<tr class="row-even"><td>&#64;JoinColumns</td>
<td>フィールド <br/> メソッド</td>
<td>&#64;JoinColumnを複数同時に記述する場合に利用する。</td>
</tr>
<tr class="row-odd"><td>&#64;JoinColumn</td>
<td>フィールド <br/> メソッド</td>
<td>結合のための外部キーカラム及び外部参照制約オプションを指定する。</td>
</tr>
<tr class="row-even"><td>&#64;PraimaryKeyJoinColums</td>
<td>フィールド <br/> メソッド</td>
<td>&#64;PrimaryKeyJoinColumnを複数同時に記述する場合に利用する。</td>
</tr>
<tr class="row-odd"><td>&#64;PraimaryKeyJoinColumn</td>
<td>フィールド <br/> メソッド</td>
<td>他のテーブルと結合する場合に、外部キーとして扱われるカラム</td>
</tr>
<tr class="row-even"><td>&#64;OneToOne</td>
<td>フィールド <br/> メソッド</td>
<td>OneToOneリレーションシップであることを示す場合に付与する。</td>
</tr>
<tr class="row-odd"><td>&#64;OneToMany</td>
<td>フィールド <br/> メソッド</td>
<td>OneToManyリレーションシップであることを示す場合に付与する。</td>
</tr>
<tr class="row-even"><td>&#64;ManyToOne</td>
<td>フィールド <br/> メソッド</td>
<td>ManyToOneリレーションシップであることを示す場合に付与する。</td>
</tr>
<tr class="row-odd"><td>&#64;AttributeOverrides</td>
<td>フィールド <br/> メソッド</td>
<td>&#64;AttributeOverrideを複数記述する場合に利用する。</td>
</tr>
<tr class="row-even"><td>&#64;AttributeOverride</td>
<td>フィールド <br/> メソッド</td>
<td>マッピング情報をオーバーライドする。</td>
</tr>
<tr class="row-odd"><td>&#64;Transient</td>
<td>フィールド <br/> メソッド</td>
<td>永続化しないエンティティクラス、マップドスーパークラス、または組み込みクラスのフィールドであることを示す。</td>
</tr>
<tr class="row-even"><td>&#64;Temporal</td>
<td>フィールド <br/> メソッド</td>
<td>時刻を示す型(java.util.Date及び、java.util.Calendar)を持つフィールドに付与する。</td>
</tr>
<tr class="row-odd"><td>&#64;GeneratedValue</td>
<td>フィールド <br/> メソッド</td>
<td>プライマリーキーカラムにユニークな値を自動生成、付与する方法を指定する。</td>
</tr>
<tr class="row-even"><td>&#64;NamedQuery</td>
<td>クラス</td>
<td>JPQLの名前付きクエリを指定する。</td>
</tr>
</tbody>
</table>
<p>ユーザエンティティを表現するUserクラスには&#64;Entityを付与し、テーブル”usr”と対応づけるために&#64;Tableアノテーションを設定する。各プロパティには&#64;Columnを付与し、テーブルカラム定義に従ってuniqueやlengthなどのオプションや、&#64;Temporalアノテーション、&#64;Transientなど設定する。Userエンティティは、1対1の関連を持つAddressエンティティ、1対Nの関連を持つEmailエンティティ、Affilicationエンティティを関連実体としてN対Nの関連を持つGroupエンティティと関連をもつ。こうした関連エンティティには各々&#64;OneToOneアノテーション、&#64;OneToManyアノテーションを付与する。</p>
<div class="literal-block-wrapper docutils container" id="id52">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.momain.model.entity.User.java</span><a class="headerlink" href="#id52" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.FetchType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.OneToMany</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.OneToOne</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Temporal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.TemporalType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.UniqueConstraint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.NamedQuery</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="s">&quot;public&quot;</span><span class="o">,</span>
    <span class="n">uniqueConstraints</span> <span class="o">=</span> <span class="nd">@UniqueConstraint</span><span class="o">(</span><span class="n">columnNames</span> <span class="o">=</span> <span class="s">&quot;login_id&quot;</span><span class="o">)</span> <span class="o">)</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;User.findAll&quot;</span><span class="o">,</span> <span class="n">query</span><span class="o">=</span><span class="s">&quot;SELECT u FROM User u&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3097005474180552877L</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;login_id&quot;</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">64</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">loginId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_name&quot;</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">ver</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">&quot;usr&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;usr&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">&quot;usr&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Timestamp</span> <span class="nf">getLastUpdatedDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastUpdatedDate</span><span class="o">(</span><span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span> <span class="o">=</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLoginId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">loginId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLoginId</span><span class="o">(</span><span class="n">String</span> <span class="n">loginId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loginId</span> <span class="o">=</span> <span class="n">loginId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">userName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getVer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">ver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAddress</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="nf">getAffiliations</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">affiliations</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAffiliations</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">affiliations</span> <span class="o">=</span> <span class="n">affiliations</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Affiliation</span> <span class="nf">addAffiliation</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getAffiliations</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">affiliation</span><span class="o">);</span>
        <span class="n">affiliation</span><span class="o">.</span><span class="na">setUsr</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">affiliation</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Affiliation</span> <span class="nf">removeAffiliation</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getAffiliations</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">affiliation</span><span class="o">);</span>
        <span class="n">affiliation</span><span class="o">.</span><span class="na">setUsr</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">affiliation</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">emails</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmails</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">emails</span> <span class="o">=</span> <span class="n">emails</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Email</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getEmails</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">email</span><span class="o">.</span><span class="na">setUsr</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Email</span> <span class="nf">removeEmail</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getEmails</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">email</span><span class="o">.</span><span class="na">setUsr</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">関連のコレクションのデータ型にjava.util.Setを使用しているのは、JPAの仕様上、エンティティのキーとなるプロパティの重複を許さないためである。</p>
</div>
<p>グループエンティティを表現するGroupクラスには&#64;Entityを付与し、テーブル”grp”と対応づけるために&#64;Tableアノテーションを設定する。各プロパティには&#64;Columnを付与し、テーブルカラム定義に従ってuniqueやlengthなどのオプションや、&#64;Temporalアノテーション、&#64;Transientなど設定する。Groupエンティティは、Affilicationエンティティを関連実体として、N対NでUserエンティティと関連をもつため、Affiliationのコレクションに&#64;OneToManyアノテーションを付与する。</p>
<div class="literal-block-wrapper docutils container" id="id53">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.Group.java</span><a class="headerlink" href="#id53" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.FetchType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.OneToMany</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.NamedQuery</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;grp&quot;</span><span class="o">)</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Group.findAll&quot;</span><span class="o">,</span> <span class="n">query</span><span class="o">=</span><span class="s">&quot;SELECT g FROM Group g&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5846174125268574714L</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;group_id&quot;</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">10</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;group_name&quot;</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">50</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">ver</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;grp&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Group</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGroupId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGroupId</span><span class="o">(</span><span class="n">String</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGroupName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">groupName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGroupName</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">groupName</span> <span class="o">=</span> <span class="n">groupName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Timestamp</span> <span class="nf">getLastUpdatedDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastUpdatedDate</span><span class="o">(</span><span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span> <span class="o">=</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getVer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">ver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="nf">getAffiliations</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">affiliations</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAffiliations</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">affiliations</span> <span class="o">=</span> <span class="n">affiliations</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Affiliation</span> <span class="nf">addAffiliation</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getAffiliations</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">affiliation</span><span class="o">);</span>
        <span class="n">affiliation</span><span class="o">.</span><span class="na">setGrp</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">affiliation</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Affiliation</span> <span class="nf">removeAffiliation</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getAffiliations</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">affiliation</span><span class="o">);</span>
        <span class="n">affiliation</span><span class="o">.</span><span class="na">setGrp</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">affiliation</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>住所エンティティを表現するAddressクラスには&#64;Entityを付与し、テーブル”address”と対応づけるために&#64;Tableアノテーションを設定する。各プロパティには&#64;Columnを付与し、テーブルカラム定義に従ってuniqueやlengthなどのオプションや、&#64;Temporalアノテーション、&#64;Transientなど設定する。Addressエンティティは、1対1でUserエンティティと関連をもつため、&#64;OneToOneアノテーション及び&#64;PrimaryKeyJoinColumnアノテーションをUserプロパティに設定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id54">
<div class="code-block-caption"><span class="caption-text">org.degugroom.sample.spring.jpa.domain.entity.Address</span><a class="headerlink" href="#id54" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.FetchType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.GeneratedValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.OneToOne</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.PrimaryKeyJoinColumn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.NamedQuery</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="s">&quot;public&quot;</span><span class="o">)</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Address.findAll&quot;</span><span class="o">,</span> <span class="n">query</span><span class="o">=</span><span class="s">&quot;SELECT a FROM Address a&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">2339974563902001678L</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">generator</span> <span class="o">=</span> <span class="s">&quot;generator&quot;</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;address&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">ver</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zip_cd&quot;</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@PrimaryKeyJoinColumn</span>
    <span class="kd">private</span> <span class="n">User</span> <span class="n">usr</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Address</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getAddress</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Timestamp</span> <span class="nf">getLastUpdatedDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastUpdatedDate</span><span class="o">(</span><span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span> <span class="o">=</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getVer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">ver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getZipCd</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">zipCd</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZipCd</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">zipCd</span> <span class="o">=</span> <span class="n">zipCd</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUsr</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">usr</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsr</span><span class="o">(</span><span class="n">User</span> <span class="n">usr</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">usr</span> <span class="o">=</span> <span class="n">usr</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>メールエンティティを表現するEmailクラスには&#64;Entityを付与し、テーブル”email”と対応づけるために&#64;Tableアノテーションを設定する。Emailでは主キーが、ユーザID及びメールIDの複合主キーとなるため、複合主キーを示すEmailPKクラスを別途作成するが、その場合、&#64;EmbeddedIdアノテーションを設定する形になる。各プロパティには&#64;Columnを付与し、テーブルカラム定義に従ってuniqueやlengthなどのオプションや、&#64;Temporalアノテーション、&#64;Transientなど設定する。Emailエンティティは、N対1でUserエンティティと関連をもつため、&#64;ManyToOne及び、&#64;JoinColumnアノテーションをUserプロパティに設定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id55">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.Email.java</span><a class="headerlink" href="#id55" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.AttributeOverride</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.AttributeOverrides</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.EmbeddedId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.FetchType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.JoinColumn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.ManyToOne</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.NamedQuery</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="s">&quot;public&quot;</span><span class="o">)</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Email.findAll&quot;</span><span class="o">,</span> <span class="n">query</span><span class="o">=</span><span class="s">&quot;SELECT e FROM Email e&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Email</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">7714950945678285107L</span><span class="o">;</span>

    <span class="nd">@EmbeddedId</span>
    <span class="nd">@AttributeOverrides</span><span class="o">({</span>
        <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;userId&quot;</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span> <span class="o">),</span>
        <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;emailId&quot;</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;email_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="o">)</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">EmailPK</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">ver</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">User</span> <span class="n">usr</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Email</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">EmailPK</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">EmailPK</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Timestamp</span> <span class="nf">getLastUpdatedDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastUpdatedDate</span><span class="o">(</span><span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span> <span class="o">=</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getVer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">ver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUsr</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">usr</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsr</span><span class="o">(</span><span class="n">User</span> <span class="n">usr</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">usr</span> <span class="o">=</span> <span class="n">usr</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Emailの複合主キークラスであるEmailPKクラスには埋め込みクラスである事を示す&#64;Embeddableアノテーションを設定する。&#64;ColumnにはEmailテーブルの複合主キーとなる、user_id及びemail_idを設定する。</p>
<div class="literal-block-wrapper docutils container" id="id56">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.EmailPK.java</span><a class="headerlink" href="#id56" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Embeddable</span><span class="o">;</span>

<span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmailPK</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3546965750394227468L</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;email_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">emailId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EmailPK</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getEmailId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">emailId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmailId</span><span class="o">(</span><span class="n">String</span> <span class="n">emailId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">emailId</span> <span class="o">=</span> <span class="n">emailId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">EmailPK</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">EmailPK</span> <span class="n">castOther</span> <span class="o">=</span> <span class="o">(</span><span class="n">EmailPK</span><span class="o">)</span><span class="n">other</span><span class="o">;</span>
        <span class="k">return</span>  <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">castOther</span><span class="o">.</span><span class="na">userId</span><span class="o">)</span>
                  <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">emailId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">castOther</span><span class="o">.</span><span class="na">emailId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">17</span><span class="o">;</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">emailId</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">equals()メソッドとhashcode()をオーバーライドしているのは、これらの主キーの値が同じ場合のみ同一のオブジェクトと見なす必要があるためである。オーバーライドしなければ、たとえ、user_id及び、emial_idがそれぞれ一致していたとしても、インスタンスが異なれば、同一と見なされない。</p>
</div>
<p>所属エンティティを表現するAffiliationクラスには&#64;Entityを付与し、テーブル”affiliation”と対応づけるために&#64;Tableアノテーションを設定する。Affiliationでは主キーが、ユーザID及びグループIDの複合主キーとなるため、複合主キーを示すAffiliationPKクラスを別途作成するが、その場合、&#64;EmbeddedIdアノテーションを設定する形になる。各プロパティには&#64;Columnを付与し、テーブルカラム定義に従ってuniqueやlengthなどのオプションや、&#64;Temporalアノテーション、&#64;Transientなど設定する。Affiliationエンティティは、ユーザ及びグループエンティティの関連実体であり、N対Nのユーザとグループの関連を各々1対１にする役割を持つ。&#64;ManyToOne及び、&#64;JoinColumnアノテーションをUser、Groupプロパティに設定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id57">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.Affiliation.java</span><a class="headerlink" href="#id57" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.AttributeOverride</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.AttributeOverrides</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.EmbeddedId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.FetchType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.JoinColumn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.ManyToOne</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.NamedQuery</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;affiliation&quot;</span><span class="o">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="s">&quot;public&quot;</span><span class="o">)</span>
<span class="nd">@NamedQuery</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Affiliation.findAll&quot;</span><span class="o">,</span> <span class="n">query</span><span class="o">=</span><span class="s">&quot;SELECT a FROM Affiliation a&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Affiliation</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">3832620537736917777L</span><span class="o">;</span>

    <span class="nd">@EmbeddedId</span>
    <span class="nd">@AttributeOverrides</span><span class="o">({</span>
        <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;groupId&quot;</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;group_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">10</span><span class="o">)</span> <span class="o">),</span>
        <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;userId&quot;</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span> <span class="o">)</span> <span class="o">})</span>
    <span class="kd">private</span> <span class="n">AffiliationPK</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">ver</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;group_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Group</span> <span class="n">grp</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">User</span> <span class="n">usr</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Affiliation</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">AffiliationPK</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">AffiliationPK</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Timestamp</span> <span class="nf">getLastUpdatedDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastUpdatedDate</span><span class="o">(</span><span class="n">Timestamp</span> <span class="n">lastUpdatedDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastUpdatedDate</span> <span class="o">=</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getVer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVer</span><span class="o">(</span><span class="n">Integer</span> <span class="n">ver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">getGrp</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">grp</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGrp</span><span class="o">(</span><span class="n">Group</span> <span class="n">grp</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">grp</span> <span class="o">=</span> <span class="n">grp</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUsr</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">usr</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsr</span><span class="o">(</span><span class="n">User</span> <span class="n">usr</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">usr</span> <span class="o">=</span> <span class="n">usr</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Affiliationの複合主キークラスであるAffiliationPKクラスには埋め込みクラスである事を示す&#64;Embeddableアノテーションを設定する。&#64;ColumnにはAffiliationテーブルの複合主キーとなる、user_id及びgroup_idを設定する。</p>
<div class="literal-block-wrapper docutils container" id="id58">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.AffiliationId.java</span><a class="headerlink" href="#id58" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Embeddable</span><span class="o">;</span>

<span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AffiliationPK</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1873418684097700980L</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;group_id&quot;</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AffiliationPK</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGroupId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGroupId</span><span class="o">(</span><span class="n">String</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">AffiliationPK</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">AffiliationPK</span> <span class="n">castOther</span> <span class="o">=</span> <span class="o">(</span><span class="n">AffiliationPK</span><span class="o">)</span><span class="n">other</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">castOther</span><span class="o">.</span><span class="na">groupId</span><span class="o">)</span>
                 <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">castOther</span><span class="o">.</span><span class="na">userId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">17</span><span class="o">;</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">groupId</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">userId</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>また、クラスパス配下にMETA-INF/を作成し、persistence.xmlを以下の通り作成し、エンティティクラスを指定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id59">
<div class="code-block-caption"><span class="caption-text">src/main/resource/META-INF/persistence.xml</span><a class="headerlink" href="#id59" title="Permalink to this code">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;persistence</span> <span class="na">version=</span><span class="s">&quot;2.1&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
                       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
              <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://xmlns.jcp.org/xml/ns/persistence</span>
<span class="s">                                  http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;sample-spring-jpa&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;provider&gt;</span>org.hibernate.ejb.HibernatePersistence<span class="nt">&lt;/provider&gt;</span>
    <span class="nt">&lt;class&gt;</span>org.debugroom.sample.spring.jpa.domain.entity.Address<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;class&gt;</span>org.debugroom.sample.spring.jpa.domain.entity.Affiliation<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;class&gt;</span>org.debugroom.sample.spring.jpa.domain.entity.Email<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;class&gt;</span>org.debugroom.sample.spring.jpa.domain.entity.Group<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;class&gt;</span>org.debugroom.sample.spring.jpa.domain.entity.User<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;class&gt;</span>org.debugroom.sample.spring.jpa.domain.entity.AffiliationPK<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;class&gt;</span>org.debugroom.sample.spring.jpa.domain.entity.EmailPK<span class="nt">&lt;/class&gt;</span>
  <span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-1-2-spring-data-jpa-usage-simple-access-repository-label">
<span id="id3"></span><h3>レポジトリクラスの作成<a class="headerlink" href="#section2-1-2-spring-data-jpa-usage-simple-access-repository-label" title="Permalink to this headline">¶</a></h3>
<p>データベースアクセスを実現するレポジトリインターフェースクラスを作成する。org.springrramework.data.jpa.repository.JpaRepositoryを継承したインターフェースクラスを作成し、型パラメータにエンティティクラス及び、プライマリキーとなる型のクラスを指定する。ユーザテーブルにアクセスしたい場合、UserRepository(名前は任意でよいが慣例的にEntityNameRepositoryとするケースが多い)というインターフェースを作成し、型パラメータに上記で作成したUserエンティティクラスと、プライマリーキーであるuser_idの型であるString型を指定する。</p>
<div class="literal-block-wrapper docutils container" id="id60">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.UserRepository.java</span><a class="headerlink" href="#id60" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">データベースアクセスの実装クラスを作成せず、インターフェースのみ作成すればよい。Spring Data JPAでは、基本的なリレーショナルデータベースへのアクセス実装を、Generic DAOパターンの形で提供しており、シンプルなデータベースへのアクセスは特に実装クラスを作成せずとも実現できる。</p>
</div>
<p>同様に、Address、Group、Emailにおいてレポジトリインターフェースを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id61">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.AddressRepository.java</span><a class="headerlink" href="#id61" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AddressRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>GroupRepositoryでは、指定したグループ名を元にグループを検索するユースケースのために、インターフェースにfindByGroupName(String groupName)メソッドを追加する。Spring Data JPAでは、インターフェースのメソッド名をキーワードを元にした命名規約により、クエリを動的に組み立てる事が可能であり、ここでは、グループ名をキーにグループを検索するfindByGroupName()メソッドを追加する。</p>
<div class="literal-block-wrapper docutils container" id="id62">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.GroupRepository.java</span><a class="headerlink" href="#id62" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GroupRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>

    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">findByGroupName</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">クエリのキーワードについては、<a class="reference external" href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-keywords">Springの公式ドキュメント Appendix C: Repository query keyword</a> を参考にすること。</p>
</div>
<p>EmailRepositoryでは、指定したユーザIDを元にそのユーザが持つメールアドレスを検索するユースケースのために、インターフェースにfindByIdUserId(String userId)を追加する。</p>
<div class="literal-block-wrapper docutils container" id="id63">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.EmailRepository.java</span><a class="headerlink" href="#id63" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.EmailPK</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmailRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">,</span> <span class="n">EmailPK</span><span class="o">&gt;{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">findByIdUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">パラメータがネストする場合は、エンティティの変数名をキャメルケースで指定する。上記のEmailの例では、EmailPKクラスの中にuserIdがあり、Emailクラスの中でEmailPKは変数名を”id”でフィールド宣言しているため、findBy以降のパラメータ部の名称は”id”と”userId”をキャメルケースでつなげた”IdUserId”となり、結局メソッドはfindByIdUserId(String userId)となる。</p>
</div>
</div>
<div class="section" id="section2-1-3-spring-data-jpa-usage-simple-access-service-label">
<span id="id4"></span><h3>サービスクラスの作成<a class="headerlink" href="#section2-1-3-spring-data-jpa-usage-simple-access-service-label" title="Permalink to this headline">¶</a></h3>
<p>ユースケースに応じて、インターフェースを作成する。</p>
<ul class="simple">
<li>全てのユーザを検索する。→ getUsers()</li>
<li>全ての住所を検索する。→ getAddressList()</li>
<li>全てのメールアドレスを検索する。→ getEmails()</li>
<li>全てのグループを検索する。→ getGroups()</li>
<li>特定のユーザを検索する。→ getUser(String userId)</li>
<li>特定のユーザのアドレスを検索する。→ getAddress(User user)</li>
<li>特定のユーザがもつEmailアドレスを検索する。→ getEmails(User user)</li>
<li>指定したグループ名を元にグループを検索する。→ getGroup(String groupName)</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id64">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.SimpleAccessService.java</span><a class="headerlink" href="#id64" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SimpleAccessService</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">getAddressList</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">getGroup</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>サービスの実装クラスでは、それぞれのユースケースを実現するためのレポジトリを各々呼び出し、結果を表示するサービスとして以下の通り実装する。</p>
<div class="literal-block-wrapper docutils container" id="id65">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.SimpleAccessServiceImpl.java</span><a class="headerlink" href="#id65" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.UserRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.AddressRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.EmailRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.GroupRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleAccessServiceImpl</span> <span class="kd">implements</span> <span class="n">SimpleAccessService</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                      <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">getAddressList</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addressList</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : addressList &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addressList</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                     <span class="o">+</span> <span class="n">address</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">address</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">addressList</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : emails &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span> <span class="o">:</span> <span class="n">emails</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                     <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">()</span>
                     <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">emails</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : groups &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span> <span class="o">:</span> <span class="n">groups</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                     <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">groups</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : userId &quot;</span> <span class="o">+</span> <span class="n">userId</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                 <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getLoginId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : address of &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                 <span class="o">+</span> <span class="n">address</span><span class="o">.</span><span class="na">getZipCd</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">address</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByIdUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : emails of userId : &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span> <span class="o">:</span> <span class="n">emails</span><span class="o">){</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                 <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">()</span>
                 <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">emails</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">getGroup</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">groupName</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Group of &quot;</span> <span class="o">+</span> <span class="n">groupName</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                 <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">group</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-1-5-spring-data-jpa-usage-simple-access-configuration-label">
<span id="id5"></span><h3>コンフィグレーションクラスの作成<a class="headerlink" href="#section2-1-5-spring-data-jpa-usage-simple-access-configuration-label" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://debugroom.github.io/doc/java/spring/springboot/usage.html#jpa">Spring Bootのサンプル</a> 同様、HSQLを使用してサービスを簡易的に実行するスタンドアロンアプリケーションを作成する。プロファイルアノテーションを使用し、開発環境向けの設定クラスは以下の通り作成する。</p>
<div class="literal-block-wrapper docutils container" id="id66">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.config.infra.DbConfigDev.java</span><a class="headerlink" href="#id66" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.config.infra</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Profile</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseType</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@Profile</span><span class="o">(</span><span class="s">&quot;dev&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DbConfigDev</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DataSource</span> <span class="nf">dataSource</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="k">new</span> <span class="n">EmbeddedDatabaseBuilder</span><span class="o">())</span>
                     <span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">EmbeddedDatabaseType</span><span class="o">.</span><span class="na">HSQL</span><span class="o">)</span>
                     <span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">&quot;classpath:ddl/sample.sql&quot;</span><span class="o">)</span>
                     <span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">&quot;classpath:ddl/data.sql&quot;</span><span class="o">)</span>
                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>デフォルトで使用するプロファイルは、devに設定しておくため、application.ymlをクラスパス配下に作成する。</p>
<div class="literal-block-wrapper docutils container" id="id67">
<div class="code-block-caption"><span class="caption-text">src/main/resources/application.yml</span><a class="headerlink" href="#id67" title="Permalink to this code">¶</a></div>
<div class="highlight-properties notranslate"><div class="highlight"><pre><span></span><span class="na">spring</span><span class="o">:</span>
<span class="na">    profiles</span><span class="o">:</span>
<span class="na">        active</span><span class="o">:</span> <span class="s">dev</span>
</pre></div>
</div>
</div>
<p>商用、開発共用となるデータベース関連設定クラスを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id68">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.config.infra.SampleAppInfra.java</span><a class="headerlink" href="#id68" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.config.infra</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.config.EnableJpaRepositories</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.orm.jpa.JpaVendorAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.EnableTransactionManagement</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableTransactionManagement</span>
<span class="nd">@EnableJpaRepositories</span><span class="o">(</span><span class="n">basePackages</span><span class="o">=</span><span class="s">&quot;org.debugroom.sample.spring.jpa.domain.repository&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleAppInfra</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">LocalContainerEntityManagerFactoryBean</span> <span class="nf">entityManagerFactory</span><span class="o">(){</span>

        <span class="n">JpaVendorAdapter</span> <span class="n">adapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HibernateJpaVendorAdapter</span><span class="o">();</span>

        <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.show_sql&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">);</span>
        <span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.format_sql&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">);</span>

        <span class="n">LocalContainerEntityManagerFactoryBean</span> <span class="n">emfb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalContainerEntityManagerFactoryBean</span><span class="o">();</span>
        <span class="n">emfb</span><span class="o">.</span><span class="na">setPackagesToScan</span><span class="o">(</span><span class="s">&quot;org.debugroom.sample.spring.jpa.domain.entity&quot;</span><span class="o">);</span>
        <span class="n">emfb</span><span class="o">.</span><span class="na">setJpaProperties</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
        <span class="n">emfb</span><span class="o">.</span><span class="na">setJpaVendorAdapter</span><span class="o">(</span><span class="n">adapter</span><span class="o">);</span>
        <span class="n">emfb</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">emfb</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>アプリケーションの設定、実行を行うコンフィグレーションクラスを作成する。&#64;ComponentScanで上記のSampleAppInfra設定クラスを詠み込むようパッケージを指定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id69">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.config.SampleApp.java</span><a class="headerlink" href="#id69" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ComponentScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.ConfigurableApplicationContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.SimpleAccessService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.SimpleAccessServiceImpl</span><span class="o">;</span>

<span class="nd">@ComponentScan</span><span class="o">(</span><span class="s">&quot;org.debugroom.sample.spring.jpa.config.infra&quot;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleApp</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span>
                                                        <span class="n">SampleApp</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">web</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>

        <span class="n">SimpleAccessService</span> <span class="n">simpleAccessService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">SimpleAccessService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getUsers</span><span class="o">();</span>
        <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getAddressList</span><span class="o">();</span>
        <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getEmails</span><span class="o">();</span>
        <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getGroups</span><span class="o">();</span>
        <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getEmails</span><span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">simpleAccessService</span><span class="o">.</span><span class="na">getGroup</span><span class="o">(</span><span class="s">&quot;org.debugroom&quot;</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="nd">@Bean</span> <span class="n">SimpleAccessService</span> <span class="nf">sampleService</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">SimpleAccessServiceImpl</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-1-6-spring-data-jpa-usage-simple-access-result-label">
<span id="id6"></span><h3>アプリケーション実行の結果<a class="headerlink" href="#section2-1-6-spring-data-jpa-usage-simple-access-result-label" title="Permalink to this headline">¶</a></h3>
<div class="section" id="section2-1-6-1-spring-data-jpa-usage-simple-access-get-users-label">
<span id="id7"></span><h4>全てのユーザを検索する。<a class="headerlink" href="#section2-1-6-1-spring-data-jpa-usage-simple-access-get-users-label" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getUsers()実行の結果、userRepository.findAll()が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_</span>
 <span class="k">from</span>
     <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>

<span class="k">select</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
 <span class="k">from</span>
     <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
 <span class="k">where</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

 <span class="k">select</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
 <span class="k">from</span>
     <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
 <span class="k">where</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

 <span class="k">select</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
 <span class="k">from</span>
     <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
 <span class="k">where</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記でAddressテーブル側にもSQLが複数発行されている(N+1)。OneToOneアノテーションが付与されたAddressオブジェクトにデフォルトでFetchType.Eagerが設定されているためである。Addressオブジェクトを使用しない場合は、不要なSQLの発行を避けるために、optional=false、fetch=FetchType.Lazyを指定する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OneToOneの関連でメインとなるデータを更新・削除した際、関連先のデータを更新・削除する場合は、cascade属性を変更する。</p>
</div>
<div class="literal-block-wrapper docutils container" id="id70">
<div class="code-block-caption"><span class="caption-text">&#64;OneToOneアノテーションの設定例</span><a class="headerlink" href="#id70" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span><span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span>
          <span class="n">cascade</span><span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-1-6-2-spring-data-jpa-usage-simple-access-get-addresslist-label">
<span id="id8"></span><h4>全ての住所を検索する。<a class="headerlink" href="#section2-1-6-2-spring-data-jpa-usage-simple-access-get-addresslist-label" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getAddressList()実行の結果、addressRepository.findAll()が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_</span><span class="p">,</span>
     <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_</span>
 <span class="k">from</span>
     <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-1-6-3-spring-data-jpa-usage-simple-access-get-emails-label">
<span id="id9"></span><h4>全てのメールアドレスを検索する。<a class="headerlink" href="#section2-1-6-3-spring-data-jpa-usage-simple-access-get-emails-label" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getEmails()実行の結果、emailRepository.findAll()が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">email0_</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-1-6-4-spring-data-jpa-usage-simple-access-get-groups-label">
<span id="id10"></span><h4>全てのグループを検索する。<a class="headerlink" href="#section2-1-6-4-spring-data-jpa-usage-simple-access-get-groups-label" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getGroups()実行の結果、groupRepository.findAll()が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span> <span class="k">as</span> <span class="n">group_na2_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_4_</span>
<span class="k">from</span>
    <span class="n">grp</span> <span class="n">group0_</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-1-6-5-spring-data-jpa-usage-simple-access-get-user-label">
<span id="id11"></span><h4>特定のユーザを検索する。<a class="headerlink" href="#section2-1-6-5-spring-data-jpa-usage-simple-access-get-user-label" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getUser(String userId)実行の結果、userRepository.findOne(String userId)が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-1-6-6-spring-data-jpa-usage-simple-access-get-address-label">
<span id="id12"></span><h4>特定のユーザのアドレスを検索する。<a class="headerlink" href="#section2-1-6-6-spring-data-jpa-usage-simple-access-get-address-label" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getAddress(User user)実行の結果、addressRepository.findOne(String userId)が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
<span class="k">where</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="email">
<span id="section2-1-6-7-spring-data-jpa-usage-simple-access-get-emails-label"></span><h4>特定のユーザがもつEmailアドレスを検索する。<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getEmails(User user)実行の結果、emailRepository.findByIdUserId(String userId)が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">email0_</span>
<span class="k">where</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-1-6-8-spring-data-jpa-usage-simple-access-get-group-label">
<span id="id13"></span><h4>指定したグループ名を元にグループを検索する。<a class="headerlink" href="#section2-1-6-8-spring-data-jpa-usage-simple-access-get-group-label" title="Permalink to this headline">¶</a></h4>
<p>simpleAccessService.getGroup(String groupName)実行の結果、groupRepository.findByGroupName(String groupName)が呼ばれ、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span> <span class="k">as</span> <span class="n">group_na2_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_4_</span>
<span class="k">from</span>
    <span class="n">grp</span> <span class="n">group0_</span>
<span class="k">where</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span><span class="o">=?</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="section2-2-spring-data-jpa-usage-one-to-one-label">
<span id="id14"></span><h2>1対1関連テーブルにおけるデータ操作<a class="headerlink" href="#section2-2-spring-data-jpa-usage-one-to-one-label" title="Permalink to this headline">¶</a></h2>
<p>1対1の関連テーブル(本サンプルでは、ユーザと住所)のデータ操作に関して以下のようなユースケースを考える。</p>
<ul class="simple">
<li>指定されたユーザの住所を取得する。</li>
<li>特定の郵便番号を持つユーザ一覧を取得する。</li>
<li>特定の郵便番号を持たないユーザ一覧を取得する</li>
<li>指定されたユーザの住所を追加する。</li>
<li>指定されたユーザの住所を更新する。</li>
<li>指定されたユーザの住所を削除する。</li>
<li>指定されたユーザの情報を住所を含めて削除する。</li>
</ul>
<p>基本的には、<a class="reference internal" href="#section2-1-spring-data-jpa-usage-simple-access-label"><span class="std std-ref">前章、シンプルなデータアクセス</span></a> で作成したエンティティクラス、及びレポジトリクラスはそのまま流用する。</p>
<div class="section" id="section2-2-1-spring-data-jpa-usage-one-to-one-service-label">
<span id="id15"></span><h3>サービスインターフェースの作成<a class="headerlink" href="#section2-2-1-spring-data-jpa-usage-one-to-one-service-label" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>指定されたユーザの住所を取得する。→ getAddress(User user)</li>
<li>特定の郵便番号を持つユーザ一覧を取得する。→ getUsersWith(String zipCd)</li>
<li>特定の郵便番号を持たないユーザ一覧を取得する → getUsersWithout(String zipCd)</li>
<li>指定されたユーザの住所を追加する。 → addAddress(Address address)</li>
<li>指定されたユーザの住所を更新する。 → updateAddress(String userId, Address address)</li>
<li>指定されたユーザの住所を削除する。 → deleteAddress(String userId)</li>
<li>指定されたユーザの情報を住所を含めて削除する。 → deleteUser(String userId)</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id71">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleService.java</span><a class="headerlink" href="#id71" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OneToOneSampleService</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWith</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWithout</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Address</span> <span class="n">address</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-2-2-spring-data-jpa-usage-one-to-one-configuration-label">
<span id="id16"></span><h3>コンフィグレーションクラスの作成<a class="headerlink" href="#section2-2-2-spring-data-jpa-usage-one-to-one-configuration-label" title="Permalink to this headline">¶</a></h3>
<p>データベースの環境の設定は、<a class="reference internal" href="#section2-1-5-spring-data-jpa-usage-simple-access-configuration-label"><span class="std std-ref">前章 シンプルなデータアクセス時の設定</span></a> を流用し、サービスを実行する設定ファイルクラスを新規作成する。</p>
<div class="literal-block-wrapper docutils container" id="id72">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.config.OneToOneSampleApp.java</span><a class="headerlink" href="#id72" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ComponentScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ConfigurableApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl</span><span class="o">;</span>

<span class="nd">@ComponentScan</span><span class="o">(</span><span class="s">&quot;org.debugroom.sample.spring.jpa.config.infra&quot;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OneToOneSampleApp</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span>
                                                      <span class="n">OneToOneSampleApp</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">web</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>

        <span class="n">OneToOneSampleService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">OneToOneSampleService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">zipCd</span> <span class="o">=</span> <span class="s">&quot;135-8670&quot;</span><span class="o">;</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getUsersWith</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getUsersWithout</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">addAddress</span><span class="o">(</span>
        <span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">zipCd</span><span class="o">(</span><span class="s">&quot;000-0000&quot;</span><span class="o">).</span><span class="na">address</span><span class="o">(</span><span class="s">&quot;Tokyo&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">updateAddress</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span>
        <span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">zipCd</span><span class="o">(</span><span class="s">&quot;100-1000&quot;</span><span class="o">).</span><span class="na">address</span><span class="o">(</span><span class="s">&quot;Japan&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteAddress</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
<span class="c1">//      service.deleteUser(user.getUserId());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteUser</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span> <span class="n">OneToOneSampleService</span> <span class="nf">oneToOneSampleService</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OneToOneSampleServiceImpl</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-2-3-spring-data-jpa-usage-one-to-one-service-impl-label">
<span id="id17"></span><h3>サービス実装クラスの作成<a class="headerlink" href="#section2-2-3-spring-data-jpa-usage-one-to-one-service-impl-label" title="Permalink to this headline">¶</a></h3>
<p>上記で定義したサービスインターフェースを実装した結果を以下に示す。</p>
<div class="literal-block-wrapper docutils container" id="id73">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl</span><a class="headerlink" href="#id73" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.transaction.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.AddressRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.UserRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUsersByNotZipCd</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUsersByZipCd</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OneToOneSampleServiceImpl</span> <span class="kd">implements</span> <span class="n">OneToOneSampleService</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : address of &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">address</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                      <span class="o">+</span> <span class="n">address</span><span class="o">.</span><span class="na">getZipCd</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">address</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {null, null}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">address</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWith</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">FindUsersByZipCd</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                     <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users with zipCd &quot;</span> <span class="o">+</span> <span class="n">zipCd</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getZipCd</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWithout</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">FindUsersByNotZipCd</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                     <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users without zipCd &quot;</span> <span class="o">+</span> <span class="n">zipCd</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getZipCd</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">count</span><span class="o">())</span>
                                  <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">newUserId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                                       <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">address</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                               <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="s">&quot;NewUser(・∀・)b&quot;</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">loginId</span><span class="o">(</span><span class="s">&quot;loginId&quot;</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>
        <span class="n">newUser</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">newUser</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())){</span>
                <span class="n">Address</span> <span class="n">newAddress</span> <span class="o">=</span> <span class="n">newUser</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;  Add Address - {&quot;</span>
                           <span class="o">+</span> <span class="n">newAddress</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">newAddress</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">newUser</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">updateAddress</span> <span class="o">=</span> <span class="n">getAddress</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setZipCd</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getZipCd</span><span class="o">());</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
<span class="c1">//      user.setAddress(null);</span>
<span class="c1">//      userRepository.save(user);</span>
<span class="c1">//      addressRepository.delete(user.getAddress());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">deleteUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteUser</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>以降、実装したサービスクラスの実装の詳細をユースケースごとに記述する。</p>
<div class="section" id="section2-2-3-1-spring-data-jpa-usage-one-to-one-get-address-label">
<span id="id18"></span><h4>指定されたユーザの住所を取得する。<a class="headerlink" href="#section2-2-3-1-spring-data-jpa-usage-one-to-one-get-address-label" title="Permalink to this headline">¶</a></h4>
<p>oneToOneSampleService.getAddress(User user)実行の結果、addressRepository.findOne(String userId)が呼ばれ、以下のようなSQLが発行される。基本的にシンプルなデータベースアクセスにおけるプライマリキー指定時の呼び出しと同じである。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
<span class="k">where</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-2-3-2-spring-data-jpa-usage-one-to-one-get-users-with-label">
<span id="id19"></span><h4>特定の郵便番号を持つユーザ一覧を取得する。<a class="headerlink" href="#section2-2-3-2-spring-data-jpa-usage-one-to-one-get-users-with-label" title="Permalink to this headline">¶</a></h4>
<p>oneToOneSampleService.getUsersWith(String zipCd)に実装しているが、住所テーブルの郵便番号を指定し、指定した郵便番号と一致した住所テーブルのデータのプライマリキーであるユーザIDを使って、ユーザテーブルと結合して、一致するユーザの一覧を取得する。
JPAと同じく、テーブル結合する場合、Criteria API、JPQL、Native SQLいずれでも可能だが、ここでは、CriteriaAPIを使用して、データ取得する場合を記述する。Spring Data JPAでCriteria APIを使ってテーブル結合するには、以下の通り、結合条件に該当するorg.springframework.data.jpa.domain.Specificationクラスを継承した条件クラスを作成し、toPredicate()メソッドをオーバーライドして、結合条件を指定したPredicateクラスを戻り値で返却する。</p>
<div class="literal-block-wrapper docutils container" id="id74">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUsersByZipCd.java</span><a class="headerlink" href="#id74" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Predicate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Root</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Join</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.domain.Specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User_</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FindUsersByZipCd</span> <span class="kd">implements</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                   <span class="n">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Predicate</span><span class="o">&gt;</span> <span class="n">predicates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Predicate</span><span class="o">&gt;();</span>

        <span class="n">Join</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">&gt;</span> <span class="n">joinAddress</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">address</span><span class="o">);</span>
        <span class="n">predicates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">joinAddress</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Address_</span><span class="o">.</span><span class="na">zipCd</span><span class="o">),</span> <span class="n">zipCd</span><span class="o">));</span>

        <span class="k">return</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">predicates</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Predicate</span><span class="o">[]{}));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>まず、最終的にデータ取得するエンティティ(ここでは、ユーザの一覧)のRoot&lt;User&gt;クラスを起点として、結合する２つのテーブルに相当するエンティティクラスを型パラメータにもつJoinクラスをjoinメソッドを通じて作成する。join()メソッドの引数には結合する際に使用するキーを <a class="reference external" href="http://docs.jboss.org/hibernate/jpamodelgen/1.0/reference/en-US/html_single/#d0e72">エンティティのメタモデルクラス</a> で指定する。上記の例では、ユーザテーブルと、アドレステーブルを結合するキーのメタモデルクラスとして、User＿.addressを引数に指定指定している。メタモデルクラスの実装は以下の通りである。</p>
<div class="literal-block-wrapper docutils container" id="id75">
<div class="code-block-caption"><span class="caption-text"><cite>org.debugroom.sample.spring.jpa.domain.entity.User_.java</cite></span><a class="headerlink" href="#id75" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.metamodel.SetAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.metamodel.SingularAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.metamodel.StaticMetamodel</span><span class="o">;</span>

<span class="nd">@StaticMetamodel</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User_</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Timestamp</span><span class="o">&gt;</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">loginId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">userName</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ver</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">&gt;</span> <span class="n">address</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SetAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SetAttribute</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Joinクラスの中で、指定したzipCdとイコールとなる条件をjava.persistence.criteria.Predicateのリストに追加し、最終的にCriteriaBuilderで一つのPredicateクラスとして返却する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記のメタモデルクラスはIDEのオプションで自動生成できる。以下はEclipseで作成したエンティティクラスに対して、自動的にメタモデルを作成するためのオプションの指定する画面である。JPAプロジェクト化してあるプロジェクトの設定画面を開き、JPAメニューの”正規メタモデル”を出力するソースコードを指定する。</p>
<div class="last figure">
<a class="reference internal image-reference" href="../../../_images/eclipse-metamodel-generation-setting.png"><img alt="../../../_images/eclipse-metamodel-generation-setting.png" src="../../../_images/eclipse-metamodel-generation-setting.png" style="width: 778.0px; height: 763.0px;" /></a>
</div>
</div>
<p>上述して作成したSpecificationクラスを利用するにはレポジトリクラスに、追加で、org.springframework.data.jpa.repository.JpaSpecificationExecutorを継承する必要がある。継承する事で、上記のSpecificationクラスを引数にとるfindAll()メソッドがレポジトリから使用可能になる。</p>
<div class="literal-block-wrapper docutils container" id="id76">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.UserRepository.javaに更にJpaSpecificationを継承</span><a class="headerlink" href="#id76" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaSpecificationExecutor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;,</span>
                                          <span class="n">JpaSpecificationExecutor</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>実際にサービスから、郵便番号をパラメータとして、上記のSpecificationクラスを生成し、レポジトリの引数に渡して実行すれば以下のようなテーブル結合したSQLが発行される。</p>
<div class="literal-block-wrapper docutils container" id="id77">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl#getUsersWith(String zipCode)</span><a class="headerlink" href="#id77" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWith</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
                <span class="n">FindUsersByZipCd</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記はSpecificationクラスはLombokのBuilderを利用してインスタンス生成している。</p>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">inner</span> <span class="k">join</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address1_</span>
    <span class="k">on</span> <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="n">address1_</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">where</span>
    <span class="n">address1_</span><span class="p">.</span><span class="n">zip_cd</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://docs.spring.io/spring-data/jpa/docs/1.10.4.RELEASE/reference/html/#specifications">Spring Dataの公式ドキュメント 5.5 Specification</a> もあわせて参照すること。</p>
</div>
</div>
<div class="section" id="section2-2-3-3-spring-data-jpa-usage-one-to-one-get-users-without-label">
<span id="id21"></span><h4>特定の郵便番号を持たないユーザ一覧を取得する<a class="headerlink" href="#section2-2-3-3-spring-data-jpa-usage-one-to-one-get-users-without-label" title="Permalink to this headline">¶</a></h4>
<p>oneToOneSampleService.getUsersWithout(String zipCd)に実装しているが、基本的には、前述のユースケース「特定の郵便番号を持つユーザ一覧を取得する」と実装する内容はほぼ同じである。唯一の違いは、結合条件を指定するクラスの実装で、副問い合わせ使用して、住所テーブルの郵便番号を指定し、指定した郵便番号と一致した住所テーブルのデータのプライマリキーであるユーザIDを使って、ユーザテーブルと結合して、一致するユーザの一覧を取得する。その結果を元にそれに該当しないユーザをNotInを用いてユーザテーブルから抽出するクエリの条件クラスを作成する形である。</p>
<div class="literal-block-wrapper docutils container" id="id78">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUsersByNotZipCd</span><a class="headerlink" href="#id78" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Predicate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Root</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Subquery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Join</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Path</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.domain.Specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FindUsersByNotZipCd</span> <span class="kd">implements</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
        <span class="n">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Path</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">path</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;userId&quot;</span><span class="o">);</span>
        <span class="n">Subquery</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">subQuery</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">().</span><span class="na">subquery</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">subQueryRoot</span> <span class="o">=</span> <span class="n">subQuery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">&gt;</span> <span class="n">subQueryJoinAddress</span> <span class="o">=</span> <span class="n">subQueryRoot</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">address</span><span class="o">);</span>
        <span class="n">Predicate</span> <span class="n">subQueryPredicate</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span>
                                          <span class="n">subQueryJoinAddress</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Address_</span><span class="o">.</span><span class="na">zipCd</span><span class="o">),</span> <span class="n">zipCd</span><span class="o">);</span>
        <span class="n">subQuery</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">subQueryRoot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;userId&quot;</span><span class="o">));</span>
        <span class="n">subQuery</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">subQueryPredicate</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">not</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="n">subQuery</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記の検索条件クラスは、サブクエリとして、起点となるUserテーブルのRootから、AddressテーブルへJoinするクラスを作成し、結合するキーとなるクラスを同じくエンティティメタモデルクラスで指定する(User＿.address)。また、アドレステーブルのzip_cdと指定したzipCdが一致する条件をCriteriaBuilderを通じて作成し、サブクエリの条件に加える。サブクエリでは、郵便番号が一致したユーザのuserIdを抽出する形として、それをメインのクエリのNotInの条件として構成する。結局、こうして組み立てた条件クラスの実行及び、発行されるSQLは以下の通りとなる。</p>
<div class="literal-block-wrapper docutils container" id="id79">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl#getUsersWithout(String zipCode)</span><a class="headerlink" href="#id79" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span> <span class="c1">//omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWithout</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">FindUsersByNotZipCd</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="c1">//omit</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">not</span> <span class="k">in</span>  <span class="p">(</span>
        <span class="k">select</span>
            <span class="n">user1_</span><span class="p">.</span><span class="n">user_id</span>
        <span class="k">from</span>
            <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user1_</span>
        <span class="k">inner</span> <span class="k">join</span>
            <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address2_</span>
                <span class="k">on</span> <span class="n">user1_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="n">address2_</span><span class="p">.</span><span class="n">user_id</span>
        <span class="k">where</span>
            <span class="n">address2_</span><span class="p">.</span><span class="n">zip_cd</span><span class="o">=?</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-2-3-4-spring-data-jpa-usage-one-to-one-add-address-label">
<span id="id22"></span><h4>指定されたユーザの住所を追加する。<a class="headerlink" href="#section2-2-3-4-spring-data-jpa-usage-one-to-one-add-address-label" title="Permalink to this headline">¶</a></h4>
<p>oneToOneSampleService.addAddress(Address address)に実装しているが、後述するAddressデータの更新や削除、ユーザの削除のためにサービスの中で新規ユーザデータを作成し、住所データを追加する実装を記述した。実際にアドレスを追加する基本的にはやり方としては、エンティティクラスを作成して、レポジトリクラスのsave()メソッドの引数として渡してしまえば完結するが、OneToOneの関連では、同じユーザIDを、Userテーブルと、Addressテーブルで主キーとして利用する以上、先にユーザデータを登録してからアドレスデータを追加する必要がある。通常、JPAにはカスケード属性があり、メインとなるエンティティ(ここではUser)に住所のエンティティクラスをプロパティにセットして、UserRepoisotry#save()メソッドだけ実行すれば十分なはずであるが、先に住所データを作成しにいく挙動をとったため、一気にやろうとすると、異常終了した(コメントアウト)。</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">OneToOne関連のデータ登録の再検証が必要。Spring Dataを使用せず、純粋なJPAのAPIを用いてOneToOne関連のデータ登録を実行した場合の結果を含めて確認する。</p>
</div>
<div class="literal-block-wrapper docutils container" id="id80">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl#addAddress(Address address)</span><a class="headerlink" href="#id80" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// omit</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">count</span><span class="o">())</span>
                                <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">newUserId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                                <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">address</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                             <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">)</span>
                             <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="s">&quot;NewUser(・∀・)b&quot;</span><span class="o">)</span>
<span class="c1">//                           .address(address)</span>
                             <span class="o">.</span><span class="na">loginId</span><span class="o">(</span><span class="s">&quot;loginId&quot;</span><span class="o">)</span>
                             <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>
        <span class="n">newUser</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">newUser</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())){</span>
                <span class="n">Address</span> <span class="n">newAddress</span> <span class="o">=</span> <span class="n">newUser</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;  Add Address - {&quot;</span>
                           <span class="o">+</span> <span class="n">newAddress</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">newAddress</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">newUser</span><span class="o">;</span>
   <span class="o">}</span>
</pre></div>
</div>
</div>
<p>以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">insert</span>
    <span class="k">into</span>
        <span class="k">public</span><span class="p">.</span><span class="n">usr</span>
        <span class="p">(</span><span class="n">last_updated_date</span><span class="p">,</span> <span class="n">login_id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">values</span>
         <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>
<span class="k">insert</span>
    <span class="k">into</span>
        <span class="k">public</span><span class="p">.</span><span class="n">address</span>
        <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">last_updated_date</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">zip_cd</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">values</span>
        <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-2-3-5-spring-data-jpa-usage-one-to-one-update-address-label">
<span id="id23"></span><h4>指定されたユーザの住所を更新する。<a class="headerlink" href="#section2-2-3-5-spring-data-jpa-usage-one-to-one-update-address-label" title="Permalink to this headline">¶</a></h4>
<p>oneToOneSampleService.updateAddress(String userId, Address address)に実装している。基本的なデータ更新のやり方としては、更新対象のエンティティクラスを取得して、値を更新するのみで良い。トランザクション境界をまたぐと自動的にupdate文が発行される。</p>
<div class="literal-block-wrapper docutils container" id="id81">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl#updateAddress(String userId, Address address)</span><a class="headerlink" href="#id81" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// omit</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">updateAddress</span> <span class="o">=</span> <span class="n">getAddress</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setZipCd</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getZipCd</span><span class="o">());</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span>
<span class="k">set</span>
    <span class="n">address</span><span class="o">=?</span><span class="p">,</span>
    <span class="n">last_updated_date</span><span class="o">=?</span><span class="p">,</span>
    <span class="n">ver</span><span class="o">=?</span><span class="p">,</span>
    <span class="n">zip_cd</span><span class="o">=?</span>
<span class="k">where</span>
    <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">パラメータを更新しただけでUPDATE文が発行される理由については、<a class="reference external" href="http://terasolunaorg.github.io/guideline/5.2.0.RELEASE/ja/ArchitectureInDetail/DataAccessDetail/DataAccessJpa.html#entity">エンティティのライフサイクル管理</a> を十分理解しておく必要がある。</p>
</div>
</div>
<div class="section" id="section2-2-3-6-spring-data-jpa-usage-one-to-one-delete-address-label">
<span id="id25"></span><h4>指定されたユーザの住所を削除する。<a class="headerlink" href="#section2-2-3-6-spring-data-jpa-usage-one-to-one-delete-address-label" title="Permalink to this headline">¶</a></h4>
<p>oneToOneSampleService.deleteAddress(String userId)に実装している。基本的なデータ削除のやり方としては、AddressRepository.delete()メソッドでエンティティを指定すればよい。</p>
<div class="literal-block-wrapper docutils container" id="id82">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl#deleteAddress(String userId)</span><a class="headerlink" href="#id82" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// omit</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
<span class="c1">//    user.setAddress(null);</span>
<span class="c1">//    userRepository.save(user);</span>
<span class="c1">//    addressRepository.delete(user.getAddress());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">delete</span>
    <span class="k">from</span>
        <span class="k">public</span><span class="p">.</span><span class="n">address</span>
    <span class="k">where</span>
        <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">Userのaddressプロパティを明示的にnullにすれば、データ削除されるはずではあるが、特に更新はされず。&#64;OneToOneアノテーションに関連する理由か検証は必要。</p>
</div>
</div>
<div class="section" id="section2-2-3-7-spring-data-jpa-usage-one-to-one-delete-user-label">
<span id="id26"></span><h4>指定されたユーザの情報を住所を含めて削除する。<a class="headerlink" href="#section2-2-3-7-spring-data-jpa-usage-one-to-one-delete-user-label" title="Permalink to this headline">¶</a></h4>
<p>oneToOneSampleService.deleteUser(String userId)に実装している。基本的なデータ削除のやり方としては、UserRepository.delete()メソッドでエンティティを指定すればよい。</p>
<div class="literal-block-wrapper docutils container" id="id83">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToOneSampleServiceImpl#deleteUser(String userId)</span><a class="headerlink" href="#id83" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">//omit</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">deleteUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteUser</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users &quot;</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;            - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>ただし、ユーザデータのように住所以外にもEmailやAffiliationなど事前にデータが残っていると削除処理で異常終了する。まとめて削除するにはエンティティの関連アノテーションのカスケード属性を設定しておく必要がある。</p>
<div class="literal-block-wrapper docutils container" id="id84">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.User</span><a class="headerlink" href="#id84" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">//omit</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span><span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span>
              <span class="n">cascade</span><span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">cascade</span><span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">cascade</span><span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">;</span>

<span class="c1">//omit</span>
</pre></div>
</div>
</div>
<p>発行されるSQLは以下の通りである。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">delete</span>
    <span class="k">from</span>
        <span class="k">public</span><span class="p">.</span><span class="n">address</span>
    <span class="k">where</span>
        <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span>
    <span class="k">from</span>
        <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span>
    <span class="k">where</span>
        <span class="n">group_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span>
   <span class="k">from</span>
       <span class="k">public</span><span class="p">.</span><span class="n">email</span>
   <span class="k">where</span>
       <span class="n">email_id</span><span class="o">=?</span>
   <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span>
   <span class="k">from</span>
       <span class="k">public</span><span class="p">.</span><span class="n">email</span>
   <span class="k">where</span>
       <span class="n">email_id</span><span class="o">=?</span>
   <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span>
  <span class="k">from</span>
       <span class="k">public</span><span class="p">.</span><span class="n">usr</span>
  <span class="k">where</span>
       <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">Userのaddressプロパティの&#64;OneToOneアノテーションのcascade属性をALLにしていても、データ削除されるはずではあるが、特に更新はされず。&#64;OneToOneアノテーションに関連する理由か検証は必要。</p>
</div>
</div>
</div>
</div>
<div class="section" id="section2-3-spring-data-jpa-usage-one-to-many-label">
<span id="id27"></span><h2>1対多関連テーブルにおけるデータ操作<a class="headerlink" href="#section2-3-spring-data-jpa-usage-one-to-many-label" title="Permalink to this headline">¶</a></h2>
<p>1対多の関連テーブル(本サンプルでは、ユーザとEmail)のデータ操作に関して以下のようなユースケースを考える。</p>
<ul class="simple">
<li>指定されたユーザのEmailの一覧を取得する。</li>
<li>特定のメールアドレスを持つユーザを検索する。</li>
<li>指定されたユーザのメールアドレスを追加する。</li>
<li>指定されたユーザをメールアドレスを含めて追加する。</li>
<li>指定されたユーザのメールアドレスを更新する。</li>
<li>指定されたユーザのメールアドレスを1件削除する。</li>
<li>指定されたユーザのメールアドレスを全件削除する。</li>
<li>指定されたユーザの情報をメールアドレスを含めて削除する。</li>
</ul>
<p>基本的には、<a class="reference internal" href="#section2-1-spring-data-jpa-usage-simple-access-label"><span class="std std-ref">前章、シンプルなデータアクセス</span></a> で作成したエンティティクラス、及びレポジトリクラスはそのまま流用する。</p>
<div class="section" id="section2-3-1-spring-data-jpa-usage-one-to-many-service-label">
<span id="id28"></span><h3>サービスインターフェースの作成<a class="headerlink" href="#section2-3-1-spring-data-jpa-usage-one-to-many-service-label" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>指定されたユーザのEmailの一覧を取得する。 → getEmails(User user)</li>
<li>特定のメールアドレスを持つユーザを検索する。 → getUser(String email)</li>
<li>指定されたユーザのメールアドレスを追加する。 → addEmail(User user, String email)</li>
<li>指定されたユーザをメールアドレスを含めて追加する。 → addUser(User user, String email)</li>
<li>指定されたユーザのメールアドレスを更新する。 → updateEmail(User user, String email)</li>
<li>指定されたユーザのメールアドレスを1件削除する。 → deleteEmail(User user, String email)</li>
<li>指定されたユーザのメールアドレスを全件削除する。 → deleteEmails(User user)</li>
<li>指定されたユーザの情報をメールアドレスを含めて削除する。 → deleteUser(User user)</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id85">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleService.java</span><a class="headerlink" href="#id85" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OneToManySampleService</span> <span class="o">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-3-2-spring-data-jpa-usage-one-to-many-configuration-label">
<span id="id29"></span><h3>コンフィグレーションクラスの作成<a class="headerlink" href="#section2-3-2-spring-data-jpa-usage-one-to-many-configuration-label" title="Permalink to this headline">¶</a></h3>
<p>データベースの環境の設定は、<a class="reference internal" href="#section2-1-5-spring-data-jpa-usage-simple-access-configuration-label"><span class="std std-ref">前章 シンプルなデータアクセス時の設定</span></a> を流用し、サービスを実行する設定ファイルクラスを新規作成する。</p>
<div class="literal-block-wrapper docutils container" id="id86">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.config.OneToManySampleApp.java</span><a class="headerlink" href="#id86" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ComponentScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ConfigurableApplicationContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.EmailPK</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl</span><span class="o">;</span>

<span class="nd">@ComponentScan</span><span class="o">(</span><span class="s">&quot;org.debugroom.sample.spring.jpa.config.infra&quot;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OneToManySampleApp</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span>
                                                      <span class="n">OneToManySampleApp</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">web</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>

        <span class="n">OneToManySampleService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">OneToManySampleService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">email</span> <span class="o">=</span> <span class="s">&quot;test@test.com&quot;</span><span class="o">;</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getEmails</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">addEmail</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="s">&quot;(ΦωΦ)@test.com&quot;</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">addEmail</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="s">&quot;(ΦωΦ)@test.co.jp&quot;</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getEmails</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">addUser</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                           <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="s">&quot;(ΦωΦ)&quot;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">emails</span><span class="o">(</span><span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;())</span>
                                           <span class="o">.</span><span class="na">build</span><span class="o">(),</span> <span class="n">email</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getEmails</span><span class="o">(</span><span class="n">addUser</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">updateEmail</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                       <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">EmailPK</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">).</span><span class="na">emailId</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">())</span>
                                       <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">&quot;(・∀・)@test.com&quot;</span><span class="o">)</span>
                                       <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getEmails</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteEmail</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                       <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">EmailPK</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">).</span><span class="na">emailId</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">())</span>
                                       <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">&quot;(・∀・)@test.com&quot;</span><span class="o">)</span>
                                       <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getEmails</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteEmails</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getEmails</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteUser</span><span class="o">(</span><span class="n">addUser</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span> <span class="n">OneToManySampleService</span> <span class="nf">oneToManySampleService</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">OneToManySampleServiceImpl</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-3-3-spring-data-jpa-usage-one-to-many-service-impl-label">
<span id="id30"></span><h3>サービス実装クラスの作成<a class="headerlink" href="#section2-3-3-spring-data-jpa-usage-one-to-many-service-impl-label" title="Permalink to this headline">¶</a></h3>
<p>上記で定義したサービスインターフェースを実装した結果を以下に示す。</p>
<div class="literal-block-wrapper docutils container" id="id87">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl.java</span><a class="headerlink" href="#id87" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.transaction.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.EmailPK</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.AddressRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.EmailRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.UserRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OneToManySampleServiceImpl</span> <span class="kd">implements</span> <span class="n">OneToManySampleService</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : emails of &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span> <span class="o">:</span> <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;           - {&quot;</span>
                       <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">findEmail</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">findEmail</span><span class="o">.</span><span class="na">getUsr</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                                 <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">size</span><span class="o">())</span>
                                 <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">newEmailId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
        <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">Email</span> <span class="n">newEmail</span> <span class="o">=</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                              <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">EmailPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                         <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">findUser</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())</span>
                                         <span class="o">.</span><span class="na">emailId</span><span class="o">(</span><span class="n">newEmailId</span><span class="o">)</span>
                                         <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                              <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">findUser</span><span class="o">.</span><span class="na">addEmail</span><span class="o">(</span><span class="n">newEmail</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">count</span><span class="o">())</span>
                                  <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">newUserId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                               <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">addEmail</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">id</span><span class="o">(</span><span class="n">EmailPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">)</span>
                                                <span class="o">.</span><span class="na">emailId</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                                <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                     <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                                     <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">User</span> <span class="n">addUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">addUser</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Email</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">updateEmail</span> <span class="o">:</span> <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">updateEmail</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">())){</span>
                <span class="n">updateEmail</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Email</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();){</span>
            <span class="n">Email</span> <span class="n">deleteEmail</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">deleteEmail</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span>
            <span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">())){</span>
                <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">findUser</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>以降、実装の詳細をユースケースごとに詳述する。</p>
<div class="section" id="section2-3-3-1-spring-data-jpa-usage-one-to-many-get-emails-label">
<span id="id31"></span><h4>指定されたユーザのEmailの一覧を取得する。<a class="headerlink" href="#section2-3-3-1-spring-data-jpa-usage-one-to-many-get-emails-label" title="Permalink to this headline">¶</a></h4>
<p>oneToManySampleService.getEmails(User user)実行の結果、emailRepository.findOne(String userId)が呼ばれ、以下のようなSQLが発行される。基本的にシンプルなデータベースアクセスにおけるプライマリキー指定時の呼び出しと同じである。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">emails0_</span>
<span class="k">where</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-3-3-2-spring-data-jpa-usage-one-to-many-get-user-label">
<span id="id32"></span><h4>特定のメールアドレスを持つユーザを検索する。<a class="headerlink" href="#section2-3-3-2-spring-data-jpa-usage-one-to-many-get-user-label" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-keywords">キーワード</a> に従って、EmailRepositoryクラスにfindByEmail(String email)メソッドを作成する。Spring Data JPAの機能により、String型のemailをキーにEmailエンティティを取得するクエリの自動組み立てが可能になる。</p>
<div class="literal-block-wrapper docutils container" id="id88">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.EmailRepository.javaへfindByEmail(String email)を追加</span><a class="headerlink" href="#id88" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.EmailPK</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmailRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">,</span> <span class="n">EmailPK</span><span class="o">&gt;{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">findByIdUserId</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">Email</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>サービスでは、emailをキーにEmailエンティティを取得し、EmailのUserプロパティを戻り値として返せば良い。</p>
<div class="literal-block-wrapper docutils container" id="id89">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl#getUser(String email)</span><a class="headerlink" href="#id89" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">findEmail</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">findEmail</span><span class="o">.</span><span class="na">getUsr</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>OneToManySampleServiceクラスでは、javax.transaction.Transactionalアノテーションを付与する事で、トランザクション境界を当サービスのメソッドに設定している。上記の呼び出し方だと、デフォルトではフェッチ戦略がLazyに設定されており、トランザクション境界の外でユーザプロパティのアクセスが発生した場合、異常終了してしまうため、Emailエンティティクラスのユーザプロパティに対するフェッチ戦略をEagerに変更しておく。</p>
<div class="literal-block-wrapper docutils container" id="id90">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.Email#User</span><a class="headerlink" href="#id90" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>   <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
   <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="kd">private</span> <span class="n">User</span> <span class="n">usr</span><span class="o">;</span>
</pre></div>
</div>
</div>
<p>実行した結果、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">email0_</span>
<span class="k">where</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
 <span class="k">from</span>
     <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
 <span class="k">where</span>
     <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring MVCのControllerクラスからのLazy Fetchについては、<a class="reference external" href="http://terasolunaorg.github.io/guideline/5.2.0.RELEASE/ja/ArchitectureInDetail/DataAccessDetail/DataAccessJpa.html#openentitymanagerinviewinterceptor">OpenEntityManagerInViewInterceptor</a> を使用する。</p>
</div>
</div>
<div class="section" id="section2-3-3-3-spring-data-jpa-usage-one-to-many-add-email-label">
<span id="id34"></span><h4>指定されたユーザのメールアドレスを追加する。<a class="headerlink" href="#section2-3-3-3-spring-data-jpa-usage-one-to-many-add-email-label" title="Permalink to this headline">¶</a></h4>
<p>oneToManySampleService#addEmail(User user, String email)にて、指定されたユーザのUserエンティティを取得し、プライマリーキー(emailId)を新しく生成して、Emailエンティティを追加する。単にエンティティを追加するだけで、INSERT文が発行される。</p>
<div class="literal-block-wrapper docutils container" id="id91">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl#addEmail(User user, String email)</span><a class="headerlink" href="#id91" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">size</span><span class="o">())</span>
                                <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">newEmailId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                            <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">Email</span> <span class="n">newEmail</span> <span class="o">=</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                              <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">EmailPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                         <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">findUser</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())</span>
                                         <span class="o">.</span><span class="na">emailId</span><span class="o">(</span><span class="n">newEmailId</span><span class="o">)</span>
                                         <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                              <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">findUser</span><span class="o">.</span><span class="na">addEmail</span><span class="o">(</span><span class="n">newEmail</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>実行した結果、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">emails0_</span>
<span class="k">where</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">insert</span> <span class="k">into</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
    <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">last_updated_date</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">email_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="k">values</span>
    <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-3-3-4-spring-data-jpa-usage-one-to-many-add-user-label">
<span id="id35"></span><h4>指定されたユーザをメールアドレスを含めて追加する。<a class="headerlink" href="#section2-3-3-4-spring-data-jpa-usage-one-to-many-add-user-label" title="Permalink to this headline">¶</a></h4>
<p>oneToManySampleService#addUser(User user, String email)にて、プライマリーキー(userId)を新しく生成して、Userエンティティ及び、Emailエンティティを追加する。なお、OneToOneのAddressとの関連があるため、Addressエンティティも追加しておく。</p>
<div class="literal-block-wrapper docutils container" id="id92">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl#addUser(User user, String email)</span><a class="headerlink" href="#id92" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                             <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                             <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">count</span><span class="o">())</span>
                             <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">newUserId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                              <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">);</span>
    <span class="n">user</span><span class="o">.</span><span class="na">addEmail</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">id</span><span class="o">(</span><span class="n">EmailPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">)</span>
                                            <span class="o">.</span><span class="na">emailId</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                            <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                 <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="n">User</span> <span class="n">addUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">addUser</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Addressエンティティは追加しなくても制約上問題はないが、削除処理をかけようとすると異常終了するため、ユーザエンティティ登録時には必ずセットで追加するようにしておく。</p>
</div>
<p>上記を実行すると、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">col_0_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>

<span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_1_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_3_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_3_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_1_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">left</span> <span class="k">outer</span> <span class="k">join</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio1_</span>
        <span class="k">on</span> <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_0_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_0_</span><span class="p">,</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">email0_</span>
<span class="k">where</span>
    <span class="n">email0_</span><span class="p">.</span><span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">email0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
<span class="k">where</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">insert</span> <span class="k">into</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span>
    <span class="p">(</span><span class="n">last_updated_date</span><span class="p">,</span> <span class="n">login_id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="k">values</span>
    <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>

<span class="k">insert</span> <span class="k">into</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
    <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">last_updated_date</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">email_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="k">values</span>
    <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>

<span class="k">insert</span> <span class="k">into</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span>
    <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">last_updated_date</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">zip_cd</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="k">values</span>
    <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-3-3-5-spring-data-jpa-usage-one-to-many-update-email-label">
<span id="id36"></span><h4>指定されたユーザのメールアドレスを更新する。<a class="headerlink" href="#section2-3-3-5-spring-data-jpa-usage-one-to-many-update-email-label" title="Permalink to this headline">¶</a></h4>
<p>oneToManySampleService#updateEmail(User user, String email)にて、指定されたユーザのUserエンティティを取得し、キーが合致する(ここでは、userIdとemailId)Emailオブジェクトのemailプロパティ属性を変更する。プロパティを変更するだけで、自動的にUPDATE文が発行される。</p>
<div class="literal-block-wrapper docutils container" id="id93">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl#updateEmail(User user, Email email)</span><a class="headerlink" href="#id93" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Email</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">updateEmail</span> <span class="o">:</span> <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">updateEmail</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">())){</span>
                <span class="n">updateEmail</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">emails0_</span>
<span class="k">where</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">update</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
<span class="k">set</span>
    <span class="n">email</span><span class="o">=?</span><span class="p">,</span>
    <span class="n">last_updated_date</span><span class="o">=?</span><span class="p">,</span>
    <span class="n">ver</span><span class="o">=?</span>
<span class="k">where</span>
    <span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-3-3-6-spring-data-jpa-usage-one-to-many-delete-email-label">
<span id="id37"></span><h4>指定されたユーザのメールアドレスを1件削除する。<a class="headerlink" href="#section2-3-3-6-spring-data-jpa-usage-one-to-many-delete-email-label" title="Permalink to this headline">¶</a></h4>
<p>oneToManySampleService#deleteEmail(User user, Email email)にて、指定されたユーザのUserエンティティを取得し、キーが合致する(ここでは、userIdとemailId)Emailオブジェクトをemailsリストから除外する。なお、コレクションから対象のオブジェクトを削除する事で、削除のSQLが実行されるためには、Userエンティティの&#64;OneToManyアノテーションのcascade属性と、orphanRemoval属性を変更しておく必要がある事に注意する。</p>
<div class="literal-block-wrapper docutils container" id="id94">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl#deleteEmail(User user, Email email)</span><a class="headerlink" href="#id94" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Email</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();){</span>
            <span class="n">Email</span> <span class="n">deleteEmail</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">deleteEmail</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getEmailId</span><span class="o">())){</span>
                <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id95">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.User#emails</span><a class="headerlink" href="#id95" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">cascade</span><span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">;</span>
</pre></div>
</div>
</div>
<p>上記のdeleteEmail()を実行すると、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">emails0_</span>
<span class="k">where</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
<span class="k">where</span>
    <span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-3-3-7-spring-data-jpa-usage-one-to-many-delete-emails-label">
<span id="id38"></span><h4>指定されたユーザのメールアドレスを全件削除する。<a class="headerlink" href="#section2-3-3-7-spring-data-jpa-usage-one-to-many-delete-emails-label" title="Permalink to this headline">¶</a></h4>
<p>oneToManySampleService#deleteEmails(User user)にて、指定されたUserのエンティティを取得し、emailsの中身を空にする。なお、コレクションから対象のオブジェクトを削除する事で、削除のSQLが実行されるためには、Userエンティティの&#64;OneToManyアノテーションのcascade属性と、orphanRemoval属性を変更しておく必要がある事に注意する。</p>
<div class="literal-block-wrapper docutils container" id="id96">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl#deleteEmails(User user)</span><a class="headerlink" href="#id96" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">findUser</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">findUser</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記のdeleteEmailsを実行すると、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">emails0_</span>
<span class="k">where</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
<span class="k">where</span>
    <span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
<span class="k">where</span>
    <span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
<span class="k">where</span>
    <span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">子要素全てに対してDELETE文が発生する事から、件数が多い場合は、JPQL等、コレクションからの要素削除以外を検討する。</p>
</div>
</div>
<div class="section" id="section2-3-3-8-spring-data-jpa-usage-one-to-many-delete-user-label">
<span id="id39"></span><h4>指定されたユーザの情報をメールアドレスを含めて削除する。<a class="headerlink" href="#section2-3-3-8-spring-data-jpa-usage-one-to-many-delete-user-label" title="Permalink to this headline">¶</a></h4>
<p>oneToManySampleService#deleteUser(User user)にて、指定されたユーザのエンティティを取得し、userRepository#delete(User user)を実行する。なお、UserにはOneToOne関連を持つAddressエンティティが存在するため、先にaddressRepository#delete(Address address)を実行しておく。
ユーザの関連エンティティには全てcascadeType.ALLが付与されているので、Userエンティティを削除すると、全ての関連データも付随して削除される。</p>
<div class="literal-block-wrapper docutils container" id="id97">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.OneToManySampleServiceImpl#deleteUser(User user)</span><a class="headerlink" href="#id97" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">findUser</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
<span class="k">where</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_1_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio0_</span>
<span class="k">where</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">emails0_</span>
<span class="k">where</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span>
<span class="k">where</span>
    <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
<span class="k">where</span>
    <span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span>
<span class="k">where</span>
    <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="section2-4-spring-data-jpa-usage-many-to-many-label">
<span id="id40"></span><h2>多対多関連テーブルにおけるデータ操作<a class="headerlink" href="#section2-4-spring-data-jpa-usage-many-to-many-label" title="Permalink to this headline">¶</a></h2>
<p>多対多の関連テーブル(本サンプルでは、ユーザとEmail)のデータ操作に関して以下のようなユースケースを考える。</p>
<ul class="simple">
<li>指定したユーザが属するグループの一覧を取得する。</li>
<li>指定したグループに所属する全てのユーザ一覧を取得する。</li>
<li>指定したグループに所属しない全てのユーザ一覧を取得する。</li>
<li>指定したユーザを指定したグループに追加する。</li>
<li>指定したユーザをグループから除外する。</li>
<li>指定したグループを削除し、ユーザが所属するグループの情報を更新する。</li>
<li>指定されたユーザを削除し、グループのユーザ一覧を更新する。</li>
</ul>
<p>基本的には、<a class="reference internal" href="#section2-1-spring-data-jpa-usage-simple-access-label"><span class="std std-ref">前章、シンプルなデータアクセス</span></a> で作成したエンティティクラス、及びレポジトリクラスはそのまま流用する。</p>
<div class="section" id="section2-4-1-spring-data-jpa-usage-many-to-many-service-label">
<span id="id41"></span><h3>サービスインターフェースの作成<a class="headerlink" href="#section2-4-1-spring-data-jpa-usage-many-to-many-service-label" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>指定したユーザが属するグループの一覧を取得する。 → getGroups(User user)</li>
<li>指定したグループに所属する全てのユーザ一覧を取得する。 → getUsersWith(Group group)</li>
<li>指定したグループに所属しない全てのユーザ一覧を取得する。 → getUsersWithout(Group group)</li>
<li>指定したユーザを指定したグループに追加する。 → addUserTo(Group group, User user)</li>
<li>指定したユーザをグループから除外する。 → deleteUserFrom(Group group, User user)</li>
<li>指定したグループを削除し、ユーザが所属するグループの情報を更新する。 → deleteGroup(Group group)</li>
<li>指定されたユーザを削除し、グループのユーザ一覧を更新する。 → deleteUser(User user)</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ManyToManySampleService</span> <span class="o">{</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWith</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">);</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWithout</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">addUserTo</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">deleteUserFrom</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="n">Group</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">);</span>

    <span class="n">User</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-4-2-spring-data-jpa-usage-many-to-many-configuration-label">
<span id="id42"></span><h3>コンフィグレーションクラスの作成<a class="headerlink" href="#section2-4-2-spring-data-jpa-usage-many-to-many-configuration-label" title="Permalink to this headline">¶</a></h3>
<p>データベースの環境の設定は、<a class="reference internal" href="#section2-1-5-spring-data-jpa-usage-simple-access-configuration-label"><span class="std std-ref">前章 シンプルなデータアクセス時の設定</span></a> を流用し、サービスを実行する設定ファイルクラスを新規作成する。</p>
<div class="literal-block-wrapper docutils container" id="id98">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.config.ManyToManySampleApp.java</span><a class="headerlink" href="#id98" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ComponentScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ConfigurableApplicationContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl</span><span class="o">;</span>

<span class="nd">@ComponentScan</span><span class="o">(</span><span class="s">&quot;org.debugroom.sample.spring.jpa.config.infra&quot;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ManyToManySampleApp</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span>
                                         <span class="n">ManyToManySampleApp</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">web</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>

        <span class="n">ManyToManySampleService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ManyToManySampleService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getGroups</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">groupName</span><span class="o">(</span><span class="s">&quot;org.debugroom&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getUsersWith</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getUsersWithout</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">addUser</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">addUserTo</span><span class="o">(</span><span class="n">group</span><span class="o">,</span>
                                 <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userName</span><span class="o">(</span><span class="s">&quot;NewComer(ΦωΦ)&quot;</span><span class="o">).</span><span class="na">affiliations</span><span class="o">(</span>
                                                    <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;()).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getGroups</span><span class="o">(</span><span class="n">addUser</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getUsersWith</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteUserFrom</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">addUser</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getUsersWith</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteGroup</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getGroups</span><span class="o">(</span><span class="n">addUser</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">deleteUser</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="s">&quot;00000001&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getUsersWith</span><span class="o">(</span><span class="n">Group</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">groupName</span><span class="o">(</span><span class="s">&quot;nttdata&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>

   <span class="o">}</span>

   <span class="nd">@Bean</span> <span class="n">ManyToManySampleService</span> <span class="nf">manyToManySampleService</span><span class="o">(){</span>
       <span class="k">return</span> <span class="k">new</span> <span class="n">ManyToManySampleServiceImpl</span><span class="o">();</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section2-4-3-spring-data-jpa-usage-many-to-many-service-impl-label">
<span id="id43"></span><h3>サービス実装クラスの作成<a class="headerlink" href="#section2-4-3-spring-data-jpa-usage-many-to-many-service-impl-label" title="Permalink to this headline">¶</a></h3>
<p>上記で定義したサービスインターフェースを実装した結果を以下に示す。</p>
<div class="literal-block-wrapper docutils container" id="id99">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl.java</span><a class="headerlink" href="#id99" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.transaction.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.AffiliationPK</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.GroupRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.AddressRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.UserRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification.FindGroupsByUserId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUsersByGroupName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUsersByNotGroupName</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ManyToManySampleServiceImpl</span> <span class="kd">implements</span> <span class="n">ManyToManySampleService</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
                                   <span class="n">FindGroupsByUserId</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                     <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())</span>
                                                     <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : groups of &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">groups</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {null,null}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span> <span class="o">:</span> <span class="n">groups</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {&quot;</span>
                       <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">groups</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWith</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
                                <span class="n">FindUsersByGroupName</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                    <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">())</span>
                                                    <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users of &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {null,null}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWithout</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
                                <span class="n">FindUsersByNotGroupName</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                       <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">())</span>
                                                       <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : no users of &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {null,null}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addUserTo</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">count</span><span class="o">())</span>
                                  <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">newUserId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                                        <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">groupId</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()).</span><span class="na">getGroupId</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">addAffiliation</span><span class="o">(</span><span class="n">Affiliation</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                       <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">AffiliationPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                        <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">)</span>
                                                        <span class="o">.</span><span class="na">groupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span>
                                                        <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                       <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteUserFrom</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Group</span> <span class="n">findGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">findGroup</span><span class="o">.</span><span class="na">getAffiliations</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">){</span>
            <span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">affiliation</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getUserId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())){</span>
                <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Group</span> <span class="n">findGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="n">groupRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">findGroup</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">findGroup</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">findUser</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>以降、実装の詳細をユースケースごとに詳述する。</p>
<div class="section" id="section2-4-3-1-spring-data-jpa-usage-manny-to-many-get-groups-label">
<span id="id44"></span><h4>指定したユーザが属するグループの一覧を取得する。<a class="headerlink" href="#section2-4-3-1-spring-data-jpa-usage-manny-to-many-get-groups-label" title="Permalink to this headline">¶</a></h4>
<p>manyToManySampleSercice#getGroups()にて、ユーザIDを指定して一致した所属テーブルのキー(userIdとgroupId)とグループテーブルを結合して、一致するグループの一覧を取得する。結合には、 <a class="reference internal" href="#section2-2-3-2-spring-data-jpa-usage-one-to-one-get-users-with-label"><span class="std std-ref">1対1関連における、特定の郵便番号を持つユーザ一覧を取得する</span></a> 場合と同様に、結合条件に該当するorg.springframework.data.jpa.domain.Specificationクラスを継承した条件クラスを作成し、toPredicate()メソッドをオーバーライドして、結合条件を指定したPredicateクラスを戻り値で返却する。</p>
<div class="literal-block-wrapper docutils container" id="id100">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl#getGroups(User user)</span><a class="headerlink" href="#id100" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
                                   <span class="n">FindGroupsByUserId</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                     <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())</span>
                                                     <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : groups of &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">groups</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {null,null}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span> <span class="o">:</span> <span class="n">groups</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {&quot;</span>
                       <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">groups</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id101">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.specification.FindGroupsByUserId.java</span><a class="headerlink" href="#id101" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Join</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Predicate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Root</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.domain.Specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FindGroupsByUserId</span> <span class="kd">implements</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="n">Root</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                        <span class="n">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Predicate</span><span class="o">&gt;</span> <span class="n">predicates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Predicate</span><span class="o">&gt;();</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">,</span> <span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">joinAffiliation</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">Group_</span><span class="o">.</span><span class="na">affiliations</span><span class="o">);</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">joinUser</span> <span class="o">=</span> <span class="n">joinAffiliation</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">Affiliation_</span><span class="o">.</span><span class="na">usr</span><span class="o">);</span>
        <span class="n">predicates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">joinUser</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">userId</span><span class="o">),</span> <span class="n">userId</span><span class="o">));</span>

        <span class="k">return</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">predicates</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Predicate</span><span class="o">[]{}));</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span> <span class="k">as</span> <span class="n">group_na2_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_4_</span>
<span class="k">from</span>
    <span class="n">grp</span> <span class="n">group0_</span>
<span class="k">inner</span> <span class="k">join</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio1_</span>
        <span class="k">on</span> <span class="n">group0_</span><span class="p">.</span><span class="n">group_id</span><span class="o">=</span><span class="n">affiliatio1_</span><span class="p">.</span><span class="n">group_id</span>
<span class="k">inner</span> <span class="k">join</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user2_</span>
        <span class="k">on</span> <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="n">user2_</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">where</span>
    <span class="n">user2_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-4-3-2-spring-data-jpa-usage-manny-to-many-get-users-with-label">
<span id="id45"></span><h4>指定したグループに所属する全てのユーザ一覧を取得する。<a class="headerlink" href="#section2-4-3-2-spring-data-jpa-usage-manny-to-many-get-users-with-label" title="Permalink to this headline">¶</a></h4>
<p>manyToManySampleSercice#getUsersWith(Group group)にて、グループ名を指定して一致したグループのデータがもつグループIDと一致する、所属テーブルのキー(userIdとgroupId)を使用して、ユーザテーブルを結合して、一致するユーザの一覧を取得する。結合には、 <a class="reference internal" href="#section2-2-3-2-spring-data-jpa-usage-one-to-one-get-users-with-label"><span class="std std-ref">1対1関連における、特定の郵便番号を持つユーザ一覧を取得する</span></a> 場合と同様に、結合条件に該当するorg.springframework.data.jpa.domain.Specificationクラスを継承した条件クラスを作成し、toPredicate()メソッドをオーバーライドして、結合条件を指定したPredicateクラスを戻り値で返却する。</p>
<div class="literal-block-wrapper docutils container" id="id102">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl#getUsersWith(Group group)</span><a class="headerlink" href="#id102" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWith</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
                                        <span class="n">FindUsersByGroupName</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                            <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">())</span>
                                                            <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : users of &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {null,null}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
   <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id103">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUserByGroupName.java</span><a class="headerlink" href="#id103" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Join</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Predicate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Root</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.domain.Specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FindUsersByGroupName</span> <span class="kd">implements</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                         <span class="n">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Predicate</span><span class="o">&gt;</span> <span class="n">predicates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Predicate</span><span class="o">&gt;();</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">joinAffiliation</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">affiliations</span><span class="o">);</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;</span> <span class="n">joinGroup</span> <span class="o">=</span> <span class="n">joinAffiliation</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">Affiliation_</span><span class="o">.</span><span class="na">grp</span><span class="o">);</span>
        <span class="n">predicates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">joinGroup</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Group_</span><span class="o">.</span><span class="na">groupName</span><span class="o">),</span> <span class="n">groupName</span><span class="o">));</span>

        <span class="k">return</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">predicates</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Predicate</span><span class="o">[]{}));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">inner</span> <span class="k">join</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio1_</span>
        <span class="k">on</span> <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">inner</span> <span class="k">join</span>
    <span class="n">grp</span> <span class="n">group2_</span>
        <span class="k">on</span> <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">group_id</span><span class="o">=</span><span class="n">group2_</span><span class="p">.</span><span class="n">group_id</span>
<span class="k">where</span>
    <span class="n">group2_</span><span class="p">.</span><span class="n">group_name</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-4-3-3-spring-data-jpa-usage-manny-to-many-get-users-without-label">
<span id="id46"></span><h4>指定したグループに所属しない全てのユーザ一覧を取得する。<a class="headerlink" href="#section2-4-3-3-spring-data-jpa-usage-manny-to-many-get-users-without-label" title="Permalink to this headline">¶</a></h4>
<p>manyToManySampleSercice#getUsersWithout(Group group)にて、前章で、”指定したグループに所属する全てのユーザ一覧を取得する”サブクエリを副問い合わせとして実行した後、その結果に該当しないユーザをNotInを使って取得する。</p>
<p>結合には、 <a class="reference internal" href="#section2-2-3-3-spring-data-jpa-usage-one-to-one-get-users-without-label"><span class="std std-ref">1対1関連における、特定の郵便番号を持たないユーザ一覧を取得する</span></a> 場合と同様に、結合条件に該当するorg.springframework.data.jpa.domain.Specificationクラスを継承した条件クラスを作成し、toPredicate()メソッドをオーバーライドして、結合条件を指定したPredicateクラスを戻り値で返却する。</p>
<div class="literal-block-wrapper docutils container" id="id104">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl#getUsersWithout(Group group)</span><a class="headerlink" href="#id104" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersWithout</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
                                       <span class="n">FindUsersByNotGroupName</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                              <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">())</span>
                                                              <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : no users of &quot;</span> <span class="o">+</span> <span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">users</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {null,null}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;        - {&quot;</span>
                       <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
   <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id105">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.repository.specification.FindUsersByNotGroupName</span><a class="headerlink" href="#id105" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.repository.specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Join</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Predicate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Root</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Subquery</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Affiliation_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.Group_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.jpa.domain.entity.User_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.domain.Specification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FindUsersByNotGroupName</span> <span class="kd">implements</span> <span class="n">Specification</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                          <span class="n">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Path</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">path</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;userId&quot;</span><span class="o">);</span>
        <span class="n">Subquery</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">subQuery</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">().</span><span class="na">subquery</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">subQueryRoot</span> <span class="o">=</span> <span class="n">subQuery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">subQueryJoinAffiliation</span> <span class="o">=</span> <span class="n">subQueryRoot</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">User_</span><span class="o">.</span><span class="na">affiliations</span><span class="o">);</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;</span> <span class="n">subQueryJoinGroup</span> <span class="o">=</span> <span class="n">subQueryJoinAffiliation</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">Affiliation_</span><span class="o">.</span><span class="na">grp</span><span class="o">);</span>
        <span class="n">Predicate</span> <span class="n">subQueryPredicate</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span>
                                                <span class="n">subQueryJoinGroup</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Group_</span><span class="o">.</span><span class="na">groupName</span><span class="o">),</span> <span class="n">groupName</span><span class="o">);</span>
        <span class="n">subQuery</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">subQueryRoot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;userId&quot;</span><span class="o">));</span>
        <span class="n">subQuery</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">subQueryPredicate</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">not</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">path</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="n">subQuery</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のSQLが実行される。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">select</span>
    <span class="n">user0_</span><span class="o">.</span><span class="na">user_id</span> <span class="n">as</span> <span class="n">user_id1_3_</span><span class="o">,</span>
    <span class="n">user0_</span><span class="o">.</span><span class="na">last_updated_date</span> <span class="n">as</span> <span class="n">last_upd2_3_</span><span class="o">,</span>
    <span class="n">user0_</span><span class="o">.</span><span class="na">login_id</span> <span class="n">as</span> <span class="n">login_id3_3_</span><span class="o">,</span>
    <span class="n">user0_</span><span class="o">.</span><span class="na">user_name</span> <span class="n">as</span> <span class="n">user_nam4_3_</span><span class="o">,</span>
    <span class="n">user0_</span><span class="o">.</span><span class="na">ver</span> <span class="n">as</span> <span class="n">ver5_3_</span>
<span class="n">from</span>
    <span class="kd">public</span><span class="o">.</span><span class="na">usr</span> <span class="n">user0_</span>
<span class="n">where</span>
    <span class="n">user0_</span><span class="o">.</span><span class="na">user_id</span> <span class="n">not</span> <span class="nf">in</span>  <span class="o">(</span>
        <span class="n">select</span>
            <span class="n">user1_</span><span class="o">.</span><span class="na">user_id</span>
        <span class="n">from</span>
            <span class="kd">public</span><span class="o">.</span><span class="na">usr</span> <span class="n">user1_</span>
        <span class="n">inner</span> <span class="n">join</span>
            <span class="kd">public</span><span class="o">.</span><span class="na">affiliation</span> <span class="n">affiliatio2_</span>
                <span class="n">on</span> <span class="n">user1_</span><span class="o">.</span><span class="na">user_id</span><span class="o">=</span><span class="n">affiliatio2_</span><span class="o">.</span><span class="na">user_id</span>
        <span class="n">inner</span> <span class="n">join</span>
            <span class="n">grp</span> <span class="n">group3_</span>
                <span class="n">on</span> <span class="n">affiliatio2_</span><span class="o">.</span><span class="na">group_id</span><span class="o">=</span><span class="n">group3_</span><span class="o">.</span><span class="na">group_id</span>
        <span class="n">where</span>
            <span class="n">group3_</span><span class="o">.</span><span class="na">group_name</span><span class="o">=?</span>
    <span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-4-3-4-spring-data-jpa-usage-manny-to-many-add-user-to-label">
<span id="id47"></span><h4>指定したユーザを指定したグループに追加する。<a class="headerlink" href="#section2-4-3-4-spring-data-jpa-usage-manny-to-many-add-user-to-label" title="Permalink to this headline">¶</a></h4>
<p>manyToManySampleSerivce#addUserTo(Group group, User user)にて、所属エンティティに指定したグループのキーを設定して、新規ユーザデータを作成し、userRepository#save()メソッドを実行する。</p>
<div class="literal-block-wrapper docutils container" id="id106">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl#addUserTo(Group group, User user)</span><a class="headerlink" href="#id106" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addUserTo</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;00000000&quot;</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">count</span><span class="o">())</span>
                                  <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">newUserId</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                                     <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">8</span><span class="o">,</span> <span class="n">sequence</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">groupId</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()).</span><span class="na">getGroupId</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">addAffiliation</span><span class="o">(</span><span class="n">Affiliation</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                       <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">AffiliationPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                        <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">newUserId</span><span class="o">)</span>
                                                        <span class="o">.</span><span class="na">groupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span>
                                                        <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                       <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

   <span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">col_0_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>

<span class="k">select</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span> <span class="k">as</span> <span class="n">group_na2_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_4_</span>
<span class="k">from</span>
    <span class="n">grp</span> <span class="n">group0_</span>
<span class="k">where</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_1_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_1_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_3_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_3_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio1_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_1_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">left</span> <span class="k">outer</span> <span class="k">join</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio1_</span>
        <span class="k">on</span> <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=</span><span class="n">affiliatio1_</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_1_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio0_</span>
<span class="k">where</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">insert</span> <span class="k">into</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span>
    <span class="p">(</span><span class="n">last_updated_date</span><span class="p">,</span> <span class="n">login_id</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="k">values</span>
    <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>

<span class="k">insert</span> <span class="k">into</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span>
    <span class="p">(</span><span class="n">last_updated_date</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="k">values</span>
     <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-4-3-5-spring-data-jpa-usage-manny-to-many-delete-user-from-label">
<span id="id48"></span><h4>指定したユーザをグループから除外する。<a class="headerlink" href="#section2-4-3-5-spring-data-jpa-usage-manny-to-many-delete-user-from-label" title="Permalink to this headline">¶</a></h4>
<p>manyToManySampleSerivce#deleteUserFrom(Group group, User user)にて、指定したグループ名に一致するグループを取得し、所属プロパティから指定されたユーザIDと一致するデータをコレクションから除外するだけで良い。除外したデータに対してDELETE文が発行されるようにするため、Groupエンティティにおける、Affiliationプロパティの&#64;OneToManyアノテーションにcascade属性CascadeType.ALLと、orphanRemovalをtrueに設定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id107">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl#deleteUserFrom(Group group, User user)</span><a class="headerlink" href="#id107" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteUserFrom</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Group</span> <span class="n">findGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">findGroup</span><span class="o">.</span><span class="na">getAffiliations</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
            <span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">){</span>
            <span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">affiliation</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">getUserId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())){</span>
                <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id108">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.Group#Set&lt;Affiliation&gt;</span><a class="headerlink" href="#id108" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;grp&quot;</span><span class="o">,</span>
                        <span class="n">cascade</span><span class="o">=</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">;</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span> <span class="k">as</span> <span class="n">group_na2_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_4_</span>
<span class="k">from</span>
    <span class="n">grp</span> <span class="n">group0_</span>
<span class="k">where</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_1_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio0_</span>
<span class="k">where</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span>
<span class="k">where</span>
    <span class="n">group_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
<div class="section" id="section2-4-3-6-spring-data-jpa-usage-manny-to-many-delete-group-label">
<span id="id49"></span><h4>指定したグループを削除し、ユーザが所属するグループの情報を更新する。<a class="headerlink" href="#section2-4-3-6-spring-data-jpa-usage-manny-to-many-delete-group-label" title="Permalink to this headline">¶</a></h4>
<p>manyToManySampleSerivce#deleteGroup(Group group)にて、指定したグループ名に一致するグループを取得し、groupRepository.delete()メソッドを実行する。グループの子要素である所属テーブルのデータに対してもDELETE文が発行されるようにするため、前節と同様、Groupエンティティにおける、Affiliationプロパティの&#64;OneToManyアノテーションにcascade属性CascadeType.ALLと、orphanRemovalをtrueに設定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id109">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl#deleteGroup(Group group)</span><a class="headerlink" href="#id109" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Group</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Group</span> <span class="n">findGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="n">groupRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">findGroup</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">findGroup</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のようなSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span> <span class="k">as</span> <span class="n">group_na2_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_4_</span><span class="p">,</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_4_</span>
<span class="k">from</span>
    <span class="n">grp</span> <span class="n">group0_</span>
<span class="k">where</span>
    <span class="n">group0_</span><span class="p">.</span><span class="n">group_name</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_1_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio0_</span>
<span class="k">where</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span>
<span class="k">where</span>
    <span class="n">group_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span>
<span class="k">where</span>
    <span class="n">group_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="n">grp</span>
<span class="k">where</span>
    <span class="n">group_id</span><span class="o">=?</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">所属しているユーザの数だけDELETE文が実行されるため、ユーザ数が多い場合は、JPQLによる一括のデータ削除等を検討する。</p>
</div>
</div>
<div class="section" id="section2-4-3-7-spring-data-jpa-usage-manny-to-many-delete-user-label">
<span id="id50"></span><h4>指定されたユーザを削除し、グループのユーザ一覧を更新する。<a class="headerlink" href="#section2-4-3-7-spring-data-jpa-usage-manny-to-many-delete-user-label" title="Permalink to this headline">¶</a></h4>
<p>manyToManySampleSerivce#deleteUser(User user)にて、指定したユーザIDに一致するユーザを取得し、userRepository.delete()メソッドを実行する。ユーザエンティティにはOneToOne関連でAddressエンティティが設定されているため、事前に削除を行う。ユーザの子要素である所属テーブルのデータに対してもDELETE文が発行されるようにするため、前節と同様、Userエンティティにおける、Affiliationプロパティの&#64;OneToManyアノテーションにcascade属性CascadeType.ALLと、orphanRemovalをtrueに設定しておく。</p>
<div class="literal-block-wrapper docutils container" id="id110">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.service.ManyToManySampleServiceImpl#deleteUser(User user)</span><a class="headerlink" href="#id110" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">findUser</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id111">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.spring.jpa.domain.entity.User#Set&lt;Affiliation&gt;</span><a class="headerlink" href="#id111" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">cascade</span><span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span><span class="o">;</span>
</pre></div>
</div>
</div>
<p>上記を実行すると、以下のSQLが発行される。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd2_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">login_id</span> <span class="k">as</span> <span class="n">login_id3_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_name</span> <span class="k">as</span> <span class="n">user_nam4_3_0_</span><span class="p">,</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_3_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span> <span class="n">user0_</span>
<span class="k">where</span>
    <span class="n">user0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id1_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">address</span> <span class="k">as</span> <span class="n">address2_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_0_0_</span><span class="p">,</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">zip_cd</span> <span class="k">as</span> <span class="n">zip_cd5_0_0_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span> <span class="n">address0_</span>
<span class="k">where</span>
    <span class="n">address0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_0_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">group_id</span> <span class="k">as</span> <span class="n">group_id1_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd3_1_1_</span><span class="p">,</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver4_1_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span> <span class="n">affiliatio0_</span>
<span class="k">where</span>
    <span class="n">affiliatio0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">select</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_0_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email_id</span> <span class="k">as</span> <span class="n">email_id1_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="n">user_id2_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">email</span> <span class="k">as</span> <span class="n">email3_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">last_updated_date</span> <span class="k">as</span> <span class="n">last_upd4_2_1_</span><span class="p">,</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">ver</span> <span class="k">as</span> <span class="n">ver5_2_1_</span>
<span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span> <span class="n">emails0_</span>
<span class="k">where</span>
    <span class="n">emails0_</span><span class="p">.</span><span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">address</span>
<span class="k">where</span>
    <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">affiliation</span>
<span class="k">where</span>
    <span class="n">group_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">email</span>
<span class="k">where</span>
    <span class="n">email_id</span><span class="o">=?</span>
    <span class="k">and</span> <span class="n">user_id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span>
    <span class="k">public</span><span class="p">.</span><span class="n">usr</span>
<span class="k">where</span>
    <span class="n">user_id</span><span class="o">=?</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../spring-cloud-aws/index.html" class="btn btn-neutral float-right" title="Spring Cloud AWS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="introduction.html" class="btn btn-neutral" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, org.debugroom.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1-SNAPSHOTS',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>