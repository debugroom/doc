

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>データモデリング &mdash; document 0.1-SNAPSHOTS documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="document 0.1-SNAPSHOTS documentation" href="../../index.html"/>
        <link rel="up" title="Cassandra" href="index.html"/>
        <link rel="next" title="work guideline" href="../../memo/work/index.html"/>
        <link rel="prev" title="Cassandra - SpringFrameworkアプリケーション" href="spring-integration.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> document
          

          
          </a>

          
            
            
              <div class="version">
                0.1-SNAPSHOTS
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../java/jBatch/index.html">jBatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/spring/springboot/index.html">Spring Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/spring/springdatajpa/index.html">Spring Data JPA</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cassandra</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="launch.html">Cassandraの起動</a></li>
<li class="toctree-l2"><a class="reference internal" href="definition.html">データベースの定義</a></li>
<li class="toctree-l2"><a class="reference internal" href="manipulate.html">データベースの操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="spring-integration.html">Cassandra - SpringFrameworkアプリケーション</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">データモデリング</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-cassandra-discussion-label">検証のポイント</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-cassandra-use-case-label">ユースケース</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-differenece-relational-data-modeling-label">データベースやクエリにおける相違点</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rdbmscassandra">RDBMSとCassandra</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spring-data-cassandra">Spring Data Cassandraを使用したユースケースの実装</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-x-usecase-implementation-using-spring-data-cassandra-simple-patten1-label">パターン1(非正規化モデル)を中心としたデータモデル</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-x-differenece-rdb-consistency-problem-label">データ整合性に問題が生じるケース</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-differenece-rdb-consistency-problem-denormalization-label">非正規化によるデータ分散による不整合</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-differenece-rdb-consistency-problem-replication-label">レプリケーション間のデータ不整合</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-x-differenece-design-method-label">設計手順</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../memo/work/index.html">work guideline</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">document</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Cassandra</a> &raquo;</li>
      
    <li>データモデリング</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/database/cassandra/datamodeling.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="section6-cassndra-data-modeling-label">
<span id="id1"></span><h1>データモデリング<a class="headerlink" href="#section6-cassndra-data-modeling-label" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">この内容は検証中であり、検証の結果によっては記載内容を変更する可能性がある事に注意。</p>
</div>
<div class="section" id="section6-x-cassandra-discussion-label">
<span id="id2"></span><h2>検証のポイント<a class="headerlink" href="#section6-x-cassandra-discussion-label" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Cassandraのテーブル構造  <br/>
→リレーショナルデータベースとは違い、データ中心の設計アプローチをとるべきではない(と言われている)。データストアの特性が違うので、Cassandraで出来る事・出来ない事を整理して、適切な永続化のテーブル構造を考える。</li>
<li>アプリケーションのデータモデリングの差異 <br/>
→ エンティティオブジェクトはどのような構造をとるべきか</li>
<li>Spring Data Cassandraのマッピング機能とデータアクセスのお作法 <br/>
→ どのような機能を持っていて、どういう実装方法が望ましいか</li>
<li>データモデリング設計の進め方</li>
</ul>
</div>
<div class="section" id="section6-x-cassandra-use-case-label">
<span id="id3"></span><h2>ユースケース<a class="headerlink" href="#section6-x-cassandra-use-case-label" title="Permalink to this headline">¶</a></h2>
<p>リレーショナルデータベースの場合のモデリングと対比するために、<a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/index.html">Spring Data JPAにおけるサンプルのユースケース</a> を考える。</p>
<table border="1" class="docutils" id="id40">
<caption><span class="caption-text">ユースケース</span><a class="headerlink" href="#id40" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ユースケース</th>
<th class="head">リレーショナルモデルにおける <br/> エンティティ関連</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>全てのユーザを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>全ての住所を検索する</td>
<td>なし</td>
</tr>
<tr class="row-even"><td>全てのメールアドレスを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>全てのグループを検索する</td>
<td>なし</td>
</tr>
<tr class="row-even"><td>特定のユーザを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>ログインIDをキーに特定のユーザを検索する</td>
<td>なし</td>
</tr>
<tr class="row-even"><td>特定のユーザのアドレスを検索する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのEmailの一覧を取得する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定したグループ名を元にグループを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>特定の郵便番号を持つユーザ一覧を取得する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-even"><td>特定の郵便番号を持たないユーザ一覧を取得する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-odd"><td>指定されたユーザの住所を追加する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-even"><td>指定されたユーザの住所を更新する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-odd"><td>指定されたユーザの住所を削除する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-even"><td>特定のメールアドレスを持つユーザを検索する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのメールアドレスを追加する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定されたユーザをメールアドレスを含めて追加する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのメールアドレスを更新する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定されたユーザのメールアドレスを1件削除する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのメールアドレスを全件削除する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定したユーザが属するグループの一覧を取得する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-odd"><td>指定したグループに所属する全てのユーザ一覧を取得する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-even"><td>指定したグループに所属しない全てのユーザ一覧を取得する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-odd"><td>指定したユーザを指定したグループに追加する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-even"><td>指定したユーザをグループから除外する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-odd"><td>指定したグループを削除し、 <br/> ユーザが所属するグループの情報を更新する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-even"><td>指定されたユーザを削除し、グループのユーザ一覧を更新する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="section6-x-differenece-relational-data-modeling-label">
<span id="id4"></span><h2>データベースやクエリにおける相違点<a class="headerlink" href="#section6-x-differenece-relational-data-modeling-label" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rdbmscassandra">
<span id="section6-x-x-differenece-between-rdb-and-cassandra-label"></span><h3>RDBMSとCassandra<a class="headerlink" href="#rdbmscassandra" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils" id="id41">
<caption><span class="caption-text">データベース間の相違</span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="23%" />
<col width="38%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">相違点</th>
<th class="head">RDBMS</th>
<th class="head">Cassandra</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">一貫性</th>
<td>強一貫性</td>
<td>設定可能な一貫性※1</td>
</tr>
<tr class="row-odd"><th class="stub">トランザクション</th>
<td>ACIDトランザクション</td>
<td>軽量トランザクション</td>
</tr>
<tr class="row-even"><th class="stub">クエリ</th>
<td>SQL</td>
<td>CQL※2</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id42">
<caption><span class="caption-text">設定可能な書き込み一貫性*1</span><a class="headerlink" href="#id42" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">一貫性レベル</th>
<th class="head">特徴</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ALL</td>
<td>クラスター内のすべてのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-odd"><td>EACH_QUORUM</td>
<td>書き込みが、各データ・センターのレプリカ・ノードのクォーラム（過半数）の <br/> コミット・ログとmemtableに書き込まれる</td>
</tr>
<tr class="row-even"><td>QUORUM</td>
<td>書き込みが、すべてのデータ・センターのレプリカ・ノードのクォーラム <br/> （過半数）のコミット・ログとmemtableに書き込まれる</td>
</tr>
<tr class="row-odd"><td>LOCAL_QUORUM</td>
<td>書き込みが、コーディネーター・ノードと同じデータ・センターにある <br/> レプリカ・ノードのクォーラム（過半数）のコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-even"><td>ONE</td>
<td>書き込みが、少なくとも1つのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-odd"><td>TWO</td>
<td>書き込みが、少なくとも2つのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-even"><td>THREE</td>
<td>書き込みが、少なくとも3つのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-odd"><td>LOCAL_ONE</td>
<td>ローカル・データ・センターの少なくとも1つのレプリカ・ノードに <br/> 書き込みを送信し、 確認応答がある</td>
</tr>
<tr class="row-even"><td>ANY</td>
<td>書き込みが、少なくとも1つのノードに書き込まれる。パーティション・キーの <br/> すべての レプリカ・ノードがダウンしていても、 <br/> ヒンテッド・ハンドオフが書き込まれれば、書き込みを成功と見なす。</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id43">
<caption><span class="caption-text">設定可能な読み込み一貫性*1</span><a class="headerlink" href="#id43" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">一貫性レベル</th>
<th class="head">特徴</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ALL</td>
<td>すべてのレプリカが応答した後に、レコードを返す。1つでもレプリカが <br/> 応答しないと、読み取り操作は失敗する。</td>
</tr>
<tr class="row-odd"><td>EACH_QUORUM</td>
<td>読み取りが、各データ・センターのレプリカ・ノードのクォーラム <br/> （過半数）で読み取られる。</td>
</tr>
<tr class="row-even"><td>QUORUM</td>
<td>すべてのデータ・センターのクォーラム（過半数）のレプリカが応答したら、 <br/> レコードを返す。</td>
</tr>
<tr class="row-odd"><td>LOCAL_QUORUM</td>
<td>コーディネーター・ノードが報告された際に現在のデータ・センター内のクォーラム <br/> （過半数）の|br|レプリカが応答したら、レコードを返す。</td>
</tr>
<tr class="row-even"><td>ONE</td>
<td>スニッチによって定まる最も近いレプリカから応答を返します。デフォルトでは、 <br/> 他のレプリカとの|br|整合性を維持するために、読み取りリペアが <br/> バックグラウンドで実行される。</td>
</tr>
<tr class="row-odd"><td>TWO</td>
<td>最も近い2つのレプリカから最新のデータを返す。</td>
</tr>
<tr class="row-even"><td>THREE</td>
<td>最も近い3つのレプリカから最新のデータを返す。</td>
</tr>
<tr class="row-odd"><td>LOCAL_ONE</td>
<td>ローカル・データ・センターの最も近いレプリカからの応答を返す</td>
</tr>
<tr class="row-even"><td>SERIAL</td>
<td>新しい追加や更新を提示することなく、現在の（そしてコミットされていない <br/> 可能性がある）データの状態を読み取ることができる。SERIALの読み取りにおいて <br/> 進行中のコミットされていないトランザクションが見つかった場合は、 <br/> 読み取りの一環としてそのトランザクションがコミットされる。</td>
</tr>
<tr class="row-odd"><td>LOCAL_SERIAL</td>
<td>SERIALと同じだが、データ・センターに限定される。</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id44">
<caption><span class="caption-text">SQLと比較した場合のCQLの特徴*2</span><a class="headerlink" href="#id44" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">No</th>
<th class="head">特徴</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>結合や外部キー、副問合せのサポートがない  <br/> → 必要に応じてテーブルを非正規化、マテリアライズドビューを使用する。</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>GROUP BY等集約関数が標準で存在しない。Cassandra3以降、ユーザ定義関数はサポート。 <br/> → アプリの中でロジックとして実装する</td>
</tr>
<tr class="row-even"><td>3</td>
<td>WHERE句でプライマリキー以外を使用するにはインデックスが必要 <br/> → セカンダリインデックスを作成したり、マテリアライズドビューを使用する。</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>データ型でCollectionをサポート。1:n関連に相当する有限のデータはCollectionを利用する。 <br/>
センサーデータのような無限にデータが増えていく場合は、複合プライマリーキーを使用する。 <br/> → 必要に応じて、テーブルを非正規化する。</td>
</tr>
<tr class="row-even"><td>5</td>
<td>更新の条件指定はプライマリキーのみに限定される <br/> アプリの中でロジックとして実装する。</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>&#8220;OR&#8221;、&#8221;NOT&#8221;といった論理演算子はなく、ANDのみに限定される <br/> → アプリの中でロジックとして実装する</td>
</tr>
<tr class="row-even"><td>7</td>
<td>日付型の演算時可能な表現が異なる <br/> → アプリの中でロジックとして実装する。</td>
</tr>
<tr class="row-odd"><td>8</td>
<td>重複したキーのインサートはアップデートとして扱われる</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="spring-data-cassandra">
<span id="section6-x-x-usecase-implementation-using-spring-data-cassandra-label"></span><h2>Spring Data Cassandraを使用したユースケースの実装<a class="headerlink" href="#spring-data-cassandra" title="Permalink to this headline">¶</a></h2>
<p>データのモデリングによって、実装のパターンは異なる。まず最初にデータモデルの非正規化を中心としたパターンについて実装方法を考察する。</p>
<p>本サンプルでは、以下の構成をパターン1として実装例を記述する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/data-modeling-pattern1.png"><img alt="../../_images/data-modeling-pattern1.png" src="../../_images/data-modeling-pattern1.png" /></a>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-using-spring-data-cassandra-simple-patten1-label">
<span id="id5"></span><h3>パターン1(非正規化モデル)を中心としたデータモデル<a class="headerlink" href="#section6-x-x-x-usecase-implementation-using-spring-data-cassandra-simple-patten1-label" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/index.html">Spring Data JPAの例</a> との比較のために類似のユースケースを勘案して、解説する。</p>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-entity-label">
<span id="id7"></span><h4>エンティティクラスの作成<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-entity-label" title="Permalink to this headline">¶</a></h4>
<p>テーブルを表現するアノーテションを付与したエンティティクラスを作成する。
アノテーションはorg.springframework.data.cassandra.mappingパッケージにあるが、
代表的なアノテーションの概要は以下の通りである。</p>
<table border="1" class="docutils" id="id45">
<caption><span class="caption-text">org.springframework.data.cassandra.mappingアノテーションの概要</span><a class="headerlink" href="#id45" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="20%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">設定</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&#64;Table</td>
<td>クラス</td>
<td>エンティティクラスとマッピングする物理テーブル名を指定する。</td>
</tr>
<tr class="row-odd"><td>&#64;PrimaryKeyClass</td>
<td>クラス</td>
<td>複合主キーで使用されるカラムを表現するクラス</td>
</tr>
<tr class="row-even"><td>&#64;Id</td>
<td>フィールド</td>
<td>IDとして表現するフィールドに付与する。</td>
</tr>
<tr class="row-odd"><td>&#64;PrimaryKey</td>
<td>フィールド</td>
<td>&#64;Idと機能は同じで、カラム名を指定可能である。</td>
</tr>
<tr class="row-even"><td>&#64;PrimaryKeyColumn</td>
<td>フィールド</td>
<td>パーティションカラム、クラスタカラムを指定できるプライマリキーカラム</td>
</tr>
<tr class="row-odd"><td>&#64;Column</td>
<td>フィールド</td>
<td>フィールドとデータベースのカラム名のマッピングを定義する。</td>
</tr>
<tr class="row-even"><td>&#64;Transient</td>
<td>フィールド</td>
<td>永続化しないエンティティクラス、マップドスーパークラス、<br/> または組み込みクラスのフィールドであることを示す。</td>
</tr>
<tr class="row-odd"><td>&#64;CassandraType</td>
<td>フィールド</td>
<td>Cassandraのデータ型を指定する際に利用する。</td>
</tr>
<tr class="row-even"><td>&#64;UserDefinedType</td>
<td>クラス</td>
<td>ユーザ定義型に付与する際に利用する。</td>
</tr>
</tbody>
</table>
<p>以降、上記のアノテーションを付与したサンプルを幾つか記載する。</p>
<p>ユーザエンティティを表現するUserクラスにテーブル名を指定した&#64;Tableアノテーションを設定する。各フィールドには各カラム名を指定した&#64;Columnアノテーションを付与する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-entity-user">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-entity-user" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Transient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.CassandraType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.DataType.Name</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>

        <span class="kd">public</span> <span class="nf">User</span><span class="o">(){</span>
        <span class="o">}</span>
        <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isEnabled</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isAdmin</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
        <span class="nd">@CassandraType</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="na">UDT</span><span class="o">,</span> <span class="n">userTypeName</span><span class="o">=</span><span class="s">&quot;addressofuser&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">UDTValue</span> <span class="n">address</span><span class="o">;</span>
        <span class="nd">@Transient</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;</span> <span class="n">credentials</span><span class="o">;</span>
        <span class="nd">@Transient</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;groups&quot;</span><span class="o">)</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groups</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#64;AllArgsConstructorや&#64;Builder、&#64;Dataアノテーションはコードを簡略化して記述するためのLombokアノテーションである。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Data Cassandraでは、ユーザ定義型を使用する場合、直接ユーザ定義型のクラスをプロパティとして定義する方法と、UDTValueクラスを使用する２通りの定義の仕方があるが、UDTValueを使用する場合、AP起動前に事前にCREATE TYPE文で、ユーザ定義型を定義しておく必要がある。直接クラスをプロパティに指定した場合は、設定ファイルにおいて、SchemaActionでCREATE、RECREATE等指定しておくと、AP起動時に、自動でCREATE TYPE文が発行される。</p>
</div>
<p>同様に、各テーブルと対応するクラスを各々作成する。なお、テーブルの構成や非正規化のポイントについてはユースケースごとの説明のセクションで後述するが、以下は、ユーザ定義型を使用したAddressOfUserクラスでの例である。クラスに&#64;UserDefinedTypeを付与する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-entity-addressofuser">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressOfUser</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-entity-addressofuser" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.CassandraType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.DataType.Name</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressOfUser</span> <span class="o">{</span>

        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="repository">
<span id="section6-x-x-x-usecase-implementation-patten1-repository-label"></span><h4>Repositoryクラスの作成<a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h4>
<p>作成したエンティティクラスのRepositoryクラスを作成する。<a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/usage.html#section2-1-2-spring-data-jpa-usage-simple-access-repository-label">Spring Data JPA同様</a> 、org.springframework.data.repository.CrudRepositoryを継承したインターフェースを作成し、型パラメータに作成したエンティティクラスとキーとなるデータ型を指定することで、基本的なCRUD操作を実行するメソッドをもつDAOが作成できる。以下は、Userエンティティクラスに対するRepositoryクラスの例である。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-repository-userrepository">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRepository</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-repository-userrepository" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/usage.html#section2-1-2-spring-data-jpa-usage-simple-access-repository-label">Spring Data JPA同様、命名規約に従って、メソッド名を定義すること</a> により自動でCQLが生成される。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Data JPA同様、カスタムメソッドを作成することも可能である(「特定の郵便番号を持たないユーザ一覧を取得する」にて後述)。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#8220;NOT IN&#8221;や&#8221;GROUP BY&#8221;などCQLではサポートされない構文を含めたメソッドを定義できるが、実行すると当然エラーとなる。</p>
</div>
</div>
<div class="section" id="service">
<span id="section6-x-x-x-usecase-implementation-patten1-service-label"></span><h4>Serviceクラスの作成<a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h4>
<p>ユースケースに応じて、インターフェースを作成する。なお、Spring Data JPAの例で内容が重複しているユースケースは除外した。</p>
<ul class="simple">
<li>全てのユーザを検索する。 → getUsers()</li>
<li>全ての住所を検索する。 → getAddresses()</li>
<li>全てのメールアドレスを検索する。 → getEmails()</li>
<li>全てのグループを検索する。 → getGroups()</li>
<li>特定のユーザを検索する。 → getUser(Long userId)</li>
<li>特定のユーザのアドレスを検索する。 → getAddress(Long userId)</li>
<li>特定のユーザがもつEmailアドレスを検索する。 → getEmails(Long userId)</li>
<li>指定したグループ名を元にグループを検索する。 → getGroups(String groupName)</li>
<li>特定の郵便番号を持つユーザ一覧を取得する。 → getUsers(String zipCd)</li>
<li>特定の郵便番号を持たないユーザ一覧を取得する → getNotUsers(String zipCd)</li>
<li>指定されたユーザの住所を追加する。 → addAddress(Long userId, String zipCd, String address)</li>
<li>指定されたユーザの住所を更新する。 → updateAddress(Long userId, String zipCd, String address)</li>
<li>指定されたユーザの住所を削除する。 → deleteAddress(Long userId)</li>
<li>特定のメールアドレスを持つユーザを検索する。 → getUserByEmail(String email)</li>
<li>指定されたユーザのメールアドレスを追加する。 → addEmail(Long userId, String email)</li>
<li>指定されたユーザをメールアドレスを含めて追加する。 → addUserWithEmail(Long userId, String userName, String email)</li>
<li>指定されたユーザのメールアドレスを更新する。 → updateEmail(Long userId, String email, String newEmail)</li>
<li>指定されたユーザのメールアドレスを1件削除する。 → deleteEmail(Long userId, String email)</li>
<li>指定されたユーザのメールアドレスを全件削除する。 → deleteEmails(Long userId)</li>
<li>指定したユーザが属するグループの一覧を取得する。→ getGroups(Long userId)</li>
<li>指定したグループに所属する全てのユーザ一覧を取得する。 → getUsersByGroupId(Long groupId)</li>
<li>指定したグループに所属しない全てのユーザ一覧を取得する。 → getNotUsersByGroupId(Long groupId)</li>
<li>指定したユーザを指定したグループに追加する。 → addUserToGroup(Long userId, Long groupId)</li>
<li>指定したユーザをグループから除外する。 → deleteUserFromGroup(Long userId, Long groupId)</li>
<li>指定したグループを削除し、ユーザが所属するグループの情報を更新する。 → deleteGroup(Long groupId)</li>
<li>指定されたユーザを削除し、グループのユーザ一覧を更新する。 → deleteUser(Long userId)</li>
</ul>
<p>以下の通りのServiceインターフェースを作成し、各パターンに応じたService実装クラスを作成する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-domain-service-sampleservice">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.domain.service.SampleService</span><a class="headerlink" href="#org-debugroom-sample-cassandra-domain-service-sampleservice" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SampleService</span><span class="o">&lt;</span><span class="n">U</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">E</span><span class="o">,</span> <span class="n">G</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">getAddresses</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">G</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">String</span> <span class="n">loginId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">A</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">G</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getNotUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">getUserByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">addUserWithEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">newEmail</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">G</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getNotUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">G</span> <span class="nf">addUserToGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">G</span> <span class="nf">deleteUserFromGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">G</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>以降、各々のユースケースにおいて、サービスの実装を含め、詳述する。</p>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-users-label">
<span id="id10"></span><h4>全てのユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-users-label" title="Permalink to this headline">¶</a></h4>
<p>Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Userテーブルのすべてのデータを検索する場合は、UserRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getusers">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUsers()</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getusers" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">()</span> <span class="o">{</span>
             <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
   <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-addresses-label">
<span id="id11"></span><h4>全ての住所を検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-addresses-label" title="Permalink to this headline">¶</a></h4>
<p>住所の全てのデータを一括検索する場合にはAddressエンティティクラスを作成し、テーブルを構成する必要がある。
Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Addressテーブルのすべてのデータを検索する場合は、AddressRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-entity-address">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Address</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-entity-address" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="c1">// constructor needs for avoiding repository instantiation error</span>
    <span class="kd">public</span> <span class="nf">Address</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;addresspk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AddressPK</span> <span class="n">addresspk</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">エンティティクラスは引数なしのコンストラクタが必要なことに注意。それがないと、AP起動時にレポジトリクラスをインスタンス化する際にエラーが発生する。</p>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-repository-addressrepository">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.AddressRepository</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-repository-addressrepository" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressPK</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AddressRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">AddressPK</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">通常、１つのユーザが1つの住所を保持できるようにする(リレーショナルデータモデルでいうところの1対1の関係の)場合、ユニークなIDか、ユーザIDをキーにして実現するが、ここではAddressPKというクラスを作成して主キーにしている。理由はセクション「特定の郵便番号をもつユーザを検索する」にて後述する。</p>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getaddresses">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getAddresses()</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getaddresses" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">getAddresses</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;)</span><span class="n">addressRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-emails-label">
<span id="id12"></span><h4>全てのメールアドレスを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-emails-label" title="Permalink to this headline">¶</a></h4>
<p>全てのデータを一括検索する場合にはEmailエンティティクラスを作成し、テーブルを構成する必要がある。
Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Emailテーブルのすべてのデータを検索する場合は、EmailRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-entity-email">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Email</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-entity-email" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Email</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Email</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">通常、１つのユーザが複数のメールアドレスを保持できるようにする(リレーショナルデータモデルでいうところの1対多の関係の)場合、ユニークなIDか、ユーザIDと番号などの複合主キーにして実現するが、ここではユニークな値となるメールアドレスそのものを主キーにしている。理由はセクション「特定のユーザがもつEmailアドレスを検索する」にて後述する。</p>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-repository-emailrepository">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.EmailRepository</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-repository-emailrepository" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmailRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getemails">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getEmails()</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getemails" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;)</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-groups-label">
<span id="id13"></span><h4>全てのグループを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-groups-label" title="Permalink to this headline">¶</a></h4>
<p>全てのデータを一括検索する場合にはGroupエンティティクラスを作成し、テーブルを構成する必要がある。
Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Groupテーブルのすべてのデータを検索する場合は、GroupRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-entity-group">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Group</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-entity-group" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Group</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

 <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-repository-grouprepository">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.GroupRepository</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-repository-grouprepository" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GroupRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getgroups">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getGroups()</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getgroups" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;)</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-user-label">
<span id="id14"></span><h4>特定のユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-user-label" title="Permalink to this headline">¶</a></h4>
<p>ユーザデータをプライマリーキーuserIdを使用して検索する場合には、Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。UserRepository.findOne(Long userId)を使用する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getuser-long-userid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUser(Long userId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getuser-long-userid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-address-label">
<span id="id15"></span><h4>特定のユーザのアドレスを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-address-label" title="Permalink to this headline">¶</a></h4>
<p>特定のユーザIDをキーに住所を検索する場合、いくつか方法がある。他にどのような住所検索のクエリが必要かによって、適切な実装方法は異なる。まず、ここでは、エンティティUserにユーザ定義型AddressOfUserを定義して、ユーザテーブルから非正規化した住所データを取得する例を記載する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>

        <span class="kd">public</span> <span class="nf">User</span><span class="o">(){</span>
        <span class="o">}</span>
        <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>

        <span class="c1">// omit</span>

        <span class="nd">@CassandraType</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="na">UDT</span><span class="o">,</span> <span class="n">userTypeName</span><span class="o">=</span><span class="s">&quot;addressofuser&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">UDTValue</span> <span class="n">address</span><span class="o">;</span>     <span class="c1">// ユーザ定義型AddressOfUserを使用してデータを非正規化する。</span>

<span class="o">}</span>
</pre></div>
</div>
<p>当然Addressテーブルにも同じ住所のデータはあるが、このように非正規化している理由は、後述するユースケース「特定の郵便番号を持つユーザ一覧を取得する」でも示すように、郵便番号をAddressテーブルの検索条件のキーに持たせる必要があり、Addressエンティティではプライマリキーとして、郵便番号とユーザIDを複合主キーとしたAddressPKを作成しているため、Addressテーブルは、userId単体ではデフォルトそのままでは検索キーとして使用できないためである。</p>
<div class="literal-block-wrapper container" id="id16">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Addressが使用できない理由</span><a class="headerlink" href="#id16" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Address</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;addresspk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AddressPK</span> <span class="n">addresspk</span><span class="o">;</span> <span class="c1">//Addressテーブルの検索にはaddressPKのzipCdが必要。</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-entity-addresspk">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressPK</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-entity-addresspk" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.PrimaryKeyType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyColumn</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@PrimaryKeyClass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressPK</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">public</span> <span class="nf">AddressPK</span><span class="o">(){}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">828112214783052932L</span><span class="o">;</span>

    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zip_cd&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">PARTITIONED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span> <span class="c1">// zipCdはパーティションキーで指定しているので必須</span>
    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">CLUSTERED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span> <span class="c1">// userIdはクラスタカラムとして指定しているので必須ではない</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">AddressPKクラスにおいて、クラスタカラムとして定義しているuserIdを単体の検索キーとして利用するには、セカンダリインデックスを作成すれば可能であるが、<a class="reference external" href="https://docs.datastax.com/ja/cql-jajp/3.3/cql/cql_using/useWhenIndex.html">DataStax社の提供するCassandraのドキュメント</a> ではカーディナリティの高い(バラエティが多い)データで、セカンダリインデックスを作るのは推奨していない。カーディナリティの高いデータに対してはマテリアライズドビューの作成を推奨しているが、いずれにせよパーティションキーである郵便番号が必要になる。</p>
</div>
<p>Serviceの実装クラスでは、Userテーブルから非正規化した住所データをcom.datastax.driver.core.UDTValueの形式で取得している。
これをAddressクラスにデータを移した返却している。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getaddress-long-userid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getAddress(Long userId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getaddress-long-userid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">getAddress</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">udtValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">addresspk</span><span class="o">(</span><span class="n">AddressPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                          <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                          <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                      <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">com.datastax.driver.core.UDTValueは今回サンプルとして使用方法を記述しているが、特定のベンダのパッケージにServiceクラスが依存してしまうのであまり使用しない方が良い。Spring Data Cassandraでは、ユーザ定義型はUDTValueクラスを使用せずとも直接&#64;UserDefinedTypeアノテーションが付与されたクラスを変数宣言すると使用可能なのでそちらの利用を推奨。</p>
</div>
</div>
<div class="section" id="email">
<span id="section6-x-x-x-usecase-implementation-patten1-get-email-label"></span><h4>特定のユーザがもつEmailアドレスを検索する<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h4>
<p>Emailテーブルでは、Emailがプライマリキーであるため、CQLのwhere句の条件にuserIdは指定できない。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Email</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Email</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span> <span class="c1">// &lt;---通常ではプライマリキーしかwhere句に指定できない</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>  <span class="c1">// &lt;---セカンダリインデックスを指定等すれば、検索キーとしては利用可能。</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<p>特定のユーザがもつEmailアドレスを検索する場合、こちらも「特定のユーザのアドレスを検索する」と同様、ユーザテーブルに非正規化されたEmailデータを持たせるのが簡易ではあるが、こちらのユースケースでは、逆に非正規化せず、プライマリーキー以外の項目をwhere条件で指定して検索する方法で実装する。基本的には、セカンダリインデックスを作成するか、EmailRepositoryクラスにCQLを定義し、オプションでallow filteringオプションを指定するか、マテリアライズドビューを作成すれば可能である。ここでは、EmailRepositoryインターフェースにfindByUserIdメソッドを定義し、allow filteringオプションを付与した例を有効化している。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmailRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>

    <span class="c1">// Use secondary index or materialized view depending on data cardinality.</span>
    <span class="c1">// (Not recommend) 1. Create secondary index</span>
    <span class="c1">// &quot;create index on sample.email (user_id);&quot;</span>
        <span class="c1">// @Query(&quot;select * from email where user_id = ?0&quot;)</span>
    <span class="c1">// (Not recommend) 2. Add allow filtering option to cql.</span>
        <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;select * from email where user_id = ?0 allow filtering&quot;</span><span class="o">)</span>
    <span class="c1">// (Recommend) 3. Use materialized view</span>
        <span class="c1">// &quot;create materialized view email_by_user_id as select email, user_id, ver, last_updated_date from email where user_id is not null and email is not null primary key(user_id, email);&quot;</span>
    <span class="c1">//@Query(&quot;select * from email_by_user_id where user_id = ?0&quot;)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">findByUserId</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">userIdはユニークな値なので、本来一番推奨される方法はマテリアライズドビューを使用する方法である。</p>
</div>
<p>Service実装クラスからは、定義したメソッドEmailRepository.findByUserId()を実行すれば良い。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getemails-long-userid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getEmails(Long userId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getemails-long-userid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
     <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-group-by-groupname-label">
<span id="id17"></span><h4>指定したグループ名を元にグループを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-group-by-groupname-label" title="Permalink to this headline">¶</a></h4>
<p>Groupテーブルでは、groupIdがプライマリキーであるため、CQLのwhere句の条件にgroupNameは指定できない。</p>
<div class="highlight-java"><div class="highlight"><pre>  package org.debugroom.sample.cassandra.pattern1.domain.entity;

  // omit import statement.

  @AllArgsConstructor
  @Builder
  @Data
  @Table(&quot;group&quot;)
  public class Group {

      public Group(){
      }

      @PrimaryKey(&quot;group_id&quot;)
      private Long groupId;   // &lt;-- where句に条件指定ができる
      @Column(&quot;group_name&quot;)
      private String groupName; // &lt;-- where句に条件指定ができない
      // omit

   }

こちらも、「特定のユーザがもつEmailアドレスを検索する  」と同様、GroupRepositoryインターフェースにfindByGroupNameメソッドを定義し、allow filteringオプションを付与した例を有効化している。

.. sourcecode:: java

   package org.debugroom.sample.cassandra.pattern1.domain.repository;

   import java.util.List;

   import org.debugroom.sample.cassandra.pattern1.domain.entity.Group;
   import org.springframework.data.cassandra.repository.Query;
   import org.springframework.data.repository.CrudRepository;

   public interface GroupRepository extends CrudRepository&lt;Group, Long&gt;{

           // Use query adding allow filtering option or secondary index or materialized view.
           @Query(&quot;select * from group where group_name = ?0 allow filtering&quot;)
           public List&lt;Group&gt; findByGroupName(String groupName);

   }
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">検索キーとなる項目のカーディナリティに応じて、適切な方法を選択するために、目安となるベンチマークを測定する。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-users-by-zipcd-label">
<span id="id18"></span><h4>特定の郵便番号を持つユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-users-by-zipcd-label" title="Permalink to this headline">¶</a></h4>
<p>リレーショナルモデルでは1対1関連として扱いたいUserとAddressエンティティの関係であるが、特定の項目をキーにした検索が必要なユースケースでは、その項目をプライマリキーにしておくことで高速な検索が見込める。ここでは、郵便番号と、ユーザIDをプライマリキーをAddressPKクラスとして定義した例で実装する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;addresspk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AddressPK</span> <span class="n">addresspk</span><span class="o">;</span> <span class="c1">//&lt;-プライマリキークラスを作成。</span>

   <span class="c1">// omit.</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.PrimaryKeyType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyColumn</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@PrimaryKeyClass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressPK</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">public</span> <span class="nf">AddressPK</span><span class="o">(){}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">828112214783052932L</span><span class="o">;</span>

    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zip_cd&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">PARTITIONED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span> <span class="c1">// パーティションキーとして定義</span>
    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">CLUSTERED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>  <span class="c1">// クラスタカラムキーとして定義</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>パーティションキーはどのノードにデータを配置するかを決定する重要なキーである。
パーティションキーの指定なしに検索を行うと、どのノードにデータが配置されているかをトレースせねばならず、
ノードが増えるごとに線形的に検索速度は低下する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/partitionkey.png"><img alt="../../_images/partitionkey.png" src="../../_images/partitionkey.png" /></a>
</div>
<p class="last">クラスタカラムキーはパーティションに格納されたデータのキーとなる項目である。</p>
</div>
<p>Serviceクラスの実装では、まずパーティションキーであるzipCdを指定して、対象のAddressオブジェクトのリストを取得したのち、AddressオブジェクトのuserIdのリストを作って、IN句を使ってユーザデータを検索する。zipCdをキーにアドレスリストを取得するためにAddressRepositoryにfindByAddresspkZipCdメソッドを定義する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressPK</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AddressRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">AddressPK</span><span class="o">&gt;{</span>

   <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">findByAddresspkZipCd</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">メソッドの命名規約により、Spring Data Cassandraが、findByAddresspxZipCdでAddressPKクラスのzipCdをキーにCQLを組み立てる。なお、ネストされたクラスはキャメルケースによりプロパティ名を推定するが、英大文字小文字の区別を明確化するために&#64;PraimaryKeyで変数名を明確に定義しておくこと。</p>
</div>
<p>また、UserRepositoryインターフェースにIN句を使用したCQLを実行するよう、findByUserIdIn(List&lt;Long&gt; userIds)メソッドを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserIdIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Service実装クラスでは、</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getusers-string-zipcd">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUsers(String zipCd)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getusers-string-zipcd" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkZipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addresses</span><span class="o">){</span>
            <span class="n">userIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getAddresspk</span><span class="o">().</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByUserIdIn</span><span class="o">(</span><span class="n">userIds</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">IN句の実行速度が不明のため、マルチノードでデータを分散した場合の実行速度を計測して評価すること。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-not-users-by-zipcd-label">
<span id="id19"></span><h4>特定の郵便番号を持たないユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-not-users-by-zipcd-label" title="Permalink to this headline">¶</a></h4>
<p>特定の郵便番号を持たないユーザの一覧だと、「特定の郵便番号を持つユーザ一覧を取得する」場合の論理否定であるが、CQLではNOT IN句をサポートしていない。そのため、別の方法で全体のユーザから特定の郵便番号をもつユーザを除外することで、持たないユーザ一覧を作成する。
1件ずつ対象のユーザをループでチェックするとデータが大きくなった場合、指数関数的に増加するため、Map型でユーザの一覧を取得し、特定の郵便番号を持つユーザのリストから除外する方法で実装する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getnotusers-string-zipcd">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getNotUsers(String zipCd)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getnotusers-string-zipcd" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getNotUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>

        <span class="cm">/* Not_In statement is no-supported for cassandra.</span>
<span class="cm">        List&lt;Address&gt; addresses = addressRepository.findByAddresspkZipCd(zipCd);</span>
<span class="cm">        List&lt;Long&gt; userIds = new ArrayList&lt;Long&gt;();</span>
<span class="cm">        for(Address address : addresses){</span>
<span class="cm">            userIds.add(address.getAddresspk().getUserId());</span>
<span class="cm">        }</span>
<span class="cm">        return userRepository.findByUserIdNotIn(userIds);</span>
<span class="cm">        */</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkZipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">usersMap</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMap</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addresses</span><span class="o">){</span>
            <span class="n">usersMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getAddresspk</span><span class="o">().</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">usersMap</span><span class="o">.</span><span class="na">values</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>検索結果をMap型で返却するメソッドはSpring Dataでは標準ではサポートされていないため、カスタムレポジトリクラスを作成し、Map型で返却するよう拡張する。なお、データのマッピングはorg.springframework.cassandra.core.ResultSetExtractorを利用する。まず、Repositoryを拡張するためのカスタムインターフェースを作成する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-repository-userrespositorycustom">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRespositoryCustom</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-repository-userrespositorycustom" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepositoryCustom</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>カスタムインターフェースをUserRepositoryクラスに継承させる。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserIdIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserIdNotIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<p>カスタムインターフェースの実装クラスを作成する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-repository-impl-userrepositoryimpl">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.impl.UserRepositoryImpl</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-repository-impl-userrepositoryimpl" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryImpl</span> <span class="kd">implements</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserMapExtractor</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Repositoryインターフェースと同一のパッケージに配置していると、メソッド名命名規約のチェックが発生して、(ここではForMapという変数がない等でエラーが発生してしまう。)自由なメソッド名を設定できなくなるため、レポジトリ実装クラスは&#64;NoRepositoryBeanアノテーションを付与し、別パッケージに配置すること。</p>
</div>
<p>また、ResultSetとエンティティクラスのカラムマッピングの拡張で、ResultSetExtractorを継承したクラスを以下の通り実装する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-repository-impl-usermapextractor">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.impl.UserMapExtractor</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-repository-impl-usermapextractor" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.ResultSetExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.DataAccessException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.exceptions.DriverException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.GroupOfUser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMapExtractor</span> <span class="kd">implements</span> <span class="n">ResultSetExtractor</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">extractData</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">resultSet</span><span class="o">)</span>
                                <span class="kd">throws</span> <span class="n">DriverException</span><span class="o">,</span> <span class="n">DataAccessException</span> <span class="o">{</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">hasNext</span><span class="o">()){</span>
            <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">resultSet</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupOfUsers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;();</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getUDTValue</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">))</span>
<span class="c1">//                          .groups(row.getList(&quot;groups&quot;, GroupOfUser.class))</span>
                            <span class="o">.</span><span class="na">groups</span><span class="o">(</span><span class="n">groupOfUsers</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span> <span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;groups&quot;</span><span class="o">);</span>
            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="n">groups</span><span class="o">){</span>
                <span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">GroupOfUser</span><span class="o">();</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setGroupId</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">));</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setGroupName</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">));</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setVer</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">));</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setLastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">));</span>
                <span class="n">groupOfUsers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">userMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">),</span> <span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="k">return</span> <span class="n">userMap</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ユーザ定義型のListオブジェクトのマッピングがRow.getList()メソッドではうまく動作しなかったため、row.getObject()にてリスト型データを取得し、マッピングし直している。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-address-label">
<span id="id20"></span><h4>指定されたユーザの住所を追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-address-label" title="Permalink to this headline">¶</a></h4>
<p>指定されたユーザの住所データを追加する場合は、Repositoryクラスのsaveメソッドを利用すれば良いが、本サンプルでは郵便番号検索や、住所全件検索のために住所データをAddressテーブルと、UserテーブルのAddressOfUserプロパティに非正規化している。そのため、Service実装クラスでは、２回データの追加を行うことになる。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-addaddress-long-userid-string-zipcd-string-address">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addAddress(Long userId, String zipCd, String address)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-addaddress-long-userid-string-zipcd-string-address" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Add data to Address Table</span>
        <span class="n">Address</span> <span class="n">saveAddress</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                     <span class="o">.</span><span class="na">addresspk</span><span class="o">(</span><span class="n">AddressPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                         <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                                         <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">)</span>
                                                         <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                     <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
                                     <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                     <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">saveAddress</span><span class="o">);</span>
        <span class="c1">// Add data to Address of User</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">addAddress</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>また、AddressOfUserはユーザ定義型としてUDTValueを使用しているので、カスタムレポジトリに追加で実装を行う。
UDTValueは org.springframework.data.cassandra.core.CassandraAdminOperationsからKeyspaceMetadataを取得し、UserTypeを使って生成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.KeyspaceMetadata</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UserType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryImpl</span> <span class="kd">implements</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraAdminOperations&quot;</span><span class="o">)</span>
    <span class="n">CassandraAdminOperations</span> <span class="n">cassandraAdminOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">);</span>
       <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserMapExtractor</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// For instantiating udtvalue object, need to use cassandraadminoperations.</span>
        <span class="n">KeyspaceMetadata</span> <span class="n">keyspaceMetadata</span> <span class="o">=</span> <span class="n">cassandraAdminOperations</span><span class="o">.</span><span class="na">getKeyspaceMetadata</span><span class="o">();</span>
        <span class="n">UserType</span> <span class="n">userTypeAddress</span> <span class="o">=</span> <span class="n">keyspaceMetadata</span><span class="o">.</span><span class="na">getUserType</span><span class="o">(</span><span class="s">&quot;addressofuser&quot;</span><span class="o">);</span>

        <span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">=</span> <span class="n">userTypeAddress</span><span class="o">.</span><span class="na">newValue</span><span class="o">();</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">,</span> <span class="n">zipCd</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">udtValue</span><span class="o">);</span>

        <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>なお、 org.springframework.data.cassandra.core.CassandraAdminOperationsが使用可能なよう、Bean定義を行なっておくこと。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-confing-infra-commoncassandraconfig">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.confing.infra.CommonCassandraConfig</span><a class="headerlink" href="#org-debugroom-sample-cassandra-confing-infra-commoncassandraconfig" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.config.infra</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.config.SchemaAction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.config.java.AbstractCassandraConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.convert.CassandraConverter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Session</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CommonCassandraConfig</span> <span class="kd">extends</span> <span class="n">AbstractCassandraConfiguration</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">SchemaAction</span> <span class="nf">getSchemaAction</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">CREATE_IF_NOT_EXISTS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CassandraTemplate</span> <span class="nf">cassandraTemplate</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CassandraTemplate</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CassandraAdminOperations</span> <span class="nf">cassandraAdminOperations</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CassandraAdminTemplate</span><span class="o">(</span><span class="n">session</span><span class="o">().</span><span class="na">getObject</span><span class="o">(),</span> <span class="n">cassandraConverter</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-update-address-label">
<span id="id21"></span><h4>指定されたユーザの住所を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-update-address-label" title="Permalink to this headline">¶</a></h4>
<p>指定されたユーザの住所データを更新する場合、Cassandraでは既にキーがあるデータの追加は更新として扱われるため、Repositoryクラスのsaveメソッドを利用すれば良い。ただし、本サンプルでは郵便番号検索や、住所全件検索のために住所データをAddressテーブルと、UserテーブルのAddressOfUserプロパティに非正規化している。そのため、Service実装クラスでは、２回データの追加を行うことになる。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-updateaddress-long-userid-string-zipcd-string-address">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#updateAddress(Long userId, String zipCd, String address)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-updateaddress-long-userid-string-zipcd-string-address" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">updateAddress</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span>
                                    <span class="n">AddressPK</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setVer</span><span class="o">(</span><span class="n">updateAddress</span><span class="o">.</span><span class="na">getVer</span><span class="o">()+</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setLastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">updateAddress</span><span class="o">);</span>

        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">,</span> <span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)+</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-address-label">
<span id="id22"></span><h4>指定されたユーザの住所を削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-address-label" title="Permalink to this headline">¶</a></h4>
<p>指定されたユーザの住所データを削除する場合、Repositoryクラスのdeleteメソッドを利用すれば良い。ただし、本サンプルでは郵便番号検索や、住所全件検索のために住所データをAddressテーブルと、UserテーブルのAddressOfUserプロパティに非正規化している。そのため、Service実装クラスでは、Addressテーブルについては、delete()メソッドで削除を行い、UserオブジェクトではNULLを設定する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteaddress-long-userid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteAddress(Long userId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteaddress-long-userid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addresses</span><span class="o">){</span>
            <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-user-by-email-label">
<span id="id23"></span><h4>特定のメールアドレスを持つユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-user-by-email-label" title="Permalink to this headline">¶</a></h4>
<p>特定のEmailからユーザを検索する場合、Email Tableはemailをプライマリキーとしたテーブル構造となっているので、対象のEmailを取得したのち、userIdをキーにしてUserテーブルからデータを取得する。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getuserbyemail-string-email">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUserByEmail(String email)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getuserbyemail-string-email" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span>
            <span class="n">emailRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">email</span><span class="o">).</span><span class="na">getUserId</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-email-label">
<span id="id24"></span><h4>指定されたユーザのメールアドレスを追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-email-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを追加する場合は、EmailRepository.save()メソッドを使用すればよい。なお、UserクラスのList&lt;Email&gt;は&#64;Transientを付与しているので、特に永続化はされない。あくまでView層に返す際にデータを設定しているだけである。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-addemail-long-userid-string-email">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addEmail(Long userId, String email)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-addemail-long-userid-string-email" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">addEmail</span> <span class="o">=</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                              <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="n">emails</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-user-with-email-label">
<span id="id25"></span><h4>指定されたユーザをメールアドレスを含めて追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-user-with-email-label" title="Permalink to this headline">¶</a></h4>
<p>ユーザデータと一緒にEmailを追加する場合も、それぞれUserRepository.save()、EmailRepository.save()メソッドを使って各々データを保存すれば良い。なお、UserクラスのList&lt;Email&gt;は&#64;Transientを付与しているので、特に永続化はされない。あくまでView層に返す際にデータを設定しているだけである。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-adduserwithemail-long-userid-string-username-string-email">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addUserWithEmail(Long userId, String userName, String email)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-adduserwithemail-long-userid-string-username-string-email" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addUserWithEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">addEmail</span> <span class="o">=</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                              <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
        <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">addUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                           <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">userName</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">emails</span><span class="o">(</span><span class="n">emails</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                           <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">addUser</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-update-email-label">
<span id="id26"></span><h4>指定されたユーザのメールアドレスを更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-update-email-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを更新する場合、Emailはプライマリキーであるため、そのまま更新をかけようとすると、新たなキーとしてデータが追加されてしまうため、一度データを削除して、追加を行う形でデータ更新を行う必要がある。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-updateemail-long-userid-string-email-string-newemail">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#updateEmail(Long userId, String email, String newEmail)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-updateemail-long-userid-string-email-string-newemail" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">newEmail</span><span class="o">)</span> <span class="o">{</span>

        <span class="cm">/* Primary key updating equals new saving row.</span>
<span class="cm">        Email updateEmail = emailRepository.findOne(email);</span>
<span class="cm">        updateEmail.setEmail(newEmail);</span>
<span class="cm">        emailRepository.save(updateEmail);</span>
<span class="cm">        */</span>

        <span class="n">Email</span> <span class="n">deleteEmail</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteEmail</span><span class="o">);</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                  <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">newEmail</span><span class="o">)</span>
                                      <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                  <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-email-label">
<span id="id27"></span><h4>指定されたユーザのメールアドレスを1件削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-email-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを削除する場合、単純に指定されたEmailオブジェクトを取得し、EmailRepository.delete()メソッドを実行すれば良い。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteemail-long-userid-string-email">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteEmail(Long userId, String email)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteemail-long-userid-string-email" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">deleteEmail</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteEmail</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-emails-label">
<span id="id28"></span><h4>指定されたユーザのメールアドレスを全件削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-emails-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを全て削除する場合、ユーザIDをキーにEmailオブジェクトのリストを取得し、各データをEmailRepository.delete()メソッドを実行して各々削除すれば良い。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteemails-long-userid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteEmails(Long userId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteemails-long-userid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span> <span class="o">:</span> <span class="n">emails</span><span class="o">){</span>
            <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-group-by-userid-label">
<span id="id29"></span><h4>指定したユーザが属するグループの一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-group-by-userid-label" title="Permalink to this headline">¶</a></h4>
<p>指定したユーザが所属するグループを検索する場合、リレーショナルモデルでは通常多対多の関連を持ち、関連実体となるテーブル(例えば所属など)を結合して、データを取得する方法が一般的であるが、Cassandraでは結合はサポートされていない。ここでは、全件検索したGroupテーブルとは別にUserテーブルにGroupのListデータを持たせて非正規化を行う。理由は、次セクション「指定したグループに所属する全てのユーザ一覧を取得する」で説明するが、逆にGroupにもUserのデータを持たせる必要があるため、相互参照(循環参照)とならないよう、Userエンティティにユーザ定義型クラスGroupOfUserクラスを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>

        <span class="kd">public</span> <span class="nf">User</span><span class="o">(){</span>
        <span class="o">}</span>
        <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>

        <span class="c1">// omit</span>

        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;groups&quot;</span><span class="o">)</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groups</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-entity-groupofuser">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.GroupOfUser</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-entity-groupofuser" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupOfUser</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nf">GroupOfUser</span><span class="o">(){}</span>
    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>データの取得は単純にUserRepositoryからUserデータを取得し、Groupを返すだけで良い。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getgroups-long-userid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getGroups(Long userId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getgroups-long-userid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupsOfUser</span> <span class="o">=</span>  <span class="n">getGroupsOfUser</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Lists</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">groupsOfUser</span><span class="o">,</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Group</span> <span class="nf">apply</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">mapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">,</span> <span class="n">Group</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="nf">getGroupsOfUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">getGroups</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ここではList&lt;Group&gt;を返却するためにList&lt;GroupOfUser&gt;を、GuavaのListsクラスを使って変換している。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-users-by-groupid-label">
<span id="id30"></span><h4>指定したグループに所属する全てのユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-users-by-groupid-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザが属するグループの一覧を取得する」と同様、こちらは逆パターンであり、GroupエンティティにもUserデータのListを保持し、非正規化する。同様にUserクラスもGroupのデータを保持する必要があるため、相互にUser -&gt; Group、Group -&gt; Userの参照をもつと相互参照(循環参照)になってしまうため、ここでもGroup内にUserと同じプロパティをもつUserOfGroupをユーザ定義型クラスとして作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Group</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserOfGroup</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nf">UserOfGroup</span><span class="o">(){}</span>
    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isEnabled</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isAdmin</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Service実装クラスからはGroupRepositoryを介してデータを取得し、返却するだけで良い。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getusersbygroupid-long-groupid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUsersByGroupId(Long groupId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getusersbygroupid-long-groupid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="n">getUsersOfGroup</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Lists</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">usersOfGroup</span><span class="o">,</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;(){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">User</span> <span class="nf">apply</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">mapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="nf">getUsersOfGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">).</span><span class="na">getUsers</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ここではList&lt;User&gt;を返却するためにList&lt;UserOfGroup&gt;を、GuavaのListsクラスを使って変換している。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-not-users-by-groupid-label">
<span id="id31"></span><h4>指定したグループに所属しない全てのユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-not-users-by-groupid-label" title="Permalink to this headline">¶</a></h4>
<p>ユースケース「特定の郵便番号を持たないユーザ一覧を取得する」と同じく、特定のグループに所属するユーザを全体のユーザから除外したリストを返却すれば良い。Service実装クラスは、</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getnotusersbygroupid-long-groupid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getNotUsersByGroupId(Long groupId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-getnotusersbygroupid-long-groupid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getNotUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">).</span><span class="na">getUsers</span><span class="o">();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMap</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">usersOfGroup</span><span class="o">){</span>
            <span class="n">userMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userMap</span><span class="o">.</span><span class="na">values</span><span class="o">());</span>
         <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">UserRepository.findAllForMap()はユースケース「特定の郵便番号を持たないユーザ一覧を取得する」で作成したカスタムUserRepositoryクラスのメソッドである。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-user-to-group-label">
<span id="id32"></span><h4>指定したユーザを指定したグループに追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-user-to-group-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザが属するグループの一覧を取得する」、「指定したグループに所属する全てのユーザ一覧を取得する」のユースケースにおいて、User及びGroupエンティティにそれぞれ非正規化されたデータが定義されている。そのため、各テーブルに相互に整合性が取れた形でデータを保存する必要がある。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-addusertogroup-long-userid-long-groupid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addUserToGroup(Long userId, Long groupId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-addusertogroup-long-userid-long-groupid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">addUserToGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="n">group</span><span class="o">.</span><span class="na">getUsers</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">UserOfGroup</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isLocked</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isAdmin</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">getGroups</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">GroupOfUser</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">groupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-user-from-group-label">
<span id="id33"></span><h4>指定したユーザをグループから除外する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-user-from-group-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザを指定したグループに追加する」と同様、非正規化されたデータに対し、双方データ更新を行う必要がある。
Listデータからremove()すると実装が複雑化するので、除外しないデータだけで新たなListを作成し、更新する実装とする。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteuserfromgroup-long-userid-long-groupid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteUserFromGroup(Long userId, Long groupId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteuserfromgroup-long-userid-long-groupid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteUserFromGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupsOfUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getGroups</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">groupId</span> <span class="o">!=</span> <span class="n">groupOfUser</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()){</span>
                <span class="n">groupsOfUser</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setGroups</span><span class="o">(</span><span class="n">groupsOfUser</span><span class="o">);</span>
        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">group</span><span class="o">.</span><span class="na">getUsers</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">userId</span> <span class="o">!=</span> <span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()){</span>
                <span class="n">usersOfGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">);</span>
            <span class="o">}</span>
                <span class="o">}</span>
        <span class="n">group</span><span class="o">.</span><span class="na">setUsers</span><span class="o">(</span><span class="n">usersOfGroup</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-group-label">
<span id="id34"></span><h4>指定したグループを削除し、ユーザが所属するグループの情報を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-group-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザを指定したグループに追加する」と同様、非正規化されたデータに対し、双方データ更新を行う必要がある。
Listデータからremove()すると実装が複雑化するので、除外しないデータだけで新たなListを作成し、更新する実装とする。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deletegroup-long-groupid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteGroup(Long groupId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deletegroup-long-groupid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Group</span> <span class="n">deleteGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">deleteGroup</span><span class="o">.</span><span class="na">getUsers</span><span class="o">()){</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupsOfUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;();</span>
            <span class="k">for</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getGroups</span><span class="o">()){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()</span> <span class="o">!=</span> <span class="n">groupId</span><span class="o">){</span>
                    <span class="n">groupsOfUser</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setGroups</span><span class="o">(</span><span class="n">groupsOfUser</span><span class="o">);</span>
            <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
                <span class="n">groupRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteGroup</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">deleteGroup</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-user-label">
<span id="id35"></span><h4>指定されたユーザを削除し、グループのユーザ一覧を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-user-label" title="Permalink to this headline">¶</a></h4>
<p>ユーザデータを削除するにあたり、これまで非正規化したテーブルなど含めて全てデータ更新する必要がある。</p>
<div class="literal-block-wrapper container" id="org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteuser-long-userid">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteUser(Long userId)</span><a class="headerlink" href="#org-debugroom-sample-cassandra-pattern1-domain-service-sampleserviceimpl-deleteuser-long-userid" title="Permalink to this code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">deleteUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">:</span> <span class="n">deleteUser</span><span class="o">.</span><span class="na">getGroups</span><span class="o">()){</span>
            <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">());</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;();</span>
            <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">group</span><span class="o">.</span><span class="na">getUsers</span><span class="o">()){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">userId</span> <span class="o">!=</span> <span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()){</span>
                    <span class="n">usersOfGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">group</span><span class="o">.</span><span class="na">setUsers</span><span class="o">(</span><span class="n">usersOfGroup</span><span class="o">);</span>
            <span class="n">groupRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">)){</span>
            <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span> <span class="o">:</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">)){</span>
            <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Credential</span> <span class="n">credential</span> <span class="o">:</span> <span class="n">credentialRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">)){</span>
            <span class="n">credentialRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">credential</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteUser</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">deleteUser</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">ノード数を増やした状態で検証し、性能問題が起きないか検証を行う。</p>
</div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-differenece-rdb-consistency-problem-label">
<span id="id36"></span><h2>データ整合性に問題が生じるケース<a class="headerlink" href="#section6-x-x-differenece-rdb-consistency-problem-label" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section6-x-x-differenece-rdb-consistency-problem-denormalization-label">
<span id="id37"></span><h3>非正規化によるデータ分散による不整合<a class="headerlink" href="#section6-x-x-differenece-rdb-consistency-problem-denormalization-label" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="section6-x-x-differenece-rdb-consistency-problem-replication-label">
<span id="id38"></span><h3>レプリケーション間のデータ不整合<a class="headerlink" href="#section6-x-x-differenece-rdb-consistency-problem-replication-label" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="section6-x-x-differenece-design-method-label">
<span id="id39"></span><h2>設計手順<a class="headerlink" href="#section6-x-x-differenece-design-method-label" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>リレーショナルモデルの設計手順</li>
</ul>
<ol class="arabic simple">
<li>概念データモデル・論理設計<ol class="arabic">
<li>エンティティの抽出</li>
<li>エンティティモデル定義</li>
<li>正規化</li>
<li>ER図の作成</li>
</ol>
</li>
<li>ユースケース記述・処理設計<ol class="arabic">
<li>サービスインターフェース設計</li>
<li>ドメインインターフェース設計</li>
<li>コンポーネント処理設計(クエリ設計)</li>
</ol>
</li>
<li>物理設計<ol class="arabic">
<li>テーブル定義</li>
<li>インデックス定義</li>
<li>ハードウェアサイジング</li>
<li>ストレージ冗長化構成</li>
<li>物理配置設計</li>
</ol>
</li>
</ol>
<ul class="simple">
<li>Cassandraでの設計手順</li>
</ul>
<ol class="arabic simple">
<li>概念データモデル・論理設計<ol class="arabic">
<li>エンティティの抽出</li>
<li>エンティティモデル定義</li>
</ol>
</li>
<li>ユースケース記述・処理設計<ol class="arabic">
<li>サービスインターフェース設計</li>
<li>ドメインインターフェース設計</li>
<li>コンポーネント処理設計(クエリ設計)</li>
</ol>
</li>
<li>物理設計<ol class="arabic">
<li>テーブル定義</li>
<li>インデックス定義</li>
<li>物理配置設計</li>
</ol>
</li>
</ol>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../memo/work/index.html" class="btn btn-neutral float-right" title="work guideline" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="spring-integration.html" class="btn btn-neutral" title="Cassandra - SpringFrameworkアプリケーション" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, org.debugroom.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1-SNAPSHOTS',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>