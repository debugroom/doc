

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>データモデリング &mdash; document 0.1-SNAPSHOTS documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="トラブルシューティング" href="trouble-shooting.html" />
    <link rel="prev" title="Cassandra - SpringFrameworkアプリケーション" href="spring-integration.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> document
          

          
          </a>

          
            
            
              <div class="version">
                0.1-SNAPSHOTS
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../java/javaee/jpa/index.html">JavaEE JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/javaee/jBatch/index.html">JavaEE jBatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/spring/spring-boot/index.html">Spring Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/spring/spring-data-jpa/index.html">Spring Data JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/spring/spring-cloud-aws/index.html">Spring Cloud AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java/spring/spring-cloud-function/index.html">Spring Cloud Function</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cassandra</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html">Cassandraのインストール</a></li>
<li class="toctree-l2"><a class="reference internal" href="launch.html">Cassandraの起動</a></li>
<li class="toctree-l2"><a class="reference internal" href="definition.html">データベースの定義</a></li>
<li class="toctree-l2"><a class="reference internal" href="manipulate.html">データベースの操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="spring-integration.html">Cassandra - SpringFrameworkアプリケーション</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">データモデリング</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-cassandra-discussion-label">検証のポイント</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-cassandra-use-case-label">ユースケース</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-differenece-relational-data-modeling-label">データベースやクエリにおける相違点</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rdbmscassandra">RDBMSとCassandra</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spring-data-cassandra">Spring Data Cassandraを使用したユースケースの実装</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-x-usecase-implementation-patten1-entity-label">エンティティクラスの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-x-usecase-implementation-using-spring-data-cassandra-simple-patten1-label">パターン1(非正規化モデル)を中心としたデータモデル</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-x-usecase-implementation-using-spring-data-cassandra-patten2-label">パターン2(リレーショナルモデル)を中心としたデータモデル</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-x-differenece-rdb-consistency-problem-label">データ整合性に問題が生じるケース</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-differenece-rdb-consistency-problem-denormalization-label">非正規化によるデータ分散による不整合</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section6-x-x-differenece-rdb-consistency-problem-replication-label">レプリケーション間のデータ不整合</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cassandra">Cassandraにおけるデータモデリングのポイント</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section6-x-x-differenece-design-method-label">設計手順</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="trouble-shooting.html">トラブルシューティング</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/aws/index.html">Amazon web service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cloud/kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../convention/app-infra/index.html">AP基盤処理方式・実装規約</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../memo/work/index.html">work guideline</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">document</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Cassandra</a> &raquo;</li>
        
      <li>データモデリング</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/database/cassandra/datamodeling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="section6-cassndra-data-modeling-label">
<span id="id1"></span><h1>データモデリング<a class="headerlink" href="#section6-cassndra-data-modeling-label" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">この内容は検証中であり、検証の結果によっては記載内容を変更する可能性がある事に注意。</p>
</div>
<p>実際に検証した結果は、<a class="reference external" href="https://github.com/debugroom/sample/tree/feature/sample-spring-cassandra/sample-spring-cassandra">GitGubのソースコード</a> を参照のこと。</p>
<div class="section" id="section6-x-cassandra-discussion-label">
<span id="id2"></span><h2>検証のポイント<a class="headerlink" href="#section6-x-cassandra-discussion-label" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Cassandraのテーブル構造  <br/>
→リレーショナルデータベースとは違い、データ中心の設計アプローチをとるべきではない(と言われている)。データストアの特性が違うので、Cassandraで出来る事・出来ない事を整理して、適切な永続化のテーブル構造を考える。</li>
<li>アプリケーションのデータモデリングの差異 <br/>
→ エンティティオブジェクトはどのような構造をとるべきか</li>
<li>Spring Data Cassandraのマッピング機能とデータアクセスのお作法 <br/>
→ どのような機能を持っていて、どういう実装方法が望ましいか</li>
<li>データモデリング設計の進め方</li>
</ul>
</div>
<div class="section" id="section6-x-cassandra-use-case-label">
<span id="id3"></span><h2>ユースケース<a class="headerlink" href="#section6-x-cassandra-use-case-label" title="Permalink to this headline">¶</a></h2>
<p>リレーショナルデータベースの場合のモデリングと対比するために、<a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/index.html">Spring Data JPAにおけるサンプルのユースケース</a> を考える。</p>
<table border="1" class="colwidths-given docutils" id="id66">
<caption><span class="caption-text">ユースケース</span><a class="headerlink" href="#id66" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ユースケース</th>
<th class="head">リレーショナルモデルにおける <br/> エンティティ関連</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>全てのユーザを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>全ての住所を検索する</td>
<td>なし</td>
</tr>
<tr class="row-even"><td>全てのメールアドレスを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>全てのグループを検索する</td>
<td>なし</td>
</tr>
<tr class="row-even"><td>特定のユーザを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>ログインIDをキーに特定のユーザを検索する</td>
<td>なし</td>
</tr>
<tr class="row-even"><td>特定のユーザのアドレスを検索する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのEmailの一覧を取得する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定したグループ名を元にグループを検索する</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>特定の郵便番号を持つユーザ一覧を取得する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-even"><td>特定の郵便番号を持たないユーザ一覧を取得する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-odd"><td>指定されたユーザの住所を追加する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-even"><td>指定されたユーザの住所を更新する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-odd"><td>指定されたユーザの住所を削除する</td>
<td>ユーザ : 住所 = 1 : 1</td>
</tr>
<tr class="row-even"><td>特定のメールアドレスを持つユーザを検索する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのメールアドレスを追加する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定されたユーザをメールアドレスを含めて追加する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのメールアドレスを更新する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定されたユーザのメールアドレスを1件削除する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-odd"><td>指定されたユーザのメールアドレスを全件削除する</td>
<td>ユーザ : メール = 1 : N</td>
</tr>
<tr class="row-even"><td>指定したユーザが属するグループの一覧を取得する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-odd"><td>指定したグループに所属する全てのユーザ一覧を取得する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-even"><td>指定したグループに所属しない全てのユーザ一覧を取得する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-odd"><td>指定したユーザを指定したグループに追加する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-even"><td>指定したユーザをグループから除外する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-odd"><td>指定したグループを削除し、 <br/> ユーザが所属するグループの情報を更新する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
<tr class="row-even"><td>指定されたユーザを削除し、グループのユーザ一覧を更新する</td>
<td>ユーザ : グループ = N : N</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="section6-x-differenece-relational-data-modeling-label">
<span id="id4"></span><h2>データベースやクエリにおける相違点<a class="headerlink" href="#section6-x-differenece-relational-data-modeling-label" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rdbmscassandra">
<span id="section6-x-x-differenece-between-rdb-and-cassandra-label"></span><h3>RDBMSとCassandra<a class="headerlink" href="#rdbmscassandra" title="Permalink to this headline">¶</a></h3>
<table border="1" class="colwidths-given docutils" id="id67">
<caption><span class="caption-text">データベース間の相違</span><a class="headerlink" href="#id67" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="23%" />
<col width="38%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">相違点</th>
<th class="head">RDBMS</th>
<th class="head">Cassandra</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">一貫性</th>
<td>強一貫性</td>
<td>設定可能な一貫性※1</td>
</tr>
<tr class="row-odd"><th class="stub">トランザクション</th>
<td>ACIDトランザクション</td>
<td>軽量トランザクション</td>
</tr>
<tr class="row-even"><th class="stub">クエリ</th>
<td>SQL</td>
<td>CQL※2</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given docutils" id="id68">
<caption><span class="caption-text">設定可能な書き込み一貫性*1</span><a class="headerlink" href="#id68" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">一貫性レベル</th>
<th class="head">特徴</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ALL</td>
<td>クラスター内のすべてのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-odd"><td>EACH_QUORUM</td>
<td>書き込みが、各データ・センターのレプリカ・ノードのクォーラム（過半数）の <br/> コミット・ログとmemtableに書き込まれる</td>
</tr>
<tr class="row-even"><td>QUORUM</td>
<td>書き込みが、すべてのデータ・センターのレプリカ・ノードのクォーラム <br/> （過半数）のコミット・ログとmemtableに書き込まれる</td>
</tr>
<tr class="row-odd"><td>LOCAL_QUORUM</td>
<td>書き込みが、コーディネーター・ノードと同じデータ・センターにある <br/> レプリカ・ノードのクォーラム（過半数）のコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-even"><td>ONE</td>
<td>書き込みが、少なくとも1つのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-odd"><td>TWO</td>
<td>書き込みが、少なくとも2つのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-even"><td>THREE</td>
<td>書き込みが、少なくとも3つのレプリカ・ノードのコミット・ログとmemtableに <br/> 書き込まれる</td>
</tr>
<tr class="row-odd"><td>LOCAL_ONE</td>
<td>ローカル・データ・センターの少なくとも1つのレプリカ・ノードに <br/> 書き込みを送信し、 確認応答がある</td>
</tr>
<tr class="row-even"><td>ANY</td>
<td>書き込みが、少なくとも1つのノードに書き込まれる。パーティション・キーの <br/> すべての レプリカ・ノードがダウンしていても、 <br/> ヒンテッド・ハンドオフが書き込まれれば、書き込みを成功と見なす。</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given docutils" id="id69">
<caption><span class="caption-text">設定可能な読み込み一貫性*1</span><a class="headerlink" href="#id69" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">一貫性レベル</th>
<th class="head">特徴</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ALL</td>
<td>すべてのレプリカが応答した後に、レコードを返す。1つでもレプリカが <br/> 応答しないと、読み取り操作は失敗する。</td>
</tr>
<tr class="row-odd"><td>EACH_QUORUM</td>
<td>読み取りが、各データ・センターのレプリカ・ノードのクォーラム <br/> （過半数）で読み取られる。</td>
</tr>
<tr class="row-even"><td>QUORUM</td>
<td>すべてのデータ・センターのクォーラム（過半数）のレプリカが応答したら、 <br/> レコードを返す。</td>
</tr>
<tr class="row-odd"><td>LOCAL_QUORUM</td>
<td>コーディネーター・ノードが報告された際に現在のデータ・センター内のクォーラム <br/> （過半数）の|br|レプリカが応答したら、レコードを返す。</td>
</tr>
<tr class="row-even"><td>ONE</td>
<td>スニッチによって定まる最も近いレプリカから応答を返します。デフォルトでは、 <br/> 他のレプリカとの|br|整合性を維持するために、読み取りリペアが <br/> バックグラウンドで実行される。</td>
</tr>
<tr class="row-odd"><td>TWO</td>
<td>最も近い2つのレプリカから最新のデータを返す。</td>
</tr>
<tr class="row-even"><td>THREE</td>
<td>最も近い3つのレプリカから最新のデータを返す。</td>
</tr>
<tr class="row-odd"><td>LOCAL_ONE</td>
<td>ローカル・データ・センターの最も近いレプリカからの応答を返す</td>
</tr>
<tr class="row-even"><td>SERIAL</td>
<td>新しい追加や更新を提示することなく、現在の（そしてコミットされていない <br/> 可能性がある）データの状態を読み取ることができる。SERIALの読み取りにおいて <br/> 進行中のコミットされていないトランザクションが見つかった場合は、 <br/> 読み取りの一環としてそのトランザクションがコミットされる。</td>
</tr>
<tr class="row-odd"><td>LOCAL_SERIAL</td>
<td>SERIALと同じだが、データ・センターに限定される。</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given docutils" id="id70">
<caption><span class="caption-text">SQLと比較した場合のCQLの特徴*2</span><a class="headerlink" href="#id70" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">No</th>
<th class="head">特徴</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>結合や外部キー、副問合せのサポートがない  <br/> → 必要に応じてテーブルを非正規化、マテリアライズドビューを使用する。</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>GROUP BY等集約関数が標準で存在しない。Cassandra3以降、ユーザ定義関数はサポート。 <br/> → アプリの中でロジックとして実装する</td>
</tr>
<tr class="row-even"><td>3</td>
<td>WHERE句でプライマリキー以外を使用するにはインデックスが必要 <br/> → セカンダリインデックスを作成したり、マテリアライズドビューを使用する。</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>データ型でCollectionをサポート。1:n関連に相当する有限のデータはCollectionを利用する。 <br/>
センサーデータのような無限にデータが増えていく場合は、ノードを分散させるために、 <br/>
複合プライマリーキーを使用する。 <br/> → 必要に応じて、テーブルを非正規化する。</td>
</tr>
<tr class="row-even"><td>5</td>
<td>更新の条件指定はプライマリキーのみに限定される <br/> アプリの中でロジックとして実装する。</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>“OR”、”NOT”といった論理演算子はなく、ANDのみに限定される <br/> → アプリの中でロジックとして実装する</td>
</tr>
<tr class="row-even"><td>7</td>
<td>日付型の演算時可能な表現が異なる <br/> → アプリの中でロジックとして実装する。</td>
</tr>
<tr class="row-odd"><td>8</td>
<td>重複したキーのインサートはアップデートとして扱われる</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="spring-data-cassandra">
<span id="section6-x-x-usecase-implementation-using-spring-data-cassandra-label"></span><h2>Spring Data Cassandraを使用したユースケースの実装<a class="headerlink" href="#spring-data-cassandra" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/index.html">Spring Data JPAの例</a> との比較のために類似のユースケースを勘案して、解説する。実際に作成したサンプルは <a class="reference external" href="https://github.com/debugroom/sample/tree/feature/sample-spring-cassandra/sample-spring-cassandra">GitHub</a> を参照のこと。</p>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-entity-label">
<span id="id6"></span><h3>エンティティクラスの作成<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-entity-label" title="Permalink to this headline">¶</a></h3>
<p>テーブルを表現するアノーテションを付与したエンティティクラスを作成する。
アノテーションはorg.springframework.data.cassandra.mappingパッケージにあるが、
代表的なアノテーションの概要は以下の通りである。</p>
<table border="1" class="colwidths-given docutils" id="id71">
<caption><span class="caption-text">org.springframework.data.cassandra.mappingアノテーションの概要</span><a class="headerlink" href="#id71" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="20%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">アノテーション</th>
<th class="head">設定</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&#64;Table</td>
<td>クラス</td>
<td>エンティティクラスとマッピングする物理テーブル名を指定する。</td>
</tr>
<tr class="row-odd"><td>&#64;PrimaryKeyClass</td>
<td>クラス</td>
<td>複合主キーで使用されるカラムを表現するクラス</td>
</tr>
<tr class="row-even"><td>&#64;Id</td>
<td>フィールド</td>
<td>IDとして表現するフィールドに付与する。</td>
</tr>
<tr class="row-odd"><td>&#64;PrimaryKey</td>
<td>フィールド</td>
<td>&#64;Idと機能は同じで、カラム名を指定可能である。</td>
</tr>
<tr class="row-even"><td>&#64;PrimaryKeyColumn</td>
<td>フィールド</td>
<td>パーティションカラム、クラスタカラムを指定できるプライマリキーカラム</td>
</tr>
<tr class="row-odd"><td>&#64;Column</td>
<td>フィールド</td>
<td>フィールドとデータベースのカラム名のマッピングを定義する。</td>
</tr>
<tr class="row-even"><td>&#64;Transient</td>
<td>フィールド</td>
<td>永続化しないエンティティクラス、マップドスーパークラス、<br/> または組み込みクラスのフィールドであることを示す。</td>
</tr>
<tr class="row-odd"><td>&#64;CassandraType</td>
<td>フィールド</td>
<td>Cassandraのデータ型を指定する際に利用する。</td>
</tr>
<tr class="row-even"><td>&#64;UserDefinedType</td>
<td>クラス</td>
<td>ユーザ定義型に付与する際に利用する。</td>
</tr>
</tbody>
</table>
<p>以降、上記のアノテーションを付与したサンプルを幾つか記載する。</p>
<p>ユーザエンティティを表現するUserクラスにテーブル名を指定した&#64;Tableアノテーションを設定する。各フィールドには各カラム名を指定した&#64;Columnアノテーションを付与する。</p>
<div class="literal-block-wrapper docutils container" id="id72">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><a class="headerlink" href="#id72" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Transient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.CassandraType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.DataType.Name</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>

        <span class="kd">public</span> <span class="nf">User</span><span class="o">(){</span>
        <span class="o">}</span>
        <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isEnabled</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isAdmin</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
        <span class="nd">@CassandraType</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="na">UDT</span><span class="o">,</span> <span class="n">userTypeName</span><span class="o">=</span><span class="s">&quot;addressofuser&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">UDTValue</span> <span class="n">address</span><span class="o">;</span>
        <span class="nd">@Transient</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;</span> <span class="n">credentials</span><span class="o">;</span>
        <span class="nd">@Transient</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;groups&quot;</span><span class="o">)</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groups</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#64;AllArgsConstructorや&#64;Builder、&#64;Dataアノテーションはコードを簡略化して記述するためのLombokアノテーションである。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Data Cassandraでは、ユーザ定義型を使用する場合、直接ユーザ定義型のクラスをプロパティとして定義する方法と、UDTValueクラスを使用する２通りの定義の仕方があるが、UDTValueを使用する場合、AP起動前に事前にCREATE TYPE文で、ユーザ定義型を定義しておく必要がある。直接クラスをプロパティに指定した場合は、設定ファイルにおいて、SchemaActionでCREATE、RECREATE等指定しておくと、AP起動時に、自動でCREATE TYPE文が発行される。</p>
</div>
<p>同様に、各テーブルと対応するクラスを各々作成する。なお、テーブルの構成や非正規化のポイントについてはユースケースごとの説明のセクションで後述するが、以下は、ユーザ定義型を使用したAddressOfUserクラスでの例である。クラスに&#64;UserDefinedTypeを付与する。</p>
<div class="literal-block-wrapper docutils container" id="id73">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressOfUser</span><a class="headerlink" href="#id73" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.CassandraType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.DataType.Name</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressOfUser</span> <span class="o">{</span>

        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="repository">
<span id="section6-x-x-x-usecase-implementation-patten1-repository-label"></span><h4>Repositoryクラスの作成<a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h4>
<p>作成したエンティティクラスのRepositoryクラスを作成する。<a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/usage.html#section2-1-2-spring-data-jpa-usage-simple-access-repository-label">Spring Data JPA同様</a> 、org.springframework.data.repository.CrudRepositoryを継承したインターフェースを作成し、型パラメータに作成したエンティティクラスとキーとなるデータ型を指定することで、基本的なCRUD操作を実行するメソッドをもつDAOが作成できる。以下は、Userエンティティクラスに対するRepositoryクラスの例である。</p>
<div class="literal-block-wrapper docutils container" id="id74">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRepository</span><a class="headerlink" href="#id74" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://debugroom.github.io/doc/java/spring/springdatajpa/usage.html#section2-1-2-spring-data-jpa-usage-simple-access-repository-label">Spring Data JPA同様、命名規約に従って、メソッド名を定義すること</a> により自動でCQLが生成される。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Data JPA同様、カスタムメソッドを作成することも可能である(「特定の郵便番号を持たないユーザ一覧を取得する」にて後述)。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">“NOT IN”や”GROUP BY”などCQLではサポートされない構文を含めたメソッドを定義できるが、実行すると当然エラーとなる。</p>
</div>
</div>
<div class="section" id="service">
<span id="section6-x-x-x-usecase-implementation-patten1-service-label"></span><h4>Serviceクラスの作成<a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h4>
<p>ユースケースに応じて、インターフェースを作成する。なお、Spring Data JPAの例で内容が重複しているユースケースは除外した。</p>
<ul class="simple">
<li>全てのユーザを検索する。 <br/> → getUsers()</li>
<li>全ての住所を検索する。 <br/>  → getAddresses()</li>
<li>全てのメールアドレスを検索する。  <br/> → getEmails()</li>
<li>全てのグループを検索する。  <br/> → getGroups()</li>
<li>特定のユーザを検索する。  <br/> → getUser(Long userId)</li>
<li>特定のユーザのアドレスを検索する。  <br/> → getAddress(Long userId)</li>
<li>特定のユーザがもつEmailアドレスを検索する。  <br/> → getEmails(Long userId)</li>
<li>指定したグループ名を元にグループを検索する。  <br/> → getGroups(String groupName)</li>
<li>特定の郵便番号を持つユーザ一覧を取得する。  <br/> → getUsers(String zipCd)</li>
<li>特定の郵便番号を持たないユーザ一覧を取得する  <br/> → getNotUsers(String zipCd)</li>
<li>指定されたユーザの住所を追加する。  <br/> → addAddress(Long userId, String zipCd, String address)</li>
<li>指定されたユーザの住所を更新する。  <br/> → updateAddress(Long userId, String zipCd, String address)</li>
<li>指定されたユーザの住所を削除する。  <br/> → deleteAddress(Long userId)</li>
<li>特定のメールアドレスを持つユーザを検索する。  <br/> → getUserByEmail(String email)</li>
<li>指定されたユーザのメールアドレスを追加する。  <br/> → addEmail(Long userId, String email)</li>
<li>指定されたユーザをメールアドレスを含めて追加する。  <br/> → addUserWithEmail(Long userId, String userName, String email)</li>
<li>指定されたユーザのメールアドレスを更新する。  <br/> → updateEmail(Long userId, String email, String newEmail)</li>
<li>指定されたユーザのメールアドレスを1件削除する。  <br/> → deleteEmail(Long userId, String email)</li>
<li>指定されたユーザのメールアドレスを全件削除する。  <br/> → deleteEmails(Long userId)</li>
<li>指定したユーザが属するグループの一覧を取得する。 <br/> → getGroups(Long userId)</li>
<li>指定したグループに所属する全てのユーザ一覧を取得する。  <br/> → getUsersByGroupId(Long groupId)</li>
<li>指定したグループに所属しない全てのユーザ一覧を取得する。  <br/> → getNotUsersByGroupId(Long groupId)</li>
<li>指定したユーザを指定したグループに追加する。  <br/> → addUserToGroup(Long userId, Long groupId)</li>
<li>指定したユーザをグループから除外する。  <br/> → deleteUserFromGroup(Long userId, Long groupId)</li>
<li>指定したグループを削除し、ユーザが所属するグループの情報を更新する。  <br/> → deleteGroup(Long groupId)</li>
<li>指定されたユーザを削除し、グループのユーザ一覧を更新する。  <br/> → deleteUser(Long userId)</li>
</ul>
<p>以下の通りのServiceインターフェースを作成し、各パターンに応じたService実装クラスを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id75">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.domain.service.SampleService</span><a class="headerlink" href="#id75" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SampleService</span><span class="o">&lt;</span><span class="n">U</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">E</span><span class="o">,</span> <span class="n">G</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="nf">getAddresses</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">G</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">String</span> <span class="n">loginId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">A</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">G</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getNotUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">getUserByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">addUserWithEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">newEmail</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">G</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">getNotUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">G</span> <span class="nf">addUserToGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">G</span> <span class="nf">deleteUserFromGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">G</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">U</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>以降、各々のユースケースにおいて、サービスの実装を含め、詳述する。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-using-spring-data-cassandra-simple-patten1-label">
<span id="id9"></span><h3>パターン1(非正規化モデル)を中心としたデータモデル<a class="headerlink" href="#section6-x-x-x-usecase-implementation-using-spring-data-cassandra-simple-patten1-label" title="Permalink to this headline">¶</a></h3>
<p>データのモデリングによって、実装のパターンは異なる。まず最初にデータモデルの非正規化を中心としたパターンについて実装方法を考察する。
本サンプルでは、以下の構成をパターン1として実装例を記述する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/data-modeling-pattern1.png"><img alt="../../_images/data-modeling-pattern1.png" src="../../_images/data-modeling-pattern1.png" style="width: 1398.0px; height: 933.0px;" /></a>
</div>
<p>なお、上記のテーブル構成は以下のCQLによって構成されるものと同等である。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">sample</span><span class="p">.</span><span class="n">addressofuser</span> <span class="p">(</span>
    <span class="n">address</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">zip_cd</span> <span class="nb">text</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">sample</span><span class="p">.</span><span class="n">groupofuser</span> <span class="p">(</span>
    <span class="n">group_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">group_name</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">sample</span><span class="p">.</span><span class="n">userofgroup</span> <span class="p">(</span>
    <span class="n">is_admin</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">is_enabled</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">is_locked</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">user_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">user_name</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="n">credential</span> <span class="p">(</span>
    <span class="n">login_id</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">credential_type</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">credential_key</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">expired_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">user_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">((</span><span class="n">login_id</span><span class="p">,</span> <span class="n">credential_type</span><span class="p">))</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="n">users</span> <span class="p">(</span>
    <span class="n">user_id</span> <span class="nb">bigint</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">address</span> <span class="n">frozen</span><span class="o">&lt;</span><span class="n">addressofuser</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">groups</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">&lt;</span><span class="n">groupofuser</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">is_admin</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">is_enabled</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">is_locked</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">user_name</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="k">group</span> <span class="p">(</span>
    <span class="n">group_id</span> <span class="nb">bigint</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">group_name</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">users</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">&lt;</span><span class="n">userofgroup</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="n">email</span> <span class="p">(</span>
    <span class="n">email</span> <span class="nb">text</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">user_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="n">address</span> <span class="p">(</span>
    <span class="n">zip_cd</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">user_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">address</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">zip_cd</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-users-label">
<span id="id10"></span><h4>全てのユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-users-label" title="Permalink to this headline">¶</a></h4>
<p>Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Userテーブルのすべてのデータを検索する場合は、UserRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper docutils container" id="id76">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUsers()</span><a class="headerlink" href="#id76" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">()</span> <span class="o">{</span>
             <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
   <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-addresses-label">
<span id="id11"></span><h4>全ての住所を検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-addresses-label" title="Permalink to this headline">¶</a></h4>
<p>住所の全てのデータを一括検索する場合にはAddressエンティティクラスを作成し、テーブルを構成する必要がある。
Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Addressテーブルのすべてのデータを検索する場合は、AddressRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper docutils container" id="id77">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Address</span><a class="headerlink" href="#id77" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="c1">// constructor needs for avoiding repository instantiation error</span>
    <span class="kd">public</span> <span class="nf">Address</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;addresspk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AddressPK</span> <span class="n">addresspk</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">エンティティクラスは引数なしのコンストラクタが必要なことに注意。それがないと、AP起動時にレポジトリクラスをインスタンス化する際にエラーが発生する。なお、プライマリーキークラスも同様だが、起動時にorg.springframework.data.mapping.PropertyReferenceException: No property ”property” found for type “class” となるので注意すること。</p>
</div>
<div class="literal-block-wrapper docutils container" id="id78">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.AddressRepository</span><a class="headerlink" href="#id78" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressPK</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AddressRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">AddressPK</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">通常、１つのユーザが1つの住所を保持できるようにする(リレーショナルデータモデルでいうところの1対1の関係の)場合、ユニークなIDか、ユーザIDをキーにして実現するが、ここではAddressPKというクラスを作成して主キーにしている。理由はセクション「特定の郵便番号をもつユーザを検索する」にて後述する。</p>
</div>
<div class="literal-block-wrapper docutils container" id="id79">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getAddresses()</span><a class="headerlink" href="#id79" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">getAddresses</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;)</span><span class="n">addressRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-emails-label">
<span id="id12"></span><h4>全てのメールアドレスを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-emails-label" title="Permalink to this headline">¶</a></h4>
<p>全てのデータを一括検索する場合にはEmailエンティティクラスを作成し、テーブルを構成する必要がある。
Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Emailテーブルのすべてのデータを検索する場合は、EmailRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper docutils container" id="id80">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Email</span><a class="headerlink" href="#id80" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Email</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Email</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">通常、１つのユーザが複数のメールアドレスを保持できるようにする(リレーショナルデータモデルでいうところの1対多の関係の)場合、ユニークなIDか、ユーザIDと番号などの複合主キーにして実現するが、ここではユニークな値となるメールアドレスそのものを主キーにしている。理由はセクション「特定のユーザがもつEmailアドレスを検索する」にて後述する。</p>
</div>
<div class="literal-block-wrapper docutils container" id="id81">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.EmailRepository</span><a class="headerlink" href="#id81" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmailRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id82">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getEmails()</span><a class="headerlink" href="#id82" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;)</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-groups-label">
<span id="id13"></span><h4>全てのグループを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-groups-label" title="Permalink to this headline">¶</a></h4>
<p>全てのデータを一括検索する場合にはGroupエンティティクラスを作成し、テーブルを構成する必要がある。
Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Groupテーブルのすべてのデータを検索する場合は、GroupRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper docutils container" id="id83">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Group</span><a class="headerlink" href="#id83" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Group</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

 <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id84">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.GroupRepository</span><a class="headerlink" href="#id84" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GroupRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;{</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id85">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getGroups()</span><a class="headerlink" href="#id85" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;)</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-user-label">
<span id="id14"></span><h4>特定のユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-user-label" title="Permalink to this headline">¶</a></h4>
<p>ユーザデータをプライマリーキーuserIdを使用して検索する場合には、Service実装クラスでは、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。UserRepository.findOne(Long userId)を使用する。</p>
<div class="literal-block-wrapper docutils container" id="id86">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUser(Long userId)</span><a class="headerlink" href="#id86" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-address-label">
<span id="id15"></span><h4>特定のユーザのアドレスを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-address-label" title="Permalink to this headline">¶</a></h4>
<p>特定のユーザIDをキーに住所を検索する場合、いくつか方法がある。他にどのような住所検索のクエリが必要かによって、適切な実装方法は異なる。まず、ここでは、エンティティUserにユーザ定義型AddressOfUserを定義して、ユーザテーブルから非正規化した住所データを取得する例を記載する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>

        <span class="kd">public</span> <span class="nf">User</span><span class="o">(){</span>
        <span class="o">}</span>
        <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>

        <span class="c1">// omit</span>

        <span class="nd">@CassandraType</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="na">UDT</span><span class="o">,</span> <span class="n">userTypeName</span><span class="o">=</span><span class="s">&quot;addressofuser&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">UDTValue</span> <span class="n">address</span><span class="o">;</span>     <span class="c1">// ユーザ定義型AddressOfUserを使用してデータを非正規化する。</span>

<span class="o">}</span>
</pre></div>
</div>
<p>当然Addressテーブルにも同じ住所のデータはあるが、このように非正規化している理由は、後述するユースケース「特定の郵便番号を持つユーザ一覧を取得する」でも示すように、郵便番号をAddressテーブルの検索条件のキーに持たせる必要があり、Addressエンティティではプライマリキーとして、郵便番号とユーザIDを複合主キーとしたAddressPKを作成しているため、Addressテーブルは、userId単体ではデフォルトそのままでは検索キーとして使用できないためである。</p>
<div class="literal-block-wrapper docutils container" id="id87">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.Addressが使用できない理由</span><a class="headerlink" href="#id87" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Address</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;addresspk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AddressPK</span> <span class="n">addresspk</span><span class="o">;</span> <span class="c1">//Addressテーブルの検索にはaddressPKのzipCdが必要。</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id88">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressPK</span><a class="headerlink" href="#id88" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.PrimaryKeyType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyColumn</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@PrimaryKeyClass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressPK</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">public</span> <span class="nf">AddressPK</span><span class="o">(){}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">828112214783052932L</span><span class="o">;</span>

    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zip_cd&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">PARTITIONED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span> <span class="c1">// zipCdはパーティションキーで指定しているので必須</span>
    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">CLUSTERED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span> <span class="c1">// userIdはクラスタカラムとして指定しているので必須ではない</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">AddressPKクラスにおいて、クラスタカラムとして定義しているuserIdを単体の検索キーとして利用するには、セカンダリインデックスを作成すれば可能であるが、<a class="reference external" href="https://docs.datastax.com/ja/cql-jajp/3.3/cql/cql_using/useWhenIndex.html">DataStax社の提供するCassandraのドキュメント</a> ではカーディナリティの高い(バラエティが多い)データで、セカンダリインデックスを作るのは推奨していない。カーディナリティの高いデータに対してはマテリアライズドビューの作成を推奨しているが、いずれにせよパーティションキーである郵便番号が必要になる。</p>
</div>
<p>Serviceの実装クラスでは、Userテーブルから非正規化した住所データをcom.datastax.driver.core.UDTValueの形式で取得している。
これをAddressクラスにデータを移した返却している。</p>
<div class="literal-block-wrapper docutils container" id="id89">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getAddress(Long userId)</span><a class="headerlink" href="#id89" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">getAddress</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">udtValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">addresspk</span><span class="o">(</span><span class="n">AddressPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                          <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                          <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                      <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">com.datastax.driver.core.UDTValueは今回サンプルとして使用方法を記述しているが、特定のベンダのパッケージにServiceクラスが依存してしまうのであまり使用しない方が良い。Spring Data Cassandraでは、ユーザ定義型はUDTValueクラスを使用せずとも直接&#64;UserDefinedTypeアノテーションが付与されたクラスを変数宣言すると使用可能なのでそちらの利用を推奨。</p>
</div>
</div>
<div class="section" id="email">
<span id="section6-x-x-x-usecase-implementation-patten1-get-email-label"></span><h4>特定のユーザがもつEmailアドレスを検索する<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h4>
<p>Emailテーブルでは、Emailがプライマリキーであるため、CQLのwhere句の条件にuserIdは指定できない。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Email</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Email</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span> <span class="c1">// &lt;---通常ではプライマリキーしかwhere句に指定できない</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>  <span class="c1">// &lt;---セカンダリインデックスを指定等すれば、検索キーとしては利用可能。</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<p>特定のユーザがもつEmailアドレスを検索する場合、こちらも「特定のユーザのアドレスを検索する」と同様、ユーザテーブルに非正規化されたEmailデータを持たせるのが簡易ではあるが、こちらのユースケースでは、逆に非正規化せず、プライマリーキー以外の項目をwhere条件で指定して検索する方法で実装する。基本的には、セカンダリインデックスを作成するか、EmailRepositoryクラスにCQLを定義し、オプションでallow filteringオプションを指定するか、マテリアライズドビューを作成すれば可能である。ここでは、EmailRepositoryインターフェースにfindByUserIdメソッドを定義し、allow filteringオプションを付与した例を有効化している。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Email</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmailRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>

    <span class="c1">// Use secondary index or materialized view depending on data cardinality.</span>
    <span class="c1">// (Not recommend) 1. Create secondary index</span>
    <span class="c1">// &quot;create index on sample.email (user_id);&quot;</span>
        <span class="c1">// @Query(&quot;select * from email where user_id = ?0&quot;)</span>
    <span class="c1">// (Not recommend) 2. Add allow filtering option to cql.</span>
        <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;select * from email where user_id = ?0 allow filtering&quot;</span><span class="o">)</span>
    <span class="c1">// (Recommend) 3. Use materialized view</span>
        <span class="c1">// &quot;create materialized view email_by_user_id as select email, user_id, ver, last_updated_date from email where user_id is not null and email is not null primary key(user_id, email);&quot;</span>
    <span class="c1">//@Query(&quot;select * from email_by_user_id where user_id = ?0&quot;)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">findByUserId</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">userIdはユニークな値なので、本来一番推奨される方法はマテリアライズドビューを使用する方法である。</p>
</div>
<p>Service実装クラスからは、定義したメソッドEmailRepository.findByUserId()を実行すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id90">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getEmails(Long userId)</span><a class="headerlink" href="#id90" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
     <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-group-by-groupname-label">
<span id="id16"></span><h4>指定したグループ名を元にグループを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-group-by-groupname-label" title="Permalink to this headline">¶</a></h4>
<p>Groupテーブルでは、groupIdがプライマリキーであるため、CQLのwhere句の条件にgroupNameは指定できない。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Group</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>   <span class="c1">// &lt;-- where句に条件指定ができる</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span> <span class="c1">// &lt;-- where句に条件指定ができない</span>
    <span class="c1">// omit</span>

 <span class="o">}</span>
</pre></div>
</div>
<p>こちらも、「特定のユーザがもつEmailアドレスを検索する   」と同様、GroupRepositoryインターフェースにfindByGroupNameメソッドを定義し、allow filteringオプションを付与した例を有効化している。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GroupRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;{</span>

    <span class="c1">// Use query adding allow filtering option or secondary index or materialized view.</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;select * from group where group_name = ?0 allow filtering&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">findByGroupName</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">検索キーとなる項目のカーディナリティに応じて、適切な方法を選択するために、目安となるベンチマークを測定する。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-users-by-zipcd-label">
<span id="id17"></span><h4>特定の郵便番号を持つユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-users-by-zipcd-label" title="Permalink to this headline">¶</a></h4>
<p>リレーショナルモデルでは1対1関連として扱いたいUserとAddressエンティティの関係であるが、特定の項目をキーにした検索が必要なユースケースでは、その項目をプライマリキーにしておくことで高速な検索が見込める。ここでは、郵便番号と、ユーザIDをプライマリキーをAddressPKクラスとして定義した例で実装する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;addresspk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AddressPK</span> <span class="n">addresspk</span><span class="o">;</span> <span class="c1">//&lt;-プライマリキークラスを作成。</span>

   <span class="c1">// omit.</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.PrimaryKeyType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyColumn</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@PrimaryKeyClass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddressPK</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">public</span> <span class="nf">AddressPK</span><span class="o">(){}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">828112214783052932L</span><span class="o">;</span>

    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zip_cd&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">PARTITIONED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span> <span class="c1">// パーティションキーとして定義</span>
    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">CLUSTERED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>  <span class="c1">// クラスタカラムキーとして定義</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>パーティションキーはどのノードにデータを配置するかを決定する重要なキーである。
パーティションキーの指定なしに検索を行うと、どのノードにデータが配置されているかをトレースせねばならず、
ノードが増えるごとに線形的に検索速度は低下する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/partitionkey.png"><img alt="../../_images/partitionkey.png" src="../../_images/partitionkey.png" style="width: 566.0px; height: 663.0px;" /></a>
</div>
<p class="last">クラスタカラムキーはパーティションに格納されたデータのキーとなる項目である。</p>
</div>
<p>Serviceクラスの実装では、まずパーティションキーであるzipCdを指定して、対象のAddressオブジェクトのリストを取得したのち、AddressオブジェクトのuserIdのリストを作って、IN句を使ってユーザデータを検索する。zipCdをキーにアドレスリストを取得するためにAddressRepositoryにfindByAddresspkZipCdメソッドを定義する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.AddressPK</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AddressRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">AddressPK</span><span class="o">&gt;{</span>

   <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">findByAddresspkZipCd</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">メソッドの命名規約により、Spring Data Cassandraが、findByAddresspxZipCdでAddressPKクラスのzipCdをキーにCQLを組み立てる。なお、ネストされたクラスはキャメルケースによりプロパティ名を推定するが、英大文字小文字の区別を明確化するために&#64;PraimaryKeyで変数名を明確に定義しておくこと。</p>
</div>
<p>また、UserRepositoryインターフェースにIN句を使用したCQLを実行するよう、findByUserIdIn(List&lt;Long&gt; userIds)メソッドを作成する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserIdIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Service実装クラスでは、</p>
<div class="literal-block-wrapper docutils container" id="id91">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUsers(String zipCd)</span><a class="headerlink" href="#id91" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkZipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addresses</span><span class="o">){</span>
            <span class="n">userIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getAddresspk</span><span class="o">().</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByUserIdIn</span><span class="o">(</span><span class="n">userIds</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">IN句の実行速度が不明のため、マルチノードでデータを分散した場合の実行速度を計測して評価すること。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-not-users-by-zipcd-label">
<span id="id18"></span><h4>特定の郵便番号を持たないユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-not-users-by-zipcd-label" title="Permalink to this headline">¶</a></h4>
<p>特定の郵便番号を持たないユーザの一覧だと、「特定の郵便番号を持つユーザ一覧を取得する」場合の論理否定であるが、CQLではNOT IN句をサポートしていない。そのため、別の方法で全体のユーザから特定の郵便番号をもつユーザを除外することで、持たないユーザ一覧を作成する。
1件ずつ対象のユーザをループでチェックするとデータが大きくなった場合、指数関数的に増加するため、Map型でユーザの一覧を取得し、特定の郵便番号を持つユーザのリストから除外する方法で実装する。</p>
<div class="literal-block-wrapper docutils container" id="id92">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getNotUsers(String zipCd)</span><a class="headerlink" href="#id92" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getNotUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>

        <span class="cm">/* Not_In statement is no-supported for cassandra.</span>
<span class="cm">        List&lt;Address&gt; addresses = addressRepository.findByAddresspkZipCd(zipCd);</span>
<span class="cm">        List&lt;Long&gt; userIds = new ArrayList&lt;Long&gt;();</span>
<span class="cm">        for(Address address : addresses){</span>
<span class="cm">            userIds.add(address.getAddresspk().getUserId());</span>
<span class="cm">        }</span>
<span class="cm">        return userRepository.findByUserIdNotIn(userIds);</span>
<span class="cm">        */</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkZipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">usersMap</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMap</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addresses</span><span class="o">){</span>
            <span class="n">usersMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getAddresspk</span><span class="o">().</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">usersMap</span><span class="o">.</span><span class="na">values</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>検索結果をMap型で返却するメソッドはSpring Dataでは標準ではサポートされていないため、カスタムレポジトリクラスを作成し、Map型で返却するよう拡張する。なお、データのマッピングはorg.springframework.cassandra.core.ResultSetExtractorを利用する。まず、Repositoryを拡張するためのカスタムインターフェースを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id93">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRespositoryCustom</span><a class="headerlink" href="#id93" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepositoryCustom</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>カスタムインターフェースをUserRepositoryクラスに継承させる。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserIdIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserIdNotIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<p>カスタムインターフェースの実装クラスを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id94">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.impl.UserRepositoryImpl</span><a class="headerlink" href="#id94" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryImpl</span> <span class="kd">implements</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserMapExtractor</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Repositoryインターフェースと同一のパッケージに配置していると、メソッド名命名規約のチェックが発生して、(ここではForMapという変数がない等でエラーが発生してしまう。)自由なメソッド名を設定できなくなるため、レポジトリ実装クラスは&#64;NoRepositoryBeanアノテーションを付与し、別パッケージに配置すること。</p>
</div>
<p>また、ResultSetとエンティティクラスのカラムマッピングの拡張で、ResultSetExtractorを継承したクラスを以下の通り実装する。</p>
<div class="literal-block-wrapper docutils container" id="id95">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.repository.impl.UserMapExtractor</span><a class="headerlink" href="#id95" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.ResultSetExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.DataAccessException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.exceptions.DriverException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.GroupOfUser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMapExtractor</span> <span class="kd">implements</span> <span class="n">ResultSetExtractor</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">extractData</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">resultSet</span><span class="o">)</span>
                                <span class="kd">throws</span> <span class="n">DriverException</span><span class="o">,</span> <span class="n">DataAccessException</span> <span class="o">{</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">hasNext</span><span class="o">()){</span>
            <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">resultSet</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupOfUsers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;();</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getUDTValue</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">))</span>
<span class="c1">//                          .groups(row.getList(&quot;groups&quot;, GroupOfUser.class))</span>
                            <span class="o">.</span><span class="na">groups</span><span class="o">(</span><span class="n">groupOfUsers</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span> <span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;groups&quot;</span><span class="o">);</span>
            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="n">groups</span><span class="o">){</span>
                <span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">GroupOfUser</span><span class="o">();</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setGroupId</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">));</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setGroupName</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">));</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setVer</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">));</span>
                <span class="n">groupOfUser</span><span class="o">.</span><span class="na">setLastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">));</span>
                <span class="n">groupOfUsers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">userMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">),</span> <span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="k">return</span> <span class="n">userMap</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ユーザ定義型のListオブジェクトのマッピングがRow.getList()メソッドではうまく動作しなかったため、row.getObject()にてリスト型データを取得し、マッピングし直している。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-address-label">
<span id="id19"></span><h4>指定されたユーザの住所を追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-address-label" title="Permalink to this headline">¶</a></h4>
<p>指定されたユーザの住所データを追加する場合は、Repositoryクラスのsaveメソッドを利用すれば良いが、本サンプルでは郵便番号検索や、住所全件検索のために住所データをAddressテーブルと、UserテーブルのAddressOfUserプロパティに非正規化している。そのため、Service実装クラスでは、２回データの追加を行うことになる。</p>
<div class="literal-block-wrapper docutils container" id="id96">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addAddress(Long userId, String zipCd, String address)</span><a class="headerlink" href="#id96" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Add data to Address Table</span>
        <span class="n">Address</span> <span class="n">saveAddress</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                     <span class="o">.</span><span class="na">addresspk</span><span class="o">(</span><span class="n">AddressPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                         <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                                         <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">)</span>
                                                         <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                     <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
                                     <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                     <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">saveAddress</span><span class="o">);</span>
        <span class="c1">// Add data to Address of User</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">addAddress</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>また、AddressOfUserはユーザ定義型としてUDTValueを使用しているので、カスタムレポジトリに追加で実装を行う。
UDTValueは org.springframework.data.cassandra.core.CassandraAdminOperationsからKeyspaceMetadataを取得し、UserTypeを使って生成する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.KeyspaceMetadata</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UserType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.repository.UserRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryImpl</span> <span class="kd">implements</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraAdminOperations&quot;</span><span class="o">)</span>
    <span class="n">CassandraAdminOperations</span> <span class="n">cassandraAdminOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">);</span>
       <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserMapExtractor</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// For instantiating udtvalue object, need to use cassandraadminoperations.</span>
        <span class="n">KeyspaceMetadata</span> <span class="n">keyspaceMetadata</span> <span class="o">=</span> <span class="n">cassandraAdminOperations</span><span class="o">.</span><span class="na">getKeyspaceMetadata</span><span class="o">();</span>
        <span class="n">UserType</span> <span class="n">userTypeAddress</span> <span class="o">=</span> <span class="n">keyspaceMetadata</span><span class="o">.</span><span class="na">getUserType</span><span class="o">(</span><span class="s">&quot;addressofuser&quot;</span><span class="o">);</span>

        <span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">=</span> <span class="n">userTypeAddress</span><span class="o">.</span><span class="na">newValue</span><span class="o">();</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">,</span> <span class="n">zipCd</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">udtValue</span><span class="o">);</span>

        <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>なお、 org.springframework.data.cassandra.core.CassandraAdminOperationsが使用可能なよう、Bean定義を行なっておくこと。</p>
<div class="literal-block-wrapper docutils container" id="id97">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.confing.infra.CommonCassandraConfig</span><a class="headerlink" href="#id97" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.config.infra</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.config.SchemaAction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.config.java.AbstractCassandraConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.convert.CassandraConverter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Session</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CommonCassandraConfig</span> <span class="kd">extends</span> <span class="n">AbstractCassandraConfiguration</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">SchemaAction</span> <span class="nf">getSchemaAction</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">CREATE_IF_NOT_EXISTS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CassandraTemplate</span> <span class="nf">cassandraTemplate</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CassandraTemplate</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CassandraAdminOperations</span> <span class="nf">cassandraAdminOperations</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CassandraAdminTemplate</span><span class="o">(</span><span class="n">session</span><span class="o">().</span><span class="na">getObject</span><span class="o">(),</span> <span class="n">cassandraConverter</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-update-address-label">
<span id="id20"></span><h4>指定されたユーザの住所を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-update-address-label" title="Permalink to this headline">¶</a></h4>
<p>指定されたユーザの住所データを更新する場合、Cassandraでは既にキーがあるデータの追加は更新として扱われるため、Repositoryクラスのsaveメソッドを利用すれば良い。ただし、本サンプルでは郵便番号検索や、住所全件検索のために住所データをAddressテーブルと、UserテーブルのAddressOfUserプロパティに非正規化している。そのため、Service実装クラスでは、２回データの追加を行うことになる。</p>
<div class="literal-block-wrapper docutils container" id="id98">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#updateAddress(Long userId, String zipCd, String address)</span><a class="headerlink" href="#id98" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span>
<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Address</span> <span class="n">updateAddress</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span>
                                    <span class="n">AddressPK</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setVer</span><span class="o">(</span><span class="n">updateAddress</span><span class="o">.</span><span class="na">getVer</span><span class="o">()+</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">updateAddress</span><span class="o">.</span><span class="na">setLastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">addressRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">updateAddress</span><span class="o">);</span>

        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">,</span> <span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)+</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">udtValue</span><span class="o">.</span><span class="na">setTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-address-label">
<span id="id21"></span><h4>指定されたユーザの住所を削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-address-label" title="Permalink to this headline">¶</a></h4>
<p>指定されたユーザの住所データを削除する場合、Repositoryクラスのdeleteメソッドを利用すれば良い。ただし、本サンプルでは郵便番号検索や、住所全件検索のために住所データをAddressテーブルと、UserテーブルのAddressOfUserプロパティに非正規化している。そのため、Service実装クラスでは、Addressテーブルについては、delete()メソッドで削除を行い、UserオブジェクトではNULLを設定する。</p>
<div class="literal-block-wrapper docutils container" id="id99">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteAddress(Long userId)</span><a class="headerlink" href="#id99" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addresses</span><span class="o">){</span>
            <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-user-by-email-label">
<span id="id22"></span><h4>特定のメールアドレスを持つユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-user-by-email-label" title="Permalink to this headline">¶</a></h4>
<p>特定のEmailからユーザを検索する場合、Email Tableはemailをプライマリキーとしたテーブル構造となっているので、対象のEmailを取得したのち、userIdをキーにしてUserテーブルからデータを取得する。</p>
<div class="literal-block-wrapper docutils container" id="id100">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUserByEmail(String email)</span><a class="headerlink" href="#id100" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span>
            <span class="n">emailRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">email</span><span class="o">).</span><span class="na">getUserId</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-email-label">
<span id="id23"></span><h4>指定されたユーザのメールアドレスを追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-email-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを追加する場合は、EmailRepository.save()メソッドを使用すればよい。なお、UserクラスのList&lt;Email&gt;は&#64;Transientを付与しているので、特に永続化はされない。あくまでView層に返す際にデータを設定しているだけである。</p>
<div class="literal-block-wrapper docutils container" id="id101">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addEmail(Long userId, String email)</span><a class="headerlink" href="#id101" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">addEmail</span> <span class="o">=</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                              <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="n">emails</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-user-with-email-label">
<span id="id24"></span><h4>指定されたユーザをメールアドレスを含めて追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-user-with-email-label" title="Permalink to this headline">¶</a></h4>
<p>ユーザデータと一緒にEmailを追加する場合も、それぞれUserRepository.save()、EmailRepository.save()メソッドを使って各々データを保存すれば良い。なお、UserクラスのList&lt;Email&gt;は&#64;Transientを付与しているので、特に永続化はされない。あくまでView層に返す際にデータを設定しているだけである。</p>
<div class="literal-block-wrapper docutils container" id="id102">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addUserWithEmail(Long userId, String userName, String email)</span><a class="headerlink" href="#id102" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addUserWithEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">addEmail</span> <span class="o">=</span> <span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                              <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
        <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addEmail</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">addUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                           <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">userName</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">emails</span><span class="o">(</span><span class="n">emails</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                           <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                           <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">addUser</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-update-email-label">
<span id="id25"></span><h4>指定されたユーザのメールアドレスを更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-update-email-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを更新する場合、Emailはプライマリキーであるため、そのまま更新をかけようとすると、新たなキーとしてデータが追加されてしまうため、一度データを削除して、追加を行う形でデータ更新を行う必要がある。</p>
<div class="literal-block-wrapper docutils container" id="id103">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#updateEmail(Long userId, String email, String newEmail)</span><a class="headerlink" href="#id103" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">newEmail</span><span class="o">)</span> <span class="o">{</span>

        <span class="cm">/* Primary key updating equals new saving row.</span>
<span class="cm">        Email updateEmail = emailRepository.findOne(email);</span>
<span class="cm">        updateEmail.setEmail(newEmail);</span>
<span class="cm">        emailRepository.save(updateEmail);</span>
<span class="cm">        */</span>

        <span class="n">Email</span> <span class="n">deleteEmail</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteEmail</span><span class="o">);</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                  <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">newEmail</span><span class="o">)</span>
                                      <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                  <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-email-label">
<span id="id26"></span><h4>指定されたユーザのメールアドレスを1件削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-email-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを削除する場合、単純に指定されたEmailオブジェクトを取得し、EmailRepository.delete()メソッドを実行すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id104">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteEmail(Long userId, String email)</span><a class="headerlink" href="#id104" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Email</span> <span class="n">deleteEmail</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteEmail</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-emails-label">
<span id="id27"></span><h4>指定されたユーザのメールアドレスを全件削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-emails-label" title="Permalink to this headline">¶</a></h4>
<p>Emailを全て削除する場合、ユーザIDをキーにEmailオブジェクトのリストを取得し、各データをEmailRepository.delete()メソッドを実行して各々削除すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id105">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteEmails(Long userId)</span><a class="headerlink" href="#id105" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span> <span class="o">:</span> <span class="n">emails</span><span class="o">){</span>
            <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-group-by-userid-label">
<span id="id28"></span><h4>指定したユーザが属するグループの一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-group-by-userid-label" title="Permalink to this headline">¶</a></h4>
<p>指定したユーザが所属するグループを検索する場合、リレーショナルモデルでは通常多対多の関連を持ち、関連実体となるテーブル(例えば所属など)を結合して、データを取得する方法が一般的であるが、Cassandraでは結合はサポートされていない。ここでは、全件検索したGroupテーブルとは別にUserテーブルにGroupのListデータを持たせて非正規化を行う。理由は、次セクション「指定したグループに所属する全てのユーザ一覧を取得する」で説明するが、逆にGroupにもUserのデータを持たせる必要があるため、相互参照(循環参照)とならないよう、Userエンティティにユーザ定義型クラスGroupOfUserクラスを作成する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement.</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>

        <span class="kd">public</span> <span class="nf">User</span><span class="o">(){</span>
        <span class="o">}</span>
        <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>

        <span class="c1">// omit</span>

        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;groups&quot;</span><span class="o">)</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groups</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id106">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.entity.GroupOfUser</span><a class="headerlink" href="#id106" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupOfUser</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nf">GroupOfUser</span><span class="o">(){}</span>
    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>データの取得は単純にUserRepositoryからUserデータを取得し、Groupを返すだけで良い。</p>
<div class="literal-block-wrapper docutils container" id="id107">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getGroups(Long userId)</span><a class="headerlink" href="#id107" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupsOfUser</span> <span class="o">=</span>  <span class="n">getGroupsOfUser</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Lists</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">groupsOfUser</span><span class="o">,</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Group</span> <span class="nf">apply</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">mapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">,</span> <span class="n">Group</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="nf">getGroupsOfUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">getGroups</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ここではList&lt;Group&gt;を返却するためにList&lt;GroupOfUser&gt;を、GuavaのListsクラスを使って変換している。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-users-by-groupid-label">
<span id="id29"></span><h4>指定したグループに所属する全てのユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-users-by-groupid-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザが属するグループの一覧を取得する」と同様、こちらは逆パターンであり、GroupエンティティにもUserデータのListを保持し、非正規化する。同様にUserクラスもGroupのデータを保持する必要があるため、相互にUser -&gt; Group、Group -&gt; Userの参照をもつと相互参照(循環参照)になってしまうため、ここでもGroup内にUserと同じプロパティをもつUserOfGroupをユーザ定義型クラスとして作成する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="c1">// omit import statement</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Group</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserOfGroup</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nf">UserOfGroup</span><span class="o">(){}</span>
    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isEnabled</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isAdmin</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Service実装クラスからはGroupRepositoryを介してデータを取得し、返却するだけで良い。</p>
<div class="literal-block-wrapper docutils container" id="id108">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getUsersByGroupId(Long groupId)</span><a class="headerlink" href="#id108" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="n">getUsersOfGroup</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Lists</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">usersOfGroup</span><span class="o">,</span> <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;(){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">User</span> <span class="nf">apply</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">mapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="nf">getUsersOfGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">).</span><span class="na">getUsers</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ここではList&lt;User&gt;を返却するためにList&lt;UserOfGroup&gt;を、GuavaのListsクラスを使って変換している。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-get-not-users-by-groupid-label">
<span id="id30"></span><h4>指定したグループに所属しない全てのユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-get-not-users-by-groupid-label" title="Permalink to this headline">¶</a></h4>
<p>ユースケース「特定の郵便番号を持たないユーザ一覧を取得する」と同じく、特定のグループに所属するユーザを全体のユーザから除外したリストを返却すれば良い。Service実装クラスは、</p>
<div class="literal-block-wrapper docutils container" id="id109">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#getNotUsersByGroupId(Long groupId)</span><a class="headerlink" href="#id109" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getNotUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">).</span><span class="na">getUsers</span><span class="o">();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMap</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">usersOfGroup</span><span class="o">){</span>
            <span class="n">userMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userMap</span><span class="o">.</span><span class="na">values</span><span class="o">());</span>
         <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">UserRepository.findAllForMap()はユースケース「特定の郵便番号を持たないユーザ一覧を取得する」で作成したカスタムUserRepositoryクラスのメソッドである。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-add-user-to-group-label">
<span id="id31"></span><h4>指定したユーザを指定したグループに追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-add-user-to-group-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザが属するグループの一覧を取得する」、「指定したグループに所属する全てのユーザ一覧を取得する」のユースケースにおいて、User及びGroupエンティティにそれぞれ非正規化されたデータが定義されている。そのため、各テーブルに相互に整合性が取れた形でデータを保存する必要がある。</p>
<div class="literal-block-wrapper docutils container" id="id110">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#addUserToGroup(Long userId, Long groupId)</span><a class="headerlink" href="#id110" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">addUserToGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="n">group</span><span class="o">.</span><span class="na">getUsers</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">UserOfGroup</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUserName</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isEnabled</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isLocked</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">isAdmin</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">getGroups</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">GroupOfUser</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">groupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">groupName</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-user-from-group-label">
<span id="id32"></span><h4>指定したユーザをグループから除外する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-user-from-group-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザを指定したグループに追加する」と同様、非正規化されたデータに対し、双方データ更新を行う必要がある。
Listデータからremove()すると実装が複雑化するので、除外しないデータだけで新たなListを作成し、更新する実装とする。</p>
<div class="literal-block-wrapper docutils container" id="id111">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteUserFromGroup(Long userId, Long groupId)</span><a class="headerlink" href="#id111" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteUserFromGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupsOfUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getGroups</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">groupId</span> <span class="o">!=</span> <span class="n">groupOfUser</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()){</span>
                <span class="n">groupsOfUser</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setGroups</span><span class="o">(</span><span class="n">groupsOfUser</span><span class="o">);</span>
        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">group</span><span class="o">.</span><span class="na">getUsers</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">userId</span> <span class="o">!=</span> <span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()){</span>
                <span class="n">usersOfGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">);</span>
            <span class="o">}</span>
                <span class="o">}</span>
        <span class="n">group</span><span class="o">.</span><span class="na">setUsers</span><span class="o">(</span><span class="n">usersOfGroup</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-group-label">
<span id="id33"></span><h4>指定したグループを削除し、ユーザが所属するグループの情報を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-group-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「指定したユーザを指定したグループに追加する」と同様、非正規化されたデータに対し、双方データ更新を行う必要がある。
Listデータからremove()すると実装が複雑化するので、除外しないデータだけで新たなListを作成し、更新する実装とする。</p>
<div class="literal-block-wrapper docutils container" id="id112">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteGroup(Long groupId)</span><a class="headerlink" href="#id112" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Group</span> <span class="n">deleteGroup</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">deleteGroup</span><span class="o">.</span><span class="na">getUsers</span><span class="o">()){</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;</span> <span class="n">groupsOfUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">GroupOfUser</span><span class="o">&gt;();</span>
            <span class="k">for</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getGroups</span><span class="o">()){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">()</span> <span class="o">!=</span> <span class="n">groupId</span><span class="o">){</span>
                    <span class="n">groupsOfUser</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setGroups</span><span class="o">(</span><span class="n">groupsOfUser</span><span class="o">);</span>
            <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
                <span class="n">groupRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteGroup</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">deleteGroup</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten1-delete-user-label">
<span id="id34"></span><h4>指定されたユーザを削除し、グループのユーザ一覧を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten1-delete-user-label" title="Permalink to this headline">¶</a></h4>
<p>ユーザデータを削除するにあたり、これまで非正規化したテーブルなど含めて全てデータ更新する必要がある。</p>
<div class="literal-block-wrapper docutils container" id="id113">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern1.domain.service.SampleServiceImpl#deleteUser(Long userId)</span><a class="headerlink" href="#id113" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern1.domain.service</span><span class="o">;</span>

<span class="c1">// omit other import statement.</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AddressRepository</span> <span class="n">addressRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">EmailRepository</span> <span class="n">emailRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="c1">// omit</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">deleteUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">GroupOfUser</span> <span class="n">groupOfUser</span> <span class="o">:</span> <span class="n">deleteUser</span><span class="o">.</span><span class="na">getGroups</span><span class="o">()){</span>
            <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupOfUser</span><span class="o">.</span><span class="na">getGroupId</span><span class="o">());</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;</span> <span class="n">usersOfGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">UserOfGroup</span><span class="o">&gt;();</span>
            <span class="k">for</span><span class="o">(</span><span class="n">UserOfGroup</span> <span class="n">userOfGroup</span> <span class="o">:</span> <span class="n">group</span><span class="o">.</span><span class="na">getUsers</span><span class="o">()){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">userId</span> <span class="o">!=</span> <span class="n">userOfGroup</span><span class="o">.</span><span class="na">getUserId</span><span class="o">()){</span>
                    <span class="n">usersOfGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userOfGroup</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">group</span><span class="o">.</span><span class="na">setUsers</span><span class="o">(</span><span class="n">usersOfGroup</span><span class="o">);</span>
            <span class="n">groupRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span> <span class="o">:</span> <span class="n">addressRepository</span><span class="o">.</span><span class="na">findByAddresspkUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">)){</span>
            <span class="n">addressRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">email</span> <span class="o">:</span> <span class="n">emailRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">)){</span>
            <span class="n">emailRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Credential</span> <span class="n">credential</span> <span class="o">:</span> <span class="n">credentialRepository</span><span class="o">.</span><span class="na">findByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">)){</span>
            <span class="n">credentialRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">credential</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">deleteUser</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">deleteUser</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">ノード数を増やした状態で検証し、性能問題が起きないか検証を行う。</p>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-using-spring-data-cassandra-patten2-label">
<span id="id35"></span><h3>パターン2(リレーショナルモデル)を中心としたデータモデル<a class="headerlink" href="#section6-x-x-x-usecase-implementation-using-spring-data-cassandra-patten2-label" title="Permalink to this headline">¶</a></h3>
<p>効率的なデータベースアクセスの検証のため、リレーショナルに近いデータモデルを構築する。
本サンプルでは、以下の構成をパターン2として実装例を記述する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../../_images/data-modeling-pattern2.png"><img alt="../../_images/data-modeling-pattern2.png" src="../../_images/data-modeling-pattern2.png" style="width: 860.0px; height: 913.0px;" /></a>
</div>
<p>テーブルとして定義する、各エンティティクラスの実装は以下の通り。</p>
<div class="literal-block-wrapper docutils container" id="id114">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><a class="headerlink" href="#id114" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Transient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;login_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">loginId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;credentials&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;</span> <span class="n">credentials</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isEnabled</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isAdmin</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;emails&quot;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="nd">@Transient</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">groups</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id115">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.Group</span><a class="headerlink" href="#id115" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Transient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Group</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Group</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;group_name&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>
    <span class="nd">@Transient</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id116">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.Affiliation</span><a class="headerlink" href="#id116" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;affiliation&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Affiliation</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Affiliation</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;affiliationpk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AffiliationPK</span> <span class="n">affiliationpk</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
        <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id117">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.AffiliationPK</span><a class="headerlink" href="#id117" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.PrimaryKeyType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyColumn</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@PrimaryKeyClass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AffiliationPK</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">6634695143792297552L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AffiliationPK</span><span class="o">(){}</span>
    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">CLUSTERED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;group_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">PARTITIONED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>ユーザ定義型クラスは以下の通り。</p>
<div class="literal-block-wrapper docutils container" id="id118">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.Address</span><a class="headerlink" href="#id118" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">address</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id119">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.Email</span><a class="headerlink" href="#id119" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Email</span> <span class="o">{</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id120">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.Credential</span><a class="headerlink" href="#id120" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.UserDefinedType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@UserDefinedType</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Credential</span> <span class="o">{</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;credential_type&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">credentialType</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;credential_key&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">credentialKey</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;expired_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">expiredDate</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記のエンティティクラスと対応づくテーブル定義は以下の通りである。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">sample</span><span class="p">.</span><span class="n">address</span> <span class="p">(</span>
    <span class="n">address</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">zip_cd</span> <span class="nb">text</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">sample</span><span class="p">.</span><span class="n">credential</span> <span class="p">(</span>
    <span class="n">credential_key</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">credential_type</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">expired_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">sample</span><span class="p">.</span><span class="n">email</span> <span class="p">(</span>
    <span class="n">email</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="k">group</span> <span class="p">(</span>
    <span class="n">group_id</span> <span class="nb">bigint</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">group_name</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="n">users</span> <span class="p">(</span>
    <span class="n">user_id</span> <span class="nb">bigint</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">address</span> <span class="n">frozen</span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">credentials</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">&lt;</span><span class="n">credential</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">emails</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">&lt;</span><span class="n">email</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="n">is_admin</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">is_enabled</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">is_locked</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">login_id</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">user_name</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span>
<span class="p">)</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sample</span><span class="p">.</span><span class="n">affiliation</span> <span class="p">(</span>
    <span class="n">group_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">user_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">last_updated_date</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">ver</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-users-label">
<span id="id36"></span><h4>全てのユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-users-label" title="Permalink to this headline">¶</a></h4>
<p>Service実装クラスでは、パターン1とも同様に、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Userテーブルのすべてのデータを検索する場合は、UserRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper docutils container" id="id121">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getUsers()</span><a class="headerlink" href="#id121" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-addresses-label">
<span id="id37"></span><h4>全ての住所を検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-addresses-label" title="Permalink to this headline">¶</a></h4>
<p>Addressクラスはユーザ定義クラスであり、Addressテーブルを定義していない。そのため、すべての住所を取得するには、Userデータから住所データを取得し、List型で返却する。</p>
<div class="literal-block-wrapper docutils container" id="id122">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getAddresses()</span><a class="headerlink" href="#id122" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="nf">getAddresses</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">getUsers</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="n">addresses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">addresses</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p class="last">テーブルを作成し、非正規化した場合に比べて、データ数に応じてどれだけ差が出るか検証</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-emails-label">
<span id="id38"></span><h4>全てのメールアドレスを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-emails-label" title="Permalink to this headline">¶</a></h4>
<p>Address同様、Emailクラスはユーザ定義クラスであり、Emailテーブルを定義していない。そのため、すべてのEmailを取得するには、UserデータからEmailデータを取得し、List型で返却する。</p>
<div class="literal-block-wrapper docutils container" id="id123">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getEmails()</span><a class="headerlink" href="#id123" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">getUsers</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">allEmails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
                <span class="n">allEmails</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getEmails</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">allEmails</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-groups-label">
<span id="id39"></span><h4>全てのグループを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-groups-label" title="Permalink to this headline">¶</a></h4>
<p>パターン1とも同様に、CrudRepositoryインターフェースを継承したインターフェースのメソッドを呼び出せばよい。
Groupテーブルのすべてのデータを検索する場合は、GroupRepository.findAll()を使用する。</p>
<div class="literal-block-wrapper docutils container" id="id124">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getGroups()</span><a class="headerlink" href="#id124" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;)</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-user-label">
<span id="id40"></span><h4>特定のユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-user-label" title="Permalink to this headline">¶</a></h4>
<p>パターン1の場合同様、特定のユーザを検索する場合は、CrudRepositoryインターフェースが持つfindOneメソッドを実行すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id125">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getUser(Long userId)</span><a class="headerlink" href="#id125" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-address-label">
<span id="id41"></span><h4>特定のユーザのアドレスを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-address-label" title="Permalink to this headline">¶</a></h4>
<p>特定のユーザのアドレスは、テーブルUserの中にユーザ定義クラスAddressの形で保持しているので、ユーザデータを取得してアドレスデータをそのまま返せば良い。</p>
<div class="literal-block-wrapper docutils container" id="id126">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getAddress(Long userId)</span><a class="headerlink" href="#id126" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Address</span> <span class="nf">getAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">getAddress</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-email-label">
<span id="id42"></span><h4>特定のユーザがもつEmailアドレスを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-email-label" title="Permalink to this headline">¶</a></h4>
<p>前セクション「特定のユーザのアドレス」と同様、テーブルUserの中にユーザ定義クラスEmailをList形式で保持しているので、ユーザデータを取得して、Emailデータをそのまま返せば良い。</p>
<div class="literal-block-wrapper docutils container" id="id127">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getEmails(Long userId)</span><a class="headerlink" href="#id127" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">getEmails</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-group-by-groupname-label">
<span id="id43"></span><h4>指定したグループ名を元にグループを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-group-by-groupname-label" title="Permalink to this headline">¶</a></h4>
<p>パターン1と同様、GroupRepositoryインターフェースにfindByGroupNameメソッドを定義し、allow filteringオプションを付与したCQLを定義する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GroupRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;{</span>

    <span class="c1">// Use query adding allow filtering option or secondary index or materialized view.</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;select * from group where group_name = ?0 allow filtering&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">findByGroupName</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<p>サービス実装クラスからは、上記のメソッドを呼び出す。</p>
<div class="literal-block-wrapper docutils container" id="id128">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getGroups(String groupName)</span><a class="headerlink" href="#id128" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">GroupRepository</span> <span class="n">groupRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">String</span> <span class="n">groupName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupName</span><span class="o">(</span><span class="n">groupName</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-users-by-zipcd-label">
<span id="id44"></span><h4>特定の郵便番号を持つユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-users-by-zipcd-label" title="Permalink to this headline">¶</a></h4>
<p>郵便番号は、ユーザ定義型クラスのプロパティであり、Userテーブルの中でキーとして使用することはできない。検索キーとして用いるのであれば、パターン1と同様、住所に関する情報を非正規化して別のテーブルに切り出すしかない。非正規化を選ばない例として、ここでは、アプリケーションで、取得したユーザ情報から該当する郵便番号と一致する方法で実装する。</p>
<div class="literal-block-wrapper docutils container" id="id129">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getUsers(String zipCd)</span><a class="headerlink" href="#id129" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">getUsers</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()</span>
                    <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getZipCd</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">zipCd</span><span class="o">)){</span>
                <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>しかし、このサービス層で対象のデータを検索する実装を行う方法は、当然ユーザテーブルから取得したデータ件数が多ければ多いほど、線形的に処理時間が増加するため、データ件数が膨大な場合は推奨はされない方法である。そのため、Cassandraからデータ取得したResultSetからエンティティクラスにマッピングする際に、郵便番号をキーとしたMap型でユーザ一覧を返却することにより、処理時間の高速化を行う。パターン1の「特定の番号を持たないユーザ一覧を取得する」場合と同様、Repositoryクラスを拡張し、郵便番号をキーとして、その郵便番号をもつユーザのリスト型をバリューにもつ、Mapを返却するメソッドをRepositoryクラスに作成する。</p>
<p>まず、カスタムのメソッドを持つ、インターフェースを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id130">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepositoryCustom</span><a class="headerlink" href="#id130" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepositoryCustom</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="nf">findAllForMappedListByZipCd</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>作成したインターフェースをUserRepositoryクラスに継承させる。</p>
<div class="literal-block-wrapper docutils container" id="id131">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepository#2</span><a class="headerlink" href="#id131" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

    <span class="c1">// omit</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="c1">// omit</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>メソッドを実装したクラスを作成する。また、ResultSetExtractorを拡張し、Map&lt;String, List&lt;User&gt;&gt;型でユーザ一覧を返却する、UserMappedListByZipCdExtractorクラスを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id132">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.UserRepositoryImpl</span><a class="headerlink" href="#id132" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryImpl</span> <span class="kd">implements</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="nf">findAllForMappedListByZipCd</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserMappedListByZipCdExtractor</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id133">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.UserMappedListByZipCdExtractor</span><a class="headerlink" href="#id133" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Credential</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Group</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.ResultSetExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.DataAccessException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.exceptions.DriverException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMappedListByZipCdExtractor</span> <span class="kd">implements</span>
                                 <span class="n">ResultSetExtractor</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;&gt;{</span>

    <span class="nd">@Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="nf">extractData</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">resultSet</span><span class="o">)</span>
                                        <span class="kd">throws</span> <span class="n">DriverException</span><span class="o">,</span> <span class="n">DataAccessException</span> <span class="o">{</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">mappedLists</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">hasNext</span><span class="o">()){</span>

            <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">resultSet</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
            <span class="n">UDTValue</span> <span class="n">address</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getUDTValue</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;</span> <span class="n">credentials</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;();</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">emails</span><span class="o">(</span><span class="n">emails</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">credentials</span><span class="o">(</span><span class="n">credentials</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">groups</span><span class="o">(</span><span class="n">groups</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

            <span class="n">String</span> <span class="n">zipCd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="k">if</span><span class="o">(</span><span class="n">address</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">zipCd</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">);</span>
                <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">((</span><span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">))</span>
                                        <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                        <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                        <span class="o">.</span><span class="na">build</span><span class="o">()));</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="n">zipCd</span> <span class="o">=</span> <span class="s">&quot;No address data.&quot;</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span><span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;emails&quot;</span><span class="o">)){</span>
                <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">))</span>
                                <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span><span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;credentials&quot;</span><span class="o">)){</span>
                <span class="n">credentials</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Credential</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                          <span class="o">.</span><span class="na">credentialType</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;credential_type&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">credentialKey</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;credential_key&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">expiredDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;expired_date&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">mappedLists</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">users</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;();</span>
                <span class="n">mappedLists</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">zipCd</span><span class="o">,</span> <span class="n">users</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="o">}</span>
        <span class="k">return</span> <span class="n">mappedLists</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>サービスクラスからは、キーである郵便番号ごとにユーザリストがまとまっているため、指定されたキーのユーザデータを返却するだけで良い。</p>
<div class="literal-block-wrapper docutils container" id="id134">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getUsers(String zipCd)i#2</span><a class="headerlink" href="#id134" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">usersMapByZipCd</span> <span class="o">=</span>
                                     <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMappedListByZipCd</span><span class="o">();</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">usersMapByZipCd</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition-todo admonition" id="index-4">
<p class="first admonition-title">Todo</p>
<p class="last">Cassandraのような分散データベースが、パターン1の方法で非正規化データを取得する場合に比べ、どの程度の件数が許容する性能の分岐点になるか目処感を検証しておく。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">パターン2のテーブル構成で性能を保つ別の一案として、非正規化せずに、アプリケーション起動時に郵便番号をキーとしたユーザ一覧をキャッシュとしてもつ実装も一案として実現は可能であるが、ユーザの郵便番号が変更されるたびにキャッシュを更新せねばならず、また分散データベース環境であるため、キャッシュを更新する実装が逆に著しく複雑になると予想されるため、除外する。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-not-users-by-zipcd-label">
<span id="id45"></span><h4>特定の郵便番号を持たないユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-not-users-by-zipcd-label" title="Permalink to this headline">¶</a></h4>
<p>「特定の郵便番号を持つユーザ一覧を取得する」のユースケースの場合と同じで、全ユーザの中で、逆に郵便番号が一致しないユーザデータをList型で返却すれば良い。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">この方法は、当然ユーザテーブルから取得したデータ件数が多ければ多いほど、線形的に処理時間が増加するため、データ件数が膨大な場合は推奨はされない方法である。</p>
</div>
<div class="literal-block-wrapper docutils container" id="id135">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getNotUsers(String zipCd)</span><a class="headerlink" href="#id135" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getNotUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">getUsers</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getZipCd</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">zipCd</span><span class="o">)){</span>
                <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>こちらも前ユースケース「特定の郵便番号を持つユーザ一覧を取得する」場合と同様、データ数が多ければ、使用できない実装であるため、拡張したRepositoryクラスのfindAllForMappedListByZipCdメソッドを使用して取得したデータから、特定のキーを除外した結果を返すと良い。サービスクラスは以下のような実装になる。</p>
<div class="literal-block-wrapper docutils container" id="id136">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getNotUsers(String zipCd)#2</span><a class="headerlink" href="#id136" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getNotUsers</span><span class="o">(</span><span class="n">String</span> <span class="n">zipCd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">usersMapByZipCd</span> <span class="o">=</span>
                                      <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMappedListByZipCd</span><span class="o">();</span>
        <span class="n">usersMapByZipCd</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">usersMapByZipCd</span><span class="o">.</span><span class="na">entrySet</span><span class="o">()){</span>
            <span class="n">users</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">パターン2のテーブル構成で性能を保つ別の一案として、非正規化せずに、アプリケーション起動時に郵便番号をキーとしたユーザ一覧をキャッシュとして構築し、データアクセス時にキャッシュを参照する実装も一案として実現は可能であるが、ユーザの住所情報や郵便番号が変更されるたびにキャッシュを更新せねばならず、また分散データベース環境であるため、キャッシュを更新する実装が逆に著しく複雑になると予想されるため、除外する。</p>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-add-address-label">
<span id="id46"></span><h4>指定されたユーザの住所を追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-add-address-label" title="Permalink to this headline">¶</a></h4>
<p>単純にUserテーブルのAddressプロパティにデータを追加すれば良い。NULLの場合は単純にデータ追加すればよいが、すでにAddressデータがある場合は、既存のデータを更新するロジックを実装する必要がある。</p>
<div class="literal-block-wrapper docutils container" id="id137">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#addAddress(Long userId, String zipCd, String address)</span><a class="headerlink" href="#id137" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getUser</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">()){</span>
                <span class="n">Address</span> <span class="n">addAddress</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                            <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">)</span>
                                            <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
                                            <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                            <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
                <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">addAddress</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="n">Address</span> <span class="n">updateAddress</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
                <span class="n">updateAddress</span><span class="o">.</span><span class="na">setZipCd</span><span class="o">(</span><span class="n">zipCd</span><span class="o">);</span>
                <span class="n">updateAddress</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
                <span class="n">updateAddress</span><span class="o">.</span><span class="na">setVer</span><span class="o">(</span><span class="n">updateAddress</span><span class="o">.</span><span class="na">getVer</span><span class="o">()+</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">updateAddress</span><span class="o">.</span><span class="na">setLastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-update-address-label">
<span id="id47"></span><h4>指定されたユーザの住所を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-update-address-label" title="Permalink to this headline">¶</a></h4>
<p>UserテーブルのAddressプロパティにデータを更新する。ロジックは前ユースケース「指定されたユーザの住所を追加する」と同じのため、そのまま利用する。</p>
<div class="literal-block-wrapper docutils container" id="id138">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#updateAddress(Long userId, String zipCd, String address)</span><a class="headerlink" href="#id138" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">addAddress</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">zipCd</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-delete-address-label">
<span id="id48"></span><h4>指定されたユーザの住所を削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-delete-address-label" title="Permalink to this headline">¶</a></h4>
<p>Userテーブルのアドレスプロパティのデータを削除する。エンティティクラスを取得し、NULLをセットする。</p>
<div class="literal-block-wrapper docutils container" id="id139">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#deleteAddress(Long userId)</span><a class="headerlink" href="#id139" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteAddress</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getUser</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">){</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-user-by-email-label">
<span id="id49"></span><h4>特定のメールアドレスを持つユーザを検索する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-user-by-email-label" title="Permalink to this headline">¶</a></h4>
<p>メールアドレスも、ユーザ定義型クラスEmailのプロパティであり、ユーザテーブルに1対多の形式でリスト型で保持されているので、検索キーとして利用することはできない。従って、サービスクラス上で、対象のメールアドレスを検索するロジックを実装する必要があるが、ユースケース「特定の郵便番号を持つユーザを検索する」場合と同様に、順次検索では、ユーザデータ量に比例して、線形的に増加する。</p>
<div class="literal-block-wrapper docutils container" id="id140">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getUserByEmail(String email)</span><a class="headerlink" href="#id140" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsers</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">getUsers</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
                <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">target</span><span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getEmail</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">email</span><span class="o">)){</span>
                        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>そのため、ResultSetからのエンティティクラスのマッピング時に、メールアドレスをキーとしたMap型でユーザ一覧を作成する方式で実装を行う。UserRepositoryの拡張インタンーフェースにカスタムメソッドを定義する。</p>
<div class="literal-block-wrapper docutils container" id="id141">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepositoryCustom#2</span><a class="headerlink" href="#id141" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepositoryCustom</span> <span class="o">{</span>

    <span class="c1">//omit</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMappByEmail</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記の実装クラスは以下の通りである。また、cassandraOperation.query()メソッドの引数として指定する、ResultSetExtractorを継承して、メールアドレスをキーに、Map&lt;String, User&gt;型のユーザ一覧を返却するよう、UserMapByEmailExtractorを実装する。</p>
<div class="literal-block-wrapper docutils container" id="id142">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.UserRepositoryImpl#2</span><a class="headerlink" href="#id142" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryImpl</span> <span class="kd">implements</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMappByEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserMapByEmailExtractor</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id143">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.UserMapByEmailExtractor</span><a class="headerlink" href="#id143" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Credential</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.ResultSetExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.DataAccessException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.exceptions.DriverException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMapByEmailExtractor</span> <span class="kd">implements</span> <span class="n">ResultSetExtractor</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;&gt;{</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">extractData</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">resultSet</span><span class="o">)</span>
                                         <span class="kd">throws</span> <span class="n">DriverException</span><span class="o">,</span> <span class="n">DataAccessException</span> <span class="o">{</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">mappedUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">hasNext</span><span class="o">()){</span>

            <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">resultSet</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
            <span class="n">UDTValue</span> <span class="n">address</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getUDTValue</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;</span> <span class="n">credentials</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;();</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">emails</span><span class="o">(</span><span class="n">emails</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">credentials</span><span class="o">(</span><span class="n">credentials</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">address</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                       <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span><span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;emails&quot;</span><span class="o">)){</span>
                <span class="n">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">);</span>
                <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
                <span class="n">mappedUser</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span><span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;credentials&quot;</span><span class="o">)){</span>
                <span class="n">credentials</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Credential</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                          <span class="o">.</span><span class="na">credentialType</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;credential_type&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">credentialKey</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;credential_key&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">expiredDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;expired_date&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                                                  <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">mappedUser</span><span class="o">;</span>
     <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>サービス実装クラスでは、キーとなるemailを指定して、一致するUserデータを返却すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id144">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getUserByEmail(String email)#2</span><a class="headerlink" href="#id144" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">usersMapByEmail</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMappByEmail</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">usersMapByEmail</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-add-email-label">
<span id="id50"></span><h4>指定されたユーザのメールアドレスを追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-add-email-label" title="Permalink to this headline">¶</a></h4>
<p>メールアドレスはユーザ定義クラスEmailのプロパティであり、Userテーブルに保持されているので、対象のデータを取得して、Emailデータを追加すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id145">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#addEmail(Long userId, String email)</span><a class="headerlink" href="#id145" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                  <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                  <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                                  <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-add-user-with-email-label">
<span id="id51"></span><h4>指定されたユーザをメールアドレスを含めて追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-add-user-with-email-label" title="Permalink to this headline">¶</a></h4>
<p>ユースケース「指定されたユーザのメールアドレス」を追加すると同様、Userクラスにユーザ定義クラスEmailを含め、必要なデータをセットして追加すればよい。</p>
<div class="literal-block-wrapper docutils container" id="id146">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#addUserWithEmail(Long userId, String userName, String email)</span><a class="headerlink" href="#id146" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">addUserWithEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">userName</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">emails</span><span class="o">(</span><span class="n">emails</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-update-email-label">
<span id="id52"></span><h4>指定されたユーザのメールアドレスを更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-update-email-label" title="Permalink to this headline">¶</a></h4>
<p>メールアドレスはユーザ定義型クラスとしてUserテーブルに複数保持されているので、対象のEmailと一致したものを更新するロジックを実装すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id147">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#updateEmail(Long userId, String email, String newEmail)</span><a class="headerlink" href="#id147" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">newEmail</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">){</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">target</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getEmail</span><span class="o">())){</span>
                    <span class="n">target</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">newEmail</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-delete-email-label">
<span id="id53"></span><h4>指定されたユーザのメールアドレスを1件削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-delete-email-label" title="Permalink to this headline">¶</a></h4>
<p>メールアドレスはユーザ定義型クラスとしてUserテーブルに複数保持されているので、対象のEmailと一致したものを削除するロジックを実装すれば良い。ループ処理の中でデータをListから削除するのはコードが複雑になるので、削除対象以外のデータ以外のリストを新たに作成して、保存し直す形で実装する。</p>
<div class="literal-block-wrapper docutils container" id="id148">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#deleteEmail(Long userId, String email)</span><a class="headerlink" href="#id148" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmail</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">newEmails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Email</span> <span class="n">target</span> <span class="o">:</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmails</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">email</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getEmail</span><span class="o">())){</span>
                <span class="n">newEmails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="n">newEmails</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-delete-emails-label">
<span id="id54"></span><h4>指定されたユーザのメールアドレスを全件削除する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-delete-emails-label" title="Permalink to this headline">¶</a></h4>
<p>メールアドレスはユーザ定義型クラスとしてUserテーブルに複数保持されているので、NULLをセットし直して再保存することで削除する。</p>
<div class="literal-block-wrapper docutils container" id="id149">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#deleteEmails(Long userId)</span><a class="headerlink" href="#id149" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteEmails</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmails</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-group-by-userid-label">
<span id="id55"></span><h4>指定したユーザが属するグループの一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-group-by-userid-label" title="Permalink to this headline">¶</a></h4>
<p>指定したユーザが所属するグループは、リレーショナルモデルでいえば、通常、関連実体である「所属」を作ることにより、ユーザとグループがそれぞれN:Nの関係になるところを、それぞれ1:Nの関係とし、指定したユーザIDをキーにテーブルを結合していくことで、データの取得が可能である。これと同様に、ユーザIDとグループIDのキーから構成されるAffiliationテーブルを作成し、ユーザIDをキーに、ユーザが所属するグループのIDの一覧を取得し、それをもとにグループ一覧を検索する方法で実装を行う。</p>
<div class="literal-block-wrapper docutils container" id="id150">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.Affiliation#2</span><a class="headerlink" href="#id150" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.Table</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@Table</span><span class="o">(</span><span class="s">&quot;affiliation&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Affiliation</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Affiliation</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@PrimaryKey</span><span class="o">(</span><span class="s">&quot;affiliationpk&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">AffiliationPK</span> <span class="n">affiliationpk</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">ver</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedDate</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id151">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.entity.AffiliationPK#2</span><a class="headerlink" href="#id151" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.PrimaryKeyType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.mapping.PrimaryKeyColumn</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="nd">@PrimaryKeyClass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AffiliationPK</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">6634695143792297552L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AffiliationPK</span><span class="o">(){}</span>

    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">CLUSTERED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="nd">@PrimaryKeyColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;group_id&quot;</span><span class="o">,</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">PrimaryKeyType</span><span class="o">.</span><span class="na">PARTITIONED</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>当サンプルでは、後述するユースケース「指定したグループに所属する全てのユーザ一覧を取得する」のために、AffiliationPKのgroup_idをパーティションキーに設定している。
そのため、クラスタカラムであるユーザIDをキーとして、そのユーザが所属するグループ一覧を取得する場合、ALLOW FILTERINGオプションを付与する必要がある。AffiliationRepositoryクラスでは、命名規約に従い、以下の通り、findByAffiliationpkUserId(Long userId)を作成し、&#64;QueryでALLOW FILTERINGオプションを付与したCQLを記述する。</p>
<div class="literal-block-wrapper docutils container" id="id152">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.AffiliationRepository</span><a class="headerlink" href="#id152" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Affiliation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.AffiliationPK</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AffiliationRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">,</span> <span class="n">AffiliationPK</span><span class="o">&gt;{</span>

    <span class="nd">@Query</span><span class="o">(</span><span class="s">&quot;select * from affiliation where user_id =?0 allow filtering&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="nf">findByAffiliationpkUserId</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>サービスクラスでは、取得した特定のユーザの所属するグループの一覧のリストを作成し、GroupRepositoryにて、IN句を使用してグループ一覧データを取得するロジックを実装する。</p>
<div class="literal-block-wrapper docutils container" id="id153">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getGroups(Long userId)</span><a class="headerlink" href="#id153" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span> <span class="o">=</span>
                                <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">findByAffiliationpkUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">groupIds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">:</span> <span class="n">affiliations</span><span class="o">){</span>
            <span class="n">groupIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">affiliation</span><span class="o">.</span><span class="na">getAffiliationpk</span><span class="o">().</span><span class="na">getGroupId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupIdIn</span><span class="o">(</span><span class="n">groupIds</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">groups</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>IN句を使用したCQLの実行のために、以下の通り、GroupRepositoryクラスに、Spring Dataのメソッド命名規約に基づき、findByGroupIdIn(List&lt;Long&gt; groupIds)メソッドを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id154">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.GroupRepository</span><a class="headerlink" href="#id154" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="c1">// omit</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GroupRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;{</span>

<span class="c1">// omit</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">findByGroupIdIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">groupIds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">パーティションキーはデータをどのノードに配置するか決定するキーであるため、基本的には条件検索する場合、指定が必須である。ALLOW FILTERオプションを指定すると、クラスタカラムキーのみで検索が可能にはなるが、各ノードごとに全て問い合わせする必要があるため、著しくパフォーマンス低下する可能性があることに注意。</p>
</div>
<p>この実装方法では、たくさんのノードが存在する場合、パフォーマンスが著しく低下することが予想されるため、所属テーブルの全件データを取得したResultSetとエンティティクラスをマッピングする際に、ユーザIDをキーとして、グループIDのリストを保持するMap型でデータ返却し、それをもとにグループの一覧を取得する実装に変更する。</p>
<p>Map型でデータ返却するために、AffiliationRepositoryのカスタムRepositoryクラスを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id155">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.AffiliationRepositoryCustom</span><a class="headerlink" href="#id155" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AffiliationRepositoryCustom</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="nf">findGroupIdsMapByUserId</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>カスタムインターフェースをAffiliationRepositoryに継承させる。</p>
<div class="literal-block-wrapper docutils container" id="id156">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.AffiliationRepository#2</span><a class="headerlink" href="#id156" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="c1">// omit.</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AffiliationRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">,</span> <span class="n">AffiliationPK</span><span class="o">&gt;,</span> <span class="n">AffiliationRepositoryCustom</span><span class="o">{</span>

<span class="c1">// omit.</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>サービス実装クラスでは、以下の通り、AffiliationMapByUserIdExtractorクラスを指定して、クエリ実行を行う。</p>
<div class="literal-block-wrapper docutils container" id="id157">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.AffiliationRepositoryImpl</span><a class="headerlink" href="#id157" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.AffiliationRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AffiliationRepositoryImpl</span> <span class="kd">implements</span> <span class="n">AffiliationRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="nf">findGroupIdsMapByUserId</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;affiliation&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">AffiliationMapByUserIdExtractor</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>AffiliationMapByUserIdExtractorでは、ユーザIDをキーにして、所属するグループのIDの一覧をMap型で返却する。</p>
<div class="literal-block-wrapper docutils container" id="id158">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.AffiliationMapByUserIdExtractor</span><a class="headerlink" href="#id158" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.ResultSetExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.DataAccessException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.exceptions.DriverException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AffiliationMapByUserIdExtractor</span> <span class="kd">implements</span> <span class="n">ResultSetExtractor</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;&gt;{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="nf">extractData</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">resultSet</span><span class="o">)</span>
                                     <span class="kd">throws</span> <span class="n">DriverException</span><span class="o">,</span> <span class="n">DataAccessException</span> <span class="o">{</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">groupIdsMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">hasNext</span><span class="o">()){</span>
                        <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">resultSet</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
            <span class="n">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">groupIds</span> <span class="o">=</span> <span class="n">groupIdsMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">groupIds</span><span class="o">){</span>
                <span class="n">groupIds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
                <span class="n">groupIdsMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">groupIds</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">groupIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;group_id&quot;</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">groupIdsMap</span><span class="o">;</span>

     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
</div>
<p>従って、サービス実装クラスでは、取得したMapの中で対象のユーザIDをキーにグループIDを取得し、そのグループIDをキーのリストとして、IN句を使用した検索を行う。</p>
<div class="literal-block-wrapper docutils container" id="id159">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getGroups(Long userId)#2</span><a class="headerlink" href="#id159" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="nf">getGroups</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">groupIdsMap</span> <span class="o">=</span> <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">findGroupIdsMapByUserId</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Group</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findByGroupIdIn</span><span class="o">(</span><span class="n">groupIdsMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">groups</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>..todo:: IN句を使った検索と、カスタムRepositoryクラス+ResultSetExtractorを作成して、マッピング時にインデックスを作って(Map型)で実施する場合、パターン1で非正規化する場合に比べて、どの程度のデータカーディナリティで性能のパフォーマンスが異なってくるか検証が必要。</p>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-users-by-groupid-label">
<span id="id56"></span><h4>指定したグループに所属する全てのユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-users-by-groupid-label" title="Permalink to this headline">¶</a></h4>
<p>指定したグループに所属するユーザは、リレーショナルモデルでいえば、通常、関連実体である「所属」を作ることにより、ユーザとグループがそれぞれN:Nの関係になるところを、それぞれ1:Nの関係とし、指定したグループIDをキーにテーブルを結合していくことでデータの取得が可能である。ここでは、前ユースケース「指定したユーザが属するグループの一覧を取得する」のリレーショナルモデルと同様に関連実体テーブル「所属」から、グループIDをキーにグループに所属するユーザIDの一覧を取得し、それをもとにユーザ一覧を検索する方法で実装を行う。</p>
<p>AffiliationRepositoryクラスでは、Spring Dataのメソッド命名規約に従い、findByAffiliationpkGroupIdメソッドを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id160">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.AffiliationRepository#3</span><a class="headerlink" href="#id160" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="c1">// omit</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AffiliationRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">,</span> <span class="n">AffiliationPK</span><span class="o">&gt;{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="nf">findByAffiliationpkGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">);</span>

    <span class="c1">//omit</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">エンティティクラスの変数名に合わせてメソッドのキャメルケースを決定すること。</p>
</div>
<p>サービス実装クラスでは、グループIDをキーに取得した所属データから、ユーザIDの一覧を作成し、IN句を使用した検索を実行する。</p>
<div class="literal-block-wrapper docutils container" id="id161">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getUsersByGroupId(Long groupId)</span><a class="headerlink" href="#id161" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span> <span class="o">=</span>
            <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">findByAffiliationpkGroupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">:</span> <span class="n">affiliations</span><span class="o">){</span>
            <span class="n">userIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">affiliation</span><span class="o">.</span><span class="na">getAffiliationpk</span><span class="o">().</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByUserIdIn</span><span class="o">(</span><span class="n">userIds</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">users</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>IN句を使用したCQLの実行のために、以下の通り、UserRepositoryクラスに、Spring Dataのメソッド命名規約に基づき、findByUserIdIn(List&lt;Long&gt; userIds)メソッドを作成する。</p>
<div class="literal-block-wrapper docutils container" id="id162">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepository</span><a class="headerlink" href="#id162" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.CrudRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

<span class="c1">// omit</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserIdIn</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-get-not-users-by-groupid-label">
<span id="id57"></span><h4>指定したグループに所属しない全てのユーザ一覧を取得する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-get-not-users-by-groupid-label" title="Permalink to this headline">¶</a></h4>
<p>指定したグループに所属するユーザIDの一覧を取得し、全ユーザデータから当該データを除外する方式で実装する。
サービス実装クラスでは、前ユースケース「指定したグループに所属するすべてのユーザ一覧を取得する」と同様、findByAffiliationpkGroupId()メソッドを使って、Affiliationテーブルから指定されたグループIDに属する所属データを取得したのち、Map形式で取得したユーザ一覧で、キーをとなるユーザIDを指定して除外する。</p>
<div class="literal-block-wrapper docutils container" id="id163">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#getNotUsersByGroupId(Long groupId)</span><a class="headerlink" href="#id163" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getNotUsersByGroupId</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span> <span class="o">=</span>
                               <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">findByAffiliationpkGroupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAllForMap</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">:</span> <span class="n">affiliations</span><span class="o">){</span>
            <span class="n">userMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">affiliation</span><span class="o">.</span><span class="na">getAffiliationpk</span><span class="o">().</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userMap</span><span class="o">.</span><span class="na">values</span><span class="o">());</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
<p>上記では、Map形式でユーザを取得するため、パターン1のユースケース「特定の郵便番号を持たないユーザ一覧を取得する」と同様に、カスタムRepositoryインターフェースを作成し、ResutSetExtractorを利用して実装する。</p>
<div class="literal-block-wrapper docutils container" id="id164">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepositoryCustom#3</span><a class="headerlink" href="#id164" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepositoryCustom</span> <span class="o">{</span>

    <span class="c1">//omit</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>実装クラスは、以下の通り、UserMapExtractorクラスを指定してクエリ実行する。</p>
<div class="literal-block-wrapper docutils container" id="id165">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.UserRepositoryImpl#3</span><a class="headerlink" href="#id165" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraAdminOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.cassandra.core.CassandraOperations</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.NoRepositoryBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.QueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.querybuilder.Select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.UserRepositoryCustom</span><span class="o">;</span>

<span class="nd">@NoRepositoryBean</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryImpl</span> <span class="kd">implements</span> <span class="n">UserRepositoryCustom</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&quot;cassandraTemplate&quot;</span><span class="o">)</span>
    <span class="n">CassandraOperations</span> <span class="n">cassandraOperations</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAllForMap</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;users&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cassandraOperations</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">select</span><span class="o">,</span> <span class="k">new</span> <span class="n">UserMapExtractor</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>UserMapExtractorクラスの実装は以下の通りである。</p>
<div class="literal-block-wrapper docutils container" id="id166">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.repository.impl.UserMapExtractor</span><a class="headerlink" href="#id166" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.repository.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Credential</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.Email</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cassandra.core.ResultSetExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.dao.DataAccessException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.UDTValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.datastax.driver.core.exceptions.DriverException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMapExtractor</span> <span class="kd">implements</span> <span class="n">ResultSetExtractor</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;&gt;{</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="nf">extractData</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">resultSet</span><span class="o">)</span>
                                <span class="kd">throws</span> <span class="n">DriverException</span><span class="o">,</span> <span class="n">DataAccessException</span> <span class="o">{</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">hasNext</span><span class="o">()){</span>
            <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">resultSet</span><span class="o">.</span><span class="na">one</span><span class="o">();</span>
            <span class="n">UDTValue</span> <span class="n">address</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getUDTValue</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;</span> <span class="n">credentials</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Credential</span><span class="o">&gt;();</span>
            <span class="n">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;user_id&quot;</span><span class="o">);</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">userName</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;user_name&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isEnabled</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_enabled&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_locked&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">isAdmin</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBool</span><span class="o">(</span><span class="s">&quot;is_admin&quot;</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">emails</span><span class="o">(</span><span class="n">emails</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">credentials</span><span class="o">(</span><span class="n">credentials</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">address</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">Address</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                       <span class="o">.</span><span class="na">zipCd</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;zip_cd&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                       <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span><span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;emails&quot;</span><span class="o">)){</span>
                <span class="n">emails</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Email</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">))</span>
                                <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">for</span><span class="o">(</span><span class="n">UDTValue</span> <span class="n">udtValue</span> <span class="o">:</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">UDTValue</span><span class="o">&gt;)</span><span class="n">row</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="s">&quot;credentials&quot;</span><span class="o">)){</span>
                <span class="n">credentials</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Credential</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                          <span class="o">.</span><span class="na">credentialType</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;credential_type&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">credentialKey</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;credential_key&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">expiredDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;expired_date&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">ver</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;ver&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">lastUpdatedDate</span><span class="o">(</span><span class="n">udtValue</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">&quot;last_updated_date&quot;</span><span class="o">))</span>
                                          <span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">userMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userMap</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-add-user-to-group-label">
<span id="id58"></span><h4>指定したユーザを指定したグループに追加する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-add-user-to-group-label" title="Permalink to this headline">¶</a></h4>
<p>指定したユーザを指定したグループに追加することは、所属テーブルにデータを追加することとイコールであるため、AffiliationRepositoryでデータを追加するだけで良い。サービス実装クラスは、</p>
<div class="literal-block-wrapper docutils container" id="id167">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#addUserToGroup(Long, userId, Long groupId)</span><a class="headerlink" href="#id167" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">addUserToGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span>  <span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">=</span> <span class="n">Affiliation</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                             <span class="o">.</span><span class="na">affiliationpk</span><span class="o">(</span><span class="n">AffiliationPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                                         <span class="o">.</span><span class="na">groupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span>
                                                                         <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                                                         <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                                             <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">affiliation</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-delete-user-from-group-label">
<span id="id59"></span><h4>指定したユーザをグループから除外する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-delete-user-from-group-label" title="Permalink to this headline">¶</a></h4>
<p>前ユースケース「指定したユーザを指定したグループに追加する」と同様、所属テーブルにある該当のデータを削除すれば良い。サービス実装クラスは、</p>
<div class="literal-block-wrapper docutils container" id="id168">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#deleteUserFromGroup(Long, userId, Long groupId)</span><a class="headerlink" href="#id168" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteUserFromGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">=</span> <span class="n">affiliationRepository</span>
                                      <span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">AffiliationPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                            <span class="o">.</span><span class="na">groupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span>
                                                            <span class="o">.</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span>
                                                            <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">affiliation</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-delete-group-label">
<span id="id60"></span><h4>指定したグループを削除し、ユーザが所属するグループの情報を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-delete-group-label" title="Permalink to this headline">¶</a></h4>
<p>当ユースケースの場合、削除対象のグループのIDをもつ所属テーブルのデータをすべて削除し、最後にグループを削除すれば良い。サービス内の複数のテーブルアクセスによるトランザクションは提供されないため、先に所属テーブルのデータを削除する形で実装する。</p>
<div class="literal-block-wrapper docutils container" id="id169">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#deleteGroup(Long groupId)</span><a class="headerlink" href="#id169" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Group</span> <span class="nf">deleteGroup</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Affiliation</span><span class="o">&gt;</span> <span class="n">affiliations</span> <span class="o">=</span>
                                <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">findByAffiliationpkGroupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Affiliation</span> <span class="n">affiliation</span> <span class="o">:</span> <span class="n">affiliations</span><span class="o">){</span>
            <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">affiliation</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">groupId</span><span class="o">);</span>
        <span class="n">groupRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">group</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-x-usecase-implementation-patten2-delete-user-label">
<span id="id61"></span><h4>指定されたユーザを削除し、グループのユーザ一覧を更新する<a class="headerlink" href="#section6-x-x-x-usecase-implementation-patten2-delete-user-label" title="Permalink to this headline">¶</a></h4>
<p>前ユースケース「指定したグループを削除し、ユーザが所属するグループの情報を更新する」と同様、削除対象のユーザIDを持つ所属テーブルのデータをすべて削除し、最後にユーザを削除すれば良い。</p>
<div class="literal-block-wrapper docutils container" id="id170">
<div class="code-block-caption"><span class="caption-text">org.debugroom.sample.cassandra.pattern2.domain.service.SampleServiceImpl#deleteUser(Long, userId)</span><a class="headerlink" href="#id170" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.cassandra.pattern2.domain.service</span><span class="o">;</span>

<span class="c1">// omit import statements.</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">&quot;sampleService&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleServiceImpl</span> <span class="kd">implements</span> <span class="n">SampleService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Address</span><span class="o">,</span> <span class="n">Email</span><span class="o">,</span> <span class="n">Group</span><span class="o">&gt;{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">groupIdsMap</span> <span class="o">=</span> <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">findGroupIdsMapByUserId</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">groupIds</span> <span class="o">=</span> <span class="n">groupIdsMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Long</span> <span class="n">groupId</span> <span class="o">:</span> <span class="n">groupIds</span><span class="o">){</span>
            <span class="n">affiliationRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">AffiliationPK</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                         <span class="o">.</span><span class="na">groupId</span><span class="o">(</span><span class="n">groupId</span><span class="o">).</span><span class="na">userId</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="section6-x-x-differenece-rdb-consistency-problem-label">
<span id="id62"></span><h2>データ整合性に問題が生じるケース<a class="headerlink" href="#section6-x-x-differenece-rdb-consistency-problem-label" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>サービス内でトランザクションが提供されないため、異なるテーブルへの更新処理は何らかのエラーが発生した場合、業務的なデータ論理性が保証されない場合が発生する。こうした場合、運用対処するか、補償トランザクションによるデータの整合性(エラーが発生した場合リトライ処理を行うよう実装すること)を考える必要がある。</li>
</ul>
<div class="section" id="section6-x-x-differenece-rdb-consistency-problem-denormalization-label">
<span id="id63"></span><h3>非正規化によるデータ分散による不整合<a class="headerlink" href="#section6-x-x-differenece-rdb-consistency-problem-denormalization-label" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>非正規化された場合、複数のテーブルにデータが存在するため、データ更新の回数が増え、エラー発生頻度が高まり、データ整合性に問題が発生するリスクが高まる。同様に、運用対処するか、補償トランザクションによるデータの整合性(エラーが発生した場合、リトライ処理を行うよう実装すること)を考える必要がある。</li>
</ul>
</div>
<div class="section" id="section6-x-x-differenece-rdb-consistency-problem-replication-label">
<span id="id64"></span><h3>レプリケーション間のデータ不整合<a class="headerlink" href="#section6-x-x-differenece-rdb-consistency-problem-replication-label" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="cassandra">
<span id="section6-x-x-cassandra-data-modeling-label"></span><h2>Cassandraにおけるデータモデリングのポイント<a class="headerlink" href="#cassandra" title="Permalink to this headline">¶</a></h2>
<p>検証の結果からポイントをまとめると以下の通りとなる。</p>
<table border="1" class="colwidths-given docutils" id="id171">
<caption><span class="caption-text">Cassandraにおけるデータモデリングのポイント</span><a class="headerlink" href="#id171" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="48%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">No</th>
<th class="head">ポイント</th>
<th class="head">理由</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">1</th>
<td>1度のデータアクセスで関連エンティティの <br/>
情報も含めて(ユーザと住所など)取得したい場合は <br/>
ユーザ定義型を使用する。</td>
<td>結合の概念がないので、テーブル定義した単位で <br/>
データアクセスする必要があるため。</td>
</tr>
<tr class="row-odd"><th class="stub">2</th>
<td>あるテーブルに全件データアクセスする場合は <br/>
No1と併用するのであれば、非正規化が必要</td>
<td>ユーザ定義型のデータには当然全件検索できないため</td>
</tr>
<tr class="row-even"><th class="stub">3</th>
<td>プライマリキー以外を検索キーに指定する場合、<br/>
マテリアライズドビューを作成するか、 <br/>
セカンダリインデックスを作成するか、 <br/>
CQLにallow filteringオプションを付与する <br/>
必要がある。ただし、性能劣化が予想されるため、 <br/>
非正規化することも検討する。</td>
<td>ユーザ定義型のデータには当然全件検索できないため</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="section6-x-x-differenece-design-method-label">
<span id="id65"></span><h2>設計手順<a class="headerlink" href="#section6-x-x-differenece-design-method-label" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>リレーショナルモデルの設計手順</li>
</ul>
<ol class="arabic simple">
<li>概念データモデル・論理設計<ol class="arabic">
<li>エンティティの抽出</li>
<li>エンティティモデル定義</li>
<li>正規化</li>
<li>ER図の作成</li>
</ol>
</li>
<li>ユースケース記述・処理設計<ol class="arabic">
<li>サービスインターフェース設計</li>
<li>ドメインインターフェース設計</li>
<li>コンポーネント処理設計(クエリ設計)</li>
</ol>
</li>
<li>物理設計<ol class="arabic">
<li>テーブル定義</li>
<li>インデックス定義</li>
<li>ハードウェアサイジング</li>
<li>ストレージ冗長化構成</li>
<li>物理配置設計</li>
</ol>
</li>
</ol>
<ul class="simple">
<li>Cassandraでの設計手順</li>
</ul>
<ol class="arabic simple">
<li>概念データモデル・論理設計<ol class="arabic">
<li>エンティティの抽出</li>
<li>エンティティモデル定義</li>
</ol>
</li>
<li>ユースケース記述・処理設計<ol class="arabic">
<li>サービスインターフェース設計</li>
<li>ドメインインターフェース設計</li>
<li>コンポーネント処理設計(クエリ設計)</li>
</ol>
</li>
<li>物理設計<ol class="arabic">
<li>テーブル定義</li>
<li>インデックス定義</li>
<li>物理配置設計</li>
</ol>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="trouble-shooting.html" class="btn btn-neutral float-right" title="トラブルシューティング" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="spring-integration.html" class="btn btn-neutral" title="Cassandra - SpringFrameworkアプリケーション" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, org.debugroom.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1-SNAPSHOTS',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>