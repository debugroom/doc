

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Network Category &mdash; document 0.1-SNAPSHOTS documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Computing Category" href="computing.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> document
          

          
          </a>

          
            
            
              <div class="version">
                0.1-SNAPSHOTS
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../java/javaee/jpa/index.html">JavaEE JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/javaee/jBatch/index.html">JavaEE jBatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-boot/index.html">Spring Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-data-jpa/index.html">Spring Data JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-data-dynamodb/index.html">Spring Data DynamoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-cloud-aws/index.html">Spring Cloud AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-cloud-function/index.html">Spring Cloud Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database/cassandra/index.html">Cassandra</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Amazon web service</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Network Category</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#virtual-private-network-vpc">Virtual Private Network(VPC)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vpc">VPCの構築</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section3-1-4-create-subnet-label">サブネットの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section3-1-5-create-ibgw-label">インターネットゲートウェイの作成・アタッチ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section3-1-6-edit-routetable-label">ルートテーブルの編集</a></li>
<li class="toctree-l4"><a class="reference internal" href="#elastic-ip-address">Elastic IP Address</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section3-1-8-create-vpc-with-public-private-subnet-label">パブリックサブネットとプライベートサブネットをもつVPCの構築</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#direct-connect">Direct Connect</a></li>
<li class="toctree-l3"><a class="reference internal" href="#elastic-load-balancing-elb">Elastic Load Balancing(ELB)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section3-3-1-elb-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#classic-load-barancing-application-load-barancingnetwork-load-barancing">Classic Load Barancing と Application Load Barancing、Network Load Barancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#alb">ALBの設定</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#route53">Route53</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section3-4-1-route53-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section3-4-2-route53-registration-label">ドメインの登録</a></li>
<li class="toctree-l4"><a class="reference internal" href="#elastic-ip">登録したドメインとElastic IPアドレスの紐付け設定</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section3-4-3-route53-healthcheck-label">ヘルスチェックの設定</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#transit-gateway">Transit Gateway</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-gateway">API Gateway</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section3-6-1-api-gateway-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rest-api">REST APIの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vpc-link">VPC Linkの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#albhttp-api">インターナルALBに接続するHTTP APIの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http-api">HTTP APIの認証設定</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="computing.html">Computing Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage.html">Storage Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastore.html">DataStore Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Security Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="application.html">Application Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html">DevOps Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="iot.html">AWS IoT</a></li>
<li class="toctree-l2"><a class="reference internal" href="management.html">Management Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html">Appendix - 付録</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swagger/index.html">Swagger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../convention/app-infra/index.html">AP基盤処理方式・実装規約</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../memo/work/index.html">work guideline</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">document</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Amazon web service</a> &raquo;</li>
        
      <li>Network Category</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/cloud/aws/article/network.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="network-category">
<span id="section3-network-label"></span><h1>Network Category<a class="headerlink" href="#network-category" title="Permalink to this headline">¶</a></h1>
<div class="section" id="virtual-private-network-vpc">
<span id="section3-1-vpc-label"></span><h2>Virtual Private Network(VPC)<a class="headerlink" href="#virtual-private-network-vpc" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overview">
<span id="section3-1-1-vpc-overview-label"></span><h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>Aamazon VPCはAWS上に占有可能なプライベートネットワークを構築するためのサービスである。
AWSパブリッククラウド上に利用者独自の仮想プライベートネットワークを構築し、
仮想サーバの「EC2」やデータベース「RDS」といったAWSのリソースを配置する。Amazon VPCはVPNを通じてオンプレミスとの接続も可能である。
VPCはリージョン単位で作成でき、VPC内にはリソースへのアクセス制御を主な目的とする、複数のサブネットを作成できる。VPCを作成する際に、CIDR表記に沿って一連のIPアドレスを指定する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">VPCは１リージョン内に構築される。リージョンをまたいで別のVPCと通信したい場合は、インターリージョンVPCを使うと、一部のリージョン同士でVPC間の相互接続が可能である。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">VPCは複数のアベイラビリティゾーンを跨ぐことはできるが、サブネットは各アベイラビリティゾーン毎に作成する必要がある。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>VPC内のアドレスはCIDRが/16か/28の間で使用できる。ただし、以下の通り、各サブネットの最初の４アドレス、最後の1アドレスは使用不可のため注意。</p>
<ul class="simple">
<li>XXX.XXX.XXX.0 (ネットワークアドレス用)</li>
<li>XXX.XXX.XXX.1 (VPCルータ)</li>
<li>XXX.XXX.XXX.2 (Amazon Provided DNS)</li>
<li>XXX.XXX.XXX.3 (予備)</li>
<li>XXX.XXX.XXX.255 (ブロードキャストはサポートしていないが予約)</li>
</ul>
<p class="last">CIDRは一度作成すると変更することができないが、2017年10月よりVPCに割り当てるCIDRが拡張可能となった。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">EC2、RDS、ELBはVPC内のサービスであるが、S3や DynamoDB、SQS等のサービスはリージョンで提供されるサービスである。そのため、リージョンサービスに接続が必要なEC2は、通常VPC外への接続口を確保する必要があるが、S3とDynamoDBは接続のためのVPCエンドポイントが提供されている。
VPCエンドポイントには2種類あり、ゲートウェイ型エンドポイント、インターフェース型エンドポイントの２種類ある。<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-endpoints.html">サポートされるサービス</a> ごとにエンドポイントを選択する。</p>
</div>
<p>VPCリソース間の通信はルートテーブルというルールセットでアクセス制御する。VPCを作成すると通常同時にメインルートテーブルが作成されるが、追加でカスタムルートテーブルを作成し、サブネット間のアクセス・通信制御を行う。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">VPC内の各サブネットはルートテーブルに関連づけられる必要がある。サブネットを特定のルートテーブルに明示的に関連付けていない場合、サブネットは自動的にメインルートテーブルに暗黙的に関連づけられる。１つのサブネットに同時に複数のルートテーブルを関連づけることはできないが、複数のサブネットを１つのルートテーブルに関連づけることはできる。</p>
</div>
<p>AmazonVPCは「セキュリティグループ」と「ネットワークACL」の2つのフィルタリング機構によって不要な通信をブロックし、
セキュリティを強化できる。</p>
<p>セキュリティグループは、EC2やRDSなどのAWSリソースに関連付けることで、ファイアウォールとして動作する。
受信と送信の両方をリソースレベルで制御でき、リソースをグループ化し、共通のセキュリティグループを関連付けることもできる。
一般的なファイアウォール同様、ステートフルに動作し、発生した通信に対する応答通信は自動的に許可される。</p>
<p>ネットワークACLはIPサブネットに関連付けられ、受信と送信の両方をIPサブネットレベルで制御する。
関連付けられたIPサブネット全てに適用されるのでセキュリティグループより広範囲な制御設定が可能であるが、
セキュリティグループとは異なりステートレスに動作するため、応答通信にも許可の設定が必要
(戻り宛先のIPとポートが必要：ポートは特定できないので事実上任意設定)となることに注意が必要である。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">セキュリティグループは許可設定しかできないので、特定のクライアントのアクセスをブロックしたいときはネットワークACLを使う。</p>
</div>
<p>VPC内のリソースが外部通信する際は、ネットワークゲートウェイをVPCに設置するが、</p>
<ul class="simple">
<li>インターネットゲートウェイ</li>
<li>仮想プライベートゲートウェイ</li>
<li>VPCピア接続</li>
</ul>
<p>の3種類がある。</p>
<p>インターネットゲートウェイは文字通りインターネットとの通信であるが、通信元のAWSリソースがパブリックIPアドレスを持っている必要がある。
パブリックアドレスは動的に割り当てられるものと、固定的に割り当てられるものがある。後者を「Elastic IP Address」と呼ぶ。
インターネットゲートウェイは定義としては1つの機器のように扱われるが、内部的に冗長化されており、
通信が増加した際には自動的にスケーリングされる。またシステムの保守作業で最新のミドルウェアやセキュリティパッチを入手する際も
インターネットゲートウェイの設置が必須になるので、閉塞したネットワークの際は考慮が必要である。</p>
<p>仮想プライベートゲートウェイはVPCとオンプレミス環境をVPN接続するためのネットワークゲートウェイである。
インターネットゲートウェイ同様、冗長化構成をとる。動的ルーティングと静的ルーティング両方をサポートし、
動的ルーティングではBGPピア接続を利用して、オンプレミスと接続する。ユーザ側のリモートエンドポイントで
BGPアドバタイズにより、ルーティングの優先順位、ポリシーなど設定できる。
静的ルーティングにおいて、オンプレミス環境では、VPN通信が行えるルーターと、接続を許可するIPアドレスの設定のために、固定的なパブリックIPアドレスが必要になる。</p>
<p>VPCピア接続はそれぞれ独立した仮想プライベートネットワークである2つのVPCを接続し、
プライベートアドレスで相互に通信する。こちらもインターネットゲートウェイ、仮想プライベートゲートウェイと同様、
冗長化構成をとる。自分が所有しているVPCだけではなく、同じリージョンの別アカウントのVPCとも接続ができる。
ただし、接続できるのはVPCの範囲内に限られ、接続先のVPCとVPN接続されているネットワークには接続できない。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">VPC Peeringでは、2017年に海外のリージョンに接続可能なInterーRegion Peeringが利用可能である。Inter-Region Peeringでは、Amazon Globl Network経由でリージョン間接続を行う(インターネットを使った通信ではない)。</p>
</div>
<p>VPC接続の主な用途としては、複数システムでのデータ共有や監視システムの統合があげられる。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>VPCピア接続には以下のルールと制限がある。</p>
<ul class="last simple">
<li>VPCの送信単位(MTU)は1500バイトである。</li>
<li>VPCの送信単位はリージョンが異なるVPCピア接続はできない。</li>
<li>また、２つの同じVPCで複数のVPC接続もできない。</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>プライベートサブネット内にあるインスタンスがインターネットなど外部通信する必要がある場合は、パブリックサブネットにNAT用のEC2インスタンスを配置するか、VPC NAT ゲートウェイを使うオプションがある。</p>
<table border="1" class="colwidths-given last docutils" id="id12">
<caption><span class="caption-text">VPC NAT ゲートウェイとNATインスタンスの違い</span><a class="headerlink" href="#id12" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="40%" />
<col width="40%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>観点</td>
<td>VPC NAT ゲートウェイ</td>
<td>NAT インスタンス</td>
</tr>
<tr class="row-even"><td>可用性</td>
<td>デフォルトで可用性高い</td>
<td>個別スクリプトでフェイルオーバーを管理</td>
</tr>
<tr class="row-odd"><td>帯域幅</td>
<td>10Gbpsでバースト</td>
<td>インスタンスの帯域幅に依存</td>
</tr>
<tr class="row-even"><td>メンテナンス</td>
<td>AWS管理</td>
<td>ユーザが管理</td>
</tr>
<tr class="row-odd"><td>セキュリティ</td>
<td>ネットワークACL</td>
<td>セキュリティグループ、ネットワークACL</td>
</tr>
<tr class="row-even"><td>ポートフォワーディング</td>
<td>サポートなし</td>
<td>サポートあり</td>
</tr>
</tbody>
</table>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">VPC内のトラフィックログを収集する場合は、VPCフローログ機能(コンソール&gt;VPC&gt;フローログタブ)を利用すること。</p>
</div>
</div>
<div class="section" id="vpc">
<span id="section3-1-3-create-vpc-label"></span><h3>VPCの構築<a class="headerlink" href="#vpc" title="Permalink to this headline">¶</a></h3>
<p>■AWSコンソールから、「VPC」サービスを選択し、「VPCを作成」ボタンを押下する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-create-vpc-1.png" src="../../../_images/management-console-vpc-create-vpc-1.png" />
</div>
</div></blockquote>
<p>■以下の通り、VPCの設定値を入力して、「create」ボタンを押下する。</p>
<ul class="simple">
<li>Name Tag：任意の名前</li>
<li>IPv4 CIDR block：XXX.XXX.XXX.XXX/16-28</li>
<li>IPv6 CIDR block：No IPv6 CIDR Block</li>
<li>Tenancy :Default</li>
</ul>
</div>
<div class="section" id="section3-1-4-create-subnet-label">
<span id="id2"></span><h3>サブネットの作成<a class="headerlink" href="#section3-1-4-create-subnet-label" title="Permalink to this headline">¶</a></h3>
<p>■AWSコンソールから、「VPC」サービスを選択し、「サブネット」メニューを選び、「サブネットの作成」ボタンを押下する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-create-subnet-public-1.png" src="../../../_images/management-console-vpc-create-subnet-public-1.png" />
</div>
</div></blockquote>
<p>■以下の通り、パブリックサブネットの設定値を入力して、「作成」ボタンを押下する。</p>
<ul class="simple">
<li>名前タグ：任意の名前</li>
<li>VPC：サブネットを作成するVPCを選択</li>
<li>アベイラビリティゾーン：サブネットを設定するアベイラビリティゾーンを設定</li>
<li>IPv4 CIDRブロック：サブネットに割り当てるIPv4 CIDRブロック</li>
</ul>
</div>
<div class="section" id="section3-1-5-create-ibgw-label">
<span id="id3"></span><h3>インターネットゲートウェイの作成・アタッチ<a class="headerlink" href="#section3-1-5-create-ibgw-label" title="Permalink to this headline">¶</a></h3>
<p>パブリックサブネットにアタッチするための、インターネットゲートウェイを作成する。</p>
<p>■AWSコンソールから、「VPC」サービスを選択し、「インターネットゲートウェイ」メニューから、「インターネットゲートウェイの作成」ボタンを押下する。名前タグを入力して、「作成」ボタンを押下する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-create-igw-1.png" src="../../../_images/management-console-vpc-create-igw-1.png" />
</div>
</div></blockquote>
<p>■作成したインターネットゲートウェイを選択し、「アクション」ボタンから「VPCにアタッチ」を選択し、アタッチするVPCを選択する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-attach-igw-1.png" src="../../../_images/management-console-vpc-attach-igw-1.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="section3-1-6-edit-routetable-label">
<span id="id4"></span><h3>ルートテーブルの編集<a class="headerlink" href="#section3-1-6-edit-routetable-label" title="Permalink to this headline">¶</a></h3>
<p>アタッチしたインターネットゲートウェイの設定をルートテーブルに追加する。</p>
<p>■AWSコンソールから「VPC」サービスを選択し、「ルートテーブル」メニューを選択する。作成したVPCに関連付けられているルートテーブルを選択し、「Route」タブから「Edit Routes」ボタンを押下する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-edit-routetable-1.png" src="../../../_images/management-console-vpc-edit-routetable-1.png" />
</div>
</div></blockquote>
<p>■「Add Route」ボタンを押下し、アウトバウンドトラフィック「0.0.0.0/0」に作成したインターネットゲートウェイを設定する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-edit-routetable-2.png" src="../../../_images/management-console-vpc-edit-routetable-2.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="elastic-ip-address">
<span id="section3-1-7-elastic-ip-address-label"></span><h3>Elastic IP Address<a class="headerlink" href="#elastic-ip-address" title="Permalink to this headline">¶</a></h3>
<p>前節「 <a class="reference internal" href="#section3-1-1-vpc-overview-label"><span class="std std-ref">Overview</span></a> 」でも述べた通り、IPアドレスは動的に割り当てられるものと固定で割り当てられるElastic IP Addressがあり、EC2インスタンスではデフォルトで動的なIPアドレスが割り当てられるが、稼働中のEC2インスタンス１つにつき、１つのElastic IP Addressを割り当てることができる。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Elastic IP Addressは最大５つまで確保でき、別途申請することでそれ以上のIPアドレスを確保することができる。ただし、EC2インスタンスやネットワークインターフェースと１つも紐づけていないIPは課金対象となるので注意すること。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Elastic IPアドレスの設定</p>
<p>Elastic IP Addressを割り当てるにはコンソール画面のElastic IPメニューから、「新しいIPアドレスの割り当て」を選択すると、新しく固定IPアドレスが獲得できる。</p>
<div class="figure">
<img alt="../../../_images/management-console-elastic-ip-address-1.png" src="../../../_images/management-console-elastic-ip-address-1.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-elastic-ip-address-2.png" src="../../../_images/management-console-elastic-ip-address-2.png" />
</div>
<p>獲得した固定IPアドレスを稼働中のEC2インスタンスに割り当てる場合は、「アクション」ボタンからアドレスの関連付けを選択し、割り当てるEC2インスタンスIDを指定する。</p>
<div class="last figure">
<img alt="../../../_images/management-console-elastic-ip-address-3.png" src="../../../_images/management-console-elastic-ip-address-3.png" />
</div>
</div>
</div>
<div class="section" id="section3-1-8-create-vpc-with-public-private-subnet-label">
<span id="id5"></span><h3>パブリックサブネットとプライベートサブネットをもつVPCの構築<a class="headerlink" href="#section3-1-8-create-vpc-with-public-private-subnet-label" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">この方法でVPCを作成する場合は、事前にNATゲートウェイに設定するElasticIPアドレスを取得しておくこと。</p>
</div>
<p>■AWSコンソールから、「VPC」サービスを選択し、「VPCダッシュボード」メニューから、「VPCを作成」ボタンを押下する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-create-vpc-public-private-subnet-1.png" src="../../../_images/management-console-vpc-create-vpc-public-private-subnet-1.png" />
</div>
</div></blockquote>
<p>■以下の通り、VPCのCIDRや、パブリック、プライベートサブネットのCIDR、NAT Gatewayに割り当てるElasticIPアドレスを設定する。</p>
<blockquote>
<div><div class="figure">
<img alt="../../../_images/management-console-vpc-create-vpc-public-private-subnet-2.png" src="../../../_images/management-console-vpc-create-vpc-public-private-subnet-2.png" />
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="direct-connect">
<span id="section3-2-direct-connect-label"></span><h2>Direct Connect<a class="headerlink" href="#direct-connect" title="Permalink to this headline">¶</a></h2>
<p>Direct ConnectはVPCとオンプレミス環境をプライベートに接続するためのサービスであるが、より高速で安定的な通信が特徴になっている。
同様のサービスとしてはVPC内の仮想プライベートゲートウェイが利用できるが、通常のインターネット回線を用いるため、
帯域幅の制限があり、そうした問題をクリアするためのサービスと捉えてよい。Direct Connectは「Direct Connectロケーション」と呼ばれる
AWSの各リージョンに対する接続ポイントを提供する。オンプレミス環境と接続ポイントを経由したVPCの間は、
IEEEによって標準化されたネットワーク規格である「802.1Q VLANタンキング」を用いて、論理的な接続経路を構築する。
接続ポイントとオンプレミス環境は通信キャリアが提供している閉域網サービスが必要なため、通信キャリアとの契約が必要である。
通信キャリアのサービスには、接続ポイント内の物理接続を占有して提供する「占有プラン」と、物理接続を複数のユーザで共有し、
その物理接続を通る論理接続を払い出して提供する「共有プラン」の2パターンが存在する。</p>
<p>占有プランは高価だが、論理接続を自由に作成できるので、多数のVPCをオンプレミス環境に接続したい場合は有用である。
共有プランは安価だが論理接続ごとに費用が発生する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">2017年10月にDirect Connect Gatewayがリリースされ、1つのprivate VICで複数のVPC接続が可能になる。Direct Connect Gatewayを経由して、Amazon Global Networkを利用して他リージョンのVPCにアクセスすることも可能である。
例えば東京にあるオンプレのデータセンタからオレゴンリージョンのVPCにアクセスする場合は、オンプレ⇔東京リージョンのDirectConnect⇔DirectConnectGateway⇔Amazon Global network⇔オレゴンリージョンのVPCとなる。(海外のリージョンのDirectConnectまで専用線まで繋げる必要はない)</p>
</div>
</div>
<div class="section" id="elastic-load-balancing-elb">
<span id="section3-3-elastic-load-balancing-label"></span><h2>Elastic Load Balancing(ELB)<a class="headerlink" href="#elastic-load-balancing-elb" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section3-3-1-elb-overview-label">
<span id="id6"></span><h3>Overview<a class="headerlink" href="#section3-3-1-elb-overview-label" title="Permalink to this headline">¶</a></h3>
<p>Elastic Load BalancingはAWS内で利用できる仮想ロードバランサーで以下の様な特徴を持つ。</p>
<ul class="simple">
<li>ELB自体のスケーリング</li>
<li>ヘルスチェック</li>
<li>クロスアベイラビリティゾーン負荷分散</li>
<li>Proxy Protocolヘッダーの利用</li>
<li>スティッキーセッションサポート</li>
<li>ConnectionDraningサポート</li>
<li>従量課金性</li>
<li>運用管理の容易性</li>
</ul>
<p>ELBはアプリケーショントラフィックの増減にあわせて自動的にスケーリングを行う。定義上ELBは1つの機器のように扱われるが、内部的には複数のリソースで構成されており、負荷に合わせて自動的にELBを構成する。
負荷が増えるとELBリソースを追加してスケールアウトしたり、ELBリソースの性能を向上させてスケールアップするが、逆に負荷が減少するとELBのリソースを削除したり、スケールダウンを行う。
ELBは定期的に分散するEC2へpingを送信し、HTTPステータスコード200が応答されると、インスタンスは正常だと判断する。複数のアベイラビリティゾーンを跨いだ分散が可能だが、各アベイラビリティゾーンに均等にバランスされるため、
バックエンドインスタンスが 各アベイラビリティーゾーンのリクエストロードを処理できるようにするには、各ゾーンにほぼ同じ数のインスタンスが存在することが重要である。</p>
<p>Proxy Protocolヘッダーは、TCP/SSL接続に設定されたロードバランサーを使用する場合、クライアントのIPアドレスを識別するのに役立つ。ロードバランサーはクライアントとバックエンドインスタンス間のトラフィックを傍受するため、
バックエンドインスタンス内のアクセスログには、発信元クライアントのIPアドレスでなく、ロードバランサーのIPアドレスが含まれている。Proxy Protocolを有効化すると、ロードバランサーは、
発信元 IP アドレス、送信先 IP アドレス、およびクライアントのポート番号などの接続情報が含まれる、人間が読んで理解できるヘッダーが追加されるようになる。ヘッダーはその後、リクエストの一部として
バックエンドインスタンスに送信され、リクエストの1行目を解析して、クライアントのIPアドレスとポート番号を取得することができる。</p>
<p>スティッキーセッション機能 (セッションアフィニティとも呼ばれる) を使用することによって、ロードバランサーがユーザーのセッションを特定のアプリケーションインスタンスにバインドするように設定できる。
これにより、セッション中にそのユーザーから来たリクエストをすべて同じアプリケーションインスタンスに送信でき、ブラウザのWebSocket接続機能を利用できる。</p>
<p>ConnectionDraining機能を活用することにより、EC2インスタンスをスケールインする場合、特定のドレインのための時間を設けることで安全なスケールインが可能になる。</p>
<p>ELBは従量課金性で、使用時間と処理データ量の組み合わせで料金が決定する。そのためスケールの状況によって変化しない。また、ファームウェアの更新はAWSにより行われるため、容易に運用管理を行える。
その他、ELBはSSLターミネーションとアクセスログ取得機能を持つ。SSLターミネーションは通信の暗号化処理を行い、サーバ側のパフォーマンス向上に寄与する。
アクセスログはロードバランサーで一括して収集を行うことでEC2インスタンスに分散してログ収集を行わずにすむ。</p>
</div>
<div class="section" id="classic-load-barancing-application-load-barancingnetwork-load-barancing">
<span id="section3-3-2-clb-and-alb-label"></span><h3>Classic Load Barancing と Application Load Barancing、Network Load Barancing<a class="headerlink" href="#classic-load-barancing-application-load-barancingnetwork-load-barancing" title="Permalink to this headline">¶</a></h3>
<p>ELBでは、ロードバランシングサービスの１つとして「Application Load Balancer（ALB）」が提供されている。
代表的な機能としては、パケットの内容に応じたコンテントベースのルーティングで、レイヤー7（L7）スイッチが備える機能を持つ。
従来のロードバランシングサービスELBは「Classic Load Balancer（CLB）」という名称に変更された。
ELBは、新しいALBと従来のCLB、後述するNLBを合わせたロードバランシングサービスの総称として表現される。</p>
<p>ALBでは、その他にも、以下の特徴をもつ。</p>
<ul class="simple">
<li>パスベースルーティング</li>
<li>コンテナ化されたアプリケーションのサポート</li>
<li>HTTP/2サポート</li>
<li>WebSocketサポート</li>
<li>StickySessionの強化</li>
<li>ヘルスチェックの強化</li>
<li>インスタンスのヘルスチェックは従来通りHTTP/HTTPSでping</li>
<li>レスポンスコードの指定（200〜299複数）</li>
<li>CloudWatchのメトリクス強化（ターゲットグループ単位とか）</li>
</ul>
<p>ALB、ELBはリバースプロキシ型の負荷分散サービスを提供する一方、もっとも最新のNLBはL4 NATロードバランサである。特徴としては、</p>
<ul class="simple">
<li>固定IPアドレス</li>
<li>Pre-warming申請不要</li>
<li>ゾーナリティ</li>
<li>Source Address Preservation</li>
<li>フェイルオーバーに対応</li>
</ul>
<p>などがある。各ロードバランシングサービスの比較は <a class="reference external" href="https://aws.amazon.com/jp/elasticloadbalancing/details/#compare">Elastic Load Balancing 製品の詳細</a> に詳細がまとめられている。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ロードバランサーはマルチリージョンで負荷分散を行えるが、実態としては各アベイラブルゾーンに配置され、各々IPが設定される。そのため、ELBエンドポイントというパブリックなDNS名を持ち、各IPは同一のELBエンドポイントに紐付けられる形になる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">VPCサブネットではロードバランサ用にプライベートIPを複数確保（余裕を持ってサブネットをきっておく）しておくこと。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">従来のロードバランサのDNSに割り振られるグローバルIPは動的に変更されるので、IPアドレスを直接指定してロードバランサに振り分けることは難しかったが、NLBでは固定のIPとなる。</p>
</div>
</div>
<div class="section" id="alb">
<span id="section3-3-3-alb-setting-label"></span><h3>ALBの設定<a class="headerlink" href="#alb" title="Permalink to this headline">¶</a></h3>
<p>ここでは、ロードバランシングサービス利用の一例として、ALBの設定を行う。</p>
<ol class="arabic simple">
<li>EC2コンソールメニューから、ロードバランサを選択し、「ロードバランサの作成」をクリックする。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-1.png" src="../../../_images/management-console-application-load-balancing-setting-1.png" />
</div>
<ol class="arabic simple" start="2">
<li>「アプリケーションロードバランサ」を選択する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-2.png" src="../../../_images/management-console-application-load-balancing-setting-2.png" />
</div>
<ol class="arabic simple" start="3">
<li>ロードバランサの以下の設定項目を入力する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-3.png" src="../../../_images/management-console-application-load-balancing-setting-3.png" />
</div>
<ul class="simple">
<li>名前：ALBの名称</li>
<li>スキーム：ロードバランサーのタイプを選択する。外部からのアクセスかAPサーバ等の内部ネットワークからのアクセスか。</li>
<li>リスナー：プロトコルを指定する。http or HTTPS</li>
<li>アベイラビリティゾーン：ALBを配置するアベイラビティゾーンを選択。２箇所以上が必須。</li>
</ul>
<ol class="arabic simple" start="4">
<li>証明書・セキュリティポリシーの設定。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-4.png" src="../../../_images/management-console-application-load-balancing-setting-4.png" />
</div>
<ul class="simple">
<li>証明書タイプ：設定する証明書のタイプを指定する。 <a class="reference internal" href="security.html#section7-2-2-acm-request-certication-label"><span class="std std-ref">証明書のリクエスト</span></a> にて作成した証明書を使用</li>
<li>証明書の名前：証明書をプルダウンから選択</li>
<li>セキュリティポリシー： <a class="reference external" href="http://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/application/create-https-listener.html">フロントエンド接続に使用するセキュリティポリシー</a> を選択</li>
</ul>
<ol class="arabic simple" start="5">
<li>セキュリティグループの設定</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-5.png" src="../../../_images/management-console-application-load-balancing-setting-5.png" />
</div>
<ol class="arabic simple" start="6">
<li>ルーティングの設定</li>
</ol>
<p>ロードバランサーからディスパッチするサーバのインスタンスグループを指定する。</p>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-6.png" src="../../../_images/management-console-application-load-balancing-setting-6.png" />
</div>
<ul class="simple">
<li>名前：任意のターゲットグループ名(xxx-app-alb等)</li>
<li>プロトコル：HTTP/HTTPS(ロードバランサーでSSL Terminationを行う場合はHTTPでよい)</li>
<li>ヘルスチェックプロトコル：HTTP/HTTPS(ロードバランサーでSSL Terminationを行う場合はHTTPでよい)</li>
<li>ヘルスチェックパス：ヘルスチェックを行うURLでドメイン名以下のパス</li>
<li>ヘルスチェックの詳細設定：任意</li>
</ul>
<ol class="arabic simple" start="7">
<li>ターゲットの登録</li>
</ol>
<p>インスタンスグループに登録するターゲットを指定。</p>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-7.png" src="../../../_images/management-console-application-load-balancing-setting-7.png" />
</div>
<p>確認ボタンを押下し、ALBを作成する。</p>
<ol class="arabic simple" start="8">
<li>スティッキーセッションの設定</li>
</ol>
<p>セッションがサーバ固有のものを使用しているアプリケーションやWebSocketアプリケーションなど、
スティッキーセッションを維持する必要があるものは、ターゲットグループからスティッキーセッションの設定を行う。</p>
<p>EC2コンソールから、メニュー「ターゲットグループ」を選び、「属性」オプションを選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-8.png" src="../../../_images/management-console-application-load-balancing-setting-8.png" />
</div>
<p>「ロードバランサーによって生成されたCookieの維持を有効化」にチェックを入れ、維持期間を設定する。</p>
<div class="figure">
<img alt="../../../_images/management-console-application-load-balancing-setting-9.png" src="../../../_images/management-console-application-load-balancing-setting-9.png" />
</div>
</div>
</div>
<div class="section" id="route53">
<span id="section3-4-route53-label"></span><h2>Route53<a class="headerlink" href="#route53" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section3-4-1-route53-overview-label">
<span id="id8"></span><h3>Overview<a class="headerlink" href="#section3-4-1-route53-overview-label" title="Permalink to this headline">¶</a></h3>
<p>Route53はAWSが提供するDNSサービスで、世界37カ国に配置された高い可用性と100%のSLA保証が大きな特徴である。
Route53は以下のルーティングをサポートする。</p>
<table border="1" class="colwidths-given docutils" id="id13">
<caption><span class="caption-text">Route53のルーティングサポート</span><a class="headerlink" href="#id13" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>シンプルルーティング</td>
<td>単一のサーバ向けのルーティング</td>
</tr>
<tr class="row-even"><td>加重ラウンドロビン</td>
<td>頻度を指定するために、リソースレコードセットに重みを割り当てる</td>
</tr>
<tr class="row-odd"><td>レイテンシールーティング</td>
<td>世界中で使用されるアプリケーション向けに、AWSエンドポイントのうち、レスポンスが最速のものにルーティングする。</td>
</tr>
<tr class="row-even"><td>ヘルスチェック及びDNSフェイルオーバー</td>
<td>プライマリアクセスサイトがアクセス不能になった場合、バックアップサイトへフェイルオーバーする</td>
</tr>
<tr class="row-odd"><td>位置情報ルーティング</td>
<td>ユーザの地理的場所(DNSクエリの送信元の場所)を大陸別、国別、米国の州別に指定する</td>
</tr>
</tbody>
</table>
<p>また、他のAWS同様、REST APIによるサポートがあり、ドメインやホストの追加・削除、設定内容の変更がプログラムからも実行可能である。
また、マルチリージョンで複数のホストへバランシングする際、レイテンシー（より物理的に距離が近いほうのホスト）ルーティングする機能や、
ホストサイトへヘルスチェックして、応答がない場合、S3等セカンダリサイトへ フェイルオーバーできる機能を持つ。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Route53では、AWSマネジメントコンソール及びAPIからドメインの購入・登録ができる。既に登録済みのドメインを登録しても、レジストラ(ドメインの登録業者)から購入してRoute53へ登録しても良いが、Route53経由で登録した場合、ドメインの詳細情報をAWSマネジメントコンソールから一括で確認できる。</p>
</div>
</div>
<div class="section" id="section3-4-2-route53-registration-label">
<span id="id9"></span><h3>ドメインの登録<a class="headerlink" href="#section3-4-2-route53-registration-label" title="Permalink to this headline">¶</a></h3>
<p>Route53を利用して、ドメインを登録する。トップページのRoute53によるドメイン登録を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-registration-1.png" src="../../../_images/management-console-route53-registration-1.png" />
</div>
<p>登録したいドメインが利用可能かチェックを行う。カートに追加すると、どのくらいの期間ドメインを利用するか選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-registration-2.png" src="../../../_images/management-console-route53-registration-2.png" />
</div>
<p>ドメインの管理者の連絡先情報を入力する。入力したメールアドレス宛に認証のためのメールが届くため、メール記載のリンクを押下して認証を行う。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-registration-3.png" src="../../../_images/management-console-route53-registration-3.png" />
</div>
<p>登録依頼が完了すると、下記の画面が表示される。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-registration-4.png" src="../../../_images/management-console-route53-registration-4.png" />
</div>
<p>Route53ダッシュボードに移動すると、申請したドメインの登録情報に関するステータスが表示される。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-registration-5.png" src="../../../_images/management-console-route53-registration-5.png" />
</div>
<p>登録が完了(完了画面では最大3日程度と書かれているが、今回は1時間程度で完了した)すると、管理者宛のメールアドレスに登録完了のメールが送付され、ダッシュボードの表示が切り替わる。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-registration-6.png" src="../../../_images/management-console-route53-registration-6.png" />
</div>
</div>
<div class="section" id="elastic-ip">
<span id="section3-4-3-route53-domain-setting-label"></span><h3>登録したドメインとElastic IPアドレスの紐付け設定<a class="headerlink" href="#elastic-ip" title="Permalink to this headline">¶</a></h3>
<p>前節「 <a class="reference internal" href="#section3-4-2-route53-registration-label"><span class="std std-ref">ドメインの登録</span></a> 」に続き、登録したドメインを「 <a class="reference internal" href="#section3-1-7-elastic-ip-address-label"><span class="std std-ref">Elastic IP Address</span></a> 」にて設定したElastic IP Addressに紐づける設定を行う。Route53ダッシュボード画面からDNS ManagementにあるHosted zonesを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-registration-6.png" src="../../../_images/management-console-route53-registration-6.png" />
</div>
<p>対象のドメインにチェックを入れ、「Go to Record Sets」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-setting-domain-1.png" src="../../../_images/management-console-route53-setting-domain-1.png" />
</div>
<p>以下の要領で、Create Record SetにドメインとIPアドレスを設定する。</p>
<div class="figure">
<img alt="../../../_images/management-console-route53-setting-domain-2.png" src="../../../_images/management-console-route53-setting-domain-2.png" />
</div>
<table border="1" class="colwidths-given docutils" id="id14">
<caption><span class="caption-text">Create Record Setの設定値</span><a class="headerlink" href="#id14" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="23%" />
<col width="54%" />
<col width="23%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>設定値</td>
<td>説明</td>
<td>IPv4設定値サンプル</td>
</tr>
<tr class="row-even"><td>Name</td>
<td>ドメイン名の接頭辞となるホスト名を指定</td>
<td>www</td>
</tr>
<tr class="row-odd"><td>Type</td>
<td>レコードタイプを指定する。 <br /> Aレコード：ドメインとIPアドレスを指定 <br /> AAAAレコード：ドメインとIPv6アドレスを設定 <br /> PTRレコード：ドメインとIPアドレスの逆引き設定 <br /> MXレコード：メールサーバの設定 <br /> NSレコード：DNSレコードを設定</td>
<td>A IPv4アドレス</td>
</tr>
<tr class="row-even"><td>Alias</td>
<td>他のレコードの設定を参照する場合Yes</td>
<td>No</td>
</tr>
<tr class="row-odd"><td>TTL</td>
<td>キャッシュの有効期間を設定</td>
<td>300</td>
</tr>
<tr class="row-even"><td>Value</td>
<td>Aレコードの場合IPアドレス</td>
<td>XXX.XXX.XXX.XXX</td>
</tr>
<tr class="row-odd"><td>Routing Policy</td>
<td>複数のIPアドレスを同一のホスト名で指定する場合、 <br /> 優先対象を指定</td>
<td>Simple</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">既に登録されている２つのレコードのうち、「NSレコード」はゾーンを担当するDNSサーバー群（Route53サービスで「Name Servers」として表示されているものと同じ）を、 「SOAレコード」はゾーンを設定する管理者やキャッシュのデフォルト有効期限などを設定するものである。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TTLの設定はキャッシュの更新時間であるため、間隔が長ければ長いほど、パフォーマンスは良くなるが、変更時の反映時間が長くなることがトレードオフとなる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">マルチリージョンで同一のドメイン名で異なるサイト・アプリケーションをホストする場合は、Route53でそれぞれのロードバランサー等登録しておけば、低レイテンシー(より早くアクセス可能)な方を選択し、解決してくれる。</p>
</div>
<p>Createボタンを押下すると、設定が反映される。しばらく時間が経過したのち、指定したドメイン名でサーバにアクセス可能か確認を行う。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh -i /Users/username/.ssh/キー名.pem ec2-user@設定したドメイン名
</pre></div>
</div>
</div>
<div class="section" id="section3-4-3-route53-healthcheck-label">
<span id="id10"></span><h3>ヘルスチェックの設定<a class="headerlink" href="#section3-4-3-route53-healthcheck-label" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">マルチリージョンフェイルオーバーの設定を記述。</p>
</div>
</div>
</div>
<div class="section" id="transit-gateway">
<span id="section3-5-transit-gateway-label"></span><h2>Transit Gateway<a class="headerlink" href="#transit-gateway" title="Permalink to this headline">¶</a></h2>
<p><br /></p>
<p>Transit Gatewayは従来VPC間でPeering接続していた代わりにTransitGatewayがハブとなり、VPC間の接続を行うリージョンサービスである。
親アカウントにTransitGatewayを作成しておくと、親アカウントに紐づく複数の子アカウントに作成したVPCのピア接続が可能になる。
DirectConnectGatewayとも連携し、他リージョンにある子アカウントと接続することもできる。</p>
<p><br /></p>
</div>
<div class="section" id="api-gateway">
<span id="section3-6-api-gateway-label"></span><h2>API Gateway<a class="headerlink" href="#api-gateway" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section3-6-1-api-gateway-overview-label">
<span id="id11"></span><h3>Overview<a class="headerlink" href="#section3-6-1-api-gateway-overview-label" title="Permalink to this headline">¶</a></h3>
<p>API GatewayはAPIの作成、公開やリクエストのモニタリング等の管理を行うサービスである。作成可能なAPI種類として以下の３種類がある。</p>
<ul class="simple">
<li>GET、POST、PUT、PATCH、DELETEなどの標準HTTPメソッドを用いたリソースベースのステートレスな通信を実現するREST API</li>
<li>より低コストで低レイテンシーなHTTP API</li>
<li>クライアントとの双方向通信を実現するWebSocket API</li>
</ul>
<p>REST APIとHTTP APIの違いについては <a class="reference external" href="https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/http-api-vs-rest.html">HTTP API または REST API の選択</a> にも記載されているが、
HTTP APIはネイティブなOpenID Connect / OAuth 2.0 のオーソライザのサポートとバックエンドにプライベートなALBをVPCリンクを介して接続できるなどの特徴が目立つ。
反面、2020年6月現在では、AWS LamndaやIAMはオーソライザとしてサポートされていないので、ユースケースに応じて、利用するAPIを使い分けると良い。</p>
<p><br /></p>
</div>
<div class="section" id="rest-api">
<span id="section3-6-2-create-rest-api-label"></span><h3>REST APIの作成<a class="headerlink" href="#rest-api" title="Permalink to this headline">¶</a></h3>
<p><br /></p>
<p>マネジメントコンソール上からAPI Gatewayを選択し、API名を入力した上で「新しいAPIの作成」ボタンをクリックする。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-1.png" src="../../../_images/management-console-apigateway-create-1.png" />
</div>
<p><br /></p>
<p>RESTのリソースとして返却するモデルの名称とリソースパスを定義する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-2.png" src="../../../_images/management-console-apigateway-create-2.png" />
</div>
<p><br /></p>
<p>RESTのリソースに対するアクションを定義する。統合タイプとしてLambdaを選択し、実行するLambdaファンクションを入力する。Lambdaの作成方法については <a class="reference internal" href="application.html#section7-4-3-lambda-deploy-label"><span class="std std-ref">コードの作成・デプロイ</span></a> を参考にすること。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-3.png" src="../../../_images/management-console-apigateway-create-3.png" />
</div>
<p><br /></p>
<p>RESTのリソースに対するアクションを定義する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-4.png" src="../../../_images/management-console-apigateway-create-4.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-5.png" src="../../../_images/management-console-apigateway-create-5.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-6.png" src="../../../_images/management-console-apigateway-create-6.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-7.png" src="../../../_images/management-console-apigateway-create-7.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-resource-1.png" src="../../../_images/management-console-apigateway-create-resource-1.png" />
</div>
<p><br /></p>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">REST API の作成手順を最新化。</p>
</div>
<p><br /></p>
</div>
<div class="section" id="vpc-link">
<span id="section3-6-3-create-vpc-link-label"></span><h3>VPC Linkの作成<a class="headerlink" href="#vpc-link" title="Permalink to this headline">¶</a></h3>
<p><br /></p>
<p>HTTP APIから特定のVPC内にあるPrivate ALBにアクセスするためのVPC Linkを作成する。このVPC LinkはENI(Elastic Network Interface)であり、ネットワークインターフェースは通常インスタンスなどにアタッチされ、
異なるネットワークへ繋げるための、仮想的なLinuxでいう論理NICに相当する。AWSコンソール上でAPI GatewayサービスからVPCリンクメニューを選択し、作成ボタンを押下する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-vpclink-1.png" src="../../../_images/management-console-apigateway-create-vpclink-1.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-vpclink-2.png" src="../../../_images/management-console-apigateway-create-vpclink-2.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-vpclink-3.png" src="../../../_images/management-console-apigateway-create-vpclink-3.png" />
</div>
<p><br /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">REST APIのVPC LinkはVPCエンドポイントで有料となるので注意。</p>
</div>
<p><br /></p>
</div>
<div class="section" id="albhttp-api">
<span id="section3-6-4-create-http-api-label"></span><h3>インターナルALBに接続するHTTP APIの作成<a class="headerlink" href="#albhttp-api" title="Permalink to this headline">¶</a></h3>
<p><br /></p>
<p>続いて、HTTP APIの作成を行うが、事前に <a class="reference internal" href="computing.html#section3-2-2-ecs-create-cluster-label"><span class="std std-ref">EC2起動型-クラスタの作成</span></a> を参考に、
HTTP APIで呼び出させれるECSクラスタ、タスク、サービスおよびBackend用のインターナルALBを作成しておくこと。</p>
<p>AWSコンソール上でAPI GatewayサービスからAPIメニューを選択し、「構築」ボタンを押下する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-httpapi-1.png" src="../../../_images/management-console-apigateway-create-httpapi-1.png" />
</div>
<p><br /></p>
<p>API名を入力し、「次へ」ボタンを押下する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">統合にはプライベートリソースを選択するが作成時には選択できないため、特に設定せずいったん構築する。</p>
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-httpapi-2.png" src="../../../_images/management-console-apigateway-create-httpapi-2.png" />
</div>
<p><br /></p>
<p>「次へ」ボタンを押下する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-httpapi-3.png" src="../../../_images/management-console-apigateway-create-httpapi-3.png" />
</div>
<p><br /></p>
<p>「次へ」ボタンを押下する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-httpapi-4.png" src="../../../_images/management-console-apigateway-create-httpapi-4.png" />
</div>
<p><br /></p>
<p>続いてHTTP APIの接続先を統合する設定を行う。作成したHTTP APIを選択し、「統合」メニューで、「統合を管理」タブを選択し、「Create」ボタンを押下する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-integration-1.png" src="../../../_images/management-console-apigateway-create-integration-1.png" />
</div>
<p><br /></p>
<p>プライベートリソースを選択し、統合のターゲットとして、インターナルなALBを選択する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-integration-2.png" src="../../../_images/management-console-apigateway-create-integration-2.png" />
</div>
<p><br /></p>
<p>VPCリンクでは <a class="reference internal" href="#section3-6-3-create-vpc-link-label"><span class="std std-ref">VPC Linkの作成</span></a> で作成したリンクを選択する。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-integration-3.png" src="../../../_images/management-console-apigateway-create-integration-3.png" />
</div>
<p><br /></p>
<p>APIの受け口となるパスを作成する。ECSコンテナでリクエストを受け付けるパスと同様のルートを設定する。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">パス変数は{}で指定すること。詳細は <a class="reference external" href="https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/http-api-develop-routes.html">HTTPルートの使用</a> を参照のこと。</p>
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-route-1.png" src="../../../_images/management-console-apigateway-create-route-1.png" />
</div>
<p><br /></p>
<p>作成したルートに上述で作成した統合をアタッチする。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-attach-route-1.png" src="../../../_images/management-console-apigateway-attach-route-1.png" />
</div>
<p><br /></p>
<p>作成したHTTP APIを呼び出して、バックエンドのECSコンテナアプリケーションが実行され、レスポンスが返却されるか確認する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl https://4jc6u6rpuk.execute-api.ap-northeast-1.amazonaws.com/backend/user/api/v1/users/0
</pre></div>
</div>
</div>
<div class="section" id="http-api">
<span id="section3-6-4-create-authorizer-label"></span><h3>HTTP APIの認証設定<a class="headerlink" href="#http-api" title="Permalink to this headline">¶</a></h3>
<p>■続いて、上記で作成したAPIにAmazon Cognitoで作成したユーザに対してのみAPIが実行可能なように、IDトークンを使用した認証設定を行う。
事前に、 <a class="reference internal" href="security.html#section7-3-2-cognito-create-userpool-label"><span class="std std-ref">ユーザプールプールの作成</span></a> を参考にして、ユーザプールおよびユーザ、IDプールを作成しておくこと。</p>
<p>コンソールの「認可」メニューから、「オーソライザー」を管理タブを選択し、「作成」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-authorizer-1.png" src="../../../_images/management-console-apigateway-create-authorizer-1.png" />
</div>
<p><br /></p>
<p>■以下の通り入力してアタッチする。</p>
<ul class="simple">
<li>オーソライザ名：任意の名前を入力</li>
<li>IDソース：「$request.header.Authorization」を設定(この設定によりHTTPリクエストのヘッダにAuthorization属性でIDトークンを指定することにより認証が行われる)</li>
<li>発行者URL：<a class="reference external" href="https://cognito-idp">https://cognito-idp</a>.&lt;region&gt;.amazonaws.com/&lt;userPoolID&gt;</li>
<li>対象者：Coginitoで作成したアプリクライアントIDを指定</li>
</ul>
<div class="figure">
<img alt="../../../_images/management-console-apigateway-create-authorizer-2.png" src="../../../_images/management-console-apigateway-create-authorizer-2.png" />
</div>
<p><br /></p>
<p>■アタッチすると、これまで実行できていたAPIが認証エラーになる</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl https://4jc6u6rpuk.execute-api.ap-northeast-1.amazonaws.com/backend/user/api/v1/users/0
<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;Unauthorized&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p><br /></p>
<p>■HTTPリクエストヘッダに付与するIDトークンの照会を行う。Amazon CLIで以下のコマンドを実行し、Cognitoで作成したユーザのIDトークンを取得する。なお、</p>
<ul class="simple">
<li>ユーザプールID</li>
<li>アプリクライアントID</li>
<li>ユーザ名</li>
<li>パスワード</li>
</ul>
<p>を適宜差し替えてコマンド実行すること。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CLIを実行するユーザに事前にIAMでCognitoのアクセス権限(PowerUser)を付与しておくこと。</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws cognito-idp admin-initiate-auth --user-pool-id ap-northeast-1_&lt;UserPoolID&gt; --client-id &lt;AppClientID&gt; --auth-flow ADMIN_USER_PASSWORD_AUTH --auth-parameters <span class="s2">&quot;USERNAME=&lt;UserName&gt;,PASSWORD=&lt;Password&gt;&quot;</span>
</pre></div>
</div>
<p><br /></p>
<p>■初回アクセスの場合、以下のようなレスポンスが返却されて、パスワードの変更が必要になる。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
    &quot;ChallengeName&quot;: &quot;NEW_PASSWORD_REQUIRED&quot;,
    &quot;ChallengeParameters&quot;: {
        &quot;USER_ID_FOR_SRP&quot;: &quot;711e8fe5-bbc1-40a1-abbf-3c06931a0d04&quot;,
        &quot;requiredAttributes&quot;: &quot;[\&quot;userAttributes.family_name\&quot;,\&quot;userAttributes.given_name\&quot;,\&quot;userAttributes.picture\&quot;]&quot;,
        &quot;userAttributes&quot;: &quot;{\&quot;email_verified\&quot;:\&quot;true\&quot;,\&quot;given_name\&quot;:\&quot;\&quot;,\&quot;family_name\&quot;:\&quot;\&quot;,\&quot;email\&quot;:\&quot;&lt;username&gt;\&quot;,\&quot;picture\&quot;:\&quot;\&quot;}&quot;
    },
    &quot;Session&quot;: &quot;ZfKb47kDu1cS8wQKaizrsqGhwJ8OmtMnQoCz-cotKgOz9Ny_nfngacRIJPVGdDSMchIk6ttDO3IfFYeyafve1XYlYufP4lypu8DeGQhjCjlv-9f7Qw_dB8KColr7V7rdHp5aM4qefRIG1hwq4iBwYxzY90o_MQ6_Kbr5sWCBHVnbUPD5u4yBhkTniabO3zXkKX-IShmKqiZJahOrDPVkhOHhqLQIEYXjuCDOECNe8YYbzjAKObl3qCicrD62bkMGzm12bBzzmOmrVVOqb050S8pphYjtMJkLxDby4UOw9r0XdHiOcrldCYBZiNZJ1O0vk5f4L6nwi1FpQPD-pDBn_N5Ac6GA0Fk5to8myC0AS8fkYZp99TKKgu6PQWyQmyvrApHwZHJvGs-xkoUNNnlcjmXAYHvddDC7mVRp_q6ggVRlHl_7b6IZA_tINy8o1sfBPgpe5w_u2RamkNeQxIA6AFiC-fkfuZNbZZHmxLT1lv4EdTS_C8pLVAOSUp1r7PAM-Bv16kxANaPKADUsbB5EHm7QLpXcS4ORYcDLyaG1soJLxGHFMwQaIXQZgabs_7U61OsXHlup_6-A4Y1kHVFY0EH5f9Yi0HzYX6isSei63sMxtdPI9QK1__XiA_nxuo8dLdDmBLtMmGEgjv6pZCHwa2B0bixuZyuVkSRkRGALHPsBsqAUI0MoJsnAByR7L4s1xxIr8b-k2zBZ6p4-TVn8bQuZ2kfqMYIfqiIcBkrEXpa3rFNHYtyvnWYkIE2kb8ymtqmlnrnlVhKqT86y8PXkPDtIdjF3NL3gAIrQT81Z8d0E5uI-Vagf9fHvUKmmX9rPZvPGjl2UuKNekuh8dPPxGX6DH3EW27yHSE--_Tc7Cv4PBEpPH7lJjgVtZOeQ4APMh7BYZJSM_o2rhUinkZcl4IpEjuCNa3wnlyouCrfjbYNMXQZA_yFKNwXIIovIXNqJ4Q-PgX9tl0OZqIrmCJtkIXbm5el4VHZYmCE1L4jt6Vjm1Mh1ekc-8td8v8c73Dr53jI3E0znk_DbydFWQgT8b-iShdtdBI3x5yBPkw&quot;
}
</pre></div>
</div>
<p>以下のコマンドを実行し、ユーザ情報のアップデートを行うこと。ただし、</p>
<ul class="simple">
<li>ユーザプールID</li>
<li>アプリクライアントID</li>
<li>ユーザ名</li>
<li>新しいパスワード</li>
<li>ユーザのサインアップ時に必須設定したパラメータ(ここの例では、given_name、family_name、picture)</li>
<li>上記のSession</li>
</ul>
<p>を適宜変更して、コマンド実行すること。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">ここでユーザ名は上記のレスポンスのUSER_ID_FOR_SRPの値を設定すること。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">必須設定のパラメータは「userAttributes.xxxxx」の形式で設定すること。</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws cognito-idp admin-respond-to-auth-challenge --user-pool-id &lt;UserPoolID&gt; --client-id &lt;AppClientID&gt; --challenge-name NEW_PASSWORD_REQUIRED --challenge-responses <span class="s2">&quot;USERNAME=&lt;UserName&gt;,NEW_PASSWORD=&lt;NewPassword&gt;,userAttributes.given_name=&lt;custom_name&gt;,userAttributes.family_name=&lt;custom_name&gt;,userAttributes.picture=&lt;custom_param&gt;&quot;</span> --session <span class="s2">&quot;&lt;Session&gt;&quot;</span>
</pre></div>
</div>
<p><br /></p>
<p>■正常に変更が完了すると、IDトークンやリフレッシュトークン、アクセストークンが得られる。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
    &quot;AuthenticationResult&quot;: {
        &quot;ExpiresIn&quot;: 3600,
        &quot;IdToken&quot;: &quot;eyJraWQiOiI3RlRaSkVtd0c2aVltSnFQZHVoOXM1U1BMRklXVXA5akJ2K3BnVEdBSURzPSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiI3MTFlOGZlNS1iYmMxLTQwYTEtYWJiZi0zYzA2OTMxYTBkMDQiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiaXNzIjoiaHR0cHM6XC9cL2NvZ25pdG8taWRwLmFwLW5vcnRoZWFzdC0xLmFtYXpvbmF3cy5jb21cL2FwLW5vcnRoZWFzdC0xX0ZFeEdwTFlPZCIsImNvZ25pdG86dXNlcm5hbWUiOiI3MTFlOGZlNS1iYmMxLTQwYTEtYWJiZi0zYzA2OTMxYTBkMDQiLCJnaXZlbl9uYW1lIjoia29oZWkiLCJwaWN0dXJlIjoidGVzdC5wbmciLCJhdWQiOiIzdmJzcDVjdDU2YjA2MmdkNjdkdmlkNTJhdiIsImV2ZW50X2lkIjoiMmU2YjljZTItZmYwMy00NDk5LThiMjItYTVlZDYxYmZiZjhmIiwidG9rZW5fdXNlIjoiaWQiLCJhdXRoX3RpbWUiOjE1OTI2Mzg4NzQsImV4cCI6MTU5MjY0MjQ3NCwiaWF0IjoxNTkyNjM4ODc0LCJmYW1pbHlfbmFtZSI6Imthd2FiYXRhIiwiZW1haWwiOiJrb2hlaS5rYXdhYmF0YUBtYWMuY29tIn0.cqLJnA6EhayzG-4r-ps-g8VOB4q-9fDLTRxvRmqfldSw3plZVplLcrdvns2ufIZ0fuG0FwoDqd5hXi0qFr87ETL7-UHsMe8kbuvIQxO1xnZ-OGzd07gvwlHg-p5hlctucftAleEm5IrHLvwr3gSN8Uttl-BvoQ_lauF-alu_P5R4wtAHJCeEU9TKJUBQa0i0F83v8Gm0a-S5ZHaibVxa5qv1J75SrHnaefdXmU6dUp39Lq74jhEuoF8-NoUxYPK9CYWnkIzf9yPRxORvBP9V0Pz5Gxl0b9yqpgh6fegxggvZIJiujoF8zyUwZaqHGGOseNcCJNlrCc_bo4L-eqwOVg&quot;,
        &quot;RefreshToken&quot;: &quot;eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ.JV6kOU4TznCfBKl0rPr4yO0PEw7KK7xjuWzZV4SQT-C8RvQmk2VRGmGhgHAbTcWnGJkQ_itFeKHiE1g5lgD3CUHvbFchQD7YJaZFVYou8D0EJ00x0FT7heT1xffW3kxujIqg11HGl6vIYgEvHw_IY9ZpiVTv5B1P93mtDo5lIZiIWmndqMl71eokTE6STmUdrXz7kYly0AgOP04uIZmKHv_1bckWlM1THmViQcvsUOCyUdSpK3oKKrrVda5oUEFErIf-X0To2LobGZ0SsD6u9__-mJqtZznX8Rd5zsd4XsfV73gypZsscZhi342MNqwxi74a9p7GGL3LmZjkEStUwA.MlmjHNrteAOsiZ2d.r8oKnpf2AT-IPINgeFfOUZCaEQelLzJbZfgsGlnAq0xHDTl62VlurPAr9BfEaIOyfb8uw92yMDdq98kPjQ313e2G9LDzQddc2fMB83jZww6sDQljYCtmLJEkZ0z6LnDunAdB7ZShBZTLJ77EDqVEjzCqUd6kRiPM_T7G_GxGYE4bh2W6A4ut0OW4AL6-zbAPR2hoqSjbvqjs5P44utvVbM0Fp8tzR3F9Yl-jaHp_0nCOaNun0crIjDX7d0y1aihl2-Rm7Uts2t4NyH5dzZnWreg_BwXUVNmXBB8dxTJ8C-USsvlV0WAw15VYHzV4lyZJkG6oe_igin0E5t40tvvVxOsDWMu7o0WVFC7FYrrDT3uXZ7sNm5EJSWODEIi5os212-4saxeRPRuc12MBG3W6z5hynPzNdflDmDWNUByyWKd4CsS4Yg9AjPROQSl0xU20HHM3PMF8O6go_k9CIAhwL8odRqR__hUBga8L4_2pKIUkq8ph2N6pMjgaJlYRihNn8ZFgGAMLyYjDn0MA_gsBQVxVdDjBMavPy2-OJNU4widQ_89Hqt0lAD1z_jK7_VF_LDQYvx2OBYk4S5-5jim8__2eVBlJeHeoY2g0ZaPbTnNpcrQSWRPZDWEYxXpSz1lWKydosKZQwmZmaZoZC-B7i8J9zWTbjUW4n8pBWb65Kj4bqzpEV2GCIKQfNcPD6LJqqhiC-p0-tvM6bEe-rNQfmr0r6lj7lsR2OiQzgRzR5UejvnYmKrqW9bQEFAVde2LEwLCHyB5x5knF-WtnO32u49z2VTSYGQL_Fe-kWXGYDjfMWqlFBwGVisM44hwqdAmSlx7N4pXpdnEDmN2WfU22tScu2Iqf9O7T_6vIKRXcr5MKkY4rFdBEaWllozBU4VPHAuznPVCaOsHOQHk5hsO_-pgaihuor-U-XHsZBO8KnsdwBe6En-Cp_569ICBKNw9U26sT2MEZ1Grxkw9Saf-tyIFL5xmmxe5InY3-5WSWBiDdr89Iuu-RvBfLeiWry_JjvvMO9NfgEaFItIim0s3kta22_nFFVJNDAwi_r9ybDwe09r5OLFTyhE7hfRgmxYldDRVe9m9t9LX84oe0jF7CdjAnTlf23mnPDO3g3wIw1ssPSq9xTRNcnSkytEeYIOiv_vHqiA-joRjNc1BNQXxyNjyJgcouypDYiBAMKgyQSOIUL4mCiloLoFbSzQjXUc_2dQ-8mNXm0Ze4K_o8AWOidCKlpzAGmz9bS9IArhOFl28b1CWYtDlkZaP9LlvqBaypVp_bt1SbTmaapVLejIF4-oIC8KKVYiBzX5h6OJo_ytu_VhGaSHGsh6JjlO988XvP4OoGOGfIF2sDNIvG1Q.8J_ZLL6WmtsBPCdaS_kxDA&quot;,
        &quot;TokenType&quot;: &quot;Bearer&quot;,
        &quot;AccessToken&quot;: &quot;eyJraWQiOiJEd3RnVjdlb0dRT3hiblNpRFpsVkFXeVNOXC92VCtVTW1wKzFIZVpJejVoTT0iLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiI3MTFlOGZlNS1iYmMxLTQwYTEtYWJiZi0zYzA2OTMxYTBkMDQiLCJldmVudF9pZCI6IjJlNmI5Y2UyLWZmMDMtNDQ5OS04YjIyLWE1ZWQ2MWJmYmY4ZiIsInRva2VuX3VzZSI6ImFjY2VzcyIsInNjb3BlIjoiYXdzLmNvZ25pdG8uc2lnbmluLnVzZXIuYWRtaW4iLCJhdXRoX3RpbWUiOjE1OTI2Mzg4NzQsImlzcyI6Imh0dHBzOlwvXC9jb2duaXRvLWlkcC5hcC1ub3J0aGVhc3QtMS5hbWF6b25hd3MuY29tXC9hcC1ub3J0aGVhc3QtMV9GRXhHcExZT2QiLCJleHAiOjE1OTI2NDI0NzQsImlhdCI6MTU5MjYzODg3NCwianRpIjoiODA1MTMxYjMtYWU5Yi00OGE5LThjMTQtZTA1OGIxYTMwNjU5IiwiY2xpZW50X2lkIjoiM3Zic3A1Y3Q1NmIwNjJnZDY3ZHZpZDUyYXYiLCJ1c2VybmFtZSI6IjcxMWU4ZmU1LWJiYzEtNDBhMS1hYmJmLTNjMDY5MzFhMGQwNCJ9.LyGTDXlpvOQKIOaSqls0Twz1yPxSOCEcibXsccD1TzD5iaeuWTWzL1PMzCIyZ25v0hXF5ROYwbuUYZqIfQAMU5g_CBch-puBT-98tc7S-IMk1AK8cZn0W8V8xOtb_4lm5L5NeFiEg-Zg9QVf4PAjl_w8BUg8axyuyq6QCNdi9CvbF7VC1rl2RxvNjVLOPmVS5FFmdMvrfxAMX7o9Q4l6OQFlZOEtqjEvxFEW_gR7GL66SYVjr0cCJHRsc48Ixkj9XtjTZCA-bozpJygQcom89Bve8XvMAX0jJhIIjMusVSN2esQ3KsEhbVuGcqHmcV985WC0f4j075iz1nfctOJSdg&quot;
    },
    &quot;ChallengeParameters&quot;: {}
}
</pre></div>
</div>
<p><br /></p>
<p>■IDトークンをHTTPヘッダでAuthorization属性に指定し、リクエストすると正常に結果が得られる。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -H <span class="s1">&#39;Authorization:eyJraWQiOiI3RlRaSkVtd0c2aVltSnFQZHVoOXM1U1BMRklXVXA5akJ2K3BnVEdBSURzPSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiI3MTFlOGZlNS1iYmMxLTQwYTEtYWJiZi0zYzA2OTMxYTBkMDQiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiaXNzIjoiaHR0cHM6XC9cL2NvZ25pdG8taWRwLmFwLW5vcnRoZWFzdC0xLmFtYXpvbmF3cy5jb21cL2FwLW5vcnRoZWFzdC0xX0ZFeEdwTFlPZCIsImNvZ25pdG86dXNlcm5hbWUiOiI3MTFlOGZlNS1iYmMxLTQwYTEtYWJiZi0zYzA2OTMxYTBkMDQiLCJnaXZlbl9uYW1lIjoia29oZWkiLCJwaWN0dXJlIjoidGVzdC5wbmciLCJhdWQiOiIzdmJzcDVjdDU2YjA2MmdkNjdkdmlkNTJhdiIsImV2ZW50X2lkIjoiMmU2YjljZTItZmYwMy00NDk5LThiMjItYTVlZDYxYmZiZjhmIiwidG9rZW5fdXNlIjoiaWQiLCJhdXRoX3RpbWUiOjE1OTI2Mzg4NzQsImV4cCI6MTU5MjY0MjQ3NCwiaWF0IjoxNTkyNjM4ODc0LCJmYW1pbHlfbmFtZSI6Imthd2FiYXRhIiwiZW1haWwiOiJrb2hlaS5rYXdhYmF0YUBtYWMuY29tIn0.cqLJnA6EhayzG-4r-ps-g8VOB4q-9fDLTRxvRmqfldSw3plZVplLcrdvns2ufIZ0fuG0FwoDqd5hXi0qFr87ETL7-UHsMe8kbuvIQxO1xnZ-OGzd07gvwlHg-p5hlctucftAleEm5IrHLvwr3gSN8Uttl-BvoQ_lauF-alu_P5R4wtAHJCeEU9TKJUBQa0i0F83v8Gm0a-S5ZHaibVxa5qv1J75SrHnaefdXmU6dUp39Lq74jhEuoF8-NoUxYPK9CYWnkIzf9yPRxORvBP9V0Pz5Gxl0b9yqpgh6fegxggvZIJiujoF8zyUwZaqHGGOseNcCJNlrCc_bo4L-eqwOVg&#39;</span>
https://4jc6u6rpuk.execute-api.ap-northeast-1.amazonaws.com/backend/user/api/v1/users/0
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="computing.html" class="btn btn-neutral float-right" title="Computing Category" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="overview.html" class="btn btn-neutral" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, org.debugroom.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1-SNAPSHOTS',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>