

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DevOps Category &mdash; document 0.1-SNAPSHOTS documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="AWS IoT" href="iot.html" />
    <link rel="prev" title="Application Category" href="application.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> document
          

          
          </a>

          
            
            
              <div class="version">
                0.1-SNAPSHOTS
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../java/javaee/jpa/index.html">JavaEE JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/javaee/jBatch/index.html">JavaEE jBatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-boot/index.html">Spring Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-data-jpa/index.html">Spring Data JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-data-dynamodb/index.html">Spring Data DynamoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-cloud-aws/index.html">Spring Cloud AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-cloud-function/index.html">Spring Cloud Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database/cassandra/index.html">Cassandra</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Amazon web service</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="network.html">Network Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="computing.html">Computing Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage.html">Storage Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastore.html">DataStore Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Security Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="application.html">Application Category</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">DevOps Category</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#operation">Operation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ec2">実行中のEC2インスタンスのバックアップ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section8-1-2-stamp-label">同じ構成のEC2インスタンスを作成する</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cpu">CPUやメモリスペックを上昇させる</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section8-1-4-ondemand-disk-label">ディスク容量を増設する</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section8-1-5-application-update-label">冗長化構成のアプリケーションをアップデートする</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#codebuild">CodeBuild</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section8-2-1-codebuild-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section8-2-2-codebuild-app-build-label">アプリケーションのビルド</a></li>
<li class="toctree-l4"><a class="reference internal" href="#codebuild-local">CodeBuild Localの利用</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#codepipeline">CodePipeline</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section8-3-1-codepipeline-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ecs">ECSアプリケーションのステージングリリースの自動化</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#aws-cli">AWS CLI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section8-4-1-aws-cli-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section8-4-2-aws-cli-install-label">AWS CLIのインストール</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cloudformation">CloudFormation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section8-5-1-aws-cloudformation-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stack">Stackの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section8-5-2-aws-cloudformation-delete-stack-label">Stackの削除</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#elastic-beanstalk">Elastic Beanstalk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#opsworks">OpsWorks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aws-cdk-aws-cloud-development-kit">AWS CDK(AWS Cloud Development Kit)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="iot.html">AWS IoT</a></li>
<li class="toctree-l2"><a class="reference internal" href="management.html">Management Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html">Appendix - 付録</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swagger/index.html">Swagger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../convention/app-infra/index.html">AP基盤処理方式・実装規約</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../memo/work/index.html">work guideline</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">document</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Amazon web service</a> &raquo;</li>
        
      <li>DevOps Category</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/cloud/aws/article/devops.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="devops-category">
<span id="section8-devops-label"></span><h1>DevOps Category<a class="headerlink" href="#devops-category" title="Permalink to this headline">¶</a></h1>
<div class="section" id="operation">
<span id="section8-1-operation-label"></span><h2>Operation<a class="headerlink" href="#operation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ec2">
<span id="section8-1-1-snapshot-label"></span><h3>実行中のEC2インスタンスのバックアップ<a class="headerlink" href="#ec2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="overview">
<span id="section8-1-1-1-overview-label"></span><h4>overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h4>
<p>クラウドデザインパターンでは「Snapshotパターン」と呼ばれる。
EC2インスタンスはディスクボリュームに「EBS(Elastic Block Store)」というストレージデバイスを使用しており、
EBSにはある瞬間のスナップショットとしてバックアップを作成する機能がある。作成したデータはS3に保存されるが、
特殊な形式のデータのため、直接S3から取り出すことはできない。作成したデータはEBSとして新たに作成し、
EC2インスタンスにマウントするか、AMIイメージを作成し、新たなEC2インスタンスとし起動できる。
これは次章「  <a class="reference internal" href="#section8-1-2-stamp-label"><span class="std std-ref">同じ構成のEC2インスタンスを作成する</span></a> 」にて記述する「Stampパターン」である。</p>
</div>
<div class="section" id="ebs">
<span id="section8-1-1-1-operation-create-ebs-label"></span><h4>EBSボリュームの作成手順<a class="headerlink" href="#ebs" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>対象のストレージの確認</li>
</ol>
<p>EC2コンソールメニューから、「ボリューム」を選択し、スナップショットを作成する対象のストレージを選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-snapshot-1.png" src="../../../_images/management-console-operation-snapshot-1.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">/dev/xvda はXenベースのLinuxシステムにおいて、1台目のハードディスクドライブを指す。</p>
</div>
<ol class="arabic simple" start="2">
<li>スナップショットの作成</li>
</ol>
<p>VolumeIDを右クリックし、「Create Snapshot」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-snapshot-2.png" src="../../../_images/management-console-operation-snapshot-2.png" />
</div>
<p>名称を入力する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-snapshot-3.png" src="../../../_images/management-console-operation-snapshot-3.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-operation-snapshot-4.png" src="../../../_images/management-console-operation-snapshot-4.png" />
</div>
<ol class="arabic simple" start="3">
<li>EBSボリュームを作成する。</li>
</ol>
<p>作成したスナップショットを右クリックし、「Create Volume」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-snapshot-5.png" src="../../../_images/management-console-operation-snapshot-5.png" />
</div>
<p>「ディスクの種類」、「ディスクの容量」、「アベイラビリティゾーンを選択する。」</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-snapshot-6.png" src="../../../_images/management-console-operation-snapshot-6.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">EBSボリュームは同一のアベイラビリティゾーンでしか利用できないため、実行するEC2インスタンスのアベイラビリティゾーンに応じて、作成するゾーンを決定する。</p>
</div>
<p>実行すると、ボリュームにEBSがステータスavailabilityで作成される。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-snapshot-7.png" src="../../../_images/management-console-operation-snapshot-7.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">スナップショットの選択時に、右クリック「コピー」を選択すると、別のリージョンへボリュームをコピーできる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">EBSスナップショットは
* 差分(増分)バックアップ
* 圧縮された状態で保存
* S3に３箇所複数される。
* ディスクサイズはフルサイズ表示となるが、実態は差分バックアップのため、サイズが必ずしも実際のデータサイズと一致しているわけではない。</p>
</div>
</div>
<div class="section" id="ebsami">
<span id="section8-1-1-2-operation-create-ami-label"></span><h4>EBSスナップショットからAMIの作成手順<a class="headerlink" href="#ebsami" title="Permalink to this headline">¶</a></h4>
<p>スナップショットを作成したEBSがブート領域を含むのであれば(1台目のディスク)、AMIを作成できる。</p>
<ol class="arabic simple">
<li>イメージの作成</li>
</ol>
<p>スナップショットを右クリック「イメージの作成」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-stamp-1.png" src="../../../_images/management-console-operation-stamp-1.png" />
</div>
<p>AMIの名称、説明、仮想マシンの種別を入力する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-stamp-2.png" src="../../../_images/management-console-operation-stamp-2.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">T2インスタンスを使用する場合、「ハードウェアアシストの仮想化(Hardware-assisted virtualization)」を選択すること。</p>
</div>
<p>実行すると、AMIにイメージがステータスavailabilityで作成される。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-stamp-3.png" src="../../../_images/management-console-operation-stamp-3.png" />
</div>
</div>
</div>
<div class="section" id="section8-1-2-stamp-label">
<span id="id1"></span><h3>同じ構成のEC2インスタンスを作成する<a class="headerlink" href="#section8-1-2-stamp-label" title="Permalink to this headline">¶</a></h3>
<div class="section" id="section8-1-2-1-stamp-overview-label">
<span id="id2"></span><h4>overview<a class="headerlink" href="#section8-1-2-1-stamp-overview-label" title="Permalink to this headline">¶</a></h4>
<p>前節「 <a class="reference internal" href="#section8-1-1-2-operation-create-ami-label"><span class="std std-ref">EBSスナップショットからAMIの作成手順</span></a> 」にて、EBSのスナップショットからAMIイメージを作成したが、
稼働中のEC2インスタンスからAMIイメージを作成できる。AMIからEC2インスタンスを作るときは、
CPUやメモリ構成も設定でき、スペックを任意に調整できる。</p>
</div>
<div class="section" id="ec2ami">
<span id="section8-1-2-2-operation-create-ami-label"></span><h4>実行中EC2インスタンスからAMIの作成手順<a class="headerlink" href="#ec2ami" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>AMIイメージの作成</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">当オペレーションを実行すると、完全なディスクの複製を作成するために、実行中のEC2インスタンスが再起動するので注意。再起動したくない場合は、再起動しないオプションにチェックを入れて実行すること。</p>
</div>
<p>メニュー「インスタンス」から、右クリック「イメージの作成」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-stamp-4.png" src="../../../_images/management-console-operation-stamp-4.png" />
</div>
<p>「 <a class="reference internal" href="#section8-1-1-2-operation-create-ami-label"><span class="std std-ref">EBSスナップショットからAMIの作成手順</span></a> 」と同様、AMIの名称、説明、仮想マシンの種別を入力する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-stamp-5.png" src="../../../_images/management-console-operation-stamp-5.png" />
</div>
<p>実行すると、AMIにイメージがステータスavailabilityで作成される。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-stamp-6.png" src="../../../_images/management-console-operation-stamp-6.png" />
</div>
</div>
<div class="section" id="amiec2">
<span id="section8-1-2-3-operation-launch-ec2-by-ami-label"></span><h4>複製したAMIからEC2インスタンスを実行する手順<a class="headerlink" href="#amiec2" title="Permalink to this headline">¶</a></h4>
<p>作成したAMIを使用して、EC2インスタンスを起動する。</p>
<ol class="arabic simple">
<li>EC2インスタンスの実行</li>
</ol>
<p>メニュー「AMI」でイメージを選択し、右クリック「作成」を行う。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-stamp-7.png" src="../../../_images/management-console-operation-stamp-7.png" />
</div>
<p>「 <a class="reference internal" href="computing.html#section3-1-2-x-ec2-create-instance-label"><span class="std std-ref">インスタンスの作成</span></a> 」と同様に、EC2インスタンスを起動する。</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">AMIイメージの作成方法により実行可能なインスタンスタイプが制限される模様。条件を確認する。</p>
</div>
</div>
</div>
<div class="section" id="cpu">
<span id="section8-1-3-scale-up-label"></span><h3>CPUやメモリスペックを上昇させる<a class="headerlink" href="#cpu" title="Permalink to this headline">¶</a></h3>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">EC2インスタンス起動中にCPUやメモリスペックを変更する手順を記載する。</p>
</div>
</div>
<div class="section" id="section8-1-4-ondemand-disk-label">
<span id="id3"></span><h3>ディスク容量を増設する<a class="headerlink" href="#section8-1-4-ondemand-disk-label" title="Permalink to this headline">¶</a></h3>
<div class="section" id="section8-1-4-1-application-extend-volume-overview-label">
<span id="id4"></span><h4>overview<a class="headerlink" href="#section8-1-4-1-application-extend-volume-overview-label" title="Permalink to this headline">¶</a></h4>
<p>起動中のEC2インスタンスの容量が足りなくなった場合、以下のようなメッセージが表示される。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>open /var/lib/docker/image/devicemapper/layerdb/tmp/layer-314207183/diff: no space left on device
</pre></div>
</div>
<p>dfコマンドでディスク残容量の確認は以下の通り可能であるが、ここでは、起動中のインスタンスのディスク増設する方法を記述する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/xvda1      <span class="m">8</span>.0G  <span class="m">8</span>.0G   52M <span class="m">100</span>% /
devtmpfs        <span class="m">7</span>.4G     <span class="m">0</span>  <span class="m">7</span>.4G   <span class="m">0</span>% /dev
tmpfs           <span class="m">7</span>.4G     <span class="m">0</span>  <span class="m">7</span>.4G   <span class="m">0</span>% /dev/shm
tmpfs           <span class="m">7</span>.4G   17M  <span class="m">7</span>.4G   <span class="m">1</span>% /run
tmpfs           <span class="m">7</span>.4G     <span class="m">0</span>  <span class="m">7</span>.4G   <span class="m">0</span>% /sys/fs/cgroup
tmpfs           <span class="m">1</span>.5G     <span class="m">0</span>  <span class="m">1</span>.5G   <span class="m">0</span>% /run/user/1000
</pre></div>
</div>
</div>
<div class="section" id="section8-1-4-2-application-extend-volume-label">
<span id="id5"></span><h4>EC2ボリュームサイズの拡張<a class="headerlink" href="#section8-1-4-2-application-extend-volume-label" title="Permalink to this headline">¶</a></h4>
<p>■EC2コンソールメニューからボリュームを選び、拡張したいインスタンスのボリュームを選択する。アクションメニューから、「ボリュームの変更」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ec2-modify-volume-1.png" src="../../../_images/management-console-ec2-modify-volume-1.png" />
</div>
<p>■ボリュームサイズを変更し、「変更」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ec2-modify-volume-2.png" src="../../../_images/management-console-ec2-modify-volume-2.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-ec2-modify-volume-3.png" src="../../../_images/management-console-ec2-modify-volume-3.png" />
</div>
<p>■EC2インスタンスにSSHでログインし、拡張したボリュームサイズにルートデバイスのパーティションを拡張させる。最初に、現状のディスクの状況を確認する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ルートデバイスのパーティションサイズを確認。</span>
<span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ lsblk
NAME                         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvda                         <span class="m">202</span>:0    <span class="m">0</span>   50G  <span class="m">0</span> disk
└─xvda1                      <span class="m">202</span>:1    <span class="m">0</span>    8G  <span class="m">0</span> part /
loop0                          <span class="m">7</span>:0    <span class="m">0</span>  100G  <span class="m">0</span> loop
└─docker-202:1-12881694-pool <span class="m">253</span>:0    <span class="m">0</span>  100G  <span class="m">0</span> dm
loop1                          <span class="m">7</span>:1    <span class="m">0</span>    2G  <span class="m">0</span> loop
└─docker-202:1-12881694-pool <span class="m">253</span>:0    <span class="m">0</span>  100G  <span class="m">0</span> dm

<span class="c1"># パーティションの占有状況を確認。</span>

<span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ df -TH
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/xvda1     xfs       <span class="m">8</span>.6G  <span class="m">8</span>.6G   58M <span class="m">100</span>% /
devtmpfs       devtmpfs  <span class="m">8</span>.0G     <span class="m">0</span>  <span class="m">8</span>.0G   <span class="m">0</span>% /dev
tmpfs          tmpfs     <span class="m">8</span>.0G     <span class="m">0</span>  <span class="m">8</span>.0G   <span class="m">0</span>% /dev/shm
tmpfs          tmpfs     <span class="m">8</span>.0G   18M  <span class="m">8</span>.0G   <span class="m">1</span>% /run
tmpfs          tmpfs     <span class="m">8</span>.0G     <span class="m">0</span>  <span class="m">8</span>.0G   <span class="m">0</span>% /sys/fs/cgroup
tmpfs          tmpfs     <span class="m">1</span>.6G     <span class="m">0</span>  <span class="m">1</span>.6G   <span class="m">0</span>% /run/user/1000

<span class="c1"># ファイルシステムの確認。</span>

<span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ sudo file -s /dev/xvd*
/dev/xvda:  x86 boot sector<span class="p">;</span> partition <span class="m">1</span>: <span class="nv">ID</span><span class="o">=</span>0x83, active, starthead <span class="m">32</span>, startsector <span class="m">2048</span>, <span class="m">16775168</span> sectors, code offset 0x63
/dev/xvda1: SGI XFS filesystem data <span class="o">(</span>blksz <span class="m">4096</span>, inosz <span class="m">512</span>, v2 <span class="nb">dirs</span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference external" href="https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html">AWSの公式ガイド</a> では、XFSファイルシステムのディスク拡張はxfs_growfsコマンドを使用しているが、更新が行われなかったため、fdiskコマンドを使ってパーティションの再作成を行う方法で実施する。</p>
</div>
<p>■ fdiskコマンドを使用して、/dev/xvdaのパーティションを作成し直し、再起動する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ sudo fdisk /dev/xvda
Welcome to fdisk <span class="o">(</span>util-linux <span class="m">2</span>.23.2<span class="o">)</span>.

Changes will remain in memory only, <span class="k">until</span> you decide to write them.
Be careful before using the write command.


Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: p

Disk /dev/xvda: <span class="m">53</span>.7 GB, <span class="m">53687091200</span> bytes, <span class="m">104857600</span> sectors
<span class="nv">Units</span> <span class="o">=</span> sectors of <span class="m">1</span> * <span class="nv">512</span> <span class="o">=</span> <span class="m">512</span> bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
Disk label type: dos
Disk identifier: 0x000ae09f

Device Boot      Start         End      Blocks   Id  System
/dev/xvda1   *        <span class="m">2048</span>    <span class="m">16777215</span>     <span class="m">8387584</span>   <span class="m">83</span>  Linux

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: d
Selected partition <span class="m">1</span>
Partition <span class="m">1</span> is deleted

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: n
Partition type:
p   primary <span class="o">(</span><span class="m">0</span> primary, <span class="m">0</span> extended, <span class="m">4</span> free<span class="o">)</span>
e   extended
Select <span class="o">(</span>default p<span class="o">)</span>: p
Partition number <span class="o">(</span><span class="m">1</span>-4, default <span class="m">1</span><span class="o">)</span>: <span class="m">1</span>
First sector <span class="o">(</span><span class="m">2048</span>-104857599, default <span class="m">2048</span><span class="o">)</span>:
Using default value <span class="m">2048</span>
Last sector, +sectors or +size<span class="o">{</span>K,M,G<span class="o">}</span> <span class="o">(</span><span class="m">2048</span>-104857599, default <span class="m">104857599</span><span class="o">)</span>:
Using default value <span class="m">104857599</span>
Partition <span class="m">1</span> of <span class="nb">type</span> Linux and of size <span class="m">50</span> GiB is <span class="nb">set</span>

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: p

Disk /dev/xvda: <span class="m">53</span>.7 GB, <span class="m">53687091200</span> bytes, <span class="m">104857600</span> sectors
<span class="nv">Units</span> <span class="o">=</span> sectors of <span class="m">1</span> * <span class="nv">512</span> <span class="o">=</span> <span class="m">512</span> bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
Disk label type: dos
Disk identifier: 0x000ae09f

Device Boot      Start         End      Blocks   Id  System
/dev/xvda1            <span class="m">2048</span>   <span class="m">104857599</span>    <span class="m">52427776</span>   <span class="m">83</span>  Linux

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: w
The partition table has been altered!

Calling ioctl<span class="o">()</span> to re-read partition table.

WARNING: Re-reading the partition table failed with error <span class="m">16</span>: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe<span class="o">(</span><span class="m">8</span><span class="o">)</span> or kpartx<span class="o">(</span><span class="m">8</span><span class="o">)</span>
Syncing disks.

<span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ reboot

<span class="c1"># 再起動後、パーティションのサイズ変更を確認。</span>
<span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ df -TH
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/xvda1     xfs        54G  <span class="m">8</span>.6G   46G  <span class="m">16</span>% /
devtmpfs       devtmpfs  <span class="m">8</span>.0G     <span class="m">0</span>  <span class="m">8</span>.0G   <span class="m">0</span>% /dev
tmpfs          tmpfs     <span class="m">8</span>.0G     <span class="m">0</span>  <span class="m">8</span>.0G   <span class="m">0</span>% /dev/shm
tmpfs          tmpfs     <span class="m">8</span>.0G   18M  <span class="m">8</span>.0G   <span class="m">1</span>% /run
tmpfs          tmpfs     <span class="m">8</span>.0G     <span class="m">0</span>  <span class="m">8</span>.0G   <span class="m">0</span>% /sys/fs/cgroup
tmpfs          tmpfs     <span class="m">1</span>.6G     <span class="m">0</span>  <span class="m">1</span>.6G   <span class="m">0</span>% /run/user/1000

<span class="o">[</span>centos@ip-XXX-XXX-XXX-XXX ~<span class="o">]</span>$ lsblk
NAME                         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvda                         <span class="m">202</span>:0    <span class="m">0</span>   50G  <span class="m">0</span> disk
└─xvda1                      <span class="m">202</span>:1    <span class="m">0</span>   50G  <span class="m">0</span> part /
loop0                          <span class="m">7</span>:0    <span class="m">0</span>  100G  <span class="m">0</span> loop
└─docker-202:1-12881694-pool <span class="m">253</span>:0    <span class="m">0</span>  100G  <span class="m">0</span> dm
loop1                          <span class="m">7</span>:1    <span class="m">0</span>    2G  <span class="m">0</span> loop
└─docker-202:1-12881694-pool <span class="m">253</span>:0    <span class="m">0</span>  100G  <span class="m">0</span> dm
</pre></div>
</div>
</div>
</div>
<div class="section" id="section8-1-5-application-update-label">
<span id="id6"></span><h3>冗長化構成のアプリケーションをアップデートする<a class="headerlink" href="#section8-1-5-application-update-label" title="Permalink to this headline">¶</a></h3>
<div class="section" id="section8-1-5-1-application-update-overview-label">
<span id="id7"></span><h4>overview<a class="headerlink" href="#section8-1-5-1-application-update-overview-label" title="Permalink to this headline">¶</a></h4>
<p>ロードバランサーを使用して冗長化構成したアプリケーションをサービス停止せずにアップデートする。
片系のアプリケーションサーバをターゲットグループから除外した後、アプリケーションをアップデートし、
再度ターゲットグループに組み込む。その後もう片系のアプリケーションサーバを同様にターゲットグループから削除し、
アップデートを行い、組み戻しを行う。</p>
</div>
<div class="section" id="drain">
<span id="section8-1-5-2-exclude-target-group-label"></span><h4>インスタンスのDrain<a class="headerlink" href="#drain" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>APサーバのインスタンスをターゲットグループから除外</li>
</ol>
<p>コンソールのメニュー「ターゲットグループ」にて、ターゲットタブから編集ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-operation-app-update-1.png" src="../../../_images/management-console-operation-app-update-1.png" />
</div>
<ol class="arabic simple" start="2">
<li>アップデート対象のアプリケーションインスタンスを選択し、削除ボタンを押下する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-operation-app-update-2.png" src="../../../_images/management-console-operation-app-update-2.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">削除したインスタンスはロードバランサーがターゲットのリクエストルーティングを即時指定するが、deregistration_delay.timeout_secondsとして設定した時間、Connection Dranining状態として、セッションが維持される。</p>
</div>
</div>
</div>
</div>
<div class="section" id="codebuild">
<span id="section8-2-codebuild-label"></span><h2>CodeBuild<a class="headerlink" href="#codebuild" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section8-2-1-codebuild-overview-label">
<span id="id8"></span><h3>Overview<a class="headerlink" href="#section8-2-1-codebuild-overview-label" title="Permalink to this headline">¶</a></h3>
<p>AWS CodeBuildはクラウドでアプリケーションのビルドを行う従量課金型サービスで、buildspec.ymlに記述した内容に従ってビルド実行する。
ビルドの元になるソースコードはS3に保存したものに加え、AWS CodeCommit、GitHub、BitBucketなどの各Gitベースのバージョン管理システムをサポートする。
Jenkins Agentでも同様の処理を行えるものの、クラウドでマネージドな環境下で行われるため、大規模開発でのコミットやプルリクエスト後のテスト、ビルド処理をマシンリソースを気にせず実行できることがメリットである。</p>
</div>
<div class="section" id="section8-2-2-codebuild-app-build-label">
<span id="id9"></span><h3>アプリケーションのビルド<a class="headerlink" href="#section8-2-2-codebuild-app-build-label" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>サービスメニューから「CodeBuild」を選択し、「今すぐ始める」ボタンを押下する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-1.png" src="../../../_images/management-console-codebuild-app-build-1.png" />
</div>
<ol class="arabic simple" start="2">
<li>ビルドプロジェクトの設定を行う。ここでは、<a class="reference external" href="https://github.com/debugroom/sample-aws-codebuild">GitHub上にコミットしたSpringBootベースのアプリケーション</a> をビルドするため、以下の通り設定する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-2.png" src="../../../_images/management-console-codebuild-app-build-2.png" />
</div>
<p>[プロジェクトの設定]</p>
<ul class="simple">
<li>プロジェクト名：任意のプロジェクト名を設定(ここではsample-codebuild-build-app)</li>
</ul>
<p>[ソース：ビルドの対象]</p>
<ul class="simple">
<li>ソースプロバイダ：Github(ログインするOAuth認証があるため、適宜ログイン)</li>
<li>レポジトリ：パブリックレポジトリ</li>
<li>レポジトリのURL：<a class="reference external" href="https:github.com">https:github.com</a>/&lt;user-name&gt;/&lt;repository-name&gt;で指定</li>
<li>Gitのクローンの深さ：1(コミットされた最新履歴からのバージョン)</li>
<li>WebHook：コードがコミットされるたび、ビルド指定したければチェック</li>
<li>バッジ：ビルドバッジを有効化する場合チェック</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ソースコードレポジトリに応じて、<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/create-project.html#create-project-console">リファレンスのソースプロバイダの表でXがついている箇所の設定</a> を参照すること</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ビルドバッジはビルドステータスを個別定義・明示化するオプションである。詳しくは <a class="reference external" href="https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/sample-build-badges.html">リファレンス</a> を参照のこと。</p>
</div>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-3.png" src="../../../_images/management-console-codebuild-app-build-3.png" />
</div>
<p>[環境：ビルド方法]</p>
<ul class="simple">
<li>環境イメージ：AWS CodeBuildによって管理されたイメージの使用</li>
<li>オペレーティングシステム：Ubuntu</li>
<li>ランタイム：Java</li>
<li>ランタイムバージョン：aws/codebuild/java:openjdk-8</li>
<li>ビルド仕様：ソースコードのルートディレクトリのbuildspec.xmlを使用</li>
<li>buildspec名：buildspec.xml</li>
<li>証明書：証明書をインストールしない</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>buildspecはコミットしたアプリケーションのルートディレクトリに配置しておく。内容を以下の通り記述する。</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span>version: 0.2

phases:
  build:
    commands:
      - echo Build started on `date`
      - mvn test
  post_build:
    commands:
      - echo Build completed on `date`
      - mvn package
artifacts:
  files:
    - target/sample-aws-codebuild-0.0.1-SNAPSHOT.jar
</pre></div>
</div>
</div>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-4.png" src="../../../_images/management-console-codebuild-app-build-4.png" />
</div>
<p>[アーティファクト：このビルドプロジェクトからアーティファクトを配置する場所]</p>
<ul class="simple">
<li>タイプ：アーティファクトなし</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ビルドテストのみを実行する場合や、コンテナへプッシュする場合は指定しなくて良い。</p>
</div>
<p>[キャッシュ]</p>
<ul class="simple">
<li>タイプ：キャッシュなし</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">キャッシュを使用すると、S3に再利用可能なビルド環境が保存され高速化される。</p>
</div>
<p>[サービスロール]</p>
<ul class="simple">
<li>アカウントでサービスロールを作成</li>
</ul>
<p>[VPC]</p>
<ul class="simple">
<li>NoVPC</li>
</ul>
<ol class="arabic simple" start="3">
<li>設定内容を確認し、「保存してビルド」ボタンを押下する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-5.png" src="../../../_images/management-console-codebuild-app-build-5.png" />
</div>
<ol class="arabic simple" start="4">
<li>ビルドの開始ボタンを押下する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-6.png" src="../../../_images/management-console-codebuild-app-build-6.png" />
</div>
<ol class="arabic simple" start="5">
<li>ビルド結果を確認する。</li>
</ol>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-7.png" src="../../../_images/management-console-codebuild-app-build-7.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-codebuild-app-build-8.png" src="../../../_images/management-console-codebuild-app-build-8.png" />
</div>
<p><br /></p>
</div>
<div class="section" id="codebuild-local">
<span id="section8-2-2-codebuild-local-label"></span><h3>CodeBuild Localの利用<a class="headerlink" href="#codebuild-local" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://aws.amazon.com/jp/blogs/devops/announcing-local-build-support-for-aws-codebuild/">2018年5月に、CodeBuildをローカル環境で動かすDockerイメージが公開された</a> 。このサポートにより、Dockerがインストールされたマシンでbuildspec.ymlのデバッグやテストが可能である。</p>
<div class="section" id="section8-2-2-1-codebuild-local-prepared-label">
<span id="id11"></span><h4>事前準備<a class="headerlink" href="#section8-2-2-1-codebuild-local-prepared-label" title="Permalink to this headline">¶</a></h4>
<p>CodeBuild Localを利用するには、事前に以下を実施しておく必要がある。</p>
<ol class="arabic simple">
<li>実際にビルド実行環境コンテナイメージ(DefaultではUbuntu)を作成</li>
<li>環境コンテナを起動するためのエージェントコンテナイメージをプル</li>
</ol>
<p>なお、CodeBuild Localを実行する際は2のコンテナイメージをDocker runするかたちになるが、実行スクリプトが提供されているため、このスクリプトに1のコンテナイメージ名やアーティファクトの出力先フォルダ、認証情報など情報を渡して実行することになる。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">2のコンテナイメージを作成するためのDockerfileはAWSから公開されていない模様。</p>
</div>
<p>1の手順としては、<a class="reference external" href="https://github.com/aws/aws-codebuild-docker-images">公式サイト</a> の手順に習い、ターミナルなどを使って、適当なディレクトリで、ビルド実行環境のコンテナイメージがあるaws-codebuild-docker-imagesのレポジトリをGit cloneする。
ビルド用のコンテナ(starndard:2.0)イメージを構築するDockerfileがあるディレクトリへ移動し、docker buildコマンドを実行する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/aws/aws-codebuild-docker-images.git
$ <span class="nb">cd</span> aws-codebuild-docker-images
$ <span class="nb">cd</span> ubuntu/standard/2.0
$ docker build -t aws/codebuild/standard:2.0 .
</pre></div>
</div>
<p>続いて、2.環境コンテナを起動するためのエージェントコンテナイメージをプルする。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker pull amazon/aws-codebuild-local:latest --disable-content-trust<span class="o">=</span><span class="nb">false</span>
</pre></div>
</div>
</div>
<div class="section" id="section8-2-2-1-codebuild-local-execution-label">
<span id="id13"></span><h4>CodeBuild Localの実行<a class="headerlink" href="#section8-2-2-1-codebuild-local-execution-label" title="Permalink to this headline">¶</a></h4>
<p>Git cloneしたaws-codebuild-docker-imagesの中にlocal_builds/codebuild_build.shがあるので、buildspec.ymlがあるディレクトリへコピーする。
今回、buildspec.ymlとしては、マルチプロジェクト構成のMavenプロジェクトで、プロジェクトルート配下のcommonプロジェクトに対し、mvn packageコマンドを実行し、Sonarqubeへscan結果を送信するものを用いる。
なお、buildspec.ymlから環境変数として、SonarqubeServerのURL(SONAR_HOST_URL)とトークン(SONAR_LOGIN_COMMON)をAWS Systems Managerから取得する。なお、パラメータストアの設定は <a class="reference internal" href="management.html#section9-9-6-2-systems-manager-parameter-store-create-parameter-label"><span class="std std-ref">標準パラメータストアの設定</span></a> を参照のこと。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">AWS Systems Managerパラメータストアを利用して環境変数を取得する場合、認証情報のユーザに権限を付与しておくこと。</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>version: <span class="m">0</span>.2
env:
  parameter-store:
    SONAR_HOST_URL: <span class="s2">&quot;SONAR_HOST_URL&quot;</span>
    SONAR_LOGIN: <span class="s2">&quot;SONAR_LOGIN_COMMON&quot;</span>
phases:
  install:
    runtime-versions:
      docker: <span class="m">18</span>
  build:
    commands:
      - mvn -f common/pom.xml package sonar:sonar -Dsonar.host.url<span class="o">=</span><span class="si">${</span><span class="nv">SONAR_HOST_URL</span><span class="si">}</span> -Dsonar.login<span class="o">=</span><span class="si">${</span><span class="nv">SONAR_LOGIN</span><span class="si">}</span>
artifacts:
  files:
    - common/target/mynavi-sample-continuous-integration-common-0.0.1-SNAPSHOT.jar
</pre></div>
</div>
<p>buildspec.ymlおよびcodebuild_build.shはcommonプロジェクト配下にあるが、CodeBuildによってGitHubからクローンされるビルド対象のアプリケーションソースコードのルートディレクトリ(ビルドコマンドを実行するディレクトリ)を起点として、コピーしたcodebuild_build.shにオプションパラメータを与えて実行する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ common/codebuild_build.sh -i aws/codebuild/standard:2.0 -a common/target/ -c -b common/buildspec.yml
</pre></div>
</div>
<p>なお、上記で実行したスクリプトの各オプションの説明は以下の通り。</p>
<table border="1" class="colwidths-given docutils" id="id26">
<caption><span class="caption-text">codebuild_build.shのオプション</span><a class="headerlink" href="#id26" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>オプション</td>
<td>説明</td>
</tr>
<tr class="row-even"><td>iオプション(必須)</td>
<td>事前準備で作成したCodeBuildでビルドするコンテナイメージを指定する。</td>
</tr>
<tr class="row-odd"><td>aオプション(必須)</td>
<td>アーティファクトを出力するディレクトリを指定する。</td>
</tr>
<tr class="row-even"><td>cオプション</td>
<td>AWS認証情報を指定する(デフォルトでは~/.aws/credentialsの認証情報が使用される)</td>
</tr>
<tr class="row-odd"><td>bオプション</td>
<td>buildspec.ymlを指定する。</td>
</tr>
</tbody>
</table>
<p>スクリプトを実行すると、以下の通り、CodeBuildがローカルのDocker環境で実行されるようになる。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Build Command:

docker run -it -v /var/run/docker.sock:/var/run/docker.sock -e <span class="s2">&quot;IMAGE_NAME=aws/codebuild/standard:2.0&quot;</span> -e <span class="s2">&quot;ARTIFACTS=/Users/kawabatakouhei/Documents/repos/git/debugroom/mynavi-sample-continuous-integration/common/target/&quot;</span> -e <span class="s2">&quot;SOURCE=/Users/kawabatakouhei/Documents/repos/git/debugroom/mynavi-sample-continuous-integration&quot;</span> -e <span class="s2">&quot;BUILDSPEC=/Users/kawabatakouhei/Documents/repos/git/debugroom/mynavi-sample-continuous-integration/common/buildspec.yml&quot;</span> -e <span class="s2">&quot;AWS_CONFIGURATION=/Users/kawabatakouhei/.aws&quot;</span> -e <span class="s2">&quot;INITIATOR=kawabatakouhei&quot;</span> amazon/aws-codebuild-local:latest

Removing agent-resources_build_1 ... <span class="k">done</span>
Removing agent-resources_agent_1 ... <span class="k">done</span>
Removing network agent-resources_default
Removing volume agent-resources_source_volume
Removing volume agent-resources_user_volume
Creating network <span class="s2">&quot;agent-resources_default&quot;</span> with the default driver
Creating volume <span class="s2">&quot;agent-resources_source_volume&quot;</span> with <span class="nb">local</span> driver
Creating volume <span class="s2">&quot;agent-resources_user_volume&quot;</span> with <span class="nb">local</span> driver
Creating agent-resources_agent_1 ... <span class="k">done</span>
Creating agent-resources_build_1 ... <span class="k">done</span>
Attaching to agent-resources_agent_1, agent-resources_build_1
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:25:01 Waiting <span class="k">for</span> agent ping

// omit

agent_1  <span class="p">|</span> <span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
agent_1  <span class="p">|</span> <span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
agent_1  <span class="p">|</span> <span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
agent_1  <span class="p">|</span> <span class="o">[</span>INFO<span class="o">]</span> Total time:  <span class="m">03</span>:09 min
agent_1  <span class="p">|</span> <span class="o">[</span>INFO<span class="o">]</span> Finished at: <span class="m">2019</span>-06-27T19:29:04Z
agent_1  <span class="p">|</span> <span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
agent_1  <span class="p">|</span>
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Phase complete: BUILD State: SUCCEEDED
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Phase context status code:  Message:
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Entering phase POST_BUILD
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Phase complete: POST_BUILD State: SUCCEEDED
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Phase context status code:  Message:
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Expanding base directory path: .
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Assembling file list
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Expanding .
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Expanding artifact file paths <span class="k">for</span> base directory .
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Assembling file list
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Expanding common/target/mynavi-sample-continuous-integration-common-0.0.1-SNAPSHOT.jar
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Found <span class="m">1</span> file<span class="o">(</span>s<span class="o">)</span>
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Preparing to copy secondary artifacts
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 No secondary artifacts defined in buildspec
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Phase complete: UPLOAD_ARTIFACTS State: SUCCEEDED
agent_1  <span class="p">|</span> <span class="o">[</span>Container<span class="o">]</span> <span class="m">2019</span>/06/27 <span class="m">19</span>:29:04 Phase context status code:  Message:
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="codepipeline">
<span id="section8-3-codepipeline-label"></span><h2>CodePipeline<a class="headerlink" href="#codepipeline" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section8-3-1-codepipeline-overview-label">
<span id="id14"></span><h3>Overview<a class="headerlink" href="#section8-3-1-codepipeline-overview-label" title="Permalink to this headline">¶</a></h3>
<p>CodePipelineはアプリケーションのソースコードコミット→テスト→ビルド→ステージングデプロイ→プロダクションデプロイといった一連のソフトウェアリリースプロセスを自動化し、継続的インテグレーション・デリバリを実現するツールである。
CodeCommitやS3、CodeBuild、CodeDeployといったAWSリソースはもちろんのこと、GitHubやJenkins、DockerHubとも連携し、アプリケーションの構築にかかる一連の流れを自動化できる。</p>
</div>
<div class="section" id="ecs">
<span id="section8-3-2-codepipeline-staging-release-label"></span><h3>ECSアプリケーションのステージングリリースの自動化<a class="headerlink" href="#ecs" title="Permalink to this headline">¶</a></h3>
<p>ここでは、CodePipeLineを使って、SpringBootベースのアプリケーションをGitHub上にソースコードコミットし、Dockerコンテナを用いてテスト・ビルドを行い、構築したアプリケーションコンテナを、DockerHub上にプッシュした後、EC2起動型のECSステージング環境へのデプロイする作業を自動化する設定例を記述する。
なお、Dockerコンテナを使用したテスト・ビルドについては前章「 <a class="reference internal" href="#section8-2-codebuild-label"><span class="std std-ref">CodeBuild</span></a> 」で実行した通り、AWS CodeBuildを利用する。</p>
<div class="section" id="section8-3-2-1-codepipeline-staging-release-prepared-label">
<span id="id15"></span><h4>事前準備<a class="headerlink" href="#section8-3-2-1-codepipeline-staging-release-prepared-label" title="Permalink to this headline">¶</a></h4>
<p>CodePipeLineでステージング環境へのリリースを自動化する設定を行う前に、以下を準備しておく。</p>
<ol class="arabic simple">
<li>リリースするSpringBootアプリケーション及びCodeBuild設定</li>
<li>ステージング環境とするEC2起動型のECSコンテナ環境の構築</li>
<li>ロードバランサーの設定</li>
</ol>
<p>上記のポイントについて順次記載する。</p>
<ol class="arabic simple">
<li>リリースするSpringBootアプリケーション及びCodeBuildの設定</li>
</ol>
<p>最終的なソースコードは <a class="reference external" href="https://github.com/debugroom/sample-aws-codepipeline">GitHub</a> 上にコミットしているが、
ルートディレクトリの配下にCodeBuildで使用するbuildspec.ymlと、buildspec.yml内でDockerコマンドで実行されるビルド用のDockerfileを作成しておく。
なお、各環境変数のパラメータはCodePipelineの設定時に指定する。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>version: 0.2

phases:
  pre_build:
    commands:
#      - echo Logging in to Amazon ECR...
#      - $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
      - echo Logging in to Docker Hub...
      - docker login -u $USER -p $PASSWORD $DOCKER_REPO
  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG .
#    - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $IMAGE_REPO_NAME:$IMAGE_TAG
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker image...
#      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
      - docker push $IMAGE_REPO_NAME:$IMAGE_TAG
      - printf &#39;[{&quot;name&quot;:&quot;sample-aws-codepipeline&quot;,&quot;imageUri&quot;:&quot;%s&quot;}]&#39; $IMAGE_REPO_NAME:$IMAGE_TAG &gt; imagedefinitions.json
artifacts:
  files:
    - imagedefinitions.json
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">buildspec.yml内では、コンテナをDockerHubへプッシュした後に、ECSコンテナの構築でコンテナイメージをPullするために必要な「imagedefinitions.json」を出力している。
タスク定義で指定するコンテナ名とURLをJSON形式で表現したファイルである。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">「imagedefinitions.json」で”name”指定する値は、ECSタスク定義名ではなく、タスク定義で定義したコンテナ名を設定する必要がある。</p>
</div>
<p>Dockerfileは最終的にECSコンテナのイメージとなる。CentOS7をベースとして、JDKとMavenをインストールし、対象のソースコードをクローンしてビルドした後、タイムゾーンとロケールを変更してアプリケーションを実行する。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Dockerfile for sample service using embedded tomcat server

FROM centos:centos7
MAINTAINER debugroom

RUN yum install -y \
    java-1.8.0-openjdk \
    java-1.8.0-openjdk-devel \
    wget tar iproute git

RUN wget http://repos.fedorapeople.org/repos/dchen/apache-maven/epel-apache-maven.repo -O /etc/yum.repos.d/epel-apache-maven.repo
RUN sed -i s/\$releasever/6/g /etc/yum.repos.d/epel-apache-maven.repo
RUN yum install -y apache-maven
ENV JAVA_HOME /etc/alternatives/jre
RUN git clone https://github.com/debugroom/sample-aws-codepipeline.git /var/local/sample-aws-codepipeline
RUN mvn install -f /var/local/sample-aws-codepipeline/pom.xml

RUN rm -f /etc/rpm/macros.image-language-conf &amp;&amp; \
    sed -i &#39;/^override_install_langs=/d&#39; /etc/yum.conf &amp;&amp; \
    yum -y reinstall glibc-common &amp;&amp; \
    yum clean all

ENV LANG=&quot;ja_JP.UTF-8&quot; \
    LANGUAGE=&quot;ja_JP:ja&quot; \
    LC_ALL=&quot;ja_JP.UTF-8&quot;

RUN cp /etc/localtime /etc/localtime.org
RUN ln -sf  /usr/share/zoneinfo/Asia/Tokyo /etc/localtime

EXPOSE 8080

CMD java -jar -Dspring.profiles.active=production /var/local/sample-aws-codepipeline/target/sample-aws-codepipeline-0.0.1-SNAPSHOT.jar
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">説明は割愛するが、アプリケーションは、<a class="reference external" href="http:/">http:/</a>/&lt;loadbalancerのURL&gt;/aws-code-pipeline/api/v1/usersでユーザの一覧を返すAPIを持つアプリケーションで、テストコードを含めコミットしている。</p>
</div>
<ol class="arabic simple" start="2">
<li>ステージング環境とするEC2起動型のECSコンテナ環境の構築</li>
</ol>
<p>「 <a class="reference internal" href="computing.html#section3-2-ecs-label"><span class="std std-ref">Elastic Container Service</span></a> 」で構築したECSクラスタ、ロードバランサを利用する。ECSタスク定義・サービス定義は、アプリケーションを一度CodePipelineでビルド設定した後に行うため、ECSクラスタ・ロードバランサはそのまま利用し、アプリケーションの振り分け先であるターゲットグループのみ新規作成しておく。</p>
<p>EC2のサービスメニュー &gt; ターゲットグループを選択し、「ターゲットグループの作成」を押下して、以下のように入力してターゲットグループを作成する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ec2-create-target-group-for-codepipeline-1.png" src="../../../_images/management-console-ec2-create-target-group-for-codepipeline-1.png" />
</div>
<ul class="simple">
<li>ターゲットグループ名：任意</li>
<li>プロトコル：HTTP</li>
<li>ポート：80</li>
<li>VPC：任意(あらかじめ作ったもの)</li>
</ul>
<p>[ヘルスチェックの設定]</p>
<ul class="simple">
<li>プロトコル：HTTP</li>
<li>パス：<a class="reference external" href="http:/">http:/</a>/&lt;loadbalancerのURL&gt;/aws-code-pipeline/api/v1/users(アプリケーションの正常応答するURL)</li>
</ul>
<ol class="arabic simple" start="3">
<li>ロードバランサの設定</li>
</ol>
<p>作成したアプリケーションのURLのパスが来た場合に、上記で作成したターゲットグループへ振り分けられるよう設定を行う。</p>
<p>EC2サービスメニュー &gt; ロードバランサーを選択し、指定するロードバランサーを選んで、リスナータブで「ルールの表示/編集」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ec2-setting-loadbalancer-for-codepipeline-1.png" src="../../../_images/management-console-ec2-setting-loadbalancer-for-codepipeline-1.png" />
</div>
<p>プラスボタンを押下してルールを追加する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ec2-setting-loadbalancer-for-codepipeline-2.png" src="../../../_images/management-console-ec2-setting-loadbalancer-for-codepipeline-2.png" />
</div>
<p>作成したアプリケーションのパスルールに一致したら、上記で作成したターゲットグループに向くよう設定しておく。</p>
<div class="figure">
<img alt="../../../_images/management-console-ec2-setting-loadbalancer-for-codepipeline-3.png" src="../../../_images/management-console-ec2-setting-loadbalancer-for-codepipeline-3.png" />
</div>
</div>
<div class="section" id="section8-3-2-2-codepipeline-staging-release-setting-label">
<span id="id16"></span><h4>CodePipeLineの設定(ソース・ビルド)<a class="headerlink" href="#section8-3-2-2-codepipeline-staging-release-setting-label" title="Permalink to this headline">¶</a></h4>
<p>ステージング環境へのリリースまで設定するためには一度、ECSのタスク定義と、サービス設定をおこなっていく必要があるため、
まずCodePipeLineでGitHubからソースコードコミットし、Dockerコンテナでテスト・ビルド後、DockerHubへプッシュするところまでを設定し、起動する。</p>
<p>■サービス「CodePipeline」を選択し、「今すぐ始める」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-1.png" src="../../../_images/management-console-codepipeline-1.png" />
</div>
<p>■パイプライン名を任意に設定し、「次のステップへ」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-2.png" src="../../../_images/management-console-codepipeline-2.png" />
</div>
<p>■ソースプロバイダをGitHubに設定し、GitHubに接続した後、レポジトリ及びブランチを指定する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-3.png" src="../../../_images/management-console-codepipeline-3.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">上記のサンプルでは、masterブランチを指定しているが、実際の環境ではmasterブランチをproductionに、developブランチをstagingなどに設定することを推奨する。</p>
</div>
<p>■ビルドプロバイダに「AWS CodeBuild」を選択し、以下の通り、設定する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-4.png" src="../../../_images/management-console-codepipeline-4.png" />
</div>
<p>[プロジェクトの設定]</p>
<ul class="simple">
<li>新しいビルドプロジェクトを選択</li>
<li>プロジェクト名：任意のプロジェクト名を設定</li>
</ul>
<p>[環境の設定]</p>
<ul class="simple">
<li>環境イメージ：AWS CodeBuildマネージド型イメージの使用</li>
<li>OS：Ubuntu</li>
<li>ランタイム：DOCKER</li>
<li>バージョン：aws/codebuild/docker:YY.MM.X</li>
<li>ビルド仕様：ソースコードのルートディレクトリのbuildspec.ymlを使用</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ここで指定しているDocker環境はECSコンテナをビルドするための設定のため、Ubuntuを使用する設定で問題ない。</p>
</div>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-5.png" src="../../../_images/management-console-codepipeline-5.png" />
</div>
<p>[キャッシュ]</p>
<ul class="simple">
<li>タイプ：キャッシュ指定なし</li>
</ul>
<p>[コンテナサービスロール]</p>
<ul class="simple">
<li>アカウントで新しいロールを作成します。</li>
<li>ロール名：任意の名前を設定</li>
</ul>
<p>[VPC]</p>
<ul class="simple">
<li>VPC ID：非VPC</li>
</ul>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-6.png" src="../../../_images/management-console-codepipeline-6.png" />
</div>
<p>[アドバンスト]</p>
<ul class="simple">
<li>ビルドタイムアウト：1時間</li>
<li>コンピューティング：build.standard.small</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">コンテナのローリングアップデートに時間を要する場合があるので、ある程度タイムアウトの時間を確保しておく</p>
</div>
<p>[環境変数] 「 <a class="reference internal" href="#section8-3-2-1-codepipeline-staging-release-prepared-label"><span class="std std-ref">事前準備</span></a> 」で作成したDockerfileの実行に必要な環境変数を設定。</p>
<ul class="simple">
<li>USER：DockerHubにログインするユーザ名</li>
<li>PASSWORD：DockerHubにログインするユーザのパスワード</li>
<li>DOCKER_REPO：DockerHubのURL</li>
<li>IMAGE_REPO_NAME：Dockerイメージ名</li>
<li>IMAGE_TAG：イメージタグ(バージョン)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">DockerHubのURLは、省略しても良いがデフォルトは <a class="reference external" href="https://index.docker.io/v1/">https://index.docker.io/v1/</a> である。</p>
</div>
<p>■デプロイプロバイダには「デプロイなし」を指定し、「次のステップ」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-7.png" src="../../../_images/management-console-codepipeline-7.png" />
</div>
<p>■任意のロール名を入力し、「ロールの作成」ボタンを押下して、サービスロールを作成し、「次のステップ」を押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-8.png" src="../../../_images/management-console-codepipeline-8.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>適切な権限を持つロールを設定しないとエラーになるので注意</p>
<div class="last figure">
<img alt="../../../_images/management-console-codepipeline-9.png" src="../../../_images/management-console-codepipeline-9.png" />
</div>
</div>
<p>■設定内容を確認し、「パイプラインの作成」を押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-10.png" src="../../../_images/management-console-codepipeline-10.png" />
</div>
<p>■ソースコードがチェックアウトされ、コンテナのビルドが実行される。正常終了すると、DockerHubにコンテナイメージがプッシュされる。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-11.png" src="../../../_images/management-console-codepipeline-11.png" />
</div>
</div>
<div class="section" id="section8-3-2-3-codepipeline-staging-release-ecs-task-setting-label">
<span id="id17"></span><h4>ECSタスク定義<a class="headerlink" href="#section8-3-2-3-codepipeline-staging-release-ecs-task-setting-label" title="Permalink to this headline">¶</a></h4>
<p>プッシュしたコンテナイメージの設定情報からECSのタスク定義を行う。CodepipeLineが実行されるたび、ECSタスクのリビジョンがアップデートされる形となる。</p>
<p>■ECSサービスメニューから、タスク定義を選択し、「新しいタスク定義の作成」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-1.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-1.png" />
</div>
<p>■起動モードはEC2を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-2.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-2.png" />
</div>
<p>■タスクとコンテナの定義について以下の通り、設定を行う。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-3.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-3.png" />
</div>
<p>[タスクとコンテナの定義の設定]</p>
<ul class="simple">
<li>タスク定義名：任意</li>
<li>タスクロール：任意(ECSアプリケーションが必要な権限を設定)</li>
<li>ネットワークモード：デフォルト</li>
</ul>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-4.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-4.png" />
</div>
<p>[タスクの実行のIAMロール]</p>
<ul class="simple">
<li>タスク実行ロール： <a class="reference internal" href="computing.html#section3-2-3-ecs-create-task-label"><span class="std std-ref">EC2起動型-タスクの定義</span></a> で作成したECS Task用のIAM ロールを設定。</li>
</ul>
<p>[タスクサイズ]</p>
<ul class="simple">
<li>タスクメモリ：1024MiB</li>
<li>タスクCPU：256</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Spring Boot Applicationで構成する場合は1GB以上のメモリを割り当てておくこと。512MB程度で起動すると、アプリケーションの規模が多くなったときに、起動に時間がかかり、ヘルスチェックでエラー検出し、コンテナの無限ループ起動を誘発してしまうため。</p>
</div>
<p>■ コンテナ定義を以下の通り設定する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-5.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-5.png" />
</div>
<p>[スタンダード]</p>
<ul class="simple">
<li>コンテナ名：任意</li>
<li>イメージ：前章で作成したコンテナイメージのURL・タグ名を指定</li>
<li>メモリ制限：1024MiB</li>
<li>ポートマッピング<ul>
<li>ホストポート：0</li>
<li>コンテナポート：8080</li>
</ul>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">コンテナ名は <a class="reference internal" href="#section8-3-2-1-codepipeline-staging-release-prepared-label"><span class="std std-ref">事前準備</span></a> のbuildspec.ymlで指定した、imagedefinitions.jsonのname属性の値と同じにしておく必要がある。</p>
</div>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-6.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-6.png" />
</div>
<p>[詳細コンテナの設定]</p>
<ul class="simple">
<li>特にここでは設定しない</li>
</ul>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-7.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-7.png" />
</div>
<p>[ネットワークの設定]</p>
<ul class="simple">
<li>特にここでは設定しない</li>
</ul>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-8.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-8.png" />
</div>
<p>[ストレージとログ]</p>
<ul class="simple">
<li>特にここでは設定しない</li>
</ul>
<p>[セキュリティ]</p>
<ul class="simple">
<li>特にここでは設定しない</li>
</ul>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-9.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-9.png" />
</div>
<p>[リソースの制限]</p>
<ul class="simple">
<li>特にここでは設定しない</li>
</ul>
<p>[DOCKERラベル]</p>
<ul class="simple">
<li>特にここでは設定しない</li>
</ul>
<p>■制約等は特に設定せず、「作成」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-task-for-codepipeline-10.png" src="../../../_images/management-console-ecs-create-task-for-codepipeline-10.png" />
</div>
</div>
<div class="section" id="section8-3-2-4-codepipeline-staging-release-ecs-service-setting-label">
<span id="id18"></span><h4>ECSサービス設定<a class="headerlink" href="#section8-3-2-4-codepipeline-staging-release-ecs-service-setting-label" title="Permalink to this headline">¶</a></h4>
<p>前章  <a class="reference internal" href="#section8-3-2-3-codepipeline-staging-release-ecs-task-setting-label"><span class="std std-ref">ECSタスク定義</span></a> を元にECSサービスを設定し、ECSコンテナを起動させておく。CodePipeLineが実行されると最新のリビジョンにアップデートされたコンテナイメージがローリングアップデートされることになる。</p>
<p>■ECSサービスメニューから「クラスター」を選び、作成してあるECSクラスタ「sample-cluster」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-service-for-codepipeline-1.png" src="../../../_images/management-console-ecs-create-service-for-codepipeline-1.png" />
</div>
<p>■サービスタブから、「作成」ボタンを押下し、サービスを新規作成する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-service-for-codepipeline-2.png" src="../../../_images/management-console-ecs-create-service-for-codepipeline-2.png" />
</div>
<p>■以下の通り、サービスの新規設定を行う。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-service-for-codepipeline-3.png" src="../../../_images/management-console-ecs-create-service-for-codepipeline-3.png" />
</div>
<p>[サービスの設定]</p>
<ul class="simple">
<li>起動タイプ：EC2</li>
<li>タスク定義：前章「 <a class="reference internal" href="#section8-3-2-3-codepipeline-staging-release-ecs-task-setting-label"><span class="std std-ref">ECSタスク定義</span></a> 」で作成したタスクを指定</li>
<li>クラスター：選択したクラスタを指定</li>
<li>サービス名：任意</li>
<li>サービスタイプ：REPLICA</li>
<li>タスクの数：2</li>
<li>最小ヘルス率：50</li>
<li>最大率：200</li>
</ul>
<p>[タスクの配置]</p>
<ul class="simple">
<li>配置テンプレート：AZバランススプレッド</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">設定オプションについては、<a class="reference internal" href="computing.html#section3-2-5-ecs-create-service-label"><span class="std std-ref">EC2起動型-サービスの定義</span></a>　も参照のこと。</p>
</div>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-service-for-codepipeline-4.png" src="../../../_images/management-console-ecs-create-service-for-codepipeline-4.png" />
</div>
<p>[ヘルスチェックの猶予期間]</p>
<ul class="simple">
<li>ヘルスチェックの猶予期間：100</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SpringBootアプリケーションだと設定したメモリ・CPU、アプリの規模によっては時間がかかるため、適宜猶予期間を設定しておくこと。</p>
</div>
<p>[Elastic Load Balancing(オプション)]</p>
<ul class="simple">
<li>ELBタイプ：ApplicationLoadBalancer</li>
<li>サービス用のIAMロールの選択： <a class="reference internal" href="computing.html#section3-2-3-ecs-create-task-label"><span class="std std-ref">EC2起動型-タスクの定義</span></a> で作成したECS Task用のIAM ロールを設定。</li>
<li>ELB名： <a class="reference internal" href="computing.html#section3-2-4-ecs-create-alb-label"><span class="std std-ref">EC2起動型-ロードバランサ作成</span></a> で設定したALBを選択</li>
</ul>
<p>■ <a class="reference internal" href="#section8-3-2-1-codepipeline-staging-release-prepared-label"><span class="std std-ref">事前準備</span></a> で作成したロードバランサを指定し、「次のステップ」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-service-for-codepipeline-5.png" src="../../../_images/management-console-ecs-create-service-for-codepipeline-5.png" />
</div>
<p>■ AutoScalingオプションは、「サービスの必要数を直接調整しない」を設定し、「次のステップ」を押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-service-for-codepipeline-6.png" src="../../../_images/management-console-ecs-create-service-for-codepipeline-6.png" />
</div>
<p>■設定値を確認し、「サービスの作成」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-ecs-create-service-for-codepipeline-7.png" src="../../../_images/management-console-ecs-create-service-for-codepipeline-7.png" />
</div>
</div>
<div class="section" id="codepipeline-ecs">
<span id="section8-3-2-5-codepipeline-staging-release-setting-2-label"></span><h4>CodePipeLineの設定(ECSデプロイ)<a class="headerlink" href="#codepipeline-ecs" title="Permalink to this headline">¶</a></h4>
<p>作成したECSタスク定義・サービス定義の内容に従い、ステージング環境へECSコンテナをデプロイする設定を行う。</p>
<p>■  <a class="reference internal" href="#section8-3-2-2-codepipeline-staging-release-setting-label"><span class="std std-ref">CodePipeLineの設定(ソース・ビルド)</span></a> で作成したCodePipeline定義を開き、「編集」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-11.png" src="../../../_images/management-console-codepipeline-11.png" />
</div>
<p>■ ビルドの後にステージングデプロイ用のアクションを追加し、「アクションの追加」ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-codepipeline-12.png" src="../../../_images/management-console-codepipeline-12.png" />
</div>
<p>詳細なオプションは、以下の設定通り行う。</p>
<ul class="simple">
<li>アクションカテゴリ：デプロイ</li>
</ul>
<p>[デプロイアクション]</p>
<ul class="simple">
<li>デプロイアクション：任意の名前</li>
<li>デプロイプロバイダ：AmazonECS</li>
</ul>
<p>[AmazonECS]</p>
<ul class="simple">
<li>クラスタ名：選択したクラスタを指定</li>
<li>サービス名：前章「 <a class="reference internal" href="#section8-3-2-4-codepipeline-staging-release-ecs-service-setting-label"><span class="std std-ref">ECSサービス設定</span></a> 」で作成したサービスを指定</li>
<li>イメージファイル名： 「 <a class="reference internal" href="#section8-3-2-1-codepipeline-staging-release-prepared-label"><span class="std std-ref">事前準備</span></a> 」で作成した、「imagedefinitions.json」を指定</li>
<li>入力アーティファクト：直前のアクション「Build」の出力アーティファクトと同名にしておく</li>
</ul>
</div>
</div>
</div>
<div class="section" id="aws-cli">
<span id="section8-4-aws-cli-label"></span><h2>AWS CLI<a class="headerlink" href="#aws-cli" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section8-4-1-aws-cli-overview-label">
<span id="id19"></span><h3>Overview<a class="headerlink" href="#section8-4-1-aws-cli-overview-label" title="Permalink to this headline">¶</a></h3>
<p>AWS CLIはAWSが提供するコマンドラインインターフェイスである。</p>
</div>
<div class="section" id="section8-4-2-aws-cli-install-label">
<span id="id20"></span><h3>AWS CLIのインストール<a class="headerlink" href="#section8-4-2-aws-cli-install-label" title="Permalink to this headline">¶</a></h3>
<p>ここでは、手元にあるローカルマシンとしてMacOSにCLIをインストールする。<a class="reference external" href="https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-chap-install.html">公式サイト AWS CLIのインストール</a> では、CLIのインストールはpipコマンドを用いてインストールを行なっているため、事前にpythonを実行できる環境を構築しておくこと。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>MacOS Sierra以降はHomebrewからpythonをインストールする。以下のコマンドにより、標準インストールされているpython(/usr/bin/python)ではなく、/usr/local/bin/pythonが使用されるようになる。</p>
<div class="last highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>brew update
brew install python
</pre></div>
</td></tr></table></div>
</div>
<p>pipを利用してCLIをインストールする。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>pip3 install awscli --upgrade --user
</pre></div>
</td></tr></table></div>
<p>インストール後に.bash_profileにパスを通しておく。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/Users/XXXXXXXX/Library/Python/3.6/bin/:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table></div>
<p>コマンドが正常実行できることを確認する。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>aws --version
aws-cli/1.16.241 Python/3.6.5 Darwin/18.7.0 botocore/1.12.231
</pre></div>
</td></tr></table></div>
<p>なお、認証情報を~/.aws/configおよび、~/.aws/credentialsに保存しておくこと。</p>
</div>
</div>
<div class="section" id="cloudformation">
<span id="section8-5-cloud-formation-label"></span><h2>CloudFormation<a class="headerlink" href="#cloudformation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section8-5-1-aws-cloudformation-overview-label">
<span id="id22"></span><h3>Overview<a class="headerlink" href="#section8-5-1-aws-cloudformation-overview-label" title="Permalink to this headline">¶</a></h3>
<p>CloudFormationは、JSONとYAML形式のテンプレートを使用して、AWSリソースの起動、設定、接続を行うサービスである。
CloudFormationは以下のフォーマットで記述される。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: <span class="s2">&quot;version date&quot;</span>
Description: String
Metadata: template metadata
Parameters: <span class="nb">set</span> of parameters
Mappings: <span class="nb">set</span> of mappings
Conditions: <span class="nb">set</span> of conditions
Transform: <span class="nb">set</span> of transforms
Resources: <span class="nb">set</span> of resources
Outputs: <span class="nb">set</span> of outputs
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>intelliJ IDEAにCloudFormationのプラグインがあり、バリデーション機能などを有している。当プラグインでは、簡単な構文チェックなどは行えるが、必須・任意パラメータの有無などの検証はできないため、cfn-python-lintというAWSから提供されているプラグインも合わせて導入する。</p>
<p>pipコマンドにて、cfn-lintをインストールする。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; pip intall cfn-lint
</pre></div>
</div>
<p>IntelliJ IDEAに各プラグインを導入する。</p>
<div class="figure">
<img alt="../../../_images/intellij-install-cloudformation-plugin-1.png" src="../../../_images/intellij-install-cloudformation-plugin-1.png" />
</div>
<div class="figure">
<img alt="../../../_images/intellij-install-cloudformation-plugin-2.png" src="../../../_images/intellij-install-cloudformation-plugin-2.png" />
</div>
<div class="figure">
<img alt="../../../_images/intellij-install-cfn-lint-plugin-1.png" src="../../../_images/intellij-install-cfn-lint-plugin-1.png" />
</div>
<p>cfn-lintプラグインの設定で実行コマンドも設定しておく。</p>
<div class="last figure">
<img alt="../../../_images/intellij-install-cfn-lint-plugin-2.png" src="../../../_images/intellij-install-cfn-lint-plugin-2.png" />
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">IntelliJ IDEAのバージョンとcfn-lintのバージョンには注意する。2019.9時点で最新版のIDEAとcfn-lintの最新版は互換性がない状態。IntelliJのバージョンを2019.1にする必要がある。</p>
</div>
<p><br /></p>
</div>
<div class="section" id="stack">
<span id="section8-5-2-aws-cloudformation-create-stack-label"></span><h3>Stackの作成<a class="headerlink" href="#stack" title="Permalink to this headline">¶</a></h3>
<p>CloudFormationでテンプレートを作成し、Stackを作成する。Stackの作成はAWS CLIを通じて実行する。事前に <a class="reference internal" href="#section8-4-2-aws-cli-install-label"><span class="std std-ref">AWS CLIのインストール</span></a> に従って、 AWS CLIをインストールしておくこと。
またCLIを実行するユーザには、CloudFormationのアクセス権限を付与しておく必要がある。IAMサービスから、CLIで実行するユーザにCloudFormationのアクセス権限を付与しておくこと。</p>
<div class="figure">
<img alt="../../../_images/management-console-iam-attach-policy-for-cloudformation-1.png" src="../../../_images/management-console-iam-attach-policy-for-cloudformation-1.png" />
</div>
<p><br /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>ECSクラスタを作成するStackを実行する場合は、ECSのアクセス権限を付与しておく必要がある。IAMロールを作成する場合も同様。</p>
<div class="figure">
<img alt="../../../_images/management-console-iam-attach-policy-for-ecs-1.png" src="../../../_images/management-console-iam-attach-policy-for-ecs-1.png" />
</div>
<div class="last figure">
<img alt="../../../_images/management-console-iam-attach-policy-for-iam-1.png" src="../../../_images/management-console-iam-attach-policy-for-iam-1.png" />
</div>
</div>
<p><br /></p>
<div class="section" id="vpcstack">
<span id="section8-5-2-1-cloudformation-create-vpc-stack-label"></span><h4>VPCStackの作成<a class="headerlink" href="#vpcstack" title="Permalink to this headline">¶</a></h4>
<p>VPCおよびパブリック、プライベートを２つずつ持ち、インターネットGWをアタッチしたStackを作成する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - VPC

Resources:
  SampleCloudFormationVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.100.0.0/16
      InstanceTenancy: default
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: SampleCloudFormationVPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 172.100.1.0/24
      VpcId: !Ref SampleCloudFormationVPC
      AvailabilityZone: !Select [ 0, !GetAZs &#39;&#39; ]
      Tags:
        - Key: Name
          Value: PublicSubnet1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 172.100.2.0/24
      VpcId: !Ref SampleCloudFormationVPC
      AvailabilityZone: !Select [ 1, !GetAZs &#39;&#39; ]
      Tags:
        - Key: Name
          Value: PublicSubnet2

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 172.100.3.0/24
      VpcId: !Ref SampleCloudFormationVPC
      AvailabilityZone: !Select [ 0, !GetAZs &#39;&#39; ]
      Tags:
        - Key: Name
          Value: PrivateSubnet1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 172.100.4.0/24
      VpcId: !Ref SampleCloudFormationVPC
      AvailabilityZone: !Select [ 1, !GetAZs &#39;&#39; ]
      Tags:
        - Key: Name
          Value: PrivateSubnet2

  SampleCloudFormationIGW:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: SampleCloudFormationIGW

  SampleCloudFormationIGWAttach:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref SampleCloudFormationIGW
      VpcId: !Ref SampleCloudFormationVPC

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SampleCloudFormationVPC
      Tags:
        - Key: Name
          Value: Public Route

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: SampleCloudFormationIGW
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref SampleCloudFormationIGW

  PublicSubnet1Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

Outputs:
  VPCID:
    Description: VPC ID
    Value: !Ref SampleCloudFormationVPC
    Export:
      Name: !Sub ${AWS::StackName}-VPCID

  PublicSubnet1:
    Description: PublicSubnet1
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub ${AWS::StackName}-PublicSubnet1

  PublicSubnet2:
    Description: PublicSubnet2
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub ${AWS::StackName}-PublicSubnet2

  PrivateSubnet1:
    Description: PrivateSubnet1
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub ${AWS::StackName}-PrivateSubnet1

  PrivateSubnet2:
    Description: PrivateSubnet2
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub ${AWS::StackName}-PrivateSubnet2
</pre></div>
</div>
<p>作成したテンプレートを使ってAWS CLI経由でStack作成コマンドを実行する。コマンドが長くなりがちなため、シェルスクリプトを作成し実行する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="nv">stack_name</span><span class="o">=</span><span class="s2">&quot;sample-cloudformation-vpc-1&quot;</span>
<span class="nv">template_path</span><span class="o">=</span><span class="s2">&quot;sample-vpc-cfn.yml&quot;</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$stack_name</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> -a <span class="s2">&quot;</span><span class="nv">$template_path</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2"> stack-name template-path&quot;</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

aws cloudformation create-stack --stack-name <span class="si">${</span><span class="nv">stack_name</span><span class="si">}</span> --template-body file://<span class="si">${</span><span class="nv">template_path</span><span class="si">}</span>
</pre></div>
</div>
<p>コマンドを実行すると、マネジメントコンソール上にStackがステータス”CREATE_IN_PROGRESS”で表示される。問題なく作成が完了すると、”CREATE_COMPLETE” となる。</p>
<div class="figure">
<img alt="../../../_images/management-console-cloudformation-create-stack-1.png" src="../../../_images/management-console-cloudformation-create-stack-1.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-cloudformation-create-stack-2.png" src="../../../_images/management-console-cloudformation-create-stack-2.png" />
</div>
<p><br /></p>
<p>VPCメニューからも作成したリソースを確認できる。</p>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-vpc-confirm-vpc-by-cloudformation-1.png" src="../../../_images/management-console-vpc-confirm-vpc-by-cloudformation-1.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-vpc-confirm-subnet-by-cloudformation-1.png" src="../../../_images/management-console-vpc-confirm-subnet-by-cloudformation-1.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-vpc-confirm-routetable-by-cloudformation-1.png" src="../../../_images/management-console-vpc-confirm-routetable-by-cloudformation-1.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-vpc-confirm-routetable-by-cloudformation-2.png" src="../../../_images/management-console-vpc-confirm-routetable-by-cloudformation-2.png" />
</div>
<p><br /></p>
<div class="figure">
<img alt="../../../_images/management-console-vpc-confirm-igw-by-cloudformation-1.png" src="../../../_images/management-console-vpc-confirm-igw-by-cloudformation-1.png" />
</div>
<p><br /></p>
</div>
<div class="section" id="natgatewaystack">
<span id="section8-5-2-2-cloudformation-create-ngw-label"></span><h4>NatGatewayStackの作成<a class="headerlink" href="#natgatewaystack" title="Permalink to this headline">¶</a></h4>
<p>前節で作成した、VPCのプライベートサブネットにアタッチするNAT Gatewayを設定するStackを作成する。テンプレートは以下の通り。</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - NatGateway

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1

Resources:
  SampleCloudFormationNatGWEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain:
        Fn::ImportValue: !Sub ${StackName}-VPCID

  SampleCloudFormationNatGW:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt SampleCloudFormationNatGWEIP.AllocationId
      SubnetId:
        Fn::ImportValue: !Sub ${StackName}-PublicSubnet1
      Tags:
        - Key: Name
          Value: SampleCloudFormationNatGW

  MainRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
    Tags:
      - Key: Name
        Value: Private Route

  MainRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref MainRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref SampleCloudFormationNatGW

  PrivateSubnet1Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1
      RouteTableId: !Ref MainRouteTable

  PrivateSubnet2Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
      Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2
      RouteTableId: !Ref MainRouteTable
</pre></div>
</div>
</div></blockquote>
<p><br /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CloudFormationはデフォルトで作成されるルートテーブルの操作はできないため、プライベートサブネットへの関連付けは別途ルートテーブルを作成し、明示的にNATGatewayへの関連付けを行う。</p>
</div>
</div>
<div class="section" id="securitygroupstack">
<span id="section8-5-2-3-cloudformation-create-sg-label"></span><h4>SecurityGroupStackの作成<a class="headerlink" href="#securitygroupstack" title="Permalink to this headline">¶</a></h4>
<p>次節以降、作成するALBやECSクラスター向けのセキュリティグループを作成するStackを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - SecurityGroup

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1

Resources:
  SampleCloudFormationSecurityGroupPublicALB:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SampleCloudFormationSecurityGroupPublicALB
      GroupDescription: http access
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Tags:
        - Key : Name
          Value: SampleCloudFormationSecurityGroupPublicALB

  SampleCloudFormationSecurityGroupInggressPublicALB:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SampleCloudFormationSecurityGroupPublicALB
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      CidrIp: 0.0.0.0/0

  SampleCloudFormationSecurityGroupPrivateALB:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SampleCloudFormationSecurityGroupPrivateALB
      GroupDescription: http access
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Tags:
        - Key : Name
          Value: SampleCloudFormationSecurityGroupPrivateALB

  SampleCloudFormationSecurityGroupIngressPrivateALB:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SampleCloudFormationSecurityGroupPrivateALB
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      CidrIp: 172.100.0.0/16

  SampleCloudFormationSecurityGroupFrontendEcsCluster:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SampleCloudFormationSecurityGroupFrontendEcsCluster
      GroupDescription: http access only alb
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Tags:
        - Key : Name
          Value: SampleCloudFormationSecurityGroupFrontendEcsCluster

  SampleCloudFormationSecurityGroupIngressFrontendEcsCluster:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SampleCloudFormationSecurityGroupFrontendEcsCluster
      IpProtocol: tcp
      FromPort: 32768
      ToPort: 61000
      SourceSecurityGroupId: !Ref SampleCloudFormationSecurityGroupPublicALB

  SampleCloudFormationSecurityGroupIngressForSSHFrontendEcsCluster:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SampleCloudFormationSecurityGroupFrontendEcsCluster
      IpProtocol: ssh
      FromPort: 22
      ToPort: 22
      CidrIp: 0.0.0.0/0

  SampleCloudFormationSecurityGroupBackendEcsCluster:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SampleCloudFormationSecurityGroupBackendEcsCluster
      GroupDescription: http access only alb
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Tags:
        - Key : Name
          Value: SampleCloudFormationSecurityGroupBackendEcsCluster

  SampleCloudFormationSecurityGroupIngressBackendEcsCluster:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SampleCloudFormationSecurityGroupBackendEcsCluster
      IpProtocol: tcp
      FromPort: 32768
      ToPort: 61000
      SourceSecurityGroupId: !Ref SampleCloudFormationSecurityGroupPrivateALB

Outputs:
  SampleCloudFormationSecurityGroupPublicALB:
    Description: Security Group for Public ALB
    Value: !Ref SampleCloudFormationSecurityGroupPublicALB
    Export:
      Name: !Sub ${StackName}-SecurityGroupPublicALB

  SampleCloudFormationSecurityGroupPrivateALB:
    Description: Security Group for Private ALB
    Value: !Ref SampleCloudFormationSecurityGroupPrivateALB
    Export:
      Name: !Sub ${StackName}-SecurityGroupPrivateALB

  SampleCloudFormationSecurityGroupFrontendEcsCluster:
    Description: Security Group for Frontend ECS Cluster
    Value: !Ref SampleCloudFormationSecurityGroupFrontendEcsCluster
    Export:
      Name: !Sub ${StackName}-SecurityGroupFrontendEcsCluster

  SampleCloudFormationSecurityGroupBackendEcsCluster:
    Description: Security Group for Backend ECS Cluster
    Value: !Ref SampleCloudFormationSecurityGroupBackendEcsCluster
    Export:
      Name: !Sub ${StackName}-SecurityGroupBackendEcsCluster
</pre></div>
</div>
</div>
<div class="section" id="applicationloadbalancerstack">
<span id="section8-5-2-4-cloudformation-create-alb-label"></span><h4>ApplicationLoadBalancerStackの作成<a class="headerlink" href="#applicationloadbalancerstack" title="Permalink to this headline">¶</a></h4>
<p>パブリック・プライベートサブネットに各々配置するECSクラスタ向けのALBを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - ApplicationLoadBalancer

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1

Resources:
  SampleCloudFormationFrontendALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: FrontendALB
      Subnets:
        - Fn::ImportValue: !Sub ${StackName}-PublicSubnet1
        - Fn::ImportValue: !Sub ${StackName}-PublicSubnet2
      SecurityGroups:
        - Fn::ImportValue: !Sub ${StackName}-SecurityGroupPublicALB

  SampleCloudFormationPublicALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: sample-cfn-public-tg-default
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Port: 80
      Protocol: HTTP
      HealthCheckPath: /index.html
      HealthyThresholdCount: 2
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: &#39;20&#39;

  SampleCloudFormationPublicALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref SampleCloudFormationFrontendALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref SampleCloudFormationPublicALBTargetGroup

  SampleCloudFormationBackendALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: BackendALB
      Subnets:
        - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1
        - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2
      SecurityGroups:
        - Fn::ImportValue: !Sub ${StackName}-SecurityGroupPrivateALB

  SampleCloudFormationPrivateALBTargetGroupDefault:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: sample-cfn-private-tg-default
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Port: 80
      Protocol: HTTP
      HealthCheckPath: /index.html
      HealthyThresholdCount: 2
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: &#39;20&#39;

  SampleCloudFormationPrivateALBTargetGroupServiceA:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: sample-cfn-private-tg-serviceA
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Port: 80
      Protocol: HTTP
      HealthCheckPath: /index.html
      HealthyThresholdCount: 2
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: &#39;20&#39;

  SampleCloudFormationPrivateALBTargetGroupServiceB:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: sample-cfn-private-tg-serviceB
      VpcId:
        Fn::ImportValue: !Sub ${StackName}-VPCID
      Port: 80
      Protocol: HTTP
      HealthCheckPath: /index.html
      HealthyThresholdCount: 2
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: &#39;20&#39;

  SampleCloudFormationPrivateALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref SampleCloudFormationBackendALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref SampleCloudFormationPrivateALBTargetGroupDefault

  SampleCloudFormationPrivateALBListenerRuleServiceA:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref SampleCloudFormationPrivateALBTargetGroupServiceA
      Conditions:
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /serviceA/*
      ListenerArn: !Ref SampleCloudFormationPrivateALBListener
      Priority: 1

  SampleCloudFormationPrivateALBListenerRuleServiceB:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref SampleCloudFormationPrivateALBTargetGroupServiceB
      Conditions:
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /serviceB/*
      ListenerArn: !Ref SampleCloudFormationPrivateALBListener
      Priority: 2

  Outputs:
    SampleCloudFormationPublicALBDNS:
      Description: Public DNS Name
      Value: !GetAtt SampleCloudFormationFrontendALB.DNSName
      Export:
        Name: !Sub ${StackName}-PublicALBDNS

    SampleCloudFormationPrivateALBDNS:
      Description: Private DNS Name
      Value: !GetAtt SampleCloudFormationBackendALB.DNSName
      Export:
        Name: !Sub ${StackName}-PrivateALBDNS
</pre></div>
</div>
</div>
<div class="section" id="ecsclusterstack">
<span id="section8-5-2-5-cloudformation-create-ecs-cluster-label"></span><h4>ECSClusterStackの作成<a class="headerlink" href="#ecsclusterstack" title="Permalink to this headline">¶</a></h4>
<p>パブリック・プライベートサブネットに各々配置するECSクラスタを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - ECS Cluster

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1
  ECSAMI:
    Description: AMI ID
    Type: AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;
    Default: /aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id
  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: r4.large
  DesiredCapacity:
    Type: Number
    Default: &#39;1&#39;
    Description: Number of EC2 instances to launch in your ECS cluster.
  EC2InstanceMaxSizeOfECS:
    Type: Number
    Default: &#39;3&#39;
    Description: Maximum number of EC2 instances that can be launched in your ECS cluster.
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: test
    Description: Key pair setting to ECS Cluster

Resources:
  SampleCloudFormationECSRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role

  SampleCloudFormationECSInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref SampleCloudFormationECSRole

  SampleCloudFormationFrontendECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: sample-frontend-cluster
      Tags:
        - Key: Name
          Value: SampleCloudFormationFrontendECSCluster

  SampleCloudFormationBackendECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: sample-backend-cluster

  SampleCloudFormationFrontendECSAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - Fn::ImportValue: !Sub ${StackName}-PublicSubnet1
        - Fn::ImportValue: !Sub ${StackName}-PublicSubnet2
      LaunchConfigurationName: !Ref SampleCloudFormationFrontendECSLaunchConfiguration
      MinSize: &#39;0&#39;
      MaxSize: !Ref EC2InstanceMaxSizeOfECS
      DesiredCapacity: !Ref DesiredCapacity
      Tags:
        - Key: Name
          Value: SampleCloudFormationFrontendECSCluster
          PropagateAtLaunch: true
    CreationPolicy:
      ResourceSignal:
        Timeout: PT5M
    UpdatePolicy:
      AutoScalingReplacingUpdate:
        WillReplace: true

  SampleCloudFormationFrontendECSLaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !Ref ECSAMI
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref SampleCloudFormationECSInstanceProfile
      KeyName: !Ref KeyPairName
      SecurityGroups:
        - Fn::ImportValue: !Sub ${StackName}-SecurityGroupFrontendEcsCluster
      AssociatePublicIpAddress: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          echo ECS_CLUSTER=${SampleCloudFormationFrontendECSCluster} &gt;&gt; /etc/ecs/ecs.config
          yum install -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SampleCloudFormationFrontendECSAutoScalingGroup --region ${AWS::Region}

  SampleCloudFormationBackendECSAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1
        - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2
      LaunchConfigurationName: !Ref SampleCloudFormationBackendECSLaunchConfiguration
      MinSize: &#39;0&#39;
      MaxSize: !Ref EC2InstanceMaxSizeOfECS
      DesiredCapacity: !Ref DesiredCapacity
      Tags:
        - Key: Name
          Value: SampleCloudFormationBackendECSCluster
          PropagateAtLaunch: true
    CreationPolicy:
      ResourceSignal:
        Timeout: PT5M
    UpdatePolicy:
      AutoScalingReplacingUpdate:
        WillReplace: true

  SampleCloudFormationBackendECSLaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !Ref ECSAMI
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref SampleCloudFormationECSInstanceProfile
      KeyName: !Ref KeyPairName
      SecurityGroups:
        - Fn::ImportValue: !Sub ${StackName}-SecurityGroupBackendEcsCluster
      AssociatePublicIpAddress: false
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          echo ECS_CLUSTER=${SampleCloudFormationBackendECSCluster} &gt;&gt; /etc/ecs/ecs.config
          yum install -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SampleCloudFormationBackendECSAutoScalingGroup --region ${AWS::Region}

Outputs:
  SampleCloudFormationFrontendECSCluster:
    Description: Frontend ECS Cluster
    Value: !Ref SampleCloudFormationFrontendECSCluster
    Export:
      Name: !Sub ${StackName}-FrontendEcsCluster

  SampleCloudFormationBackendECSCluster:
    Description: Backend ECS Cluster
    Value: !Ref SampleCloudFormationBackendECSCluster
    Export:
      Name: !Sub ${StackName}-BackendEcsCluster
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ECSクラスタは起動構成(LaunchConfiguration)・オートスケーリンググループにより実行する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">LaunchConfiguration.UserDataプロパティに指定しているのはクラスタとなるEC2インスタンスを起動する際の初期実行スクリプトである。ここでは、初期スクリプト内で、cfn-signalスクリプトを実行し、CloudFormationに起動完了シグナルを送信している。詳細は、 <a class="reference external" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/cfn-signal.html">公式ページ cfn-signal</a> を参照のこと。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CreationPolicy.ResourceSignal.Timeoutプロパティ属性で設定した時間内にクラスタとなるインスタンスが起動できないと 「Failed to receive X resource signal(s) within the specified duration」が発生し、スタック実行がロールバックされる。
ECSクラスタ起動時にCloudFormationがシグナルを受信しなかったため生じる汎用的なメッセージであり、時間内に起動できない理由は別に存在するため、適宜、パブリックアドレスの割り当てオプション、セキュリティグループの設定やVPCのルーティングなど見直すこと。詳細は、 <a class="reference external" href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/cloudformation-failed-signal/?nc1=h_ls">公式ページ</a> も参照のこと。</p>
</div>
</div>
<div class="section" id="ecstaskstack">
<span id="section8-5-2-6-cloudformation-create-ecs-task-label"></span><h4>ECSTaskStackの作成<a class="headerlink" href="#ecstaskstack" title="Permalink to this headline">¶</a></h4>
<p>パブリック・プライベートサブネットに各々配置するECSタスクを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - ECS Task Definition

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1

Resources:
  SampleCloudFormationECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
    ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  SampleCloudFormationBackendECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
      Properties:
        Family: sample-cloudformation-task-backend
        RequiresCompatibilities:
          - EC2
        Memory: &#39;1024&#39;
        Cpu: &#39;512&#39;
        NetworkMode: bridge
        ExecutionRoleArn: !Ref SampleCloudFormationECSTaskExecutionRole
        ContainerDefinitions:
          - Name: sample-ecs-backend
            Image: debugroom/sample-aws-ecs-backend:1.0-SNAPSHOT
            PortMappings:
              - ContainerPort: 8081
                HostPort: 0
            Memory: 1024

  SampleCloudFormationFrontendECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: sample-cloudformation-task-frontend
      RequiresCompatibilities:
        - EC2
      Memory: &#39;1024&#39;
      Cpu: &#39;512&#39;
      NetworkMode: bridge
      ExecutionRoleArn: !Ref SampleCloudFormationECSTaskExecutionRole
      ContainerDefinitions:
         - Name: sample-ecs-frontend
           Image: debugroom/sample-aws-ecs-frontend:1.0-SNAPSHOT
           PortMappings:
             - ContainerPort: 8080
               HostPort: 0
           Environment:
             - Name: SERVICE_DNS
               Value:
               Fn::ImportValue: !Sub ${StackName}-PrivateALBDNS
           Memory: 1024

Outputs:
  SampleCloudFormationFrontendECSTaskDefinition:
    Description: Frontend ECS Task Definition
    Value: !Ref SampleCloudFormationFrontendECSTaskDefinition
    Export:
      Name: !Sub ${StackName}-FrontendEcsTaskDefinition

  SampleCloudFormationBackendECSTaskDefinition:
    Description: Backend ECS Task Definition
    Value: !Ref SampleCloudFormationBackendECSTaskDefinition
    Export:
      Name: !Sub ${StackName}-BackendEcsTaskDefinition
</pre></div>
</div>
</div>
<div class="section" id="ecsservicestack">
<span id="section8-5-2-7-cloudformation-create-ecs-service-label"></span><h4>ECSServiceStackの作成<a class="headerlink" href="#ecsservicestack" title="Permalink to this headline">¶</a></h4>
<p>パブリック・プライベートサブネットに各々配置するECSのサービスを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - ECS Service Launch

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1
  DesiredCount:
    Description: Number of container service to launch in ECS cluster
    Type: Number
    Default: &#39;1&#39;

Resources:
  SampleCloudFormationFrontendECSService:
    Type: AWS::ECS::Service
    Properties:
    Cluster:
      Fn::ImportValue: !Sub ${StackName}-FrontendEcsCluster
    DesiredCount: !Ref DesiredCount
    TaskDefinition:
      Fn::ImportValue: !Sub ${StackName}-FrontendEcsTaskDefinition
    LaunchType: EC2
    LoadBalancers:
      - ContainerName: sample-ecs-frontend
        ContainerPort: 8080
        TargetGroupArn:
          Fn::ImportValue: !Sub ${StackName}-PublicALBTargetGroup

  SampleCloudFormationBackendECSService:
    Type: AWS::ECS::Service
    Properties:
    Cluster:
      Fn::ImportValue: !Sub ${StackName}-BackendEcsCluster
    DesiredCount: !Ref DesiredCount
    TaskDefinition:
      Fn::ImportValue: !Sub ${StackName}-BackendEcsTaskDefinition
    LaunchType: EC2
    LoadBalancers:
      - ContainerName: sample-ecs-backend
        ContainerPort: 8081
        TargetGroupArn:
          Fn::ImportValue: !Sub ${StackName}-PrivateALBTargetGroupDefault

Outputs:
  SampleCloudFormationFrontendECSService:
    Description: Frontend ECS Service
    Value: !Ref SampleCloudFormationFrontendECSService
    Export:
      Name: !Sub ${StackName}-FrontendEcsService
  SampleCloudFormationBackendECSService:
    Description: Backend ECS Service
    Value: !Ref SampleCloudFormationBackendECSService
    Export:
      Name: !Sub ${StackName}-BackendEcsService
</pre></div>
</div>
</div>
<div class="section" id="rdsstack">
<span id="section8-5-2-8-cloudformation-create-rds-label"></span><h4>RDSStackの作成<a class="headerlink" href="#rdsstack" title="Permalink to this headline">¶</a></h4>
<p>プライベートサブネットに配置されたECSクラスタからアクセスされるRDSを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - RDS Definition

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1

  RdsUser:
    Description: Database Master User Name
    Type: String
    Default: postgresql

  RdsPassword:
    Description: Database Master User Password
    Type: String
    Default: postgresql

Resources:
  SampleCloudFormationRDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
    DBInstanceIdentifier: sample-cloudformation-postgresql
    DBName: SampleCloudFormationPostgreSQL
    Engine: postgres
    MultiAZ: false
    MasterUsername: !Ref RdsUser
    MasterUserPassword: !Ref RdsPassword
    DBInstanceClass: db.t2.micro
    AllocatedStorage: &#39;20&#39;
    DBSubnetGroupName: !Ref SampleCloudFormationDBSubnetGroup
    MonitoringInterval: 10
    MonitoringRoleArn: !GetAtt SampleCloudFormationDBMonitorRole.Arn
    VPCSecurityGroups:
      - Fn::ImportValue: !Sub ${StackName}-SecurityGroupRdsPostgres

  SampleCloudFormationDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: DB Subnet Group for Private Subnet
      SubnetIds:
        - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1
        - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2

  SampleCloudFormationDBMonitorRole:
    Type: AWS::IAM::Role
    Properties:
      Path: &quot;/&quot;
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - monitoring.rds.amazonaws.com
            Action:
              - sts:AssumeRole

Outputs:
  SampleCloudFormationRDSInstance:
    Description: RDS
    Value: !Ref SampleCloudFormationRDSInstance
    Export:
      Name: !Sub ${StackName}-RDS
</pre></div>
</div>
</div>
<div class="section" id="dynamodbstack">
<span id="section8-5-2-9-cloudformation-create-dynamodb-label"></span><h4>DynamoDBStackの作成<a class="headerlink" href="#dynamodbstack" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">事前に認証情報をもつユーザにDyanamoDBのアクセス権限を付与しておく。</p>
</div>
<p>ECSクラスタからアクセスされるDynamoDBを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - DynamoDB Definition

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1

Resources:
  SampleCloudFormationDynamoDBSampleTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: SampleCloudFormationSampleTable
      BillingMode: PROVISIONED
      AttributeDefinitions:
        - AttributeName: samplePartitionKey
          AttributeType: S
        - AttributeName: sampleSortKey
          AttributeType: S
      KeySchema:
        - AttributeName: samplePartitionKey
          KeyType: HASH
        - AttributeName: sampleSortKey
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5

Outputs:
  SampleCloudFormationDynamoDB:
    Description: DynamoDB SampleTable
    Value: !Ref SampleCloudFormationDynamoDBSampleTable
    Export:
      Name: !Sub ${StackName}-DynamoDBSampleTable
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">AttributeDefinitionsとKeySchemaの属性は一致させること(AttributeにはHASHキーとRANGEキー以外は指定しないこと)。DynamoDBはスキーマレスの構成なのでキー以外の属性定義はエラーとなる。</p>
</div>
</div>
<div class="section" id="elasticachestack">
<span id="section8-5-2-10-cloudformation-create-elasticache-label"></span><h4>ElastiCacheStackの作成<a class="headerlink" href="#elasticachestack" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">事前に認証情報をもつユーザにDyanamoDBのアクセス権限を付与しておく。</p>
</div>
<p>パブリックサブネットにあるECSクラスタからアクセスされるElastiCacheを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - ElastiCache Definition

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1
  CacheInstanceType:
    Description: Cache instance type
    Type: String
    Default: cache.t2.micro

Resources:
  SampleCloudFormationElastiCacheSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      CacheSubnetGroupName: SampleCloudFormationElastiCacheSubnetGroup
      Description: SampleCloudFormation ElastiCacheSubnetGroup
      SubnetIds:
        - Fn::ImportValue: !Sub ${StackName}-PublicSubnet1
        - Fn::ImportValue: !Sub ${StackName}-PublicSubnet2

  SampleCloudFormationElastiCacheParameterGroup:
    Type: AWS::ElastiCache::ParameterGroup
    Properties:
      CacheParameterGroupFamily: redis5.0
      Description: SampleCloudFormation ElastiCacheParameterGroup
      Properties:
        cluster-enabled: &quot;no&quot;

  SampleCloudFormationElastiCacheRedis:
    Type: AWS::ElastiCache::ReplicationGroup
    Properties:
      ReplicationGroupId: samplecloudformation-1
      Engine: redis
      ReplicationGroupDescription: SampleCloudFormation RedisCluster
      EngineVersion: 5.0.3
      Port: 6379
      CacheParameterGroupName: !Ref SampleCloudFormationElastiCacheParameterGroup
      CacheNodeType: !Ref CacheInstanceType
      ReplicasPerNodeGroup: 2
      AutomaticFailoverEnabled: true
      CacheSubnetGroupName: !Ref SampleCloudFormationElastiCacheSubnetGroup
      SecurityGroupIds:
        - Fn::ImportValue: !Sub ${StackName}-SecurityGroupElastiCacheRedis

Outputs:
  SampleCloudFormationElastiCacheRedis:
    Description: ElastiCache Redis
    Value: !Ref SampleCloudFormationElastiCacheRedis
    Export:
      Name: !Sub ${StackName}-ElastiCacheRedis

  SampleCloudFormationElastiCacheRedisEndPoint:
    Description: ElastiCache Redis EndPoint
    Value: !GetAtt SampleCloudFormationElastiCacheRedis.PrimaryEndPoint.Address
    Export:
      Name: !Sub ${StackName}-ElastiCacheRedisEndPoint
</pre></div>
</div>
</div>
<div class="section" id="s3bucketstack">
<span id="section8-5-2-11-cloudformation-create-s3-label"></span><h4>S3BucketStackの作成<a class="headerlink" href="#s3bucketstack" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">事前に認証情報をもつユーザにS3のアクセス権限を付与しておく。</p>
</div>
<p>S3上にバケットを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - S3 Bucket Definition

Parameters:
  S3BucketName:
    Description: Type of this BacketName.
    Type: String
    Default: debugroom-sample-cloudformation-bucket

Resources:
  SampleCloudFormationS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${S3BucketName}
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: True
        BlockPublicPolicy: True
        IgnorePublicAcls: True
        RestrictPublicBuckets: True

Outputs:
  SampleCloudFormationS3Bucket:
    Value: !Ref SampleCloudFormationS3Bucket
</pre></div>
</div>
</div>
<div class="section" id="sqsstack">
<span id="section8-5-2-11-cloudformation-create-sqs-label"></span><h4>SQSStackの作成<a class="headerlink" href="#sqsstack" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">事前に認証情報をもつユーザにSQSのアクセス権限を付与しておく。</p>
</div>
<p>SQSのキューを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - SQS Definition

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1

Resources:
  SampleCloudFormationSQSSampleQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: SampleCloudFormationSampleQueue
      VisibilityTimeout: 30
#       FifoQueue: false
      DelaySeconds: 5
      MaximumMessageSize: 26144
      MessageRetentionPeriod: 345600
      ReceiveMessageWaitTimeSeconds: 0

Outputs:
  SampleCloudFormationSQSSampleQueue:
    Description: SQS Sample Queue.
    Value: !Ref SampleCloudFormationSQSSampleQueue
    Export:
      Name: !Sub ${StackName}-SQSSampleQueue
</pre></div>
</div>
</div>
<div class="section" id="codebuildstack">
<span id="section8-5-2-11-cloudformation-create-codebuild-label"></span><h4>CodeBuildStackの作成<a class="headerlink" href="#codebuildstack" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">事前に認証情報をもつユーザにCodeBuildのアクセス権限を付与しておく。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">CodeBuildの実行時にはNATGatewayが設定されたプライベートサブネットを設定しておくこと。</p>
</div>
<p>CodeBuildプロジェクトを作成するスタックを構築する。テンプレートは以下の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - CodeBuild

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1
  CodeBuildCIBFFProjectName:
    Description: CI CodeBuild Project Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: SampleCloudFormationCodeBuildCIBFF
  CodeBuildCIBackendProjectName:
    Description: CI CodeBuild Project Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: SampleCloudFormationCodeBuildCIBackend

Resources:
  SampleCloudFormationCodeBuildBFF:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Ref CodeBuildCIBFFProjectName
      Source:
        Type: GITHUB
        Location: https://github.com/debugroom/sample-aws-cloudformation.git
        GitCloneDepth: 1
        BuildSpec: bff-app/src/main/codebuild/dev/buildspec.yml
      Triggers:
        Webhook: true
        FilterGroups:
          - - Type: EVENT
              Pattern: PUSH
            - Type: HEAD_REF
#              Pattern: ^refs/heads/feature/.*
              Pattern: ^refs/heads/master
      Environment:
        Type: LINUX_CONTAINER
        Image: aws/codebuild/standard:2.0
        ComputeType: BUILD_GENERAL1_SMALL
      ServiceRole: !Ref SampleCloudFormationCodeBuildBFFServiceRole
      VpcConfig:
        VpcId:
          Fn::ImportValue: !Sub ${StackName}-VPCID
        Subnets:
          - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1
          - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2
        SecurityGroupIds:
          - Fn::ImportValue: !Sub ${StackName}-SecurityGroupCodeBuild
      Artifacts:
        Type: NO_ARTIFACTS
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Sub ${CodeBuildCIBFFProjectName}-CloudWatchLogs-BuildLogGroup-Name

  SampleCloudFormationCodeBuildBackend:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Ref CodeBuildCIBackendProjectName
      Source:
        Type: GITHUB
        Location: https://github.com/debugroom/sample-aws-cloudformation.git
        GitCloneDepth: 1
        BuildSpec: backend-app/src/main/codebuild/dev/buildspec.yml
      Triggers:
        Webhook: true
        FilterGroups:
          - - Type: EVENT
              Pattern: PUSH
            - Type: HEAD_REF
#              Pattern: ^refs/heads/feature/.*
              Pattern: ^refs/heads/master
      Environment:
        Type: LINUX_CONTAINER
        Image: aws/codebuild/standard:2.0
        ComputeType: BUILD_GENERAL1_SMALL
      ServiceRole: !Ref SampleCloudFormationCodeBuildBackendServiceRole
      VpcConfig:
        VpcId:
          Fn::ImportValue: !Sub ${StackName}-VPCID
        Subnets:
          - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1
          - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2
        SecurityGroupIds:
          - Fn::ImportValue: !Sub ${StackName}-SecurityGroupCodeBuild
      Artifacts:
        Type: NO_ARTIFACTS
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Sub ${CodeBuildCIBackendProjectName}-CloudWatchLogs-BuildLogGroup-Name

  SampleCloudFormationCodeBuildBFFServiceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${CodeBuildCIBFFProjectName}-codebuild-base-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CodeBuildCIBFFProjectName}-CloudWatchLogs-BuildLogGroup-Name
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CodeBuildCIBFFProjectName}-CloudWatchLogs-BuildLogGroup-Name:*
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:s3:::codepipeline-${AWS::Region}-*
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketAcl
                  - s3:GetBucketLocation
        - PolicyName: !Sub ${CodeBuildCIBFFProjectName}-codebuild-vpc-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - &quot;*&quot;
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeDhcpOptions
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:DescribeSubnets
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeVpcs
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:network-interface/*
                Action:
                  - ec2:CreateNetworkInterfacePermission
                Condition:
                  StringEquals:
                    ec2:Subnet:
                      - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1Arn
                      - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2Arn
                    ec2:AuthorizedService: codebuild.amazonaws.com
        - PolicyName: !Sub ${CodeBuildCIBFFProjectName}-ssm-parameterstore-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - &quot;*&quot;
                Action:
                  - ssm:DescribeParameters
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*
                Action:
                  - ssm:GetParameters

  SampleCloudFormationCodeBuildBackendServiceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${CodeBuildCIBackendProjectName}-codebuild-base-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CodeBuildCIBackendProjectName}-CloudWatchLogs-BuildLogGroup-Name
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CodeBuildCIBackendProjectName}-CloudWatchLogs-BuildLogGroup-Name:*
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:s3:::codepipeline-${AWS::Region}-*
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketAcl
                  - s3:GetBucketLocation
        - PolicyName: !Sub ${CodeBuildCIBackendProjectName}-codebuild-vpc-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - &quot;*&quot;
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeDhcpOptions
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:DescribeSubnets
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeVpcs
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:network-interface/*
                Action:
                  - ec2:CreateNetworkInterfacePermission
                Condition:
                  StringEquals:
                    ec2:Subnet:
                      - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1Arn
                      - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2Arn
                    ec2:AuthorizedService: codebuild.amazonaws.com
        - PolicyName: !Sub ${CodeBuildCIBackendProjectName}-ssm-parameterstore-policy
            PolicyDocument:
              Version: 2012-10-17
              Statement:
                - Effect: Allow
                  Resource:
                    - &quot;*&quot;
                  Action:
                    - ssm:DescribeParameters
                - Effect: Allow
                  Resource:
                    - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*
                  Action:
                    - ssm:GetParameters

Outputs:
  SampleCloudFormationCodeBuildBFF:
    Description: CI CodeBuild Project for BFF
    Value: !Ref SampleCloudFormationCodeBuildBFF
    Export:
      Name: !Sub ${StackName}-CodeBuildBFF

  SampleCloudFormationCodeBuildBackend:
    Description: CI CodeBuild Project for Backend
    Value: !Ref SampleCloudFormationCodeBuildBackend
    Export:
      Name: !Sub ${StackName}-CodeBuildBackend
</pre></div>
</div>
</div>
<div class="section" id="section8-5-2-12-cloudformation-create-codepipeline-label">
<span id="id24"></span><h4>CodePipelineの作成<a class="headerlink" href="#section8-5-2-12-cloudformation-create-codepipeline-label" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">事前に認証情報をもつユーザにCodePipelineのアクセス権限(GetPipelineなど)を付与しておく。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">事前に対象となるGitHubレポジトリへのオーナー権限をもつユーザのパーソナルアクセストークンを払い出しておく。トークンに付与する権限(Select scopes)はRepoおよび、admin:repo_hookの２つを付与する。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">パイプライン中に実行されるCodeBuildの実行時にはNATGatewayが設定されたプライベートサブネットを設定しておくこと。</p>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AWSTemplateFormatVersion: &#39;2010-09-09&#39;

Description: Sample CloudFormation template with YAML - CodePipeline

Parameters:
  StackName:
    Description: Target VPC Stack Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: sample-cloudformation-vpc-1
  CodePipelineProjectName:
    Description: CodePipeline CD Project Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: SampleCloudFormationCodePipeline
  CodeBuildBFFStagingContaierBuildProjectName:
    Description: CI CodeBuild Project Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: SampleCloudFormationCodeBuildCDBFF
  CodeBuildBackendStagingContainerBuildProjectName:
    Description: CI CodeBuild Project Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-Z][-a-zA-Z0-9]*$
    Default: SampleCloudFormationCodeBuildCDBackend
  S3BucketName:
    Description: Type of this BacketName.
    Type: String
    Default: debugroom-sample-cloudformation-codepipeline

Resources:
  SampleCloudFormationCodePipelineProject:
    Type: AWS::CodePipeline::Pipeline
    DependsOn: SampleCloudFormationS3BucketForCodePipeline
    Properties:
      Name: SampleCloudFormationCodePipeline
      RoleArn: !GetAtt SampleCloudFormationCodePipelineServiceRole.Arn
      Stages:
        - Name: SourceStage
          Actions:
            - Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: &quot;1&quot;
              OutputArtifacts:
                - Name: SourceOutput
              Configuration:
                Owner: &quot;{{resolve:ssm:GitHubRepositoryOwnerName:1}}&quot;
                Repo: sample-aws-cloudformation
                Branch: master
                OAuthToken: &quot;{{resolve:ssm:GitHubOAuthToken:1}}&quot;
              RunOrder: 1
        - Name: BackendStagingBuildStage
          Actions:
            - Name: BackendStagingBuildAction
              InputArtifacts:
                - Name: SourceOutput
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: &quot;1&quot;
              OutputArtifacts:
                - Name: BuildBackendStagingArtifact
              Configuration:
                ProjectName: !Ref SampleCloudFormationCodeBuildBackendStagingBuildContainer
      ArtifactStore:
        Location: !Ref S3BucketName
        Type: S3


  SampleCloudFormationCodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${CodePipelineProjectName}-codepipeline-base-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Action:
                  - elasticbeanstalk:*
                  - ec2:*
                  - elasticloadbalancing:*
                  - autoscaling:*
                  - cloudwatch:*
                  - s3:*
                  - sns:*
                  - cloudformation:*
                  - rds:*
                  - sqs:*
                  - ecs:*
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - codecommit:GetBranch
                  - codecommit:GetCommit
                  - codecommit:GetUploadArchiveStatus
                  - codecommit:UploadArchive
                  - codecommit:CancelUploadArchive
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - codedeploy:CreateDeployment
                  - codedeploy:GetApplicationRevision
                  - codedeploy:GetDeployment
                  - codedeploy:GetDeploymentConfig
                  - codedeploy:RegisterApplicationRevision
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - iam:PassRole
                Resource: &quot;*&quot;
                Effect: Allow
                Condition:
                  StringEqualsIfExists:
                    iam:PassedToService:
                      - cloudformation.amazonaws.com
                      - elasticbeanstalk.amazonaws.com
                      - ec2.amazonaws.com
                      - ecs-tasks.amazonaws.com
              - Action:
                  - lambda:InvokeFunction
                  - lambda:ListFunctions
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - opsworks:CreateDeployment
                  - opsworks:DescribeApps
                  - opsworks:DescribeCommands
                  - opsworks:DescribeDeployments
                  - opsworks:DescribeInstances
                  - opsworks:DescribeStacks
                  - opsworks:UpdateApp
                  - opsworks:UpdateStack
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - devicefarm:ListProjects
                  - devicefarm:ListDevicePools
                  - devicefarm:GetRun
                  - devicefarm:GetUpload
                  - devicefarm:CreateUpload
                  - devicefarm:ScheduleRun
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - servicecatalog:ListProvisioningArtifacts
                  - servicecatalog:CreateProvisioningArtifacts
                  - servicecatalog:DescribeProvisioningArtifacts
                  - servicecatalog:DeleteProvisioningArtifacts
                  - servicecatalog:UpdateProduct
                Resource: &quot;*&quot;
                Effect: Allow
              - Action:
                  - ecr:DescribeImages
                Resource: &quot;*&quot;
                Effect: Allow
        - PolicyName: !Sub ${CodePipelineProjectName}-ssm-parameterstore-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - &quot;*&quot;
                Action:
                  - ssm:DescribeParameters
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*
                Action:
                  - ssm:GetParameters

  SampleCloudFormationCodePipelineWebhook:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Name: SampleCloudFormationGitHubWebHook
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
        SecretToken: &quot;{{resolve:ssm:GitHubSecret:1}}&quot;
      Filters:
        - JsonPath: &quot;$.ref&quot;
          MatchEquals: refs/heads/{Branch}
      TargetPipeline: !Ref SampleCloudFormationCodePipelineProject
      TargetAction: SourceAction
      TargetPipelineVersion: !GetAtt SampleCloudFormationCodePipelineProject.Version
      RegisterWithThirdParty: True

  SampleCloudFormationCodeBuildBackendStagingBuildContainer:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Ref CodeBuildBackendStagingContainerBuildProjectName
      Source:
        Type: CODEPIPELINE
        GitCloneDepth: 1
        BuildSpec: backend-app/src/main/codebuild/staging/buildspec.yml
      Environment:
        PrivilegedMode: True
        Type: LINUX_CONTAINER
        Image: aws/codebuild/standard:2.0
        ComputeType: BUILD_GENERAL1_SMALL
      ServiceRole: !Ref SampleCloudFormationCodeBuildBackendStagingServiceRole
      VpcConfig:
        VpcId:
          Fn::ImportValue: !Sub ${StackName}-VPCID
        Subnets:
          - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1
          - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2
        SecurityGroupIds:
          - Fn::ImportValue: !Sub ${StackName}-SecurityGroupCodeBuild
      Artifacts:
        Type: CODEPIPELINE
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Sub ${CodeBuildBackendStagingContainerBuildProjectName}-CloudWatchLogs-BuildLogGroup-Name

  SampleCloudFormationCodeBuildBackendStagingServiceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${CodeBuildBackendStagingContainerBuildProjectName}-codebuild-base-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CodeBuildBackendStagingContainerBuildProjectName}-CloudWatchLogs-BuildLogGroup-Name
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CodeBuildBackendStagingContainerBuildProjectName}-CloudWatchLogs-BuildLogGroup-Name:*
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:s3:::${S3BucketName}/*
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketAcl
                  - s3:GetBucketLocation
        - PolicyName: !Sub ${CodeBuildBackendStagingContainerBuildProjectName}-codebuild-vpc-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - &quot;*&quot;
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeDhcpOptions
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:DescribeSubnets
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeVpcs
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:network-interface/*
                Action:
                  - ec2:CreateNetworkInterfacePermission
                Condition:
                  StringEquals:
                    ec2:Subnet:
                      - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet1Arn
                      - Fn::ImportValue: !Sub ${StackName}-PrivateSubnet2Arn
                    ec2:AuthorizedService: codebuild.amazonaws.com
        - PolicyName: !Sub ${CodeBuildBackendStagingContainerBuildProjectName}-ssm-parameterstore-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - &quot;*&quot;
                Action:
                  - ssm:DescribeParameters
              - Effect: Allow
                Resource:
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*
                Action:
                  - ssm:GetParameters

  SampleCloudFormationS3BucketForCodePipeline:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${S3BucketName}
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: True
        BlockPublicPolicy: True
        IgnorePublicAcls: True
        RestrictPublicBuckets: True
</pre></div>
</div>
</div>
</div>
<div class="section" id="section8-5-2-aws-cloudformation-delete-stack-label">
<span id="id25"></span><h3>Stackの削除<a class="headerlink" href="#section8-5-2-aws-cloudformation-delete-stack-label" title="Permalink to this headline">¶</a></h3>
<p>Stackを削除することで、構築していたAWSリソースごと削除が可能である。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="nv">stack_name</span><span class="o">=</span><span class="s2">&quot;sample-cloudformation-vpc-1&quot;</span>

aws cloudformation delete-stack --stack-name <span class="si">${</span><span class="nv">stack_name</span><span class="si">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="elastic-beanstalk">
<span id="section8-6-elastic-beanstalk-label"></span><h2>Elastic Beanstalk<a class="headerlink" href="#elastic-beanstalk" title="Permalink to this headline">¶</a></h2>
<p>Elastic Beanstalkは、Webアプリケーションを自動デプロイ、スケーリングするサービスである。</p>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">Elastic Beanstalkについて詳述。</p>
</div>
</div>
<div class="section" id="opsworks">
<span id="section8-7-opsworks-label"></span><h2>OpsWorks<a class="headerlink" href="#opsworks" title="Permalink to this headline">¶</a></h2>
<p>AWS OpsWorksはChefを利用して、アプリケーションの設定と管理を行う構成管理サービス</p>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p class="last">OpsWorksについて詳細を記述</p>
</div>
</div>
<div class="section" id="aws-cdk-aws-cloud-development-kit">
<span id="section8-8-cloud-development-kit-label"></span><h2>AWS CDK(AWS Cloud Development Kit)<a class="headerlink" href="#aws-cdk-aws-cloud-development-kit" title="Permalink to this headline">¶</a></h2>
<p>AWS CDKはインフラをPython、TypeScriptなどの言語で記述する言語である。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">2019.9時点でGA中のサービス。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="iot.html" class="btn btn-neutral float-right" title="AWS IoT" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="application.html" class="btn btn-neutral" title="Application Category" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, org.debugroom.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1-SNAPSHOTS',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>