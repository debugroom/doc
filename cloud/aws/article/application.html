

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Application Category &mdash; document 0.1-SNAPSHOTS documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="DevOps Category" href="devops.html" />
    <link rel="prev" title="Security Category" href="security.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> document
          

          
          </a>

          
            
            
              <div class="version">
                0.1-SNAPSHOTS
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../java/javaee/jpa/index.html">JavaEE JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/javaee/jBatch/index.html">JavaEE jBatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-boot/index.html">Spring Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-data-jpa/index.html">Spring Data JPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-data-dynamodb/index.html">Spring Data DynamoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-cloud-aws/index.html">Spring Cloud AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java/spring/spring-cloud-function/index.html">Spring Cloud Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database/cassandra/index.html">Cassandra</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Amazon web service</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="network.html">Network Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="computing.html">Computing Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage.html">Storage Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastore.html">DataStore Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Security Category</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Application Category</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#amazon-simple-notification-service-sns">Amazon Simple Notification Service(SNS)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sns-topic">SNS Topicの作成</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#amazon-simple-queue-service-sqs">Amazon Simple Queue Service(SQS)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section7-2-1-sqs-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section7-2-1-sqs-create-queue-label">キューの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sqs">SQSキューを利用するアプリケーション</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sns">SNSトピックからの通知を購読するキューの設定</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#amazon-kinesis-streams">Amazon kinesis Streams</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section7-3-1-kinesis-producer-detail-label">プロデューサアプリケーション</a></li>
<li class="toctree-l3"><a class="reference internal" href="#section7-3-2-kinesis-consumer-detail-label">コンシューマアプリケーション</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#amazon-kinesis-firehose-amazon-kinesis-analytics">Amazon kinesis firehose　/ Amazon kinesis Analytics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#amazon-lamda">Amazon Lamda</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#section7-4-1-lambda-overview-label">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#section7-4-3-lambda-deploy-label">コードの作成・デプロイ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#amazon-simple-workflow-service-swf">Amazon Simple Workflow Service(SWF)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#aws-flow-framework">AWS Flow Framework</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="devops.html">DevOps Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="iot.html">AWS IoT</a></li>
<li class="toctree-l2"><a class="reference internal" href="management.html">Management Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html">Appendix - 付録</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swagger/index.html">Swagger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../convention/app-infra/index.html">AP基盤処理方式・実装規約</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../memo/work/index.html">work guideline</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">document</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Amazon web service</a> &raquo;</li>
        
      <li>Application Category</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/cloud/aws/article/application.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="application-category">
<span id="section7-application-label"></span><h1>Application Category<a class="headerlink" href="#application-category" title="Permalink to this headline">¶</a></h1>
<div class="section" id="amazon-simple-notification-service-sns">
<span id="section7-1-sns-label"></span><h2>Amazon Simple Notification Service(SNS)<a class="headerlink" href="#amazon-simple-notification-service-sns" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overview">
<span id="section7-1-1-sns-overview-label"></span><h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>Amazon Simple Notification ServiceはPublish/Subscribe型のメッセージ配信サービスである。
発行者(Publisher)は、複数の購読者(Subscriber：WebServer, Mail, Amazon SQS, Amazon Lambda)へ非同期メッセージ送信する。</p>
<p>SNSは以下のような特徴をもつ。</p>
<ul class="simple">
<li>単一で複数の購読者へメッセージを送信できる。</li>
<li>メッセージの順序は保証されない。</li>
<li>発行済みのメッセージは削除できない。</li>
<li>メッセージ配信の失敗時は配信ポリシーによりリトライが可能。</li>
<li>メッセージには最大256KBのテキストデータ(XML、JSON、テキスト)を含めることができる。</li>
</ul>
<table border="1" class="colwidths-given docutils" id="id7">
<caption><span class="caption-text">AmazonSNSの操作</span><a class="headerlink" href="#id7" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">API</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CreateTopic</td>
<td>通知の公開先トピック(受け口・発信元の定義)を作成する。</td>
</tr>
<tr class="row-odd"><td>Subscribe</td>
<td>エンドポイントに登録確認メッセージを送信して、 <br /> エンドポイントを受信(Subscribe)登録する。</td>
</tr>
<tr class="row-even"><td>DeleteTopic</td>
<td>トピックとその登録サブスクリプションをすべて削除する。</td>
</tr>
<tr class="row-odd"><td>Publish</td>
<td>トピックを受信登録しているエンドポイントにメッセージを送信する。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sns-topic">
<span id="section7-1-2-sns-overview-label"></span><h3>SNS Topicの作成<a class="headerlink" href="#sns-topic" title="Permalink to this headline">¶</a></h3>
<p>■AWSコンソールからSNSを選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-sns-create-topic-1.png" src="../../../_images/management-console-sns-create-topic-1.png" />
</div>
<p>■トピックメニューを選択し、「新しくトピックを作成」をクリックする。</p>
<p>■トピック名を作成し、「トピックの作成」をクリックする。トピックが作成される。</p>
<div class="figure">
<img alt="../../../_images/management-console-sns-create-topic-3.png" src="../../../_images/management-console-sns-create-topic-3.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-sns-create-topic-4.png" src="../../../_images/management-console-sns-create-topic-4.png" />
</div>
<p>ここでは、AutoScaleした際にイベント通知をSNSを行う場合の例を説明する。</p>
<p>■EC2サービスでAutoScaleグループメニューを選択し、「通知」タブの「通知の作成」をクリックする。</p>
<div class="figure">
<img alt="../../../_images/management-console-sns-create-topic-5.png" src="../../../_images/management-console-sns-create-topic-5.png" />
</div>
<p>■上記で作成したトピックが選択されるので、イベントを追加し、保存を押下する。これによりAutoScaleでEC2インスタンスが起動すると、SNSトピックにメッセージが送信されるようになる。</p>
<div class="figure">
<img alt="../../../_images/management-console-sns-create-topic-6.png" src="../../../_images/management-console-sns-create-topic-6.png" />
</div>
</div>
</div>
<div class="section" id="amazon-simple-queue-service-sqs">
<span id="section7-2-sqs-label"></span><h2>Amazon Simple Queue Service(SQS)<a class="headerlink" href="#amazon-simple-queue-service-sqs" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section7-2-1-sqs-overview-label">
<span id="id1"></span><h3>Overview<a class="headerlink" href="#section7-2-1-sqs-overview-label" title="Permalink to this headline">¶</a></h3>
<p>Amazon Simple Queue Service(SQS)は完全マネージド分散型キュー配信方式のメッセージサービスである。
複数のサーバに複数のメッセージのコピーを保存して信頼性を確保しながら最低一度の配信を保証する。
大容量のデータを高スループットで転送可能であり、メッセージ送信の信頼性が高く、各コンポーネントを疎結合にできる。</p>
<p>キューは以下のようなURLフォーマット、メッセージID、受信ハンドル(ReceiptHandle)で識別される。</p>
<p><a class="reference external" href="http://sqs">http://sqs</a>.&lt;region&gt;.amazonaws.com/&lt;accout-id&gt;</p>
<p>キューは専用のAPIにより、以下のような操作が可能である。</p>
<table border="1" class="colwidths-given docutils" id="id8">
<caption><span class="caption-text">キューの操作</span><a class="headerlink" href="#id8" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">API</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CreateQueue</td>
<td>新しいキューを作成するか、既存のキューのURLを返す</td>
</tr>
<tr class="row-odd"><td>SetQueueAttribute</td>
<td>キューの属性を設定する。属性値は下記表を参照。</td>
</tr>
<tr class="row-even"><td>GetQueueAttribute</td>
<td>キューの属性を取得する。属性値は下記表を参照。</td>
</tr>
<tr class="row-odd"><td>GetQueueUrl</td>
<td>キューのURLを取得する。</td>
</tr>
<tr class="row-even"><td>ListQueues</td>
<td>キューのリストを取得する。</td>
</tr>
<tr class="row-odd"><td>DeleteQueues</td>
<td>キューを削除する。</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given docutils" id="id9">
<caption><span class="caption-text">キューの属性</span><a class="headerlink" href="#id9" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">属性名</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>DelaySecounds</td>
<td>メッセージの遅延配信時間</td>
</tr>
<tr class="row-odd"><td>MaximumMessageSize</td>
<td>メッセージに含まれる最大バイト数(デフォルト・最大値ともに256KiB)</td>
</tr>
<tr class="row-even"><td>MessageRetentionPeriod</td>
<td>メッセージが保持される秒数(デフォルト４日、最大１４日)</td>
</tr>
<tr class="row-odd"><td>RecieveMessageWaitTimeSeconds</td>
<td>呼び出しがメッセージ到着を待機する時間(デフォルト0秒、最大20秒)</td>
</tr>
<tr class="row-even"><td>Visibility Timeout</td>
<td>特定のアプリケーションコンポーネントからキューがメッセージを取得した後、 <br /> その他からメッセージが不可視となる時間。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SQSではメッセージの処理順序でシーケンス性が保証されないので注意。メッセージ順序を保証する場合はFIFOキュー(2018年2月現在、東京リージョンでは未対応)の利用を検討する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SQSには可視性タイムアウト(Visibility Timeout)機能があり、あるキューが処理中に異常処理した場合に、別のノードでキューを処理するためにキューをロックした状態で残しておくが、
可視性タイムアウトはそのロック時間を指す。ロックをかけるのは、複数のノードが同じキューを処理することをさけるためである。
また、デッドレターキューとして、処理できなかったキューを除外することもできる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SQSのサービスはS3と同じく、リージョン単位で提供されるサービスである。</p>
</div>
<p>また、キューには他のユーザとも共有することができ、匿名で他のAWSユーザと共有するオプション、アクセス許可を利用して特定のユーザとシェアするオプションがある。料金はメッセージの所有者になる。</p>
</div>
<div class="section" id="section7-2-1-sqs-create-queue-label">
<span id="id2"></span><h3>キューの作成<a class="headerlink" href="#section7-2-1-sqs-create-queue-label" title="Permalink to this headline">¶</a></h3>
<p>■コンソールからSQSを選択し、「今すぐ始める」をクリックする。</p>
<div class="figure">
<img alt="../../../_images/management-console-sqs-create-queue-1.png" src="../../../_images/management-console-sqs-create-queue-1.png" />
</div>
<p>■キューに名称、キューの属性を設定し、キューの作成を押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-sqs-create-queue-2.png" src="../../../_images/management-console-sqs-create-queue-2.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-sqs-create-queue-3.png" src="../../../_images/management-console-sqs-create-queue-3.png" />
</div>
<p>■キューが登録される。</p>
<div class="figure">
<img alt="../../../_images/management-console-sqs-create-queue-4.png" src="../../../_images/management-console-sqs-create-queue-4.png" />
</div>
</div>
<div class="section" id="sqs">
<span id="section7-2-2-sqs-usage-applicaiotn-label"></span><h3>SQSキューを利用するアプリケーション<a class="headerlink" href="#sqs" title="Permalink to this headline">¶</a></h3>
<p>Spring Cloud AWSを利用してSQSキューを利用するアプリケーションを簡単に構築できる。</p>
<p><a class="reference internal" href="../../../java/spring/spring-cloud-aws/usage.html#section2-1-spring-cloud-aws-sqs-usage-label"><span class="std std-ref">Amazon SQSを利用する実装</span></a> を参照のこと。</p>
<p>作成したキューに対し、メッセージを送信する。キューを選択し、「キュー操作」からメッセージ送信を選ぶ。</p>
<div class="figure">
<img alt="../../../_images/management-console-sqs-push-queue-1.png" src="../../../_images/management-console-sqs-push-queue-1.png" />
</div>
<p>メッセージを入力し、送信ボタンを押下する。</p>
<div class="figure">
<img alt="../../../_images/management-console-sqs-push-queue-2.png" src="../../../_images/management-console-sqs-push-queue-2.png" />
</div>
<p>アプリケーションを実行しているとリスナーがメッセージ処理する。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2018</span>-03-03 <span class="m">13</span>:02:44.071  INFO <span class="m">73635</span> --- <span class="o">[</span>  restartedMain<span class="o">]</span> o.d.sample.spring.cloud.aws.config.App   : Started App in <span class="m">14</span>.102 seconds <span class="o">(</span>JVM running <span class="k">for</span> <span class="m">16</span>.098<span class="o">)</span>
<span class="m">2018</span>-03-03 <span class="m">13</span>:02:44.286  INFO <span class="m">73635</span> --- <span class="o">[</span>enerContainer-2<span class="o">]</span> o.d.s.s.c.a.app.listener.QueueListener   : test-1
<span class="m">2018</span>-03-03 <span class="m">13</span>:05:02.628  INFO <span class="m">73635</span> --- <span class="o">[</span>enerContainer-3<span class="o">]</span> o.d.s.s.c.a.app.listener.QueueListener   : テスト
</pre></div>
</div>
</div>
<div class="section" id="sns">
<span id="section7-2-3-sqs-subscribe-sns-label"></span><h3>SNSトピックからの通知を購読するキューの設定<a class="headerlink" href="#sns" title="Permalink to this headline">¶</a></h3>
<p>SNSトピックから通知されたイベントを受け取りキューをメッセージングする設定を行う。</p>
<p>■作成したSQSキューを選択し、「キュー操作」&gt;「SNSトピックへのキューサブスクライブ」を選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-sqs-subscribe-sns-1.png" src="../../../_images/management-console-sqs-subscribe-sns-1.png" />
</div>
<p>■ 購読する対象のSNSトピックを選択する。</p>
<div class="figure">
<img alt="../../../_images/management-console-sqs-subscribe-sns-2.png" src="../../../_images/management-console-sqs-subscribe-sns-2.png" />
</div>
</div>
</div>
<div class="section" id="amazon-kinesis-streams">
<span id="section7-3-kinesis-stream-label"></span><h2>Amazon kinesis Streams<a class="headerlink" href="#amazon-kinesis-streams" title="Permalink to this headline">¶</a></h2>
<p>Amazon Kinesisは完全マネージド型のストリーミングデータサービスで、大規模なデータレコードストリームをリアルタイムで収集・処理できる。
WebアプリケーションやIoT・モバイルデバイス等から収集したデータをストリームデータとして処理する。Kinesis Streamプラットフォームの主要なコンポーネントは以下の通りである。</p>
<table border="1" class="colwidths-given docutils" id="id10">
<caption><span class="caption-text">Kinesis Streamのコンポーネント</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">コンポーネント</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>データレコード</td>
<td>データの最小単位で、イベント契機で発生するデータストリームの構成要素。 <br /> シーケンス番号、パーティションキー、データBLOBで構成される。</td>
</tr>
<tr class="row-odd"><td>ストリーム</td>
<td>順序付けされたデータレコードのシーケンス</td>
</tr>
<tr class="row-even"><td>シャード</td>
<td>ストリームからパーティションキーに基づき分割したデータ群。 <br /> ストリームを作成する際は、シャード数を指定する必要がある。</td>
</tr>
<tr class="row-odd"><td>プロデューサ</td>
<td>データを発生させるイベントアプリケーション</td>
</tr>
<tr class="row-even"><td>コンシューマ</td>
<td>ストリームからデータレコードを取得し、処理を行うアプリケーション</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="section7-3-1-kinesis-producer-detail-label">
<span id="id3"></span><h2>プロデューサアプリケーション<a class="headerlink" href="#section7-3-1-kinesis-producer-detail-label" title="Permalink to this headline">¶</a></h2>
<p>プロデューサアプリケーションでは、パーティションキーとデータBLOBを持つデータレコードを発生させる。
その後、データレコードをストリームに追加すると、Kinesis Streamがシーケンス番号をデータレコードに割り当てる。
アプリケーションでは、以下２種類のAPIが利用可能である。</p>
<ul class="simple">
<li>Amazon Kinesis Stream API</li>
<li>Amazon Kinesis Producer Library(KPL)</li>
</ul>
<p>Stream APIでは、PutRecordリクエストを利用して、ストリームにデータを追加するAPIで、
KPLは、プロデューサとストリームの仲介より柔軟な機能を提供するライブラリである。
具体的には、レコードを複数のストリームに同期・非同期で書き込む、リトライ機能、レコードを集約し、
複数のシャードに書き込む機能、CloudWatchとの連携機能が提供される。</p>
</div>
<div class="section" id="section7-3-2-kinesis-consumer-detail-label">
<span id="id4"></span><h2>コンシューマアプリケーション<a class="headerlink" href="#section7-3-2-kinesis-consumer-detail-label" title="Permalink to this headline">¶</a></h2>
<p>コンシューマアプリケーションでは、シャードイテレータを使用して特定のシャードから読み取りを行う。
シャードイテレータとはコンシューマにおいてレコードの読み取りが開始されるストリームの位置を指定するもので、
読み取りオペレーションを実行すると、シャードイテレータを用いてレコードデータを取得する。
プロデューサ同様、コンシューマアプリケーションでも、以下２種類のAPIが利用可能である。</p>
<ul class="simple">
<li>Amazon Kinesis Stream API</li>
<li>Amazon Kinesis Consumer Library(KCL)</li>
</ul>
<p>StreamAPIでは、シャードイテレータを取得して、GetRecordリクエストからデータ取得を行う。
KCLは、KPLと同様、ストリームとの間を仲介する機能を提供する。ワーカーと呼ばれるスレッドをインスタンス化して
ストリームからデータを読み込み、チェックポイント作成、シャードの再割り当て（リシャーディング）等を行う。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">KCLでは、チェックポイントやワーカーとシャードのマッピング情報をAmazonDynamoにテーブルを作成して管理する。
Kinesisを利用する場合は、IAMでDynamoDBやCloudWatchのアクセス権限を作成する必要がある。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">kinesisの最大送信メッセージサイズは1MBである。</p>
</div>
<div class="section" id="amazon-kinesis-firehose-amazon-kinesis-analytics">
<span id="section7-3-3-kinesis-firehose-label"></span><h3>Amazon kinesis firehose　/ Amazon kinesis Analytics<a class="headerlink" href="#amazon-kinesis-firehose-amazon-kinesis-analytics" title="Permalink to this headline">¶</a></h3>
<p>Amazon kinesis firehoseは上述のStreamの派生版で、ストリーミングデータを直接データストアや分析ツールにロードするサービスである。
ストリーミングデータをキャプチャして変換し、Amazon S3、Amazon Redshift、Amazon Elasticsearch Service、Splunkにロードできる。
同様に、派生版のサービスであるmazon kinesis Analyticsはプログラミング言語や処理フレームワークを習得することなく、
標準SQLでストリーミングデータをリアルタイムで処理できるサービスである。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">2018年2月現在、東京リージョンでは利用はできない。</p>
</div>
</div>
</div>
<div class="section" id="amazon-lamda">
<span id="section7-4-lamda-label"></span><h2>Amazon Lamda<a class="headerlink" href="#amazon-lamda" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section7-4-1-lambda-overview-label">
<span id="id5"></span><h3>Overview<a class="headerlink" href="#section7-4-1-lambda-overview-label" title="Permalink to this headline">¶</a></h3>
<p>Amazon Lamdaはユーザのコードを実行し、同時に基盤となるコンピューティングリソースをユーザに代わって管理するコンピューティングサービス。
S3バケットに対する変更やDynamoテーブルの更新などのAWSリソースに対するイベント、
アプリケーションやデバイスによって生成されたカスタムイベントなどに応答してコードを実行可能である。</p>
<p>Lambdaではファンクションという単位でソースコードを作成し、以下の方法でファンクションを呼び出す。</p>
<ul class="simple">
<li>プッシュイベントモデル</li>
<li>プルイベントモデル</li>
<li>相互呼び出し(request-response)モデル</li>
</ul>
<p>プッシュイベントモデルでは、定義したイベントソース(AmazonS3, AmazonSNS, Amazon Cognito, Amazon Echo等)で発生したイベントを
トリガーとしてファンクションを実行する。
プルイベントモデルでは、Lambdaがイベントソースをポーリングし、イベント検出時にファンクションを呼び出す。
これらのモデルはAmazon kinesis streamやAmazon Dynamo streamなどに適用される。
request-responseモデルは、Amazon Lambdaがファンクションを同期的に実行し、即座に応答を返す方式である。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lambdaファンクションの所有者は関数の実行権限および関連するリソースにアクセスする権限をアクセスポリシーとして付与する必要がある。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lambdaでは、実行する環境のリージョンは選べるが、実行環境は完全マネージドとなる。処理のメモリやスペックは選択でき、料金はリクエスト回数、コード実行時間、ファンクションに割り当てるメモリサイズに応じて決定される。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lambdaでは、実行時間を指定してスケジュール実行することが可能である。スケジュール登録はAWSコンソール上から行う必要がある。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>その他、Lambdaでは以下の制約が貸される。</p>
<ul class="last simple">
<li>実行処理時間が５分</li>
<li>ネットワーク通信はTCP/IPのみサポート</li>
<li>デバッグ用のシステムコールは制限される</li>
<li>TCP25ポートはトラフィックが制限される(スパム対策)</li>
</ul>
</div>
</div>
<div class="section" id="section7-4-3-lambda-deploy-label">
<span id="id6"></span><h3>コードの作成・デプロイ<a class="headerlink" href="#section7-4-3-lambda-deploy-label" title="Permalink to this headline">¶</a></h3>
<p>Lambdaファンクションを、Javaでコードを作成する場合、com.amazonaws.services.lambda.runtime.RequestHandlerを継承したクラスで、ハンドラメソッドを実装する必要がある。
AWSコンソール上から登録することでデプロイする。イベントのトリガーは、後述するAPI Gatewayからのリクエスト要求や、S3のバケットに対する変更等、同様にAWSコンソール上から設定する。
ここでは、単純な例として、S3へファイルアップロードすると、イベント通知でLambdaファンクションを実行し、結果を返すコードの実装例を記述する。</p>
<p>なお、コードの作成には、Spring Cloud Functionを利用する。プロジェクトの作成・ビルドの方法や実装したコードの詳細は <a class="reference internal" href="../../../java/spring/spring-cloud-function/introduction.html#section1-spring-cloud-function-introduction-label"><span class="std std-ref">Introduction</span></a> を参照すること。
Lambdaファンクションをデプロイするには、以下の３つの方法がある。</p>
<ul class="simple">
<li>AWSコンソール上のインラインエディタで編集</li>
<li>コードと依存関係をZIPファイルへ圧縮し(Lambdaデプロイパッケージ)、アップロード</li>
<li>LambdaデプロイパッケージをS3にアップロード</li>
</ul>
<p>ここでは、MavenプロジェクトからビルドしたJARファイルをアップロードし、デプロイする。</p>
<p>ハンドラクラス、コンフィグクラス、ファンクションクラスはそれぞれ以下の通りである。</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">1 org.debugroom.sample.spring.cloud.function.S3EventHandler.java</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.cloud.function</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.lambda.runtime.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.s3.event.S3EventNotification</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.function.adapter.aws.SpringBootRequestHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">S3EventHandler</span> <span class="kd">extends</span>
          <span class="n">SpringBootRequestHandler</span><span class="o">&lt;</span><span class="n">S3EventNotification</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;{</span>

          <span class="kd">public</span> <span class="nf">S3EventHandler</span><span class="o">(){</span>
                    <span class="kd">super</span><span class="o">();</span>
          <span class="o">}</span>

          <span class="kd">public</span> <span class="nf">S3EventHandler</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">configurationClass</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">super</span><span class="o">(</span><span class="n">configurationClass</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="n">Object</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">S3EventNotification</span> <span class="n">event</span><span class="o">,</span> <span class="n">Context</span> <span class="n">context</span><span class="o">){</span>
                    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">handleRequest</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
          <span class="o">}</span>

 <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">handleRequestをオーバーライドして型を指定しないと、java.util.LinkedHashMapにマップされ、java.lang.ClassCastExceptionが発生する模様。
以降のSpring Cloud Functionのバージョンで解消されるかもしれないが、ここでは、handleメソッドを継承し、スーパークラスのメソッドを呼び出しておく。</p>
</div>
<p>アプリケーション起動クラス・コンフィグレーションクラスは以下の通りである。</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">1 org.debugroom.sample.spring.cloud.function.config.App.java</span><a class="headerlink" href="#id12" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.cloud.function.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>

          <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]){</span>
                    <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">App</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
          <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">1 org.debugroom.sample.spring.cloud.function.config.ProductionConfig.java</span><a class="headerlink" href="#id13" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.cloud.function.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Function</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.debugroom.sample.spring.cloud.function.S3EventFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.function.context.FunctionScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.s3.AmazonS3</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.s3.AmazonS3ClientBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.s3.event.S3EventNotification</span><span class="o">;</span>

<span class="nd">@FunctionScan</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductionConfig</span> <span class="o">{</span>

          <span class="cm">/* @FunctionScanを使用しない場合Bean登録しておく。</span>
<span class="cm">          @Bean</span>
<span class="cm">          public Function&lt;S3EventNotification, String&gt; s3EventFunction() {</span>
<span class="cm">                    return event -&gt; {</span>
<span class="cm">                              S3EventNotification.S3EventNotificationRecord record = event.getRecords().get(0);</span>
<span class="cm">                              System.out.println(record.toString());</span>
<span class="cm">                              return &quot;Complete!&quot;;</span>
<span class="cm">                    };</span>
<span class="cm">          }</span>
<span class="cm">          */</span>

          <span class="nd">@Bean</span>
          <span class="kd">public</span> <span class="n">AmazonS3</span> <span class="nf">amazonS3Client</span><span class="o">(){</span>
                    <span class="k">return</span> <span class="n">AmazonS3ClientBuilder</span><span class="o">.</span><span class="na">defaultClient</span><span class="o">();</span>
          <span class="o">}</span>

 <span class="o">}</span>
</pre></div>
</div>
</div>
<p>また、実行するファンクションクラスは以下の通りである。 S3からアップされたイベント情報を表示している。</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">1 org.debugroom.sample.spring.cloud.function.S3EventFunction.java</span><a class="headerlink" href="#id14" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.sample.spring.cloud.function</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.s3.AmazonS3</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.s3.event.S3EventNotification</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.s3.model.S3Object</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">reactor.core.publisher.Flux</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">S3EventFunction</span> <span class="kd">implements</span>
         <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">function</span><span class="o">.</span><span class="na">Function</span><span class="o">&lt;</span><span class="n">Flux</span><span class="o">&lt;</span><span class="n">S3EventNotification</span><span class="o">&gt;,</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;{</span>

         <span class="nd">@Inject</span>
         <span class="n">AmazonS3</span> <span class="n">amazonS3</span><span class="o">;</span>

         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Flux</span><span class="o">&lt;</span><span class="n">S3EventNotification</span><span class="o">&gt;</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">event</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="o">{</span>
                             <span class="k">if</span><span class="o">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="na">getRecords</span><span class="o">().</span><span class="na">size</span><span class="o">()){</span>
                                       <span class="n">S3EventNotification</span><span class="o">.</span><span class="na">S3EventNotificationRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getRecords</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : AWS Region : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getAwsRegion</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Event Name : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getEventName</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Event Source : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getEventSource</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Event Version : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getEventVersion</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Event Time : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getEventTime</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : IPAddress : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getRequestParameters</span><span class="o">().</span><span class="na">getSourceIPAddress</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : PrincipalId : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getUserIdentity</span><span class="o">().</span><span class="na">getPrincipalId</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Bucket : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getS3</span><span class="o">().</span><span class="na">getBucket</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : ARN : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getS3</span><span class="o">().</span><span class="na">getBucket</span><span class="o">().</span><span class="na">getArn</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : OwnerIdentity : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getS3</span><span class="o">().</span><span class="na">getBucket</span><span class="o">().</span><span class="na">getOwnerIdentity</span><span class="o">().</span><span class="na">getPrincipalId</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : ObjectKey : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getS3</span><span class="o">().</span><span class="na">getObject</span><span class="o">().</span><span class="na">getKey</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : UrlDecodedKey : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getS3</span><span class="o">().</span><span class="na">getObject</span><span class="o">().</span><span class="na">getUrlDecodedKey</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Size : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getS3</span><span class="o">().</span><span class="na">getObject</span><span class="o">().</span><span class="na">getSizeAsLong</span><span class="o">());</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; : Sequencer : &quot;</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getS3</span><span class="o">().</span><span class="na">getObject</span><span class="o">().</span><span class="na">getSequencer</span><span class="o">());</span>
                             <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                                       <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;No event data.&quot;</span><span class="o">);</span>
                             <span class="o">}</span>
                   <span class="o">});</span>
                   <span class="k">return</span> <span class="n">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">&quot;Process for S3 Notification event is complete.&quot;</span><span class="o">);</span>
        <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>■AWSコンソールから、AWS Lambdaを選択し、「関数の作成」をクリックする。</p>
<div class="figure">
<img alt="../../../_images/management-console-lambda-upload-1.png" src="../../../_images/management-console-lambda-upload-1.png" />
</div>
<p>■関数の名前、実行する言語や環境、ロールを選択し、関数を作成する。</p>
<div class="figure">
<img alt="../../../_images/management-console-lambda-s3-1.png" src="../../../_images/management-console-lambda-s3-1.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>S3等にアクセスする場合は、権限を付与したロールを作成しておくこと。</p>
<div class="last figure">
<img alt="../../../_images/management-console-lambda-upload-3.png" src="../../../_images/management-console-lambda-upload-3.png" />
</div>
</div>
<p>■イベントのトリガーとなる要素を「トリガーの追加」リストから選択し、追加する。ここでは、S3を追加する。</p>
<div class="figure">
<img alt="../../../_images/management-console-lambda-s3-2.png" src="../../../_images/management-console-lambda-s3-2.png" />
</div>
<p>■S3におけるイベントの発生条件を設定する。ここでは特定のバケットに新規追加、更新するとLambdaにイベントが通知されるよう決定する。</p>
<div class="figure">
<img alt="../../../_images/management-console-lambda-s3-3.png" src="../../../_images/management-console-lambda-s3-3.png" />
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">S3のイベント発生条件で、Lambdaファンクション処理後に再びLambdaのイベント発生条件を満たさないよう注意すること。
例えば、S3の特定のフォルダにオブジェクトを作成することを発生条件にしていると、ファンクション内で新たにそのフォルダにオブジェクトを作成すると、永久ループすることになる。</p>
</div>
<p>■続いて、作成したLambdaファンクションを選択し、実行環境やハンドラ、環境変数などの設定を行う。</p>
<div class="figure">
<img alt="../../../_images/management-console-lambda-s3-4.png" src="../../../_images/management-console-lambda-s3-4.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-lambda-s3-5.png" src="../../../_images/management-console-lambda-s3-5.png" />
</div>
<div class="figure">
<img alt="../../../_images/management-console-lambda-s3-6.png" src="../../../_images/management-console-lambda-s3-6.png" />
</div>
<p>以下では最低限必要な設定要領を記述する。</p>
<ul class="simple">
<li>コードエントリタイプ→ZIPファイルまたはJARファイル</li>
<li>ランタイム→Java8</li>
<li>ハンドラ→作成したハンドラクラス(ここでは、org.debugroom.sample.spring.cloud.function.S3EventHandler::handleRequest)を指定。</li>
<li>環境変数の設定(必要に応じて設定する)<ul>
<li>FUNCTION_NAME=apiGatewayEventFunction</li>
<li>CLOUD_AWS_REGION_STATIC=ap-northeast-1</li>
</ul>
</li>
<li>実行ロール→Lambdaファンクションの実行に必要なロールを設定</li>
<li>基本設定<ul>
<li>メモリ→Springを起動する場合最低128MB程度必要なためそれ以上の値を設定しておく。</li>
<li>実行時間→Springのコンテナの初回起動で30[s]ほど必要なため、それを見込んだ実行時間を設定。</li>
</ul>
</li>
<li>ネットワーク→実行するトリガーがVPC内か否かを指定。(ここでは手元からHTTPリクエストを送るので非VPCを設定)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">環境変数FUNCTION_NAMEは実行するファンクションを指定するため、作成したファンクションクラスのキャメルケースを設定する。CLOUD_AWS_REGION_STATICはSpring Cloud AWSを使って、S3アクセスするために設定する。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">アップロードしたコードは一意のARNをもち、バージョニングされる。また、ファンクションのエイリアスを作成できる。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>テスト実行により関数が正常実行されるか確認できる。ただし、実際のイベントのオブジェクトは空の状態で渡ってくるので注意。</p>
<div class="last figure">
<img alt="../../../_images/management-console-lambda-s3-7.png" src="../../../_images/management-console-lambda-s3-7.png" />
</div>
</div>
<p>■画面上部の保存を押下した後、S3へファイルアップロードすると、イベントが通知され、Lambdaファンクションが起動する。実行はCloud Watchから確認できる。</p>
<div class="figure">
<img alt="../../../_images/management-console-lambda-s3-8.png" src="../../../_images/management-console-lambda-s3-8.png" />
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Spring Cloud Functionで実行するファンクションは初回起動時にDIコンテナの起動で数十秒要する。
２回目以降、Lambda実行環境が再利用するので、イベント通知後処理が早く実行されるが、完全マネージドのLambda環境では、
しばらく関数が実行されないと実行環境が破棄され、再びその後のファンクション実行時にDIコンテナの起動処理が必要になる。
API Gatewaryなどはデフォルト30[s]のリクエストタイムアウトがあるので、Spring Cloud Functionの実行は
即時性を求められる処理について、適用するかどうか十分検討して実装すること。</p>
</div>
</div>
</div>
<div class="section" id="amazon-simple-workflow-service-swf">
<span id="section7-5-swf-label"></span><h2>Amazon Simple Workflow Service(SWF)<a class="headerlink" href="#amazon-simple-workflow-service-swf" title="Permalink to this headline">¶</a></h2>
<p>Amazon Simple Workflow ServiceはEC2を前提としたマネージド型ワークフロー実行基盤である。
分散コンポーネント間でまたがって協調処理させ一元管理する。</p>
<div class="section" id="aws-flow-framework">
<span id="section7-5-1-swf-framework-label"></span><h3>AWS Flow Framework<a class="headerlink" href="#aws-flow-framework" title="Permalink to this headline">¶</a></h3>
<p>AWS Flow Frameworkはタスクレベルで協調処理を抽象化するフレームワークである。</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">AWS Flow Frameworkに関する概要を記述。</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="devops.html" class="btn btn-neutral float-right" title="DevOps Category" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="security.html" class="btn btn-neutral" title="Security Category" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, org.debugroom.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1-SNAPSHOTS',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>